version: '3.8'

# ============================================================
# DOCKER COMPOSE PARA AWS EC2-MICROSERVICIOS
# ============================================================
# Este archivo despliega los microservicios en una instancia EC2-Microservicios
# Las bases de datos residen en otra instancia EC2-DB y se conectan por IP privada
# 
# Instrucciones de uso:
# 1. Copia este archivo a docker-compose.yml en EC2-Microservicios
# 2. Configura .env con las IPs privadas correctas
# 3. Ejecuta: docker-compose up -d
# ============================================================

networks:
  microservices-network:
    driver: bridge
    ipam:
      config:
        - subnet: 10.0.1.0/24

services:
  # ============================================================
  # API GATEWAY - Punto de entrada único
  # ============================================================
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    image: acompanamiento-api-gateway:latest
    container_name: api-gateway
    ports:
      - "${API_GATEWAY_PORT:-8080}:8080"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=8080
      - GATEWAY_PORT=${API_GATEWAY_PORT:-8080}
    depends_on:
      - micro-auth
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # MICRO-AUTH - Autenticación y autorización
  # ============================================================
  micro-auth:
    build:
      context: ./micro-auth
      dockerfile: Dockerfile
    image: acompanamiento-micro-auth:latest
    container_name: micro-auth
    ports:
      - "${MICRO_AUTH_PORT:-5005}:5005"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=5005
      - MONGO_URI=${MONGO_URI:-mongodb://172.31.0.1:27017/acompanamiento}
      - REDIS_URL=${REDIS_URL:-redis://172.31.0.1:6379}
      - JWT_SECRET=${JWT_SECRET:-change_me}
      - JWT_EXPIRY=${JWT_EXPIRY:-24h}
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # MICRO-MAESTROS - Gestión de maestros
  # ============================================================
  micro-maestros:
    build:
      context: ./micro-maestros
      dockerfile: Dockerfile
    image: acompanamiento-micro-maestros:latest
    container_name: micro-maestros
    ports:
      - "${MICRO_MAESTROS_PORT:-5001}:5001"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=5001
      - MONGO_URI=${MONGO_URI:-mongodb://172.31.0.1:27017/acompanamiento}
      - KAFKA_BROKERS=${KAFKA_BROKERS:-kafka:9092}
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # MICRO-ESTUDIANTES - Gestión de estudiantes
  # ============================================================
  micro-estudiantes:
    build:
      context: ./micro-estudiantes
      dockerfile: Dockerfile
    image: acompanamiento-micro-estudiantes:latest
    container_name: micro-estudiantes
    ports:
      - "${MICRO_ESTUDIANTES_PORT:-5002}:5002"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=5002
      - MONGO_URI=${MONGO_URI:-mongodb://172.31.0.1:27017/acompanamiento}
      - KAFKA_BROKERS=${KAFKA_BROKERS:-kafka:9092}
      - RABBITMQ_URL=${RABBITMQ_URL:-amqp://guest:guest@rabbitmq:5672}
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # MICRO-REPORTES-ESTUDIANTES - Reportes de estudiantes
  # ============================================================
  micro-reportes-estudiantes:
    build:
      context: ./micro-reportes-estudiantes
      dockerfile: Dockerfile
    image: acompanamiento-micro-reportes-estudiantes:latest
    container_name: micro-reportes-estudiantes
    ports:
      - "${MICRO_REPORTES_ESTUDIANTES_PORT:-5003}:5003"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=5003
      - MONGO_URI=${MONGO_URI:-mongodb://172.31.0.1:27017/acompanamiento}
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # MICRO-REPORTES-MAESTROS - Reportes de maestros
  # ============================================================
  micro-reportes-maestros:
    build:
      context: ./micro-reportes-maestros
      dockerfile: Dockerfile
    image: acompanamiento-micro-reportes-maestros:latest
    container_name: micro-reportes-maestros
    ports:
      - "${MICRO_REPORTES_MAESTROS_PORT:-5004}:5004"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=5004
      - MONGO_URI=${MONGO_URI:-mongodb://172.31.0.1:27017/acompanamiento}
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # MICRO-NOTIFICACIONES - Email, SMS, Push
  # ============================================================
  micro-notificaciones:
    build:
      context: ./micro-notificaciones
      dockerfile: Dockerfile
    image: acompanamiento-micro-notificaciones:latest
    container_name: micro-notificaciones
    ports:
      - "${MICRO_NOTIFICACIONES_PORT:-5006}:5006"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=5006
      - POSTGRES_HOST=${POSTGRES_HOST:-172.31.0.1}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-acompanamiento}
      - KAFKA_BROKERS=${KAFKA_BROKERS:-kafka:9092}
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5006/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # MICRO-SOAP-BRIDGE - Integración SOAP legacy
  # ============================================================
  micro-soap-bridge:
    build:
      context: ./micro-soap-bridge
      dockerfile: Dockerfile
    image: acompanamiento-micro-soap-bridge:latest
    container_name: micro-soap-bridge
    ports:
      - "${MICRO_SOAP_BRIDGE_PORT:-5008}:5008"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=5008
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5008/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # FRONTEND-WEB - Interfaz de usuario
  # ============================================================
  frontend-web:
    build:
      context: ./frontend-web
      dockerfile: Dockerfile
    image: acompanamiento-frontend-web:latest
    container_name: frontend-web
    ports:
      - "${FRONTEND_PORT:-5500}:5500"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - API_GATEWAY_URL=http://localhost:${API_GATEWAY_PORT:-8080}
    depends_on:
      - api-gateway
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5500/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

# ============================================================
# NOTAS IMPORTANTES
# ============================================================
# 1. Las bases de datos (PostgreSQL, MongoDB, Redis) residen
#    en EC2-DB y se conectan usando IP privada
#
# 2. NO incluimos servicios de bases de datos en este archivo
#    porque están en otra instancia EC2-DB
#
# 3. Los brokers de mensajería (Kafka, RabbitMQ) se pueden
#    desplegar en la misma instancia o en otra separada
#    Ajusta KAFKA_BROKERS y RABBITMQ_URL en .env según necesites
#
# 4. Todos los servicios tienen:
#    - Healthchecks configurados
#    - Restart policy: unless-stopped
#    - Logging: json-file con rotación
#    - Network dedicada para aislamiento
#
# 5. Para desplegar:
#    docker-compose up -d
#
# 6. Para verificar:
#    docker-compose ps
#    docker-compose logs -f
#
# 7. Para limpiar:
#    docker-compose down
