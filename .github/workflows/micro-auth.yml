name: Build, Push, and Deploy Micro Auth

on:
  push:
    branches: [ "main" ]
    paths:
      - "micro-auth/**"
  workflow_dispatch:
    inputs:
      deploy:
        description: "Run the deploy step to AWS (true/false). Defaults to 'false'."
        required: false
        default: 'false'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.set-image.outputs.image-tag }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker Image
        id: set-image
        run: |
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          IMAGE_TAG="${SHORT_SHA}"
          echo "Image tag will be: $IMAGE_TAG"
          echo "image-tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"
          docker build -f micro-auth/Dockerfile -t ${{ secrets.DOCKERHUB_USERNAME }}/micro-auth:$IMAGE_TAG .

          echo "Verifying built image contains shared-auth files"
          if docker run --rm --entrypoint ls ${{ secrets.DOCKERHUB_USERNAME }}/micro-auth:$IMAGE_TAG /usr/src/shared-auth/src/middlewares; then
            echo "shared-auth present in built image"
          else
            echo "ERROR: shared-auth NOT found in built image; failing the job to avoid pushing a broken image"
            docker run --rm --entrypoint ls ${{ secrets.DOCKERHUB_USERNAME }}/micro-auth:$IMAGE_TAG /usr/src || true
            exit 1
          fi

          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/micro-auth:$IMAGE_TAG ${{ secrets.DOCKERHUB_USERNAME }}/micro-auth:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/micro-auth:$IMAGE_TAG
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/micro-auth:latest

  deploy-aws:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true' }}
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Set permissions for private key
        run: |
          echo "${{ secrets.EC2_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Deploy to EC2
        run: |
          if [ -z "${{ secrets.EC2_CORE_HOST }}" ]; then
            echo "ERROR: secret EC2_CORE_HOST is not set. Set the correct host secret in repository settings.";
            exit 1;
          fi

          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_CORE_HOST }} << 'EOF'
          sudo apt update -y
          if ! command -v docker &> /dev/null
          then
            sudo apt install -y docker.io
            sudo systemctl start docker
            sudo systemctl enable docker
          fi

          echo "Logging in to Docker Hub (for private image pulls)"
          sudo docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }} || echo "docker login failed (proceeding, pull may fail)"

          sudo docker stop micro-auth-container || true
          sudo docker rm micro-auth-container || true
          IMAGE_TAG=${{ needs.build-and-push.outputs.image-tag }}
          if [ -z "$IMAGE_TAG" ]; then IMAGE_TAG=latest; fi
          IMAGE_REF=${{ secrets.DOCKERHUB_USERNAME }}/micro-auth:$IMAGE_TAG
          echo "Attempting to pull image $IMAGE_REF"
          if sudo docker pull $IMAGE_REF; then
            echo "Pulled micro-auth image successfully: $IMAGE_REF"
            echo "Verifying shared-auth exists inside image..."
            sudo docker run --rm --entrypoint ls $IMAGE_REF /usr/src/shared-auth/src/middlewares || echo "shared-auth not present in image"
            RUN_IMAGE="$IMAGE_REF"
          else
            echo "Pull failed; attempting to build image locally on the EC2 host"
            if [ ! -d "$HOME/Proyecto-Acompa-amiento-" ]; then
              git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git "$HOME/Proyecto-Acompa-amiento-"
            else
              git -C "$HOME/Proyecto-Acompa-amiento-" pull || true
            fi
            sudo docker build -f "$HOME/Proyecto-Acompa-amiento-/micro-auth/Dockerfile" -t ${{ secrets.DOCKERHUB_USERNAME }}/micro-auth:latest "$HOME/Proyecto-Acompa-amiento-" || true
            RUN_IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/micro-auth:latest"
          fi

          # Create env file from repository secrets so the deployed container uses correct runtime config
          echo "MONGO_URI=${{ secrets.MONGO_URI }}" > "$HOME/micro-auth.env"
          if [ -n "${{ secrets.REDIS_HOST }}" ]; then echo "REDIS_HOST=${{ secrets.REDIS_HOST }}" >> "$HOME/micro-auth.env"; fi
          if [ -n "${{ secrets.REDIS_PORT }}" ]; then echo "REDIS_PORT=${{ secrets.REDIS_PORT }}" >> "$HOME/micro-auth.env"; fi

          echo "Running container from image: $RUN_IMAGE with env file"
          sudo docker run -d --restart unless-stopped --env-file "$HOME/micro-auth.env" -p 3001:3001 --name micro-auth-container "$RUN_IMAGE" || true
          sleep 2
          echo "Container status:"; sudo docker ps -a --filter "name=micro-auth-container" || true
          echo "Recent logs (micro-auth):"; sudo docker logs --tail 200 micro-auth-container || true
          # Post-deploy health check (retry loop)
          echo "Waiting for micro-auth service to become healthy..."
          HEALTH_OK=0
          for i in $(seq 1 12); do
            if sudo docker run --rm --network host curlimages/curl:7.88.1 -sSf http://localhost:3001/health > /dev/null 2>&1; then
              echo "micro-auth /health OK"
              HEALTH_OK=1
              break
            else
              echo "micro-auth not ready yet (attempt $i/12), sleeping 5s..."
              sleep 5
            fi
          done
          if [ "$HEALTH_OK" != "1" ]; then
            echo "ERROR: micro-auth failed health check; dumping logs"
            sudo docker logs --tail 500 micro-auth-container || true
            exit 1
          fi

          # Basic smoke test: attempt to register a test user (will not fail pipeline if service returns 4xx)
          echo "Running basic registration smoke test"
          set -o pipefail
          if sudo docker run --rm --network host curlimages/curl:7.88.1 -sS -o /tmp/smoke.json -w "%{http_code}" -X POST http://localhost:3001/auth/register -H 'Content-Type: application/json' -d '{"name":"smoke","email":"smoke+ci@example.com","password":"p","role":"estudiante"}' | grep -E "2.." >/dev/null; then
            echo "Smoke test registration returned 2xx"
          else
            echo "Smoke test registration did not return 2xx; /auth/register may be failing - check service logs"
            sudo tail -n 200 /tmp/smoke.json || true
          fi
          sudo docker image prune -f
          EOF

