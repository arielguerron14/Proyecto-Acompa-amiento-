name: ğŸš€ Deploy via SSH + Docker Compose (Optimized)

on:
  workflow_dispatch:
    inputs:
      rebuild_images:
        description: 'Rebuild Docker images from source'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  AWS_REGION: us-east-1
  DOCKER_REGISTRY: docker.io

jobs:
  # =========================================================================
  # LOAD INSTANCE IPS FROM CONFIG
  # =========================================================================
  load-config:
    name: ğŸ“‹ Load Configuration
    runs-on: ubuntu-latest
    outputs:
      bastion-public: ${{ steps.load.outputs.bastion_public }}
      api-gateway-public: ${{ steps.load.outputs.api_gateway_public }}
      core-public: ${{ steps.load.outputs.core_public }}
      reportes-public: ${{ steps.load.outputs.reportes_public }}
      notificaciones-public: ${{ steps.load.outputs.notificaciones_public }}
      messaging-public: ${{ steps.load.outputs.messaging_public }}
      db-public: ${{ steps.load.outputs.db_public }}
      analytics-public: ${{ steps.load.outputs.analytics_public }}
      monitoring-public: ${{ steps.load.outputs.monitoring_public }}
      frontend-public: ${{ steps.load.outputs.frontend_public }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Load instance IPs
        id: load
        run: |
          python3 << 'PYTHON'
          import json
          
          with open('config/instance_ips.json', 'r') as f:
              instances = json.load(f)
          
          mapping = {
              'EC-Bastion': 'bastion',
              'EC2-API-Gateway': 'api_gateway',
              'EC2-CORE': 'core',
              'EC2-Reportes': 'reportes',
              'EC2-Notificaciones': 'notificaciones',
              'EC2-Messaging': 'messaging',
              'EC2-DB': 'db',
              'EC2-Analytics': 'analytics',
              'EC2-Monitoring': 'monitoring',
              'EC2-Frontend': 'frontend'
          }
          
          for instance_name, output_name in mapping.items():
              if instance_name in instances:
                  public_ip = instances[instance_name]['PublicIpAddress']
                  print(f"::set-output name={output_name}_public::{public_ip}")
                  print(f"âœ… {instance_name}: {public_ip}")
          PYTHON

  # =========================================================================
  # 1. DEPLOY EC2-MESSAGING (Docker Compose)
  # =========================================================================
  deploy-messaging:
    name: "â±ï¸  1. Deploy EC2-Messaging"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.load-config.outputs.messaging-public }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy with Docker Compose
        run: |
          scp -i ~/.ssh/id_rsa docker-compose.messaging.yml ec2-user@${{ needs.load-config.outputs.messaging-public }}:/tmp/
          
          ssh -i ~/.ssh/id_rsa ec2-user@${{ needs.load-config.outputs.messaging-public }} << 'DEPLOY'
          set -e
          echo "================================"
          echo "â±ï¸  EC2-Messaging Deployment"
          echo "================================"
          
          cd /tmp
          docker-compose -f docker-compose.messaging.yml down 2>/dev/null || true
          docker-compose -f docker-compose.messaging.yml up -d
          
          sleep 15
          docker-compose -f docker-compose.messaging.yml ps
          echo "âœ… EC2-Messaging deployment complete"
          DEPLOY

  # =========================================================================
  # 2. DEPLOY EC2-DB (Docker Compose)
  # =========================================================================
  deploy-db:
    name: "ğŸ—„ï¸  2. Deploy EC2-DB"
    needs: [load-config, deploy-messaging]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.load-config.outputs.db-public }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy with Docker Compose
        run: |
          scp -i ~/.ssh/id_rsa docker-compose.db.yml ec2-user@${{ needs.load-config.outputs.db-public }}:/tmp/
          
          ssh -i ~/.ssh/id_rsa ec2-user@${{ needs.load-config.outputs.db-public }} << 'DEPLOY'
          set -e
          echo "================================"
          echo "ğŸ—„ï¸  EC2-DB Deployment"
          echo "================================"
          
          cd /tmp
          docker-compose -f docker-compose.db.yml down 2>/dev/null || true
          docker-compose -f docker-compose.db.yml up -d
          
          sleep 20
          docker-compose -f docker-compose.db.yml ps
          echo "âœ… EC2-DB deployment complete"
          DEPLOY

  # =========================================================================
  # 3. DEPLOY EC2-CORE (Docker Compose)
  # =========================================================================
  deploy-core:
    name: "ğŸ³ 3. Deploy EC2-CORE"
    needs: [load-config, deploy-db]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.load-config.outputs.core-public }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy with Docker Compose
        run: |
          scp -i ~/.ssh/id_rsa docker-compose.core.yml ec2-user@${{ needs.load-config.outputs.core-public }}:/tmp/
          
          ssh -i ~/.ssh/id_rsa ec2-user@${{ needs.load-config.outputs.core-public }} << 'DEPLOY'
          set -e
          echo "================================"
          echo "ğŸ³ EC2-CORE Deployment"
          echo "================================"
          
          cd /tmp
          docker-compose -f docker-compose.core.yml down 2>/dev/null || true
          
          if [ "${{ github.event.inputs.rebuild_images }}" = "true" ]; then
            docker-compose -f docker-compose.core.yml build
          fi
          
          docker-compose -f docker-compose.core.yml up -d
          
          sleep 15
          docker-compose -f docker-compose.core.yml ps
          echo "âœ… EC2-CORE deployment complete"
          DEPLOY

  # =========================================================================
  # 4. DEPLOY EC2-API-GATEWAY (Docker Compose)
  # =========================================================================
  deploy-api-gateway:
    name: "ğŸŒ 4. Deploy EC2-API-Gateway"
    needs: [load-config, deploy-core]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.load-config.outputs.api-gateway-public }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy with Docker Compose
        run: |
          scp -i ~/.ssh/id_rsa docker-compose.api-gateway.yml ec2-user@${{ needs.load-config.outputs.api-gateway-public }}:/tmp/
          
          ssh -i ~/.ssh/id_rsa ec2-user@${{ needs.load-config.outputs.api-gateway-public }} << 'DEPLOY'
          set -e
          echo "================================"
          echo "ğŸŒ EC2-API-Gateway Deployment"
          echo "================================"
          
          cd /tmp
          docker-compose -f docker-compose.api-gateway.yml down 2>/dev/null || true
          
          if [ "${{ github.event.inputs.rebuild_images }}" = "true" ]; then
            docker-compose -f docker-compose.api-gateway.yml build
          fi
          
          docker-compose -f docker-compose.api-gateway.yml up -d
          
          sleep 10
          docker-compose -f docker-compose.api-gateway.yml ps
          echo "âœ… EC2-API-Gateway deployment complete"
          DEPLOY

  # =========================================================================
  # 5. DEPLOY EC2-REPORTES (Docker Compose)
  # =========================================================================
  deploy-reportes:
    name: "ğŸ“„ 5. Deploy EC2-Reportes"
    needs: [load-config, deploy-db]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.load-config.outputs.reportes-public }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy with Docker Compose
        run: |
          scp -i ~/.ssh/id_rsa docker-compose.reportes.yml ec2-user@${{ needs.load-config.outputs.reportes-public }}:/tmp/
          
          ssh -i ~/.ssh/id_rsa ec2-user@${{ needs.load-config.outputs.reportes-public }} << 'DEPLOY'
          set -e
          echo "================================"
          echo "ğŸ“„ EC2-Reportes Deployment"
          echo "================================"
          
          cd /tmp
          docker-compose -f docker-compose.reportes.yml down 2>/dev/null || true
          
          if [ "${{ github.event.inputs.rebuild_images }}" = "true" ]; then
            docker-compose -f docker-compose.reportes.yml build
          fi
          
          docker-compose -f docker-compose.reportes.yml up -d
          
          sleep 10
          docker-compose -f docker-compose.reportes.yml ps
          echo "âœ… EC2-Reportes deployment complete"
          DEPLOY

  # =========================================================================
  # 6. DEPLOY EC2-NOTIFICACIONES (Docker Compose)
  # =========================================================================
  deploy-notificaciones:
    name: "ğŸ”” 6. Deploy EC2-Notificaciones"
    needs: [load-config, deploy-db, deploy-messaging]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.load-config.outputs.notificaciones-public }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy with Docker Compose
        run: |
          scp -i ~/.ssh/id_rsa docker-compose.notificaciones.yml ec2-user@${{ needs.load-config.outputs.notificaciones-public }}:/tmp/
          
          ssh -i ~/.ssh/id_rsa ec2-user@${{ needs.load-config.outputs.notificaciones-public }} << 'DEPLOY'
          set -e
          echo "================================"
          echo "ğŸ”” EC2-Notificaciones Deployment"
          echo "================================"
          
          cd /tmp
          docker-compose -f docker-compose.notificaciones.yml down 2>/dev/null || true
          
          if [ "${{ github.event.inputs.rebuild_images }}" = "true" ]; then
            docker-compose -f docker-compose.notificaciones.yml build
          fi
          
          docker-compose -f docker-compose.notificaciones.yml up -d
          
          sleep 10
          docker-compose -f docker-compose.notificaciones.yml ps
          echo "âœ… EC2-Notificaciones deployment complete"
          DEPLOY

  # =========================================================================
  # 7. DEPLOY EC2-ANALYTICS (Docker Compose)
  # =========================================================================
  deploy-analytics:
    name: "ğŸ“Š 7. Deploy EC2-Analytics"
    needs: [load-config, deploy-db]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.load-config.outputs.analytics-public }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy with Docker Compose
        run: |
          scp -i ~/.ssh/id_rsa docker-compose.analytics.yml ec2-user@${{ needs.load-config.outputs.analytics-public }}:/tmp/
          
          ssh -i ~/.ssh/id_rsa ec2-user@${{ needs.load-config.outputs.analytics-public }} << 'DEPLOY'
          set -e
          echo "================================"
          echo "ğŸ“Š EC2-Analytics Deployment"
          echo "================================"
          
          cd /tmp
          docker-compose -f docker-compose.analytics.yml down 2>/dev/null || true
          
          if [ "${{ github.event.inputs.rebuild_images }}" = "true" ]; then
            docker-compose -f docker-compose.analytics.yml build
          fi
          
          docker-compose -f docker-compose.analytics.yml up -d
          
          sleep 10
          docker-compose -f docker-compose.analytics.yml ps
          echo "âœ… EC2-Analytics deployment complete"
          DEPLOY

  # =========================================================================
  # 8. DEPLOY EC2-MONITORING (Docker Compose)
  # =========================================================================
  deploy-monitoring:
    name: "ğŸ“ˆ 8. Deploy EC2-Monitoring"
    needs: [load-config, deploy-core]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.load-config.outputs.monitoring-public }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy with Docker Compose
        run: |
          scp -i ~/.ssh/id_rsa docker-compose.monitoring.yml ec2-user@${{ needs.load-config.outputs.monitoring-public }}:/tmp/
          
          ssh -i ~/.ssh/id_rsa ec2-user@${{ needs.load-config.outputs.monitoring-public }} << 'DEPLOY'
          set -e
          echo "================================"
          echo "ğŸ“ˆ EC2-Monitoring Deployment"
          echo "================================"
          
          cd /tmp
          docker-compose -f docker-compose.monitoring.yml down 2>/dev/null || true
          docker-compose -f docker-compose.monitoring.yml up -d
          
          sleep 10
          docker-compose -f docker-compose.monitoring.yml ps
          echo "âœ… EC2-Monitoring deployment complete"
          DEPLOY

  # =========================================================================
  # 9. DEPLOY EC2-FRONTEND (Docker Compose)
  # =========================================================================
  deploy-frontend:
    name: "ğŸ¨ 9. Deploy EC2-Frontend"
    needs: [load-config, deploy-api-gateway]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.load-config.outputs.frontend-public }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy with Docker Compose
        run: |
          scp -i ~/.ssh/id_rsa docker-compose.frontend.yml ec2-user@${{ needs.load-config.outputs.frontend-public }}:/tmp/
          
          ssh -i ~/.ssh/id_rsa ec2-user@${{ needs.load-config.outputs.frontend-public }} << 'DEPLOY'
          set -e
          echo "================================"
          echo "ğŸ¨ EC2-Frontend Deployment"
          echo "================================"
          
          cd /tmp
          docker-compose -f docker-compose.frontend.yml down 2>/dev/null || true
          
          if [ "${{ github.event.inputs.rebuild_images }}" = "true" ]; then
            docker-compose -f docker-compose.frontend.yml build
          fi
          
          docker-compose -f docker-compose.frontend.yml up -d
          
          sleep 10
          docker-compose -f docker-compose.frontend.yml ps
          echo "âœ… EC2-Frontend deployment complete"
          DEPLOY

  # =========================================================================
  # 10. DEPLOY EC-BASTION (Docker Compose)
  # =========================================================================
  deploy-bastion:
    name: "ğŸ›¡ï¸  10. Deploy EC-Bastion"
    needs: [load-config, deploy-frontend]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.load-config.outputs.bastion-public }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy with Docker Compose
        run: |
          scp -i ~/.ssh/id_rsa docker-compose.bastion.yml ec2-user@${{ needs.load-config.outputs.bastion-public }}:/tmp/
          
          ssh -i ~/.ssh/id_rsa ec2-user@${{ needs.load-config.outputs.bastion-public }} << 'DEPLOY'
          set -e
          echo "================================"
          echo "ğŸ›¡ï¸  EC-Bastion Deployment"
          echo "================================"
          
          cd /tmp
          docker-compose -f docker-compose.bastion.yml down 2>/dev/null || true
          
          if [ "${{ github.event.inputs.rebuild_images }}" = "true" ]; then
            docker-compose -f docker-compose.bastion.yml build
          fi
          
          docker-compose -f docker-compose.bastion.yml up -d
          
          sleep 5
          docker-compose -f docker-compose.bastion.yml ps
          echo "âœ… EC-Bastion deployment complete"
          DEPLOY

  # =========================================================================
  # FINAL VERIFICATION & SUMMARY
  # =========================================================================
  verification:
    name: "âœ… Final Verification"
    needs: [load-config, deploy-bastion]
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Print deployment summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                                    â•‘"
          echo "â•‘    âœ… DEPLOYMENT COMPLETE - ALL 10 INSTANCES DEPLOYED!            â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•‘           Using Docker Compose (Optimized Deployment)             â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š DEPLOYED SERVICES:"
          echo "   âœ… EC2-Messaging:        docker-compose.messaging.yml"
          echo "   âœ… EC2-DB:               docker-compose.db.yml"
          echo "   âœ… EC2-CORE:             docker-compose.core.yml"
          echo "   âœ… EC2-API-Gateway:      docker-compose.api-gateway.yml"
          echo "   âœ… EC2-Reportes:         docker-compose.reportes.yml"
          echo "   âœ… EC2-Notificaciones:   docker-compose.notificaciones.yml"
          echo "   âœ… EC2-Analytics:        docker-compose.analytics.yml"
          echo "   âœ… EC2-Monitoring:       docker-compose.monitoring.yml"
          echo "   âœ… EC2-Frontend:         docker-compose.frontend.yml"
          echo "   âœ… EC-Bastion:           docker-compose.bastion.yml"
          echo ""
          echo "ğŸ¯ BENEFITS:"
          echo "   âœ“ Cleaner deployment (using docker-compose)"
          echo "   âœ“ Easier to maintain and update services"
          echo "   âœ“ Version controlled docker-compose files"
          echo "   âœ“ Faster deployments"
          echo "   âœ“ Consistent with local development"
          echo ""
          echo "ğŸ“ SERVICE URLs:"
          echo "   ğŸ¨ Frontend:      http://${{ needs.load-config.outputs.frontend-public }}:5500"
          echo "   ğŸŒ API Gateway:   http://${{ needs.load-config.outputs.api-gateway-public }}:8080"
          echo "   ğŸ“ˆ Grafana:       http://${{ needs.load-config.outputs.monitoring-public }}:3000"
          echo "   ğŸ“Š Prometheus:    http://${{ needs.load-config.outputs.monitoring-public }}:9090"
          echo ""
