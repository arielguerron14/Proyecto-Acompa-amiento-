name: Deploy EC2-CORE Microservices

on:
  workflow_dispatch:

env:
  EC2_CORE_PUBLIC_IP: 13.216.12.61
  EC2_CORE_PRIVATE_IP: 172.31.78.183
  EC2_DB_PRIVATE_IP: 172.31.79.193
  AWS_REGION: ap-southeast-1

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_EC2_DB_SSH_PRIVATE_KEY }}" > ~/.ssh/aws-key.pem
          chmod 600 ~/.ssh/aws-key.pem
          ssh-keyscan -H ${{ env.EC2_CORE_PUBLIC_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Detect SSH User
        run: |
          if ssh -i ~/.ssh/aws-key.pem -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o BatchMode=yes ubuntu@${{ env.EC2_CORE_PUBLIC_IP }} "true" 2>/dev/null; then
            echo "SSH_USER=ubuntu" >> $GITHUB_ENV
            echo "✅ Using ubuntu user"
          elif ssh -i ~/.ssh/aws-key.pem -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o BatchMode=yes ec2-user@${{ env.EC2_CORE_PUBLIC_IP }} "true" 2>/dev/null; then
            echo "SSH_USER=ec2-user" >> $GITHUB_ENV
            echo "✅ Using ec2-user"
          else
            echo "❌ SSH connection failed"
            exit 1
          fi

      - name: Prepare Instance
        run: |
          ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.EC2_CORE_PUBLIC_IP }} << 'EOF'
          set -e
          echo "Detecting system..."
          if [ -f /etc/os-release ]; then
            . /etc/os-release
            OS=$ID
          else
            OS=$(uname -s)
          fi
          echo "OS: $OS"
          
          if [ "$OS" = "amzn" ] || [ "$OS" = "amazon" ]; then
            sudo yum update -y > /dev/null 2>&1 || true
            sudo yum install -y docker > /dev/null 2>&1 || true
          else
            sudo apt-get update -qq > /dev/null 2>&1 || true
            sudo apt-get install -y docker.io > /dev/null 2>&1 || true
          fi
          
          sudo systemctl start docker || true
          sudo systemctl enable docker > /dev/null 2>&1 || true
          sudo usermod -aG docker $(whoami) > /dev/null 2>&1 || true
          sudo curl -sL "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose 2>/dev/null || true
          sudo chmod +x /usr/local/bin/docker-compose 2>/dev/null || true
          echo "✅ Instance ready"
          EOF

      - name: Deploy Services
        run: |
          ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.EC2_CORE_PUBLIC_IP }} << 'EOF'
          set -e
          mkdir -p /opt/microservices/core
          cd /opt/microservices/core
          
          # Clean
          docker rm -f micro-auth micro-estudiantes micro-maestros 2>/dev/null || true
          docker rmi micro-auth micro-estudiantes micro-maestros 2>/dev/null || true
          
          # Clone if needed
          if [ ! -d "proyecto" ]; then
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git proyecto
          fi
          cd proyecto
          
          # Build images
          docker build -f micro-auth/Dockerfile -t micro-auth:latest .
          docker build -f micro-estudiantes/Dockerfile -t micro-estudiantes:latest .
          docker build -f micro-maestros/Dockerfile -t micro-maestros:latest .
          
          cd /opt/microservices/core
          cat > docker-compose.yml << 'COMPOSE'
version: '3.8'
services:
  micro-auth:
    image: micro-auth:latest
    container_name: micro-auth
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      MONGO_URL: mongodb://admin:mongodb123@172.31.79.193:27017/acompanamiento?authSource=admin
      POSTGRES_URL: postgresql://postgres:postgres123@172.31.79.193:5432/acompanamiento
      REDIS_URL: redis://:redis123@172.31.79.193:6379
    restart: unless-stopped
    networks:
      - core-net

  micro-estudiantes:
    image: micro-estudiantes:latest
    container_name: micro-estudiantes
    ports:
      - "3001:3001"
    environment:
      NODE_ENV: production
      PORT: 3001
      MONGO_URL: mongodb://admin:mongodb123@172.31.79.193:27017/acompanamiento?authSource=admin
      POSTGRES_URL: postgresql://postgres:postgres123@172.31.79.193:5432/acompanamiento
      REDIS_URL: redis://:redis123@172.31.79.193:6379
      AUTH_SERVICE: http://172.31.78.183:3000
    restart: unless-stopped
    networks:
      - core-net

  micro-maestros:
    image: micro-maestros:latest
    container_name: micro-maestros
    ports:
      - "3002:3002"
    environment:
      NODE_ENV: production
      PORT: 3002
      MONGO_URL: mongodb://admin:mongodb123@172.31.79.193:27017/acompanamiento?authSource=admin
      POSTGRES_URL: postgresql://postgres:postgres123@172.31.79.193:5432/acompanamiento
      REDIS_URL: redis://:redis123@172.31.79.193:6379
      AUTH_SERVICE: http://172.31.78.183:3000
    restart: unless-stopped
    networks:
      - core-net

networks:
  core-net:
    driver: bridge
COMPOSE

          docker-compose up -d
          sleep 15
          docker ps -a
          echo "✅ Services deployed"
          EOF

      - name: Validate
        run: |
          ssh -i ~/.ssh/aws-key.pem -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.EC2_CORE_PUBLIC_IP }} << 'EOF'
          echo "Service Status:"
          docker ps -a
          echo ""
          echo "✅ Deployment complete"
          EOF
