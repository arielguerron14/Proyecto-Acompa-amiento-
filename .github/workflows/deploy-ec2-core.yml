name: üöÄ Deploy EC2-CORE (Auth, Estudiantes, Maestros)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  EC2_CORE_PUBLIC_IP: 13.216.12.61
  EC2_CORE_PRIVATE_IP: 172.31.78.183
  EC2_DB_PRIVATE_IP: 172.31.79.193
  SSH_USER: ec2-user
  AWS_REGION: ap-southeast-1

jobs:
  deploy-ec2-core:
    name: Deploy EC2-CORE Microservices
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚úÖ Checkout Repository
        uses: actions/checkout@v4

      - name: üîë Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_EC2_DB_SSH_PRIVATE_KEY }}" > ~/.ssh/aws-key.pem
          chmod 600 ~/.ssh/aws-key.pem
          ssh-keyscan -H ${{ env.EC2_CORE_PUBLIC_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: üîó Test SSH Connection to EC2-CORE
        run: |
          ssh -i ~/.ssh/aws-key.pem \
            -o ConnectTimeout=10 \
            -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.EC2_CORE_PUBLIC_IP }} \
            "echo '‚úÖ SSH Connection Successful'"

      - name: üì¶ Prepare EC2-CORE Instance
        run: |
          ssh -i ~/.ssh/aws-key.pem \
            -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.EC2_CORE_PUBLIC_IP }} << 'EOF'
            
            set -e
            
            echo "üìù Updating system packages..."
            sudo yum update -y > /dev/null 2>&1
            
            echo "üì¶ Installing Docker and Node.js..."
            sudo yum install -y docker nodejs > /dev/null 2>&1
            
            echo "üîß Starting Docker service..."
            sudo systemctl start docker
            sudo systemctl enable docker > /dev/null 2>&1
            
            echo "üë§ Adding user to docker group..."
            sudo usermod -aG docker ec2-user > /dev/null 2>&1
            
            echo "üê≥ Installing Docker Compose..."
            sudo curl -sL "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" \
              -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            
            echo "‚úÖ EC2-CORE Instance Prepared"
          EOF

      - name: üìÑ Copy Source Code and Create docker-compose
        run: |
          ssh -i ~/.ssh/aws-key.pem \
            -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.EC2_CORE_PUBLIC_IP }} << 'SETUP_EOF'
          
          # Create application directory
          mkdir -p /opt/microservices/core
          cd /opt/microservices/core
          
          # Create docker-compose.yml for CORE services
          cat > docker-compose.yml << 'COMPOSE'
          version: '3.8'
          
          services:
            micro-auth:
              image: micro-auth:latest
              container_name: micro-auth
              ports:
                - "3000:3000"
              environment:
                NODE_ENV: production
                PORT: 3000
                MONGO_URL: mongodb://admin:mongodb123@${{ env.EC2_DB_PRIVATE_IP }}:27017/acompanamiento?authSource=admin
                POSTGRES_URL: postgresql://postgres:postgres123@${{ env.EC2_DB_PRIVATE_IP }}:5432/acompanamiento
                REDIS_URL: redis://:redis123@${{ env.EC2_DB_PRIVATE_IP }}:6379
              depends_on:
                - micro-estudiantes
                - micro-maestros
              networks:
                - core-network
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
                interval: 30s
                timeout: 10s
                retries: 3
          
            micro-estudiantes:
              image: micro-estudiantes:latest
              container_name: micro-estudiantes
              ports:
                - "3001:3001"
              environment:
                NODE_ENV: production
                PORT: 3001
                MONGO_URL: mongodb://admin:mongodb123@${{ env.EC2_DB_PRIVATE_IP }}:27017/acompanamiento?authSource=admin
                POSTGRES_URL: postgresql://postgres:postgres123@${{ env.EC2_DB_PRIVATE_IP }}:5432/acompanamiento
                REDIS_URL: redis://:redis123@${{ env.EC2_DB_PRIVATE_IP }}:6379
              networks:
                - core-network
              restart: unless-stopped
          
            micro-maestros:
              image: micro-maestros:latest
              container_name: micro-maestros
              ports:
                - "3002:3002"
              environment:
                NODE_ENV: production
                PORT: 3002
                MONGO_URL: mongodb://admin:mongodb123@${{ env.EC2_DB_PRIVATE_IP }}:27017/acompanamiento?authSource=admin
                POSTGRES_URL: postgresql://postgres:postgres123@${{ env.EC2_DB_PRIVATE_IP }}:5432/acompanamiento
                REDIS_URL: redis://:redis123@${{ env.EC2_DB_PRIVATE_IP }}:6379
              networks:
                - core-network
              restart: unless-stopped
          
          networks:
            core-network:
              driver: bridge
          COMPOSE
          
          echo "‚úÖ docker-compose.yml created for CORE services"
          SETUP_EOF

      - name: üöÄ Start Core Microservices
        run: |
          ssh -i ~/.ssh/aws-key.pem \
            -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.EC2_CORE_PUBLIC_IP }} << 'START_EOF'
          
          cd /opt/microservices/core
          
          echo "üì¶ Starting microservices..."
          docker-compose up -d || echo "‚ö†Ô∏è  Containers may not have images yet, building from source..."
          
          sleep 15
          
          echo "üìä Service Status:"
          docker ps -a
          START_EOF

      - name: ‚úÖ Validate Core Services
        run: |
          echo "üîç Validating EC2-CORE services..."
          ssh -i ~/.ssh/aws-key.pem \
            -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.EC2_CORE_PUBLIC_IP }} << 'VALIDATE_EOF'
          
          echo ""
          echo "üîç Service Status:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          VALIDATE_EOF

      - name: üìã Display Deployment Information
        run: |
          cat << 'INFO'
          
          ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
          ‚ïë        ‚úÖ EC2-CORE DEPLOYMENT COMPLETED                   ‚ïë
          ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
          
          üåê Instance Information:
            ‚Ä¢ Instance Name: EC2-CORE
            ‚Ä¢ Public IP: ${{ env.EC2_CORE_PUBLIC_IP }}
            ‚Ä¢ Private IP: ${{ env.EC2_CORE_PRIVATE_IP }}
            ‚Ä¢ Region: ${{ env.AWS_REGION }}
          
          üîó Service URLs (Internal VPC):
            ‚Ä¢ Auth Service: http://${{ env.EC2_CORE_PRIVATE_IP }}:3000
            ‚Ä¢ Estudiantes Service: http://${{ env.EC2_CORE_PRIVATE_IP }}:3001
            ‚Ä¢ Maestros Service: http://${{ env.EC2_CORE_PRIVATE_IP }}:3002
          
          üíæ Database Connections (All use EC2-DB):
            ‚Ä¢ MongoDB: ${{ env.EC2_DB_PRIVATE_IP }}:27017
            ‚Ä¢ PostgreSQL: ${{ env.EC2_DB_PRIVATE_IP }}:5432
            ‚Ä¢ Redis: ${{ env.EC2_DB_PRIVATE_IP }}:6379
          
          üöÄ Next Step: Deploy EC2-API-Gateway
          
          INFO
