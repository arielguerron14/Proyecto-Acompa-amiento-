name: Deploy EC2-CORE Services (Auth, Students, Teachers, SOAP Bridge, Analytics)

on:
  workflow_dispatch:
    inputs:
      instance_name:
        description: 'EC2 Instance name to deploy (default: EC2-CORE)'
        required: false
        default: 'EC2-CORE'
      skip_verification:
        description: 'Skip health verification (true/false)'
        required: false
        default: 'false'

env:
  INSTANCE_NAME: ${{ github.event.inputs.instance_name || 'EC2-CORE' }}
  INSTANCE_USER: ubuntu
  REPO_URL: https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
  AWS_REGION: us-east-1

jobs:
  deploy-core-services:
    runs-on: ubuntu-latest
    name: Deploy Core Services to EC2-CORE

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Discover EC2 instances and IPs
      run: |
        echo "üîç Discovering EC2 instances..."

        INSTANCE_INFO=$(aws ec2 describe-instances \
          --filters "Name=tag:Name,Values=${{ env.INSTANCE_NAME }}" \
                    "Name=instance-state-name,Values=running" \
          --query 'Reservations[].Instances[].[PublicIpAddress, PrivateIpAddress, InstanceId, InstanceType, Tags[?Key==`Name`].Value|[0]]' \
          --output json)

        PUBLIC_IP=$(echo "$INSTANCE_INFO" | jq -r '.[0][0]')
        PRIVATE_IP=$(echo "$INSTANCE_INFO" | jq -r '.[0][1]')
        INSTANCE_ID=$(echo "$INSTANCE_INFO" | jq -r '.[0][2]')
        INSTANCE_TYPE=$(echo "$INSTANCE_INFO" | jq -r '.[0][3]')

        echo "INSTANCE_PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_ENV
        echo "INSTANCE_PRIVATE_IP=$PRIVATE_IP" >> $GITHUB_ENV
        echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_ENV
        echo "INSTANCE_TYPE=$INSTANCE_TYPE" >> $GITHUB_ENV

        if [ -z "$PUBLIC_IP" ] || [ "$PUBLIC_IP" == "null" ]; then
          echo "‚ùå ERROR: Could not find instance with name: ${{ env.INSTANCE_NAME }}"
          aws ec2 describe-instances \
            --filters "Name=instance-state-name,Values=running" \
            --query 'Reservations[].Instances[].[InstanceId, InstanceType, PublicIpAddress, Tags[?Key==`Name`].Value|[0]]' \
            --output table
          exit 1
        fi

        echo "‚úÖ Instance discovered:" && \
        echo "   Name:       ${{ env.INSTANCE_NAME }}" && \
        echo "   ID:         $INSTANCE_ID" && \
        echo "   Type:       $INSTANCE_TYPE" && \
        echo "   Public IP:  $PUBLIC_IP" && \
        echo "   Private IP: $PRIVATE_IP"

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ env.INSTANCE_PUBLIC_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true

    - name: Verify SSH connection
      run: |
        ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ env.INSTANCE_USER }}@${{ env.INSTANCE_PUBLIC_IP }} "echo '‚úÖ SSH connection successful'; whoami"

    - name: Discover dependent instances IPs
      run: |
        echo "üîç Discovering IPs of dependency instances..."
        
        # Discover EC2-DB instance (for mongo/postgres)
        DB_INSTANCE=$(aws ec2 describe-instances \
          --filters "Name=tag:Name,Values=EC2-DB" \
                    "Name=instance-state-name,Values=running" \
          --query 'Reservations[0].Instances[0].PrivateIpAddress' \
          --output text)
        
        # Discover EC2-Messaging instance (for kafka/zookeeper/rabbitmq)
        MESSAGING_INSTANCE=$(aws ec2 describe-instances \
          --filters "Name=tag:Name,Values=EC2-Messaging" \
                    "Name=instance-state-name,Values=running" \
          --query 'Reservations[0].Instances[0].PrivateIpAddress' \
          --output text)
        
        # Set environment variables for dependency hosts
        if [ ! -z "$DB_INSTANCE" ] && [ "$DB_INSTANCE" != "None" ]; then
          echo "DB_HOST=$DB_INSTANCE" >> $GITHUB_ENV
          echo "‚úÖ Found EC2-DB at: $DB_INSTANCE"
        else
          echo "‚ö†Ô∏è  EC2-DB not found, using local mongo"
          echo "DB_HOST=mongo" >> $GITHUB_ENV
        fi
        
        if [ ! -z "$MESSAGING_INSTANCE" ] && [ "$MESSAGING_INSTANCE" != "None" ]; then
          echo "MESSAGING_HOST=$MESSAGING_INSTANCE" >> $GITHUB_ENV
          echo "‚úÖ Found EC2-Messaging at: $MESSAGING_INSTANCE"
        else
          echo "‚ö†Ô∏è  EC2-Messaging not found, using local kafka"
          echo "MESSAGING_HOST=kafka" >> $GITHUB_ENV
        fi

    - name: Detect instance and prepare environment
      run: |
        echo "Instance Name:   ${{ env.INSTANCE_NAME }}"
        echo "Instance ID:     ${{ env.INSTANCE_ID }}"
        echo "Instance Type:   ${{ env.INSTANCE_TYPE }}"
        echo "Public IP:       ${{ env.INSTANCE_PUBLIC_IP }}"
        echo "Private IP:      ${{ env.INSTANCE_PRIVATE_IP }}"
        echo "Services:        micro-auth, micro-estudiantes, micro-maestros, micro-soap-bridge, micro-analytics"
        echo "DB Host:         ${{ env.DB_HOST }}"
        echo "Messaging Host:  ${{ env.MESSAGING_HOST }}"

    - name: Deploy and configure core services
      run: |
        ssh -o StrictHostKeyChecking=no ${{ env.INSTANCE_USER }}@${{ env.INSTANCE_PUBLIC_IP }} << 'EOF'
        set -e

        echo "=== EC2-CORE Deployment Started ==="
        echo "Hostname: $(hostname)"
        echo "IP Address: $(hostname -I)"

        echo "üì¶ Updating system packages..."
        sudo apt-get update -qq || true

        echo "üê≥ Checking Docker installation..."
        if ! command -v docker &> /dev/null; then
          sudo apt-get install -y docker.io docker-compose git
          sudo systemctl enable docker
          sudo systemctl start docker
          sudo usermod -aG docker ubuntu
        fi

        echo "üê≥ Setting up Docker Compose..."
        if docker compose version &> /dev/null 2>&1; then
          export DC="docker compose"
        elif command -v docker-compose &> /dev/null; then
          export DC="docker-compose"
        else
          sudo apt-get install -y docker-compose-plugin 2>/dev/null || {
            curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /tmp/docker-compose
            sudo mv /tmp/docker-compose /usr/local/bin/
            sudo chmod +x /usr/local/bin/docker-compose
            export DC="docker-compose"
          }
        fi
        echo "‚úÖ Using: $DC"

        if [ ! -d ~/projeto-acompanamiento ]; then
          cd ~ && git clone ${{ env.REPO_URL }} projeto-acompanamiento
        else
          cd ~/projeto-acompanamiento && git pull origin main
        fi

        cd ~/projeto-acompanamiento

        echo "üî® Building core microservices images..."
        $DC build micro-auth micro-estudiantes micro-maestros micro-soap-bridge micro-analytics --no-cache 2>&1 | tail -20 || echo "‚ö†Ô∏è Build notes"

        echo "üöÄ Starting core services with cross-instance configuration..."
        
        # Create environment override file if using remote instances
        if [ "${{ env.DB_HOST }}" != "mongo" ] || [ "${{ env.MESSAGING_HOST }}" != "kafka" ]; then
          echo "üìù Configuring remote instance connectivity..."
          cat > ~/.env.remote << ENVEOF
          MONGODB_URI=mongodb://root:example@${{ env.DB_HOST }}:27017/auth?authSource=admin
          KAFKA_BROKERS=${{ env.MESSAGING_HOST }}:9092
          RABBITMQ_URL=amqp://guest:guest@${{ env.MESSAGING_HOST }}:5672
          ENVEOF
          
          # Source the environment variables
          export $(cat ~/.env.remote | xargs)
        fi
        
        # Start microservices with proper environment
        $DC up -d micro-auth micro-estudiantes micro-maestros micro-soap-bridge micro-analytics

        # If using local hosts, also start local dependencies
        if [ "${{ env.DB_HOST }}" = "mongo" ]; then
          echo "Starting local database and messaging services..."
          $DC up -d zookeeper kafka rabbitmq mongo
        fi

        echo "‚è≥ Waiting for services to initialize (40 seconds)..."
        sleep 40

        echo "‚úÖ Current container status:" && $DC ps
        echo "=== EC2-CORE Deployment Completed ==="
        EOF

    - name: Health check - micro-auth
      if: ${{ github.event.inputs.skip_verification != 'true' }}
      continue-on-error: true
      run: |
        echo "üîç Checking micro-auth container..."
        ssh -o StrictHostKeyChecking=no ${{ env.INSTANCE_USER }}@${{ env.INSTANCE_PUBLIC_IP }} << 'EOF' || true
        cd ~/projeto-acompanamiento
        if docker compose version &>/dev/null 2>&1; then DC="docker compose"; elif command -v docker-compose &>/dev/null 2>&1; then DC="docker-compose"; else exit 0; fi
        $DC ps | grep micro-auth || true
        EOF

    - name: Health check - micro-estudiantes
      if: ${{ github.event.inputs.skip_verification != 'true' }}
      continue-on-error: true
      run: |
        echo "üîç Checking micro-estudiantes container..."
        ssh -o StrictHostKeyChecking=no ${{ env.INSTANCE_USER }}@${{ env.INSTANCE_PUBLIC_IP }} << 'EOF' || true
        cd ~/projeto-acompanamiento
        if docker compose version &>/dev/null 2>&1; then DC="docker compose"; elif command -v docker-compose &>/dev/null 2>&1; then DC="docker-compose"; else exit 0; fi
        $DC ps | grep micro-estudiantes || true
        EOF

    - name: Health check - micro-maestros
      if: ${{ github.event.inputs.skip_verification != 'true' }}
      continue-on-error: true
      run: |
        echo "üîç Checking micro-maestros container..."
        ssh -o StrictHostKeyChecking=no ${{ env.INSTANCE_USER }}@${{ env.INSTANCE_PUBLIC_IP }} << 'EOF' || true
        cd ~/projeto-acompanamiento
        if docker compose version &>/dev/null 2>&1; then DC="docker compose"; elif command -v docker-compose &>/dev/null 2>&1; then DC="docker-compose"; else exit 0; fi
        $DC ps | grep micro-maestros || true
        EOF

    - name: Health check - micro-soap-bridge
      if: ${{ github.event.inputs.skip_verification != 'true' }}
      continue-on-error: true
      run: |
        echo "üîç Checking micro-soap-bridge container..."
        ssh -o StrictHostKeyChecking=no ${{ env.INSTANCE_USER }}@${{ env.INSTANCE_PUBLIC_IP }} << 'EOF' || true
        cd ~/projeto-acompanamiento
        if docker compose version &>/dev/null 2>&1; then DC="docker compose"; elif command -v docker-compose &>/dev/null 2>&1; then DC="docker-compose"; else exit 0; fi
        $DC ps | grep micro-soap-bridge || true
        EOF

    - name: Health check - micro-analytics
      if: ${{ github.event.inputs.skip_verification != 'true' }}
      continue-on-error: true
      run: |
        echo "üîç Checking micro-analytics container..."
        ssh -o StrictHostKeyChecking=no ${{ env.INSTANCE_USER }}@${{ env.INSTANCE_PUBLIC_IP }} << 'EOF' || true
        cd ~/projeto-acompanamiento
        if docker compose version &>/dev/null 2>&1; then DC="docker compose"; elif command -v docker-compose &>/dev/null 2>&1; then DC="docker-compose"; else exit 0; fi
        $DC ps | grep micro-analytics || true
        EOF

    - name: Verify all services and generate report
      if: always()
      run: |
        echo "üìä Final service status on ${{ env.INSTANCE_NAME }}:"
        ssh -o StrictHostKeyChecking=no ${{ env.INSTANCE_USER }}@${{ env.INSTANCE_PUBLIC_IP }} << 'EOF' || true
        cd ~/projeto-acompanamiento

        if docker compose version &>/dev/null 2>&1; then
          DC="docker compose"
        elif command -v docker-compose &>/dev/null 2>&1; then
          DC="docker-compose"
        else
          DC="docker compose"
        fi

        echo "=== Docker Containers Status ==="
        $DC ps

        echo -e "\n=== Core Services (expected running) ==="
        echo "- micro-auth"
        echo "- micro-estudiantes"
        echo "- micro-maestros"
        echo "- micro-soap-bridge"
        echo "- micro-analytics"

        echo -e "\n‚úÖ EC2-CORE deployment completed"
        EOF
