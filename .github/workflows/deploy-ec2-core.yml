name: Deploy EC2 CORE Services

on:
  workflow_dispatch:

env:
  EC2_CORE_PUBLIC_IP: 13.216.12.61
  EC2_CORE_PRIVATE_IP: 172.31.78.183
  EC2_DB_PRIVATE_IP: 172.31.79.193

jobs:
  deploy-core:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_EC2_DB_SSH_PRIVATE_KEY }}" > ~/.ssh/key.pem
          chmod 600 ~/.ssh/key.pem
          ssh-keyscan -H ${{ env.EC2_CORE_PUBLIC_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Detect user
        run: |
          if ssh -i ~/.ssh/key.pem -o ConnectTimeout=10 -o StrictHostKeyChecking=no -o BatchMode=yes ubuntu@${{ env.EC2_CORE_PUBLIC_IP }} "echo ok" 2>/dev/null; then
            echo "SSH_USER=ubuntu" >> $GITHUB_ENV
            echo "‚úÖ Ubuntu user detected"
          else
            echo "SSH_USER=ec2-user" >> $GITHUB_ENV
            echo "‚ÑπÔ∏è  Using ec2-user (Amazon Linux)"
          fi

      - name: Prepare instance
        run: |
          ssh -i ~/.ssh/key.pem -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.EC2_CORE_PUBLIC_IP }} << 'PREP'
          set -e
          echo "üì¶ Installing dependencies..."
          
          # Detect OS
          if [ -f /etc/os-release ]; then
            . /etc/os-release
            OS_ID=$ID
          else
            OS_ID="unknown"
          fi
          
          # Install Docker
          if [ "$OS_ID" = "amzn" ] || [ "$OS_ID" = "amazon" ]; then
            sudo yum update -y >/dev/null 2>&1
            sudo yum install -y docker >/dev/null 2>&1
          else
            sudo apt-get update -qq >/dev/null 2>&1
            sudo apt-get install -y docker.io >/dev/null 2>&1
          fi
          
          # Start Docker
          sudo systemctl start docker || true
          sudo systemctl enable docker >/dev/null 2>&1 || true
          
          # Add user to docker group  
          sudo usermod -aG docker $(whoami) >/dev/null 2>&1 || true
          
          # Install Docker Compose
          sudo curl -sL "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose 2>/dev/null || true
          sudo chmod +x /usr/local/bin/docker-compose 2>/dev/null || true
          
          echo "‚úÖ Dependencies installed"
          PREP

      - name: Deploy microservices
        run: |
          ssh -i ~/.ssh/key.pem -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.EC2_CORE_PUBLIC_IP }} << 'DEPLOY'
          set -e
          
          mkdir -p /opt/microservices
          cd /opt/microservices
          
          echo "üßπ Cleaning old deployments..."
          docker rm -f micro-auth micro-estudiantes micro-maestros 2>/dev/null || true
          docker rmi micro-auth micro-estudiantes micro-maestros 2>/dev/null || true
          
          echo "üì• Cloning repository..."
          if [ -d "proyecto" ]; then
            cd proyecto
            git pull origin main
            cd ..
          else
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git proyecto
          fi
          
          echo "üèóÔ∏è Building Docker images..."
          cd proyecto
          docker build -f micro-auth/Dockerfile -t micro-auth:latest . --quiet
          docker build -f micro-estudiantes/Dockerfile -t micro-estudiantes:latest . --quiet
          docker build -f micro-maestros/Dockerfile -t micro-maestros:latest . --quiet
          
          cd /opt/microservices
          
          echo "üìù Creating docker-compose.yml..."
          cat > docker-compose.yml << 'COMPOSE'
version: '3.8'

services:
  micro-auth:
    image: micro-auth:latest
    container_name: micro-auth
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      MONGO_URL: mongodb://admin:mongodb123@172.31.79.193:27017/acompanamiento?authSource=admin
      POSTGRES_URL: postgresql://postgres:postgres123@172.31.79.193:5432/acompanamiento
      REDIS_URL: redis://:redis123@172.31.79.193:6379
    restart: unless-stopped
    networks:
      - core
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  micro-estudiantes:
    image: micro-estudiantes:latest
    container_name: micro-estudiantes
    ports:
      - "3001:3001"
    environment:
      NODE_ENV: production
      PORT: 3001
      MONGO_URL: mongodb://admin:mongodb123@172.31.79.193:27017/acompanamiento?authSource=admin
      POSTGRES_URL: postgresql://postgres:postgres123@172.31.79.193:5432/acompanamiento
      REDIS_URL: redis://:redis123@172.31.79.193:6379
      AUTH_SERVICE: http://172.31.78.183:3000
    restart: unless-stopped
    networks:
      - core
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3001/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  micro-maestros:
    image: micro-maestros:latest
    container_name: micro-maestros
    ports:
      - "3002:3002"
    environment:
      NODE_ENV: production
      PORT: 3002
      MONGO_URL: mongodb://admin:mongodb123@172.31.79.193:27017/acompanamiento?authSource=admin
      POSTGRES_URL: postgresql://postgres:postgres123@172.31.79.193:5432/acompanamiento
      REDIS_URL: redis://:redis123@172.31.79.193:6379
      AUTH_SERVICE: http://172.31.78.183:3000
    restart: unless-stopped
    networks:
      - core
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3002/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  core:
    driver: bridge
COMPOSE

          echo "üöÄ Starting services..."
          docker-compose up -d
          
          echo "‚è≥ Waiting 45 seconds for services to initialize..."
          sleep 45
          
          echo ""
          echo "üìä Service Status:"
          docker ps -a
          DEPLOY
          
      - name: Validate deployment
        run: |
          ssh -i ~/.ssh/key.pem -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.EC2_CORE_PUBLIC_IP }} << 'VALIDATE'
          echo ""
          echo "‚úÖ DEPLOYMENT SUMMARY"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          echo "üåê Instance Information:"
          echo "  IP: 13.216.12.61 (Public) / 172.31.78.183 (Private)"
          echo ""
          echo "üöÄ Microservices:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "üîó Service URLs (VPC):"
          echo "  ‚Ä¢ Auth: http://172.31.78.183:3000"
          echo "  ‚Ä¢ Estudiantes: http://172.31.78.183:3001"
          echo "  ‚Ä¢ Maestros: http://172.31.78.183:3002"
          echo ""
          echo "üíæ Database (EC2-DB):"
          echo "  ‚Ä¢ MongoDB: 172.31.79.193:27017"
          echo "  ‚Ä¢ PostgreSQL: 172.31.79.193:5432"
          echo "  ‚Ä¢ Redis: 172.31.79.193:6379"
          echo ""
          VALIDATE
