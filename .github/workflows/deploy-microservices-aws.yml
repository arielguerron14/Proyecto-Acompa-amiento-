name: Deploy Microservices to AWS EC2-CORE

on:
  workflow_dispatch:
    inputs:
      ec2_core_private_ip:
        description: 'IP privada de instancia EC2-CORE (ej: 172.31.79.194)'
        required: true
        type: string
      ec2_db_private_ip:
        description: 'IP privada de instancia EC2-DB (ej: 172.31.79.193)'
        required: true
        type: string
      environment:
        description: 'Ambiente (dev, staging, prod)'
        required: true
        type: choice
        default: 'dev'
        options:
          - dev
          - staging
          - prod

env:
  EC2_CORE_SSH_KEY: ${{ secrets.AWS_EC2_DB_SSH_PRIVATE_KEY }}
  POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD_AWS }}
  POSTGRES_USER: postgres
  POSTGRES_DB: acompanamiento

jobs:
  deploy-microservices:
    name: Deploy Microservices to EC2-CORE
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set EC2 variables
        run: |
          echo "EC2_CORE_IP=${{ github.event.inputs.ec2_core_private_ip }}" >> $GITHUB_ENV
          echo "EC2_DB_IP=${{ github.event.inputs.ec2_db_private_ip }}" >> $GITHUB_ENV
          echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/aws-ec2-core.pem << 'EOF'
          ${{ env.EC2_CORE_SSH_KEY }}
          EOF
          chmod 600 ~/.ssh/aws-ec2-core.pem

      - name: Test SSH connection
        run: |
          echo "Testing SSH connection to EC2-CORE..."
          if ssh -i ~/.ssh/aws-ec2-core.pem -o ConnectTimeout=10 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@${{ env.EC2_CORE_IP }} "echo 'SSH OK' && uname -a" 2>&1; then
            echo "EC2_SSH_USER=ubuntu" >> $GITHUB_ENV
          elif ssh -i ~/.ssh/aws-ec2-core.pem -o ConnectTimeout=10 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ec2-user@${{ env.EC2_CORE_IP }} "echo 'SSH OK' && uname -a" 2>&1; then
            echo "EC2_SSH_USER=ec2-user" >> $GITHUB_ENV
          else
            echo "SSH connection failed"
            exit 1
          fi

      - name: Clone and build Docker images
        run: |
          ssh -i ~/.ssh/aws-ec2-core.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ env.EC2_SSH_USER }}@${{ env.EC2_CORE_IP }} << 'EOF'
            cd ~ && rm -rf Proyecto-Acompa-amiento- 
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
            docker build -t acompanamiento/micro-auth:latest ./micro-auth
            docker build -t acompanamiento/micro-maestros:latest ./micro-maestros
            docker build -t acompanamiento/micro-estudiantes:latest ./micro-estudiantes
            docker build -t acompanamiento/api-gateway:latest ./api-gateway
            docker images | grep acompanamiento
          EOF

      - name: Create and deploy docker-compose
        run: |
          ssh -i ~/.ssh/aws-ec2-core.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ env.EC2_SSH_USER }}@${{ env.EC2_CORE_IP }} << 'EOF'
            mkdir -p ~/acompanamiento/microservices
            cd ~/acompanamiento/microservices
            cat > docker-compose.yml << 'DOCKER_EOF'
version: '3.8'
services:
  micro-auth:
    image: acompanamiento/micro-auth:latest
    container_name: acompanamiento-auth
    ports:
      - "5005:5005"
    environment:
      NODE_ENV: production
      PORT: 5005
      POSTGRES_HOST: DB_IP_PLACEHOLDER
      POSTGRES_PORT: 5432
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: DB_PASS_PLACEHOLDER
      POSTGRES_DB: acompanamiento
      MONGODB_URI: mongodb://DB_IP_PLACEHOLDER:27017/acompanamiento
      REDIS_URL: redis://DB_IP_PLACEHOLDER:6379
    networks:
      - acompanamiento-network
    restart: unless-stopped

  micro-maestros:
    image: acompanamiento/micro-maestros:latest
    container_name: acompanamiento-maestros
    ports:
      - "5001:5001"
    environment:
      NODE_ENV: production
      PORT: 5001
      POSTGRES_HOST: DB_IP_PLACEHOLDER
      POSTGRES_PORT: 5432
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: DB_PASS_PLACEHOLDER
      POSTGRES_DB: acompanamiento
      MONGODB_URI: mongodb://DB_IP_PLACEHOLDER:27017/acompanamiento
      REDIS_URL: redis://DB_IP_PLACEHOLDER:6379
    networks:
      - acompanamiento-network
    restart: unless-stopped

  micro-estudiantes:
    image: acompanamiento/micro-estudiantes:latest
    container_name: acompanamiento-estudiantes
    ports:
      - "5002:5002"
    environment:
      NODE_ENV: production
      PORT: 5002
      POSTGRES_HOST: DB_IP_PLACEHOLDER
      POSTGRES_PORT: 5432
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: DB_PASS_PLACEHOLDER
      POSTGRES_DB: acompanamiento
      MONGODB_URI: mongodb://DB_IP_PLACEHOLDER:27017/acompanamiento
      REDIS_URL: redis://DB_IP_PLACEHOLDER:6379
    networks:
      - acompanamiento-network
    restart: unless-stopped

  api-gateway:
    image: acompanamiento/api-gateway:latest
    container_name: acompanamiento-gateway
    ports:
      - "8080:8080"
    environment:
      NODE_ENV: production
      PORT: 8080
      AUTH_SERVICE_URL: http://micro-auth:5005
      MAESTROS_SERVICE_URL: http://micro-maestros:5001
      ESTUDIANTES_SERVICE_URL: http://micro-estudiantes:5002
    networks:
      - acompanamiento-network
    restart: unless-stopped

networks:
  acompanamiento-network:
    driver: bridge
DOCKER_EOF
            sed -i "s/DB_IP_PLACEHOLDER/${{ env.EC2_DB_IP }}/g" docker-compose.yml
            sed -i "s/DB_PASS_PLACEHOLDER/${{ env.POSTGRES_PASSWORD }}/g" docker-compose.yml
            docker-compose down 2>/dev/null || true
            docker-compose up -d
            sleep 15
            docker-compose ps
            docker-compose logs --tail=50
          EOF

      - name: Test services
        run: |
          echo "Testing services..."
          sleep 5
          curl -f http://${{ env.EC2_CORE_IP }}:8080/health 2>/dev/null && echo "✓ Gateway OK" || echo "⚠ Gateway checking..."
          curl -f http://${{ env.EC2_CORE_IP }}:5005/health 2>/dev/null && echo "✓ Auth OK" || echo "⚠ Auth checking..."
          curl -f http://${{ env.EC2_CORE_IP }}:5001/health 2>/dev/null && echo "✓ Maestros OK" || echo "⚠ Maestros checking..."
          curl -f http://${{ env.EC2_CORE_IP }}:5002/health 2>/dev/null && echo "✓ Estudiantes OK" || echo "⚠ Estudiantes checking..."

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/aws-ec2-core.pem
