name: Deploy Frontend to AWS EC2-Frontend

on:
  workflow_dispatch:

env:
  EC2_FRONTEND_SSH_KEY: ${{ secrets.AWS_EC2_DB_SSH_PRIVATE_KEY }}
  EC2_FRONTEND_IP: 172.31.69.203
  EC2_API_GATEWAY_PRIVATE_IP: 172.31.76.105

jobs:
  deploy:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/aws-ec2-frontend.pem << 'EOF'
          ${{ env.EC2_FRONTEND_SSH_KEY }}
          EOF
          chmod 600 ~/.ssh/aws-ec2-frontend.pem
          cat > ~/.ssh/config << 'SSHCONFIG'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
            LogLevel=QUIET
          SSHCONFIG

      - name: Test SSH connection
        run: |
          echo "=== Testing SSH connection ==="
          echo "Target IP: ${{ env.EC2_FRONTEND_IP }}"
          echo "Key file size: $(wc -c < ~/.ssh/aws-ec2-frontend.pem) bytes"
          echo ""
          
          # Test SSH with retries
          max_retries=5
          retry_delay=10
          
          for ((i=1; i<=max_retries; i++)); do
            echo "Attempt $i/$max_retries: Testing SSH connection..."
            
            if ssh -i ~/.ssh/aws-ec2-frontend.pem \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              ubuntu@${{ env.EC2_FRONTEND_IP }} \
              "echo 'SSH OK' && docker --version" 2>&1; then
              echo "✓ SSH connection successful"
              exit 0
            fi
            
            if [ $i -lt $max_retries ]; then
              echo "⚠ Attempt $i failed, waiting ${retry_delay}s before retry..."
              sleep $retry_delay
            fi
          done
          
          echo "✗ SSH connection failed after $max_retries attempts"
          echo ""
          echo "=== Diagnostic Info ==="
          echo "SSH key permissions:"
          ls -la ~/.ssh/aws-ec2-frontend.pem
          echo ""
          echo "SSH config:"
          cat ~/.ssh/config
          exit 1


      - name: Deploy Frontend via SSH
        run: |
          ssh -i ~/.ssh/aws-ec2-frontend.pem \
            -o ConnectTimeout=10 \
            ubuntu@${{ env.EC2_FRONTEND_IP }} << 'DEPLOY'
          
          set -e
          
          echo "=== Deteniendo contenedor existente ==="
          docker stop acompanamiento-frontend 2>/dev/null || true
          docker rm acompanamiento-frontend 2>/dev/null || true
          
          echo "=== Clonando repositorio ==="
          cd /tmp
          rm -rf Proyecto-Acompa-amiento-
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
          
          echo "=== Construyendo imagen Docker ==="
          docker build -t frontend-web:latest -f frontend-web/Dockerfile ./frontend-web
          
          echo "=== Desplegando Frontend ==="
          docker run -d \
            --name acompanamiento-frontend \
            --restart unless-stopped \
            -p 80:80 \
            -p 3000:3000 \
            -e API_GATEWAY_URL=http://172.31.76.105:8080 \
            frontend-web:latest
          
          echo "=== Estado de contenedor ==="
          docker ps
          
          echo "=== Logs de Frontend ==="
          docker logs --tail=30 acompanamiento-frontend || true
          
          echo "=== Verificando conectividad al API Gateway ==="
          timeout 5 bash -c 'cat < /dev/null > /dev/tcp/172.31.76.105/8080' 2>/dev/null && echo "✓ API Gateway accesible" || echo "⚠ API Gateway no accesible"
          
          echo "=== Despliegue completado ==="
          
          DEPLOY

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/aws-ec2-frontend.pem
