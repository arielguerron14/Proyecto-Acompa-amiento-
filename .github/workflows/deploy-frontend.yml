name: Deploy Frontend to AWS EC2-Frontend

on:
  workflow_dispatch:
    inputs:
      ec2_api_gateway_public_ip:
        description: 'IP pública de instancia EC2-API-Gateway (ej: 98.84.30.35)'
        required: true
        type: string

env:
  EC2_FRONTEND_SSH_KEY: ${{ secrets.AWS_EC2_DB_SSH_PRIVATE_KEY }}
  EC2_FRONTEND_SSH_USER: ubuntu
  EC2_FRONTEND_IP: 172.31.69.203
  EC2_API_GATEWAY_PRIVATE_IP: 172.31.76.105

jobs:
  deploy:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set EC2 variables
        run: |
          echo "EC2_API_GATEWAY_PUBLIC_IP=${{ github.event.inputs.ec2_api_gateway_public_ip }}" >> $GITHUB_ENV

      - name: Setup SSH key and config
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          cat > ~/.ssh/config << 'SSHCONFIG'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
            LogLevel=QUIET
          SSHCONFIG
          chmod 600 ~/.ssh/config

      - name: Deploy Frontend via SSH
        run: |
          # Create SSH key
          mkdir -p ~/.ssh
          cat > ~/.ssh/aws-ec2-frontend.pem << 'EOF'
          ${{ env.EC2_FRONTEND_SSH_KEY }}
          EOF
          chmod 600 ~/.ssh/aws-ec2-frontend.pem
          
          # Test connection first
          echo "Testing SSH connection..."
          ssh -i ~/.ssh/aws-ec2-frontend.pem \
            -o ConnectTimeout=10 \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o IdentitiesOnly=yes \
            ubuntu@172.31.69.203 "echo 'SSH connection OK' && uname -a"
          
          # Create deployment script on remote
          ssh -i ~/.ssh/aws-ec2-frontend.pem \
            -o ConnectTimeout=10 \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o IdentitiesOnly=yes \
            ubuntu@172.31.69.203 << 'REMOTESCRIPT'
          
          cat > ~/deploy-frontend.sh << 'DEPLOYEOF'
          #!/bin/bash
          set -e
          
          API_GW_PUBLIC_IP="$1"
          API_GW_PRIVATE_IP="$2"
          
          echo "=== Verificando Docker ==="
          if ! command -v docker &> /dev/null; then
            echo "Docker no encontrado, instalando..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh
            sudo usermod -aG docker ubuntu
            echo "Docker instalado correctamente"
          else
            echo "Docker ya está instalado"
            docker --version
          fi
          
          echo "=== Deteniendo contenedor existente ==="
          docker stop acompanamiento-frontend 2>/dev/null || true
          
          echo "=== Removiendo contenedor existente ==="
          docker rm acompanamiento-frontend 2>/dev/null || true
          
          echo "=== Clonando repositorio ==="
          cd /tmp
          rm -rf Proyecto-Acompa-amiento-
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
          
          echo "=== Construyendo imagen Docker ==="
          docker build -t frontend-web:latest -f frontend-web/Dockerfile ./frontend-web
          
          echo "=== Desplegando Frontend ==="
          docker run -d \
            --name acompanamiento-frontend \
            --restart unless-stopped \
            -p 80:80 \
            -p 3000:3000 \
            -e API_GATEWAY_URL=http://${API_GW_PUBLIC_IP}:8080 \
            frontend-web:latest
          
          echo "=== Estado de contenedor ==="
          docker ps
          
          echo "=== Logs de Frontend ==="
          docker logs --tail=30 acompanamiento-frontend
          
          echo "=== Verificando conectividad al API Gateway ==="
          echo "Intentando conexión a API Gateway (IP privada: ${API_GW_PRIVATE_IP}:8080)..."
          timeout 5 bash -c "cat < /dev/null > /dev/tcp/${API_GW_PRIVATE_IP}/8080" 2>/dev/null && echo "✓ API Gateway accesible" || echo "⚠ API Gateway no accesible"
          
          echo "=== Despliegue de Frontend completado ==="
          DEPLOYEOF
          
          chmod +x ~/deploy-frontend.sh
          ~/deploy-frontend.sh "$1" "$2"
          REMOTESCRIPT
          
          # Execute with arguments
          ssh -i ~/.ssh/aws-ec2-frontend.pem \
            -o ConnectTimeout=10 \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o IdentitiesOnly=yes \
            ubuntu@172.31.69.203 "bash ~/deploy-frontend.sh ${{ env.EC2_API_GATEWAY_PUBLIC_IP }} ${{ env.EC2_API_GATEWAY_PRIVATE_IP }}"

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/aws-ec2-frontend.pem
