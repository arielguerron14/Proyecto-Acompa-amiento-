name: Deploy Frontend to AWS EC2-Frontend

on:
  workflow_dispatch:

env:
  EC2_FRONTEND_SSH_KEY: ${{ secrets.AWS_EC2_DB_SSH_PRIVATE_KEY }}
  EC2_FRONTEND_IP: 172.31.69.203
  EC2_API_GATEWAY_PRIVATE_IP: 172.31.76.105

jobs:
  deploy:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy Frontend via SSH
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Write SSH key
          cat > ~/.ssh/key.pem << 'EOF'
          ${{ env.EC2_FRONTEND_SSH_KEY }}
          EOF
          chmod 600 ~/.ssh/key.pem
          
          # SSH config
          cat > ~/.ssh/config << 'EOF'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
            LogLevel=QUIET
          EOF
          
          # Test connection
          echo "=== Testing SSH connection ==="
          ssh -i ~/.ssh/key.pem -o ConnectTimeout=10 ubuntu@${{ env.EC2_FRONTEND_IP }} "echo 'SSH OK' && docker --version || echo 'Docker not installed yet'"
          
          # Deploy
          echo "=== Starting deployment ==="
          ssh -i ~/.ssh/key.pem -o ConnectTimeout=10 ubuntu@${{ env.EC2_FRONTEND_IP }} << 'DEPLOY'
          
          set -e
          
          echo "=== Deteniendo contenedor existente ==="
          docker stop acompanamiento-frontend 2>/dev/null || true
          docker rm acompanamiento-frontend 2>/dev/null || true
          
          echo "=== Clonando repositorio ==="
          cd /tmp
          rm -rf Proyecto-Acompa-amiento-
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
          
          echo "=== Construyendo imagen Docker ==="
          docker build -t frontend-web:latest -f frontend-web/Dockerfile ./frontend-web
          
          echo "=== Desplegando Frontend ==="
          docker run -d \
            --name acompanamiento-frontend \
            --restart unless-stopped \
            -p 80:80 \
            -p 3000:3000 \
            -e API_GATEWAY_URL=http://172.31.76.105:8080 \
            frontend-web:latest
          
          echo "=== Estado de contenedor ==="
          docker ps
          
          echo "=== Logs de Frontend ==="
          docker logs --tail=30 acompanamiento-frontend || true
          
          echo "=== Verificando conectividad al API Gateway ==="
          timeout 5 bash -c 'cat < /dev/null > /dev/tcp/172.31.76.105/8080' 2>/dev/null && echo "✓ API Gateway accesible" || echo "⚠ API Gateway no accesible"
          
          echo "=== Despliegue completado ==="
          
          DEPLOY

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/key.pem
