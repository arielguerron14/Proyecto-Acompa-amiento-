name: Test SSH Key Injection

on:
  workflow_dispatch:

env:
  SSH_KEY: ${{ secrets.AWS_EC2_DB_SSH_PRIVATE_KEY }}

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Test 1 - Check if secret is empty
        run: |
          if [ -z "${{ env.SSH_KEY }}" ]; then
            echo "❌ ERROR: SSH_KEY secret is EMPTY!"
            exit 1
          else
            echo "✓ SSH_KEY secret is not empty"
            echo "✓ SSH_KEY length: $(echo -n '${{ env.SSH_KEY }}' | wc -c) characters"
          fi

      - name: Test 2 - Check key format
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/key.pem << 'EOF'
          ${{ env.SSH_KEY }}
          EOF
          chmod 600 ~/.ssh/key.pem
          
          echo "Key file size: $(wc -c < ~/.ssh/key.pem) bytes"
          echo "Key file first line:"
          head -1 ~/.ssh/key.pem
          echo "Key file last line:"
          tail -1 ~/.ssh/key.pem
          echo ""
          echo "Checking if it's a valid RSA key..."
          if grep -q "BEGIN RSA PRIVATE KEY\|BEGIN PRIVATE KEY" ~/.ssh/key.pem; then
            echo "✓ Key format looks valid"
          else
            echo "❌ Key format is INVALID"
            exit 1
          fi

      - name: Test 3 - SSH to EC2-DB
        continue-on-error: true
        run: |
          ssh -i ~/.ssh/key.pem \
            -o ConnectTimeout=5 \
            -o BatchMode=yes \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -vvv \
            ubuntu@172.31.79.193 \
            "echo 'Success!' && uname -a" 2>&1 | tee ssh.log
          
          echo ""
          echo "=== SSH Output Analysis ==="
          if grep -q "Authentication succeeded" ssh.log; then
            echo "✓ SSH authentication succeeded"
          elif grep -q "Permission denied\|Authentications that can continue" ssh.log; then
            echo "❌ SSH authentication failed (permission denied)"
          elif grep -q "Could not resolve hostname\|Name or service not known" ssh.log; then
            echo "❌ Cannot resolve hostname"
          elif grep -q "Connection refused\|Connection timed out" ssh.log; then
            echo "❌ Connection refused or timed out"
          fi

      - name: Test 4 - Show SSH logs
        if: always()
        run: |
          echo "=== Complete SSH Log ==="
          cat ssh.log 2>/dev/null || echo "No ssh.log found"
