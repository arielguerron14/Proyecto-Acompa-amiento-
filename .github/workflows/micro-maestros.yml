name: Build, Push, and Deploy Micro Maestros

on:
  push:
    branches: [ "main" ]
    paths:
      - "micro-maestros/**"
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.set-image.outputs.image-tag }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker Image
        id: set-image
        run: |
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          IMAGE_TAG="${SHORT_SHA}"
          echo "Image tag will be: $IMAGE_TAG"
          echo "image-tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"
          docker build -f micro-maestros/Dockerfile -t ${{ secrets.DOCKERHUB_USERNAME }}/micro-maestros:$IMAGE_TAG .

          echo "Verifying built image contains shared-auth files"
          if docker run --rm --entrypoint ls ${{ secrets.DOCKERHUB_USERNAME }}/micro-maestros:$IMAGE_TAG /usr/src/shared-auth/src/middlewares; then
            echo "shared-auth present in built image"
          else
            echo "ERROR: shared-auth NOT found in built image; failing the job to avoid pushing a broken image"
            docker run --rm --entrypoint ls ${{ secrets.DOCKERHUB_USERNAME }}/micro-maestros:$IMAGE_TAG /usr/src || true
            exit 1
          fi

          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/micro-maestros:$IMAGE_TAG ${{ secrets.DOCKERHUB_USERNAME }}/micro-maestros:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/micro-maestros:$IMAGE_TAG
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/micro-maestros:latest

  deploy-aws:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Set permissions for private key
        run: |
          echo "${{ secrets.EC2_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Deploy to EC2
        run: |
          if [ -z "${{ secrets.EC2_CORE_HOST }}" ]; then
            echo "ERROR: secret EC2_CORE_HOST is not set. Set the correct host secret in repository settings.";
            exit 1;
          fi

          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_CORE_HOST }} << 'EOF'
          sudo apt update -y
          if ! command -v docker &> /dev/null
          then
            sudo apt install -y docker.io
            sudo systemctl start docker
            sudo systemctl enable docker
          fi

          echo "Logging in to Docker Hub (for private image pulls)"
          sudo docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }} || echo "docker login failed (proceeding, pull may fail)"

          sudo docker stop micro-maestros-container || true
          sudo docker rm micro-maestros-container || true
          IMAGE_TAG=${{ needs.build-and-push.outputs.image-tag }}
          if [ -z "$IMAGE_TAG" ]; then IMAGE_TAG=latest; fi
          IMAGE_REF=${{ secrets.DOCKERHUB_USERNAME }}/micro-maestros:$IMAGE_TAG
          echo "Attempting to pull image $IMAGE_REF"
          if sudo docker pull $IMAGE_REF; then
            echo "Pulled micro-maestros image successfully: $IMAGE_REF"
            echo "Verifying shared-auth exists inside image..."
            sudo docker run --rm --entrypoint ls $IMAGE_REF /usr/src/shared-auth/src/middlewares || echo "shared-auth not present in image"
            RUN_IMAGE="$IMAGE_REF"
          else
            echo "Pull failed; attempting to build image locally on the EC2 host"
            if [ ! -d "$HOME/Proyecto-Acompa-amiento-" ]; then
              git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git "$HOME/Proyecto-Acompa-amiento-"
            else
              git -C "$HOME/Proyecto-Acompa-amiento-" pull || true
            fi
            sudo docker build -f "$HOME/Proyecto-Acompa-amiento-/micro-maestros/Dockerfile" -t ${{ secrets.DOCKERHUB_USERNAME }}/micro-maestros:latest "$HOME/Proyecto-Acompa-amiento-" || true
            RUN_IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/micro-maestros:latest"
          fi

          echo "Running container from image: $RUN_IMAGE"
          sudo docker run -d --restart unless-stopped -p 3003:3003 --name micro-maestros-container "$RUN_IMAGE" || true
          sleep 2
          echo "Container status:"; sudo docker ps -a --filter "name=micro-maestros-container" || true
          echo "Recent logs (micro-maestros):"; sudo docker logs --tail 200 micro-maestros-container || true
          sudo docker image prune -f
          EOF

