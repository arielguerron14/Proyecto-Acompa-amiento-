name: Deploy Project

on:
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Services & Update Config
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: us-east-1

    - name: Discover instances and update configuration
      run: |
        set -e
        echo "ğŸ” Discovering EC2 instances..."
        
        # Query instances with detailed output for debugging
        INSTANCES=$(aws ec2 describe-instances \
          --filters "Name=tag:Project,Values=lab-8-ec2" "Name=instance-state-name,Values=running" \
          --query 'Reservations[*].Instances[*].{
            name: Tags[?Key==`Name`]|[0].Value,
            instance_id: InstanceId,
            private_ip: PrivateIpAddress,
            public_ip: PublicIpAddress
          }' \
          --output json)
        
        echo "Raw instances data:"
        echo "$INSTANCES"
        
        # Query Elastic IPs
        ELASTIC_IPS=$(aws ec2 describe-addresses \
          --query 'Addresses[*].[InstanceId,PublicIp]' \
          --output json)
        
        echo "Elastic IPs data:"
        echo "$ELASTIC_IPS"
        
        # Process data - flatten array and process
        ENRICHED=$(echo "$INSTANCES" | jq -c '
          [.[][] // empty] |
          map(select(.name != null)) |
          map({(.name): .}) | add
        ')
        
        echo "âœ… Discovered instances:"
        echo "$ENRICHED" | jq '.' | tee discovered.json
        
        # Generate infrastructure-instances.config.js
        cat > infrastructure-instances.config.js << 'EOF'
        /**
         * AUTO-GENERATED: Instance Configuration with Dynamic IPs
         * Generated: $(date -u)
         */
        module.exports = INSTANCES_PLACEHOLDER;
        EOF
        
        ESCAPED=$(echo "$ENRICHED" | jq -c '.' | sed 's/"/\\"/g')
        sed -i "s|INSTANCES_PLACEHOLDER|$ESCAPED|g" infrastructure-instances.config.js
        
        # Generate .env file from ENRICHED data
        echo "âœ… Generating .env file..."
        
        # Extract IPs safely
        FE_PUB=$(echo "$ENRICHED" | jq -r '.["EC2-Frontend"].public_ip // "unknown"' 2>/dev/null || echo "unknown")
        API_PUB=$(echo "$ENRICHED" | jq -r '.["EC2-API-Gateway"].public_ip // "unknown"' 2>/dev/null || echo "unknown")
        CORE_PUB=$(echo "$ENRICHED" | jq -r '.["EC2-CORE"].public_ip // "unknown"' 2>/dev/null || echo "unknown")
        DB_PUB=$(echo "$ENRICHED" | jq -r '.["EC2-DB"].public_ip // "unknown"' 2>/dev/null || echo "unknown")
        MSG_PUB=$(echo "$ENRICHED" | jq -r '.["EC2-Messaging"].public_ip // "unknown"' 2>/dev/null || echo "unknown")
        NOT_PUB=$(echo "$ENRICHED" | jq -r '.["EC2-Notificaciones"].public_ip // "unknown"' 2>/dev/null || echo "unknown")
        REP_PUB=$(echo "$ENRICHED" | jq -r '.["EC2-Reportes"].public_ip // "unknown"' 2>/dev/null || echo "unknown")
        MON_PUB=$(echo "$ENRICHED" | jq -r '.["EC2-Monitoring"].public_ip // "unknown"' 2>/dev/null || echo "unknown")
        BAS_PUB=$(echo "$ENRICHED" | jq -r '.["EC-Bastion"].public_ip // "unknown"' 2>/dev/null || echo "unknown")
        
        cat > .env.generated << ENVEOF
        # Auto-generated environment variables
        # Timestamp: $(date -u)
        FRONTEND_IP=$FE_PUB
        API_GATEWAY_IP=$API_PUB
        CORE_IP=$CORE_PUB
        DB_IP=$DB_PUB
        MESSAGING_IP=$MSG_PUB
        NOTIFICACIONES_IP=$NOT_PUB
        REPORTES_IP=$REP_PUB
        MONITORING_IP=$MON_PUB
        BASTION_IP=$BAS_PUB
        DATABASE_URL=postgresql://postgres:postgres@$DB_PUB:5432/acompanamiento
        RABBITMQ_HOST=$MSG_PUB
        API_GATEWAY_HOST=$API_PUB
        CORE_SERVICE_HOST=$CORE_PUB
        BASTION_HOST=$BAS_PUB
        BASTION_USER=ubuntu
        ENVEOF
        
        echo "âœ… Configuration files generated"

    - name: Commit configuration
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        git add infrastructure-instances.config.js .env.generated
        
        if git diff --cached --quiet; then
          echo "âš ï¸  No changes"
        else
          git commit -m "chore: Update instance configuration with discovered IPs"
          git push
          echo "âœ… Configuration pushed"
        fi

    - name: Summary
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  PROJECT DEPLOYMENT COMPLETE                 â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "âœ… Infrastructure: Terraform deployed"
        echo "âœ… Configuration: IPs discovered & updated"
        echo "âœ… Files: infrastructure-instances.config.js, .env.generated"
        echo ""
        echo "Instances deployed:"
        cat discovered.json | jq -r 'to_entries[] | "  \(.key): private=\(.value.private_ip) public=\(.value.public_ip)"'

