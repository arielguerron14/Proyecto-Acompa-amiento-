name: Deploy Project

on:
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Services & Update Config
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: us-east-1

    - name: Discover instances and update configuration
      run: |
        set -e
        echo "ğŸ” Discovering EC2 instances..."
        
        # Query instances
        INSTANCES=$(aws ec2 describe-instances \
          --filters "Name=tag:Project,Values=lab-8-ec2" "Name=instance-state-name,Values=running" \
          --query 'Reservations[*].Instances[*].[
            Tags[?Key==`Name`].Value|[0],
            InstanceId,
            PrivateIpAddress,
            PublicIpAddress
          ]' \
          --output json)
        
        # Query Elastic IPs
        ELASTIC_IPS=$(aws ec2 describe-addresses \
          --query 'Addresses[*].[InstanceId,PublicIp]' \
          --output json)
        
        # Process data
        INSTANCE_MAP=$(echo "$INSTANCES" | jq -c '
          [.[][] | select(.[0] != null)] |
          map({
            name: .[0],
            instance_id: .[1],
            private_ip: .[2],
            public_ip: (.[3] // .[2])
          })
        ')
        
        ENRICHED=$(echo "$INSTANCE_MAP" | jq \
          --argjson eips "$ELASTIC_IPS" '
          map(
            .instance_id as $id |
            .elastic_ip = ($eips[] | select(.[0] == $id) | .[1]) // .public_ip |
            {(.name): .}
          ) | add
        ')
        
        echo "âœ… Discovered instances:"
        echo "$ENRICHED" | jq '.' | tee discovered.json
        
        # Generate infrastructure-instances.config.js
        cat > infrastructure-instances.config.js << 'EOF'
        /**
         * AUTO-GENERATED: Instance Configuration with Dynamic IPs
         * Generated: $(date -u)
         */
        module.exports = INSTANCES_PLACEHOLDER;
        EOF
        
        ESCAPED=$(echo "$ENRICHED" | sed 's/"/\\"/g' | tr '\n' ' ')
        sed -i "s|INSTANCES_PLACEHOLDER|$ESCAPED|g" infrastructure-instances.config.js
        
        # Generate .env file
        echo "âœ… Generating .env file..."
        
        FRONTEND=$(echo "$ENRICHED" | jq -r '.["EC2-Frontend"] | "\(.private_ip),\(.public_ip)"')
        API=$(echo "$ENRICHED" | jq -r '.["EC2-API-Gateway"] | "\(.private_ip),\(.public_ip)"')
        CORE=$(echo "$ENRICHED" | jq -r '.["EC2-CORE"] | "\(.private_ip),\(.public_ip)"')
        DB=$(echo "$ENRICHED" | jq -r '.["EC2-DB"] | "\(.private_ip),\(.public_ip)"')
        MSG=$(echo "$ENRICHED" | jq -r '.["EC2-Messaging"] | "\(.private_ip),\(.public_ip)"')
        BASTION=$(echo "$ENRICHED" | jq -r '.["EC-Bastion"] | "\(.public_ip)"')
        
        IFS=',' read -r FE_PRIV FE_PUB <<< "$FRONTEND"
        IFS=',' read -r API_PRIV API_PUB <<< "$API"
        IFS=',' read -r CORE_PRIV CORE_PUB <<< "$CORE"
        IFS=',' read -r DB_PRIV DB_PUB <<< "$DB"
        IFS=',' read -r MSG_PRIV MSG_PUB <<< "$MSG"
        
        cat > .env.generated << ENVEOF
        # Auto-generated environment variables
        # Timestamp: $(date -u)
        FRONTEND_PRIVATE=$FE_PRIV
        FRONTEND_PUBLIC=$FE_PUB
        API_PRIVATE=$API_PRIV
        API_PUBLIC=$API_PUB
        CORE_PRIVATE=$CORE_PRIV
        CORE_PUBLIC=$CORE_PUB
        DB_PRIVATE=$DB_PRIV
        DB_PUBLIC=$DB_PUB
        MESSAGING_PRIVATE=$MSG_PRIV
        DATABASE_HOST=$DB_PRIV
        DATABASE_URL=postgresql://user:pass@$DB_PRIV:5432/acompanamiento
        RABBITMQ_HOST=$MSG_PRIV
        API_GATEWAY_HOST=$API_PRIV
        CORE_SERVICE_HOST=$CORE_PRIV
        BASTION_HOST=$BASTION
        BASTION_USER=ubuntu
        ENVEOF
        
        echo "âœ… Configuration files generated"

    - name: Commit configuration
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        git add infrastructure-instances.config.js .env.generated
        
        if git diff --cached --quiet; then
          echo "âš ï¸  No changes"
        else
          git commit -m "chore: Update instance configuration with discovered IPs"
          git push
          echo "âœ… Configuration pushed"
        fi

    - name: Summary
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  PROJECT DEPLOYMENT COMPLETE                 â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "âœ… Infrastructure: Terraform deployed"
        echo "âœ… Configuration: IPs discovered & updated"
        echo "âœ… Files: infrastructure-instances.config.js, .env.generated"
        echo ""
        echo "Instances deployed:"
        cat discovered.json | jq -r 'to_entries[] | "  \(.key): private=\(.value.private_ip) public=\(.value.public_ip)"'

