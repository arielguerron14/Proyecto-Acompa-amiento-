name: Deploy Services to EC2 Instances

on:
  workflow_dispatch:
    inputs:
      services:
        description: 'Services to deploy (comma-separated or "all")'
        required: false
        default: 'all'
      environment:
        description: 'Environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Deploy Services
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: us-east-1

    - name: Load instance configuration
      id: config
      run: |
        # Load Node.js config as JSON
        node -e "
        const config = require('./infrastructure-instances.config.js');
        const instances = config.instances || config.module.exports;
        console.log(JSON.stringify(instances, null, 2));
        " > instances-config.json 2>/dev/null || echo "{}" > instances-config.json
        
        echo "âœ… Configuration loaded"
        cat instances-config.json

    - name: Get Bastion IP
      id: bastion
      run: |
        BASTION_IP=$(jq -r '.instances | to_entries[] | select(.value.name == "EC-Bastion") | .value.public_ip' instances-config.json 2>/dev/null || echo "")
        
        if [ -z "$BASTION_IP" ] || [ "$BASTION_IP" == "null" ]; then
          echo "âš ï¸  Bastion IP not found in config, attempting to discover..."
          aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=EC-Bastion" "Name=instance-state-name,Values=running" \
            --region us-east-1 --query 'Reservations[].Instances[].[PublicIpAddress]' --output text > /tmp/bastion_ip.txt
          BASTION_IP=$(cat /tmp/bastion_ip.txt)
        fi
        
        echo "bastion_ip=${BASTION_IP}" >> $GITHUB_OUTPUT
        echo "âœ… Bastion IP: ${BASTION_IP}"

    - name: Setup SSH keys
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # Create SSH key from secret
        echo "${{ secrets.AWS_BASTION_KEY }}" > ~/.ssh/bastion_key.pem
        chmod 600 ~/.ssh/bastion_key.pem
        
        # Add bastion to known_hosts (disable strict checking for demo)
        echo "StrictHostKeyChecking=no" >> ~/.ssh/config
        echo "UserKnownHostsFile=/dev/null" >> ~/.ssh/config
        
        echo "âœ… SSH keys configured"

    - name: Deploy to EC2 instances
      env:
        BASTION_IP: ${{ steps.bastion.outputs.bastion_ip }}
        SERVICES: ${{ github.event.inputs.services }}
      run: |
        #!/bin/bash
        set -e
        
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  DEPLOYING SERVICES TO EC2 INSTANCES   â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        # Check if we have a bastion
        if [ -z "$BASTION_IP" ] || [ "$BASTION_IP" == "null" ]; then
          echo "âŒ Bastion IP not available, cannot proceed with deployment"
          echo "Please ensure Bastion instance is running"
          exit 1
        fi
        
        echo "ğŸ”— Using Bastion: ${BASTION_IP}"
        
        # Test Bastion connectivity
        echo "Testing Bastion connectivity..."
        if timeout 5 bash -c "cat < /dev/null > /dev/tcp/${BASTION_IP}/22" 2>/dev/null; then
          echo "âœ… Bastion is reachable on port 22"
        else
          echo "âš ï¸  Cannot reach Bastion SSH port, but continuing..."
        fi
        
        # Load instance configuration
        INSTANCES=$(jq '.instances // {}' instances-config.json 2>/dev/null || echo "{}")
        
        if [ "$INSTANCES" == "{}" ]; then
          echo "âŒ No instance configuration found"
          exit 1
        fi
        
        # Determine which services to deploy
        if [ "$SERVICES" == "all" ] || [ -z "$SERVICES" ]; then
          echo "ğŸ“¦ Deploying all services..."
          DEPLOY_SERVICES="core,api-gateway,frontend,db,messaging,monitoring"
        else
          DEPLOY_SERVICES="$SERVICES"
        fi
        
        echo ""
        echo "Services to deploy: $DEPLOY_SERVICES"
        echo ""
        
        # Display instance information
        echo "ğŸ“‹ Available instances:"
        jq -r '.instances | to_entries[] | "\(.value.name): \(.value.private_ip) (public: \(.value.public_ip))"' instances-config.json 2>/dev/null || echo "No instances found"
        
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… DEPLOYMENT CONFIGURATION READY"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "Next steps:"
        echo "1. SSH into Bastion: ssh -i ~/.ssh/bastion_key.pem ubuntu@${BASTION_IP}"
        echo "2. From Bastion, SSH to instances using private IPs"
        echo "3. Run: docker-compose up -d for each service"
        echo ""
        echo "Note: Full automated deployment requires additional setup"

    - name: Summary
      if: always()
      run: |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "DEPLOYMENT SUMMARY"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "Status: Configuration and validation complete"
        echo "Next: Manually deploy services via SSH or GitHub Actions Runner"
        echo ""
