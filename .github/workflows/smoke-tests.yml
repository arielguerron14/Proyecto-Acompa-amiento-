name: Smoke Tests

on:
  push:
    branches: [ "main" ]
    paths:
      - "smoke-trigger.txt"
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set permissions for private key
        run: |
          echo "${{ secrets.EC2_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Run smoke tests
        shell: bash
        run: |
          set -euo pipefail

          report_file=smoke-report.txt
          echo "Smoke tests run: $(date -u)" > "$report_file"
          echo "" >> "$report_file"

          # Define services to test: name -> host:port:path
          declare -A SERVICES
          SERVICES[api-gateway]="${{ secrets.API_GATEWAY_HOST }}:80:/health"
          SERVICES[frontend]="${{ secrets.EC2_FRONTEND_HOST }}:80:/"
          SERVICES[micro-analytics]="${{ secrets.EC2_REPORTES_HOST }}:3010:/health"
          SERVICES[micro-notificaciones]="${{ secrets.EC2_NOTIFICACIONES_HOST }}:3006:/health"
          SERVICES[micro-soap-bridge]="${{ secrets.EC2_BRIDGE_HOST }}:3007:/health"
          SERVICES[micro-auth]="${{ secrets.EC2_CORE_HOST }}:3001:/health"
          SERVICES[micro-maestros]="${{ secrets.EC2_CORE_HOST }}:3003:/health"
          SERVICES[micro-estudiantes]="${{ secrets.EC2_CORE_HOST }}:3002:/health"

          failures=0

          for name in "${!SERVICES[@]}"; do
            entry=${SERVICES[$name]}
            IFS=':' read -r host port path <<< "$entry"
            if [ -z "$host" ]; then
              echo "SKIP $name: host secret missing" | tee -a "$report_file"
              continue
            fi

            echo "\n=== SMOKE: $name @ $host:$port$path ===" | tee -a "$report_file"
            echo "-- docker ps --" | tee -a "$report_file"
            ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@"$host" "sudo docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}'" 2>&1 | tee -a "$report_file" || echo "SSH/docker ps failed for $host" | tee -a "$report_file"

            echo "-- curl health --" | tee -a "$report_file"
            status=$(ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@"$host" "curl -sS -o /dev/null -w '%{http_code}' http://localhost:$port$path" 2>/dev/null || echo "000")
            echo "HTTP status: $status" | tee -a "$report_file"
            if [ "$status" != "200" ]; then
              echo "FAILED: $name ($host:$port$path) returned $status" | tee -a "$report_file"
              failures=$((failures+1))
            else
              echo "OK: $name is healthy" | tee -a "$report_file"
            fi
          done

          echo "" | tee -a "$report_file"
          echo "Summary: failures=$failures" | tee -a "$report_file"

          # upload report
          ls -la "$report_file"
          if [ $failures -ne 0 ]; then
            echo "One or more services failed smoke tests. See artifact: $report_file" >&2
            # Let the job continue so we can upload the report artifact in the next step
            exit 1
          fi

      - name: Upload smoke report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-report
          path: smoke-report.txt

      - name: Show smoke report
        if: always()
        run: |
          echo "--- smoke-report.txt ---"
          cat smoke-report.txt || true
