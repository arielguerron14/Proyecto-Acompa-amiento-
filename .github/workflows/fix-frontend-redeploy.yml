name: üîß Fix Frontend - Redeploy

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

jobs:
  fix-frontend:
    name: "üé® Redeploy Frontend with Correct Config"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: üé® Deploy Frontend with Corrected Configuration
        run: |
          python3 << 'EOF'
          import boto3
          import json
          import time
          
          aws_region = "us-east-1"
          ec2 = boto3.client('ec2', region_name=aws_region)
          ssm = boto3.client('ssm', region_name=aws_region)
          
          # Get instance ID
          response = ec2.describe_instances(
              Filters=[
                  {'Name': 'tag:Name', 'Values': ['EC2-Frontend']},
                  {'Name': 'instance-state-name', 'Values': ['running']}
              ]
          )
          
          instances = response['Reservations'][0]['Instances'] if response['Reservations'] else []
          if not instances:
              print("‚ùå EC2-Frontend not found")
              exit(1)
          
          instance_id = instances[0]['InstanceId']
          print(f"‚úÖ Instance ID: {instance_id}")
          print("")
          print("üì§ Enviando comandos de redeploy...")
          
          commands = [
              "echo 'Deteniendo contenedor anterior...'",
              "docker stop frontend 2>/dev/null || true",
              "docker rm frontend 2>/dev/null || true",
              "echo 'Limpiando image antigua...'",
              "docker rmi frontend-web:latest 2>/dev/null || true",
              "echo 'Copiando docker-compose corregido...'",
              "cd /tmp",
              "curl -s https://raw.githubusercontent.com/arielguerron14/Proyecto-Acompa-amiento-/main/docker-compose.ec2-frontend.yml -o docker-compose.yml",
              "echo 'Verificando configuraci√≥n de puertos...'",
              "grep -A2 'ports:' docker-compose.yml",
              "echo 'Corriendo contenedor...'",
              "docker-compose up -d --no-build",
              "echo 'Esperando que inicie...'",
              "sleep 3",
              "echo 'Verificando estado...'",
              "docker ps | grep frontend",
              "echo 'Mostrando logs...'",
              "docker logs frontend 2>&1 | tail -10"
          ]
          
          response = ssm.send_command(
              InstanceIds=[instance_id],
              DocumentName="AWS-RunShellScript",
              Parameters={'commands': commands}
          )
          
          command_id = response['Command']['CommandId']
          print(f"Command ID: {command_id}")
          print("")
          print("‚è≥ Esperando resultado...")
          
          # Wait for command
          for i in range(60):
              response = ssm.get_command_invocation(
                  CommandId=command_id,
                  InstanceId=instance_id
              )
              
              status = response['Status']
              print(f"\r  Intento {i+1}/60 - Status: {status}", end='', flush=True)
              
              if status in ['Success', 'Failed']:
                  print("\n")
                  print("üìã Output:")
                  print("---")
                  print(response.get('StandardOutputContent', ''))
                  print("---")
                  
                  if status == 'Success':
                      print("‚úÖ Frontend redeploy exitoso!")
                      print("")
                      print("üåê Frontend disponible en: http://52.72.57.10:3000")
                  else:
                      print("‚ùå El comando fall√≥")
                      if response.get('StandardErrorContent'):
                          print("Error:", response.get('StandardErrorContent'))
                      exit(1)
                  break
              
              time.sleep(2)
          
          EOF
