name: Maintain CQRS Architecture

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'apps/micro-*/src/**'
      - 'scripts/generate-cqrs.js'
  pull_request:
    branches:
      - main
    paths:
      - 'apps/micro-*/src/**'

jobs:
  validate-cqrs:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: âœ… Validate CQRS Structure
        run: |
          echo "ðŸ” Validating CQRS structure in all microservices..."
          
          # Array of microservices to check
          MICROSERVICES=(
            "micro-auth"
            "micro-estudiantes"
            "micro-maestros"
            "micro-reportes-estudiantes"
            "micro-reportes-maestros"
            "micro-notificaciones"
            "micro-analytics"
            "micro-core"
          )
          
          MISSING_COUNT=0
          
          for MICRO in "${MICROSERVICES[@]}"; do
            MICRO_PATH="apps/$MICRO"
            
            if [ ! -d "$MICRO_PATH/src" ]; then
              echo "âš ï¸  Skipping $MICRO (no src/ directory)"
              continue
            fi
            
            # Check required CQRS folders
            REQUIRED_DIRS=(
              "src/api/controllers"
              "src/application/commands"
              "src/application/command-handlers"
              "src/application/queries"
              "src/application/query-handlers"
              "src/domain/entities"
              "src/domain/repositories"
              "src/infrastructure/persistence-write"
              "src/infrastructure/persistence-read"
              "src/infrastructure/config"
            )
            
            for DIR in "${REQUIRED_DIRS[@]}"; do
              if [ ! -d "$MICRO_PATH/$DIR" ]; then
                echo "âŒ $MICRO: Missing $DIR"
                ((MISSING_COUNT++))
              fi
            done
            
            if [ $MISSING_COUNT -eq 0 ]; then
              echo "âœ… $MICRO: CQRS structure complete"
            fi
          done
          
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "âš ï¸  Found $MISSING_COUNT missing directories"
            echo "Consider running: npm run cqrs:regenerate"
          fi

  ensure-cqrs:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ” Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ—ï¸  Regenerate CQRS Structure
        run: |
          echo "Ensuring CQRS structure is up to date..."
          node scripts/generate-cqrs.js

      - name: ðŸ“Š Check for changes
        id: check-changes
        run: |
          if git diff --quiet; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ CQRS structure was regenerated"
            git diff --name-only
          fi

      - name: ðŸš€ Commit changes if needed
        if: steps.check-changes.outputs.has-changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          git add -A
          git commit -m "ðŸ—ï¸ Maintain CQRS architecture structure

- Ensured all microservices have complete CQRS folder structure
- Generated missing command/query handlers, repositories, and configs
- Maintained separation of concerns for better scalability"
          git push origin main

  lint-cqrs:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“‹ Check CQRS Code Quality
        run: |
          echo "ðŸ” Linting CQRS command/query handlers..."
          
          # Check that handlers have proper structure
          for HANDLER in $(find apps/*/src/application/command-handlers -name '*.js' 2>/dev/null | grep -v README | grep -v index); do
            if ! grep -q "class.*Handler" "$HANDLER"; then
              echo "âš ï¸  $HANDLER might not be a valid handler"
            fi
            
            if ! grep -q "async handle" "$HANDLER"; then
              echo "âš ï¸  $HANDLER missing async handle method"
            fi
          done
          
          # Check that repositories have interface structure
          for REPO in $(find apps/*/src/domain/repositories -name '*.js' 2>/dev/null | grep -v README); do
            if ! grep -q "class.*Repository" "$REPO" && ! grep -q "module.exports.*Repository" "$REPO"; then
              echo "âš ï¸  $REPO might not be a valid repository"
            fi
          done
          
          echo "âœ… CQRS code quality check complete"

  documentation:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“š Generate CQRS Documentation
        run: |
          echo "# CQRS Implementation Status" > CQRS_STATUS.md
          echo "" >> CQRS_STATUS.md
          echo "Generated: $(date)" >> CQRS_STATUS.md
          echo "" >> CQRS_STATUS.md
          echo "## Microservices with CQRS" >> CQRS_STATUS.md
          echo "" >> CQRS_STATUS.md
          
          for MICRO in apps/micro-*/; do
            MICRO_NAME=$(basename "$MICRO")
            
            if [ -d "$MICRO/src/application" ]; then
              CMD_COUNT=$(find "$MICRO/src/application/command-handlers" -name '*.js' 2>/dev/null | grep -v README | grep -v index | wc -l)
              QUERY_COUNT=$(find "$MICRO/src/application/query-handlers" -name '*.js' 2>/dev/null | grep -v README | grep -v index | wc -l)
              
              echo "### $MICRO_NAME" >> CQRS_STATUS.md
              echo "- Commands: $CMD_COUNT" >> CQRS_STATUS.md
              echo "- Queries: $QUERY_COUNT" >> CQRS_STATUS.md
              echo "" >> CQRS_STATUS.md
            fi
          done

      - name: ðŸ’¾ Commit documentation
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          if [ -f CQRS_STATUS.md ]; then
            git add CQRS_STATUS.md
            git diff --cached --quiet || git commit -m "ðŸ“š Update CQRS implementation status"
          fi
          git push origin main || echo "Nothing to push"

  summary:
    needs: [validate-cqrs, ensure-cqrs, lint-cqrs]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“Š Workflow Summary
        run: |
          echo "## âœ… CQRS Architecture Maintenance Complete"
          echo ""
          echo "### Checks Run:"
          echo "- âœ… CQRS structure validation"
          echo "- âœ… Automatic structure regeneration"
          echo "- âœ… Code quality linting"
          echo "- âœ… Documentation update"
          echo ""
          echo "### Architecture Overview:"
          echo "```"
          echo "src/"
          echo "â”œâ”€â”€ api/controllers          (REST endpoints)"
          echo "â”œâ”€â”€ application/             (Commands & Queries)"
          echo "â”‚   â”œâ”€â”€ commands/"
          echo "â”‚   â”œâ”€â”€ command-handlers/"
          echo "â”‚   â”œâ”€â”€ queries/"
          echo "â”‚   â””â”€â”€ query-handlers/"
          echo "â”œâ”€â”€ domain/                  (Business logic)"
          echo "â”‚   â”œâ”€â”€ entities/"
          echo "â”‚   â”œâ”€â”€ aggregates/"
          echo "â”‚   â”œâ”€â”€ value-objects/"
          echo "â”‚   â””â”€â”€ repositories/"
          echo "â”œâ”€â”€ infrastructure/          (Persistence & Config)"
          echo "â”‚   â”œâ”€â”€ persistence-write/"
          echo "â”‚   â”œâ”€â”€ persistence-read/"
          echo "â”‚   â”œâ”€â”€ messaging/"
          echo "â”‚   â””â”€â”€ config/"
          echo "â””â”€â”€ shared/                  (Shared types)"
          echo "```
