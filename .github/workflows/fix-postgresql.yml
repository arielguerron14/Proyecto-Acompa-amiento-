name: ğŸ”§ Fix PostgreSQL (Manual Trigger)

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'restart'
        type: choice
        options:
          - restart
          - logs
          - status

env:
  EC2_DB_PUBLIC_IP: 3.236.45.128
  EC2_DB_PRIVATE_IP: 172.31.79.193
  SSH_USER: ubuntu
  AWS_REGION: us-east-1

jobs:
  fix-postgresql:
    name: Fix PostgreSQL on EC2-DB
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout
      - name: âœ… Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Setup SSH
      - name: ğŸ”‘ Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_EC2_DB_SSH_PRIVATE_KEY }}" > ~/.ssh/aws-key.pem
          chmod 600 ~/.ssh/aws-key.pem
          ssh-keyscan -H ${{ env.EC2_DB_PUBLIC_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true

      # 3. Execute Fix Script
      - name: ğŸ”§ Execute PostgreSQL Fix
        run: |
          echo "Executing PostgreSQL fix on EC2-DB..."
          ssh -i ~/.ssh/aws-key.pem \
            -o ConnectTimeout=10 \
            -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.EC2_DB_PUBLIC_IP }} << 'FIX_EOF'
          
          set -e
          cd /opt/databases
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         ğŸ”§ REPARANDO POSTGRESQL EN EC2-DB                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # 1. LIMPIAR
          echo "1ï¸âƒ£  Limpiando contenedores y volÃºmenes..."
          docker-compose down -v --remove-orphans 2>/dev/null || true
          docker rm -f postgresql mongodb redis 2>/dev/null || true
          docker volume rm -f $(docker volume ls -q --filter name=databases) 2>/dev/null || true
          echo "   âœ… Limpieza completada"
          echo ""
          
          # 2. ACTUALIZAR DOCKER-COMPOSE
          echo "2ï¸âƒ£  Actualizando docker-compose.yml..."
          cat > docker-compose.yml << 'COMPOSE'
          services:
            mongodb:
              image: mongo:6.0
              container_name: mongodb
              ports:
                - "27017:27017"
              environment:
                MONGO_INITDB_ROOT_USERNAME: admin
                MONGO_INITDB_ROOT_PASSWORD: mongodb123
              volumes:
                - mongodb_data:/data/db
              networks:
                - databases
              restart: unless-stopped
              healthcheck:
                test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
                interval: 10s
                timeout: 5s
                retries: 3
          
            postgresql:
              image: postgres:15
              container_name: postgresql
              ports:
                - "5432:5432"
              environment:
                POSTGRES_USER: postgres
                POSTGRES_PASSWORD: postgres123
                POSTGRES_DB: acompanamiento
              volumes:
                - postgresql_data:/var/lib/postgresql/data
              networks:
                - databases
              restart: unless-stopped
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U postgres"]
                interval: 10s
                timeout: 5s
                retries: 3
          
            redis:
              image: redis:7-alpine
              container_name: redis
              ports:
                - "6379:6379"
              command: redis-server --appendonly yes --requirepass redis123
              volumes:
                - redis_data:/data
              networks:
                - databases
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "redis-cli", "ping"]
                interval: 10s
                timeout: 5s
                retries: 3
          
          volumes:
            mongodb_data:
            postgresql_data:
            redis_data:
          
          networks:
            databases:
              driver: bridge
          COMPOSE
          echo "   âœ… docker-compose.yml actualizado"
          echo ""
          
          # 3. INICIAR
          echo "3ï¸âƒ£  Iniciando contenedores..."
          docker-compose up -d
          echo "   âœ… Contenedores iniciados"
          echo ""
          
          # 4. ESPERAR
          echo "4ï¸âƒ£  Esperando 45 segundos para inicializaciÃ³n..."
          sleep 45
          echo "   âœ… InicializaciÃ³n completada"
          echo ""
          
          # 5. VERIFICAR ESTADO
          echo "5ï¸âƒ£  ESTADO DE CONTENEDORES"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          docker ps -a --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          
          # 6. VERIFICAR MONGODB
          echo "6ï¸âƒ£  VERIFICANDO MONGODB"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if docker exec mongodb mongosh --eval "db.adminCommand('ping')" --quiet > /dev/null 2>&1; then
              echo "   âœ… MongoDB estÃ¡ respondiendo"
          else
              echo "   âŒ MongoDB NO estÃ¡ respondiendo"
              docker logs mongodb | tail -10
          fi
          echo ""
          
          # 7. VERIFICAR REDIS
          echo "7ï¸âƒ£  VERIFICANDO REDIS"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if docker exec redis redis-cli -a redis123 ping > /dev/null 2>&1; then
              echo "   âœ… Redis estÃ¡ respondiendo"
          else
              echo "   âŒ Redis NO estÃ¡ respondiendo"
              docker logs redis | tail -10
          fi
          echo ""
          
          # 8. VERIFICAR POSTGRESQL - CRÃTICO
          echo "8ï¸âƒ£  VERIFICANDO POSTGRESQL"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if docker exec postgresql pg_isready -U postgres > /dev/null 2>&1; then
              echo "   âœ… PostgreSQL estÃ¡ respondiendo"
              
              if docker exec postgresql psql -U postgres -d acompanamiento -c "SELECT version();" > /dev/null 2>&1; then
                  echo "   âœ… Base de datos 'acompanamiento' es accesible"
                  echo ""
                  echo "   ğŸ“‹ VersiÃ³n de PostgreSQL:"
                  docker exec postgresql psql -U postgres -d acompanamiento -c "SELECT version();" | grep "PostgreSQL"
              else
                  echo "   âŒ Base de datos 'acompanamiento' NO es accesible"
                  echo ""
                  echo "   ğŸ“‹ Logs de PostgreSQL (Ãºltimas 20 lÃ­neas):"
                  docker logs postgresql | tail -20
              fi
          else
              echo "   âŒ PostgreSQL NO estÃ¡ respondiendo"
              echo ""
              echo "   ğŸ“‹ Logs de PostgreSQL (Ãºltimas 30 lÃ­neas):"
              docker logs postgresql | tail -30
          fi
          echo ""
          
          # 9. RESUMEN
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                  âœ… REPARACIÃ“N COMPLETADA                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          FIX_EOF

      - name: ğŸ“‹ Display Summary
        run: |
          cat << 'SUMMARY'
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                   âœ… FIX COMPLETADO                        â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          El script ha ejecutado las siguientes operaciones:
          
          âœ… Limpieza completa de contenedores y volÃºmenes
          âœ… ActualizaciÃ³n de docker-compose.yml
          âœ… Reinicio de todos los servicios
          âœ… ValidaciÃ³n de MongoDB, PostgreSQL y Redis
          
          PRÃ“XIMOS PASOS:
          1. Revisa la salida anterior para ver el estado
          2. Si PostgreSQL estÃ¡ âœ… OK, procede al siguiente servicio
          3. Si PostgreSQL estÃ¡ âŒ FALLO, revisa los logs
          
          PARA VERIFICAR MANUALMENTE EN EC2-DB:
          
          ssh -i <tu-key.pem> ubuntu@3.236.45.128
          cd /opt/databases
          docker ps -a
          docker logs postgresql
          docker exec postgresql psql -U postgres -d acompanamiento -c "SELECT version();"
          
          SUMMARY
