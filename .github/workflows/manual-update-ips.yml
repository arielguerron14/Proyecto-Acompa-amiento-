name: Run Auto Update Now

on:
  workflow_dispatch:

jobs:
  run-auto-update:
    name: Discover IPs & Update Config
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: us-east-1

    - name: Install dependencies
      run: sudo apt-get update -y && sudo apt-get install -y jq

    - name: Discover instances and update configuration
      run: |
        set -e
        echo "ðŸ” Discovering EC2 instances..."
        
        # Query all running instances with Project=lab-8-ec2 tag
        INSTANCES=$(aws ec2 describe-instances \
          --filters "Name=tag:Project,Values=lab-8-ec2" "Name=instance-state-name,Values=running" \
          --query 'Reservations[*].Instances[*].[
            Tags[?Key==`Name`].Value|[0],
            InstanceId,
            PrivateIpAddress,
            PublicIpAddress
          ]' \
          --output json)
        
        echo "Raw instances:"
        echo "$INSTANCES" | jq '.'
        
        # Query Elastic IPs
        echo "Querying Elastic IPs..."
        ELASTIC_IPS=$(aws ec2 describe-addresses \
          --query 'Addresses[*].[InstanceId,PublicIp]' \
          --output json)
        
        echo "Elastic IPs:"
        echo "$ELASTIC_IPS" | jq '.'
        
        # Process instances
        INSTANCE_MAP=$(echo "$INSTANCES" | jq -c '
          [.[][] | select(.[0] != null)] |
          map({
            name: .[0],
            instance_id: .[1],
            private_ip: .[2],
            public_ip: (.[3] // .[2])
          })
        ')
        
        # Enrich with Elastic IPs
        ENRICHED=$(echo "$INSTANCE_MAP" | jq \
          --argjson eips "$ELASTIC_IPS" '
          map(
            .instance_id as $id |
            .elastic_ip = ($eips[] | select(.[0] == $id) | .[1]) // .public_ip |
            {(.name): .}
          ) | add // {}
        ')
        
        echo "Discovered instances:"
        echo "$ENRICHED" | jq '.'
        
        # Save to file for next step
        echo "$ENRICHED" > discovered-instances.json

    - name: Generate configuration files
      run: |
        INSTANCES=$(cat discovered-instances.json)
        
        # Generate infrastructure-instances.config.js
        cat > infrastructure-instances.config.js << 'EOF'
        /**
         * AUTO-GENERATED: Instance Configuration
         * Generated: $(date -u)
         * Updated by GitHub Actions
         */
        
        module.exports = {
          instances: INSTANCES_PLACEHOLDER,
          
          services: {
            frontend: { name: 'EC2-Frontend', ports: { http: 3000 } },
            api_gateway: { name: 'EC2-API-Gateway', ports: { http: 8080 } },
            core: { name: 'EC2-CORE', ports: { http: 8081 } },
            database: { name: 'EC2-DB', ports: { postgres: 5432 } },
            messaging: { name: 'EC2-Messaging', ports: { amqp: 5672 } },
            notifications: { name: 'EC2-Notificaciones', ports: { http: 8082 } },
            reports: { name: 'EC2-Reportes', ports: { http: 8083 } },
            monitoring: { name: 'EC2-Monitoring', ports: { prometheus: 9090 } }
          },
          
          getInstanceIP: function(name, type='private') {
            const inst = this.instances[name];
            return inst ? inst[type + '_ip'] : null;
          }
        };
        EOF
        
        ESCAPED=$(echo "$INSTANCES" | sed 's/"/\\"/g' | tr '\n' ' ')
        sed -i "s|INSTANCES_PLACEHOLDER|$ESCAPED|g" infrastructure-instances.config.js
        
        echo "âœ… infrastructure-instances.config.js generated"

    - name: Generate .env file
      run: |
        INSTANCES=$(cat discovered-instances.json)
        
        # Extract IPs for each instance
        EXTRACT_IPS() {
          local name=$1
          echo "$INSTANCES" | jq -r ".\"$name\" | \"\\(.private_ip),\\(.public_ip),\\(.elastic_ip)\"" 2>/dev/null || echo ",,,"
        }
        
        FRONTEND=$(EXTRACT_IPS "EC2-Frontend")
        API=$(EXTRACT_IPS "EC2-API-Gateway")
        CORE=$(EXTRACT_IPS "EC2-CORE")
        DB=$(EXTRACT_IPS "EC2-DB")
        MSG=$(EXTRACT_IPS "EC2-Messaging")
        BASTION=$(EXTRACT_IPS "EC-Bastion")
        
        IFS=',' read -r FRONTEND_PRIV FRONTEND_PUB FRONTEND_ELAS <<< "$FRONTEND"
        IFS=',' read -r API_PRIV API_PUB API_ELAS <<< "$API"
        IFS=',' read -r CORE_PRIV CORE_PUB CORE_ELAS <<< "$CORE"
        IFS=',' read -r DB_PRIV DB_PUB DB_ELAS <<< "$DB"
        IFS=',' read -r MSG_PRIV MSG_PUB MSG_ELAS <<< "$MSG"
        IFS=',' read -r BASTION_PRIV BASTION_PUB BASTION_ELAS <<< "$BASTION"
        
        cat > .env.generated << ENVEOF
        # Auto-generated environment variables
        # Timestamp: $(date -u)
        
        # Instance IPs - Internal
        FRONTEND_PRIVATE=${FRONTEND_PRIV}
        API_PRIVATE=${API_PRIV}
        CORE_PRIVATE=${CORE_PRIV}
        DB_PRIVATE=${DB_PRIV}
        MESSAGING_PRIVATE=${MSG_PRIV}
        
        # Instance IPs - External
        FRONTEND_PUBLIC=${FRONTEND_PUB}
        API_PUBLIC=${API_PUB}
        CORE_PUBLIC=${CORE_PUB}
        DB_PUBLIC=${DB_PUB}
        BASTION_PUBLIC=${BASTION_PUB}
        
        # Service Configurations
        DATABASE_HOST=${DB_PRIV}
        DATABASE_PORT=5432
        DATABASE_URL=postgresql://user:pass@${DB_PRIV}:5432/acompanamiento
        
        RABBITMQ_HOST=${MSG_PRIV}
        RABBITMQ_PORT=5672
        RABBITMQ_URL=amqp://guest:guest@${MSG_PRIV}:5672/
        
        API_GATEWAY_HOST=${API_PRIV}
        API_GATEWAY_PORT=8080
        
        CORE_SERVICE_HOST=${CORE_PRIV}
        CORE_SERVICE_PORT=8081
        
        BASTION_HOST=${BASTION_PUB}
        BASTION_USER=ubuntu
        BASTION_PORT=22
        ENVEOF
        
        echo "âœ… .env.generated created"

    - name: Commit and push
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        git add infrastructure-instances.config.js .env.generated
        
        if git diff --cached --quiet; then
          echo "âš ï¸  No changes"
        else
          git commit -m "chore: Auto-update IPs after infrastructure deployment"
          git push
          echo "âœ… Pushed to repository"
        fi

    - name: Summary
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  IPs Updated & Ready for Deployment       â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ðŸ“‹ Files generated:"
        echo "  â€¢ infrastructure-instances.config.js"
        echo "  â€¢ .env.generated"
        echo ""
        echo "âœ… Ready to deploy project services!"
