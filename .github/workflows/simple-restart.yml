name: Simple Restart Core

on:
  workflow_dispatch:

jobs:
  restart:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup SSH
        env:
          SSH_KEY: ${{ secrets.LABSUSER_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 172.31.71.182 >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Restart via Simple SSH
        continue-on-error: true
        run: |
          echo "Connecting to EC2-Core..."
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=15 ubuntu@172.31.71.182 "
          cd ~/Proyecto-Acompa-amiento-
          echo 'Stopping services...'
          sudo docker-compose -f docker-compose.core.yml down 2>/dev/null || true
          sleep 5
          echo 'Starting services...'
          sudo docker-compose -f docker-compose.core.yml up -d 2>/dev/null || true
          sleep 15
          echo 'Status:'
          docker ps -a --format 'table {{.Names}}\t{{.Status}}'
          "

      - name: Test Services
        continue-on-error: true
        run: |
          sleep 10
          echo "Testing..."
          curl -s http://52.7.168.4:8080/health
          echo ""
          curl -s http://52.7.168.4:8080/horarios
          echo ""
          curl -s http://52.7.168.4:8080/estudiantes/reservas/estudiante/1
