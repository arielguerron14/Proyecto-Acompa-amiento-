name: ğŸš€ Deploy - Resilient with Retries

on:
  workflow_dispatch:
    inputs:
      rebuild_images:
        description: 'Rebuild Docker images'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  AWS_REGION: us-east-1
  SSH_TIMEOUT: 10  # seconds

jobs:
  load-config:
    name: ğŸ“‹ Load Configuration
    runs-on: ubuntu-latest
    outputs:
      core-ip: ${{ steps.load.outputs.core_public }}
      api-gateway-ip: ${{ steps.load.outputs.api_gateway_public }}
      db-ip: ${{ steps.load.outputs.db_public }}
      messaging-ip: ${{ steps.load.outputs.messaging_public }}
      reportes-ip: ${{ steps.load.outputs.reportes_public }}
      notificaciones-ip: ${{ steps.load.outputs.notificaciones_public }}
      analytics-ip: ${{ steps.load.outputs.analytics_public }}
      monitoring-ip: ${{ steps.load.outputs.monitoring_public }}
      frontend-ip: ${{ steps.load.outputs.frontend_public }}
      bastion-ip: ${{ steps.load.outputs.bastion_public }}

    steps:
      - uses: actions/checkout@v3
      - id: load
        run: |
          python3 << 'PYTHON'
          import json
          with open('config/instance_ips.json', 'r') as f:
              instances = json.load(f)
          mapping = {
              'EC2-CORE': 'core', 'EC2-API-Gateway': 'api_gateway', 'EC2-DB': 'db',
              'EC2-Messaging': 'messaging', 'EC2-Reportes': 'reportes',
              'EC2-Notificaciones': 'notificaciones', 'EC2-Analytics': 'analytics',
              'EC2-Monitoring': 'monitoring', 'EC2-Frontend': 'frontend', 'EC-Bastion': 'bastion'
          }
          for instance_name, output_name in mapping.items():
              if instance_name in instances:
                  print(f"::set-output name={output_name}_public::{instances[instance_name]['PublicIpAddress']}")
                  print(f"âœ… {instance_name}: {instances[instance_name]['PublicIpAddress']}")
          PYTHON

  deploy-core:
    name: "ğŸ³ EC2-CORE"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true

    steps:
      - uses: actions/checkout@v3
      - run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.load-config.outputs.core-ip }} >> ~/.ssh/known_hosts 2>/dev/null || true
      
      - run: |
          echo "ğŸ³ Deploying to EC2-CORE (${{ needs.load-config.outputs.core-ip }})"
          
          # Test SSH connection first
          if ! timeout 5 ssh -i ~/.ssh/id_rsa -o ConnectTimeout=5 ubuntu@${{ needs.load-config.outputs.core-ip }} "echo 'âœ… SSH OK'" 2>&1; then
            echo "âŒ Cannot reach EC2-CORE via SSH - instance may be offline"
            exit 1
          fi
          
          # Quick deploy
          tar czf - --exclude='node_modules' --exclude='.git' --exclude='dist' --exclude='build' \
            micro-auth micro-estudiantes micro-maestros shared-monitoring shared-config shared-auth \
            | ssh -i ~/.ssh/id_rsa ubuntu@${{ needs.load-config.outputs.core-ip }} \
            "cat > /tmp/core.tar.gz && echo 'âœ… TAR transferred'"
          
          scp -i ~/.ssh/id_rsa docker-compose.ec2-core.yml ubuntu@${{ needs.load-config.outputs.core-ip }}:/tmp/
          
          ssh -i ~/.ssh/id_rsa ubuntu@${{ needs.load-config.outputs.core-ip }} << 'DEPLOY'
          cd /home/ubuntu
          tar xzf /tmp/core.tar.gz
          docker-compose -f /tmp/docker-compose.ec2-core.yml down 2>/dev/null || true
          docker-compose -f /tmp/docker-compose.ec2-core.yml build --no-cache 2>&1 | tail -5
          docker-compose -f /tmp/docker-compose.ec2-core.yml up -d
          sleep 5
          docker-compose -f /tmp/docker-compose.ec2-core.yml ps
          DEPLOY

  # Simplified placeholders for other services
  deploy-api-gateway:
    name: "ğŸŒ EC2-API-Gateway"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - run: echo "âœ… API-Gateway deployment would go here"

  deploy-db:
    name: "ğŸ—„ï¸  EC2-DB"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - run: echo "âœ… DB deployment would go here"

  deploy-messaging:
    name: "â±ï¸  EC2-Messaging"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - run: echo "âœ… Messaging deployment would go here"

  status:
    name: "ğŸ“Š Status"
    needs: [deploy-core, deploy-api-gateway, deploy-db, deploy-messaging]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - run: |
          echo "ğŸ¯ Deployment Status:"
          echo "CORE: ${{ needs.deploy-core.result }}"
          echo "API-Gateway: ${{ needs.deploy-api-gateway.result }}"
          echo "DB: ${{ needs.deploy-db.result }}"
          echo "Messaging: ${{ needs.deploy-messaging.result }}"
