name: Deploy to EC2 (Simplified)

on:
  workflow_dispatch:
    inputs:
      instance:
        description: 'Instance to deploy'
        required: true
        default: 'EC2_CORE'
        type: choice
        options:
          - EC2_CORE
          - EC2_DB
          - EC2_API_GATEWAY
          - EC2_FRONTEND
          - EC2_MESSAGING
          - EC2_MONITORING
          - EC2_NOTIFICACIONES
          - EC2_REPORTES
      rebuild_docker:
        description: 'Rebuild Docker images'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  AWS_REGION: us-east-1
  DOCKER_BUILDKIT: 1

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          cp ./ssh-key-ec2.pem ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "SSH key ready"
      
      - name: Get EC2 IP and Deploy
        run: |
          case "${{ github.event.inputs.instance }}" in
            EC2_CORE) IP="3.234.198.34" ;;
            EC2_DB) IP="3.237.32.106" ;;
            EC2_API_GATEWAY) IP="3.214.212.205" ;;
            EC2_FRONTEND) IP="54.85.92.175" ;;
            EC2_MESSAGING) IP="34.207.206.13" ;;
            EC2_MONITORING) IP="34.203.175.72" ;;
            EC2_NOTIFICACIONES) IP="35.175.200.15" ;;
            EC2_REPORTES) IP="3.94.74.223" ;;
            *) IP="0.0.0.0" ;;
          esac
          
          INSTANCE="${{ github.event.inputs.instance }}"
          REBUILD="${{ github.event.inputs.rebuild_docker }}"
          GITHUB_REPO="${{ github.repository }}"
          GITHUB_REF="${{ github.ref }}"
          
          ssh-keyscan -H $IP >> ~/.ssh/known_hosts 2>/dev/null || true
          
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=30 ubuntu@$IP bash << 'EOFSCRIPT'
          set -e
          
          INSTANCE="'"$INSTANCE"'"
          REBUILD="'"$REBUILD"'"
          GITHUB_REPO="'"$GITHUB_REPO"'"
          GITHUB_REF="'"$GITHUB_REF"'"
          
          echo "=========================================="
          echo "EC2 Deployment Script"
          echo "=========================================="
          echo "Instance: $INSTANCE"
          echo "Rebuild Docker: $REBUILD"
          echo "Repo: $GITHUB_REPO"
          echo "Ref: $GITHUB_REF"
          
          # Clean up
          echo ""
          echo "=== Cleaning old resources ==="
          docker system prune -af --volumes 2>/dev/null || true
          rm -rf ~/app ~/app-build ~/docker-images
          mkdir -p ~/app ~/docker-images
          
          # Clone repository
          echo ""
          echo "=== Cloning repository ==="
          cd ~
          git clone --depth 1 https://github.com/$GITHUB_REPO.git app-build
          cd app-build
          git checkout ${GITHUB_REF#refs/heads/}
          
          # Build Docker images if needed
          if [ "$REBUILD" = "true" ]; then
            echo ""
            echo "=== Building Docker images ==="
            
            # Determine what to build based on instance
            case "$INSTANCE" in
              EC2_MESSAGING)
                echo "Building messaging services..."
                if [ -f "./messaging/zookeeper/Dockerfile" ]; then
                  docker build --no-cache -t proyecto-zookeeper:1.0 -f ./messaging/zookeeper/Dockerfile ./messaging
                fi
                if [ -f "./messaging/kafka/Dockerfile" ]; then
                  docker build --no-cache -t proyecto-kafka:1.0 -f ./messaging/kafka/Dockerfile ./messaging
                fi
                if [ -f "./messaging/rabbitmq/Dockerfile" ]; then
                  docker build --no-cache -t proyecto-rabbitmq:1.0 -f ./messaging/rabbitmq/Dockerfile ./messaging
                fi
                ;;
              EC2_MONITORING)
                echo "Building monitoring services..."
                if [ -f "./monitoring/prometheus/Dockerfile" ]; then
                  docker build --no-cache -t proyecto-prometheus:1.0 -f ./monitoring/prometheus/Dockerfile ./monitoring
                fi
                if [ -f "./monitoring/grafana/Dockerfile" ]; then
                  docker build --no-cache -t proyecto-grafana:1.0 -f ./monitoring/grafana/Dockerfile ./monitoring
                fi
                ;;
              EC2_DB)
                echo "Building database services..."
                if [ -f "./databases/mongodb/Dockerfile" ]; then
                  docker build --no-cache -t proyecto-mongodb:1.0 -f ./databases/mongodb/Dockerfile ./databases
                fi
                if [ -f "./databases/postgres/Dockerfile" ]; then
                  docker build --no-cache -t proyecto-postgres:1.0 -f ./databases/postgres/Dockerfile ./databases
                fi
                if [ -f "./databases/redis/Dockerfile" ]; then
                  docker build --no-cache -t proyecto-redis:1.0 -f ./databases/redis/Dockerfile ./databases
                fi
                ;;
              *)
                echo "Building microservices..."
                for SERVICE in api-gateway micro-auth micro-estudiantes micro-maestros micro-notificaciones micro-reportes-estudiantes micro-reportes-maestros frontend-web; do
                  if [ -f "./$SERVICE/Dockerfile" ]; then
                    if [ "$SERVICE" = "frontend-web" ]; then
                      docker build --no-cache -t $SERVICE:latest -f ./$SERVICE/Dockerfile ./$SERVICE
                    else
                      docker build --no-cache -t $SERVICE:latest -f ./$SERVICE/Dockerfile .
                    fi
                  fi
                done
                ;;
            esac
            
            echo "Docker images built successfully"
            docker images | grep -E 'proyecto|api-gateway|micro|frontend' || echo "No custom images found"
          fi
          
          # Select docker-compose file
          echo ""
          echo "=== Selecting docker-compose file ==="
          case "$INSTANCE" in
            EC2_CORE) COMPOSE_FILE="./docker-compose.ec2-core.yml" ;;
            EC2_DB) COMPOSE_FILE="./databases/docker-compose.yml" ;;
            EC2_API_GATEWAY) COMPOSE_FILE="./docker-compose.api-gateway.yml" ;;
            EC2_FRONTEND) COMPOSE_FILE="./docker-compose.frontend.yml" ;;
            EC2_MESSAGING) COMPOSE_FILE="./messaging/docker-compose.yml" ;;
            EC2_MONITORING) COMPOSE_FILE="./monitoring/docker-compose.yml" ;;
            *) COMPOSE_FILE="./docker-compose.yml" ;;
          esac
          
          if [ ! -f "$COMPOSE_FILE" ]; then
            echo "ERROR: $COMPOSE_FILE not found!"
            exit 1
          fi
          
          cp "$COMPOSE_FILE" ~/app/docker-compose.yml
          echo "Using: $COMPOSE_FILE"
          
          # Deploy with docker-compose
          echo ""
          echo "=== Deploying services ==="
          cd ~/app
          docker-compose config > /dev/null && echo "âœ“ docker-compose.yml is valid"
          docker-compose down 2>/dev/null || true
          docker-compose up -d
          
          echo ""
          echo "=== Deployment complete ==="
          sleep 5
          docker-compose ps
          docker-compose logs --tail=30
          
          EOFSCRIPT
          
          echo ""
          echo "=========================================="
          echo "Deployment finished successfully!"
          echo "=========================================="
