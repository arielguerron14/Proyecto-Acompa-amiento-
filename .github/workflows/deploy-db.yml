name: üöÄ Deploy EC2-DB Only

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

jobs:
  deploy-db:
    name: "üöÄ Deploy EC2-DB (mongo, postgres, redis)"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v3
      - uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1
      - name: Deploy containers on EC2-DB
        run: |
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=EC2-DB" "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].InstanceId" \
            --output text)

          if [ -z "$INSTANCE_ID" ] || [ "$INSTANCE_ID" = "None" ]; then
            echo "‚ùå EC2-DB not found"
            exit 1
          fi

          echo "‚úÖ Instance: $INSTANCE_ID"
          echo "üìã Deploying mongo, postgres, redis..."

          aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "docker pull mongo:latest",
              "docker pull postgres:latest",
              "docker pull redis:latest",
              "docker stop mongo 2>/dev/null || true",
              "docker stop postgres 2>/dev/null || true",
              "docker stop redis 2>/dev/null || true",
              "docker rm mongo 2>/dev/null || true",
              "docker rm postgres 2>/dev/null || true",
              "docker rm redis 2>/dev/null || true",
              "docker run -d --name mongo --restart unless-stopped -p 27017:27017 mongo:latest",
              "docker run -d --name postgres --restart unless-stopped -e POSTGRES_PASSWORD=postgres -p 5432:5432 postgres:latest",
              "docker run -d --name redis --restart unless-stopped -p 6379:6379 redis:latest",
              "sleep 5",
              "docker ps | grep -E 'mongo|postgres|redis'"
            ]' \
            --output text > /tmp/ssm-command.txt

          COMMAND_ID=$(cat /tmp/ssm-command.txt | awk '{print $NF}')

          echo "Command ID: $COMMAND_ID"
          echo "‚è≥ Waiting for containers to be up..."

          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --query "Status" \
              --output text 2>/dev/null || echo "Pending")

            if [ $((i % 10)) -eq 0 ]; then
              echo "[$i/60] Status: $STATUS"
            fi

            if [ "$STATUS" = "Success" ]; then
              echo "\n‚úÖ DB containers running!"
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$INSTANCE_ID" \
                --query 'StandardOutputContent' \
                --output text | tail -30
              break
            elif [ "$STATUS" = "Failed" ]; then
              echo "\n‚ùå DB deploy failed"
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$INSTANCE_ID" \
                --query 'StandardErrorContent' \
                --output text
              exit 1
            fi
            sleep 5
          done
