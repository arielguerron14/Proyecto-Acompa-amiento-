name: Build, Push, and Deploy Frontend Web

on:
  push:
    branches: [ "main" ]
    paths:
      - "frontend-web/**"
  workflow_dispatch:
    inputs:
      deploy:
        description: "Run the deploy step to AWS (true/false). Defaults to 'false'."
        required: false
        default: 'false'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker Image (tagged by SHA)
        id: build_push
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/frontend-web:${SHORT_SHA}
          LATEST=${{ secrets.DOCKERHUB_USERNAME }}/frontend-web:latest

          echo "Building image $IMAGE"
          docker build -t "$IMAGE" ./frontend-web/

          echo "Tagging as latest"
          docker tag "$IMAGE" "$LATEST"

          echo "Pushing $IMAGE"
          docker push "$IMAGE"

          echo "Pushing $LATEST"
          docker push "$LATEST"

          echo "image=$IMAGE" >> $GITHUB_OUTPUT

  deploy-aws:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true' }}
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Set permissions for private key
        run: |
          echo "${{ secrets.EC2_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Deploy to EC2 (pull SHA tag or build fallback)
        env:
          IMAGE: ${{ needs.build-and-push.outputs.image }}
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_FRONTEND_HOST }} << 'EOF'
          set -e
          echo "Updating apt & ensuring docker is present"
          sudo apt update -y || true
          if ! command -v docker &> /dev/null; then
            sudo apt install -y docker.io
            sudo systemctl start docker
            sudo systemctl enable docker
          fi

          echo "Attempt docker login to pull private images"
          echo "$DOCKER_TOKEN" | sudo docker login -u "$DOCKER_USER" --password-stdin || true

          echo "Attempting to pull image: $IMAGE"
          if sudo docker pull "$IMAGE"; then
            RUN_IMAGE="$IMAGE"
            echo "Pulled $IMAGE successfully"
          else
            echo "Pull failed, building locally on EC2 as fallback"
            if [ -d ~/repo ]; then cd ~/repo && git fetch origin && git checkout main && git pull origin main; else git clone https://github.com/${{ github.repository }} ~/repo && cd ~/repo; fi
            cd ~/repo/frontend-web
            sudo docker build -t frontend-web:local .
            RUN_IMAGE=frontend-web:local
          fi

          echo "Stopping old container"
          sudo docker stop frontend-web-container || true
          sudo docker rm frontend-web-container || true

          echo "Running $RUN_IMAGE"
          sudo docker run -d --restart unless-stopped -p 80:80 --name frontend-web-container "$RUN_IMAGE"

          # prune with retries
          for i in 1 2 3 4 5; do
            if sudo docker image prune -f; then break; else echo "docker prune busy, retrying ($i)"; sleep 2; fi
          done || true
          EOF

      