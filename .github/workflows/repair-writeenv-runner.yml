name: Repair write-env runner

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Target group to write envs and run repair: reportes|notificaciones|all'
        required: false
        default: 'all'

jobs:
  write-env-and-repair:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare SSH key
        run: |
          echo "${{ secrets.EC2_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Validate MONGO_URI
        run: |
          if [ -z "${{ secrets.MONGO_URI }}" ]; then
            echo "ERROR: Required secret MONGO_URI is not set."; exit 1
          fi

      - name: Write envs on reportes host
        if: ${{ github.event.inputs.target == 'reportes' || github.event.inputs.target == 'all' }}
        run: |
          echo "Writing env files on reportes host ${{ secrets.EC2_REPORTES_HOST }}"
          MONGO_B64=$(printf '%s' "${{ secrets.MONGO_URI }}" | base64 -w0)
          REDIS_HOST_B64=$(printf '%s' "${{ secrets.REDIS_HOST }}" | base64 -w0)
          REDIS_PORT_B64=$(printf '%s' "${{ secrets.REDIS_PORT }}" | base64 -w0)
          REDIS_PW_B64=$(printf '%s' "${{ secrets.REDIS_PASSWORD }}" | base64 -w0)

          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_REPORTES_HOST }} <<EOF
  # Decode and sanitize incoming values
  MONGO_URI=$(echo '$MONGO_B64' | base64 -d | tr -d '\r\n')
  REDIS_HOST=$(echo '$REDIS_HOST_B64' | base64 -d | tr -d '\r\n')
  REDIS_PORT=$(echo '$REDIS_PORT_B64' | base64 -d | tr -d '\r\n')
  REDIS_PASSWORD=$(echo '$REDIS_PW_B64' | base64 -d | tr -d '\r\n')

  cat > "$HOME/micro-analytics.env" <<ENV
  MONGO_URI='$MONGO_URI'
  REDIS_HOST='$REDIS_HOST'
  REDIS_PORT='$REDIS_PORT'
  REDIS_PASSWORD='$REDIS_PASSWORD'
  ENV

  cat > "$HOME/micro-reportes-estudiantes.env" <<ENV
  MONGO_URI='$MONGO_URI'
  ENV

  cat > "$HOME/micro-reportes-maestros.env" <<ENV
  MONGO_URI='$MONGO_URI'
  ENV

  echo "Env files written on reportes host"
  # Ensure no embedded newlines remain inside quoted values (defensive)
  perl -0777 -pe "s/(MONGO_URI=')(.+?)(')/\$1.(\$2=~s/[\r\n]+//gr).\$3/egs" -i "$HOME/micro-analytics.env"
  perl -0777 -pe "s/(MONGO_URI=')(.+?)(')/\$1.(\$2=~s/[\r\n]+//gr).\$3/egs" -i "$HOME/micro-reportes-estudiantes.env"
  perl -0777 -pe "s/(MONGO_URI=')(.+?)(')/\$1.(\$2=~s/[\r\n]+//gr).\$3/egs" -i "$HOME/micro-reportes-maestros.env"
EOF

      - name: Write env on notificaciones host
        if: ${{ github.event.inputs.target == 'notificaciones' || github.event.inputs.target == 'all' }}
        run: |
          echo "Writing env file on notificaciones host ${{ secrets.EC2_NOTIFICACIONES_HOST }}"
          MONGO_B64=$(printf '%s' "${{ secrets.MONGO_URI }}" | base64 -w0)
          REDIS_HOST_B64=$(printf '%s' "${{ secrets.REDIS_HOST }}" | base64 -w0)
          REDIS_PORT_B64=$(printf '%s' "${{ secrets.REDIS_PORT }}" | base64 -w0)
          REDIS_PW_B64=$(printf '%s' "${{ secrets.REDIS_PASSWORD }}" | base64 -w0)

          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_NOTIFICACIONES_HOST }} <<EOF
  MONGO_URI=$(echo '$MONGO_B64' | base64 -d | tr -d '\r\n')
  REDIS_HOST=$(echo '$REDIS_HOST_B64' | base64 -d | tr -d '\r\n')
  REDIS_PORT=$(echo '$REDIS_PORT_B64' | base64 -d | tr -d '\r\n')
  REDIS_PASSWORD=$(echo '$REDIS_PW_B64' | base64 -d | tr -d '\r\n')

  cat > "$HOME/micro-notificaciones.env" <<ENV
  MONGO_URI='$MONGO_URI'
  REDIS_HOST='$REDIS_HOST'
  REDIS_PORT='$REDIS_PORT'
  REDIS_PASSWORD='$REDIS_PASSWORD'
  ENV

  echo "Env file written on notificaciones host"
EOF

      - name: Run fix script on reportes host
        if: ${{ github.event.inputs.target == 'reportes' || github.event.inputs.target == 'all' }}
        run: |
          echo "Running fix script on reportes host ${{ secrets.EC2_REPORTES_HOST }}"
          cat scripts/fix-deploy.sh | ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_REPORTES_HOST }} 'bash -s' | tee repair-reportes.log

      - name: Run fix script on notificaciones host
        if: ${{ github.event.inputs.target == 'notificaciones' || github.event.inputs.target == 'all' }}
        run: |
          echo "Running fix script on notificaciones host ${{ secrets.EC2_NOTIFICACIONES_HOST }}"
          cat scripts/fix-deploy.sh | ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_NOTIFICACIONES_HOST }} 'bash -s' | tee repair-notificaciones.log

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: repair-writeenv-logs
          path: repair-*.log
