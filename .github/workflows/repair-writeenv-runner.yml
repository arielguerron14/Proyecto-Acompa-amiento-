name: Repair write-env runner (TEMPORARY MINIMAL)

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Target group: reportes|notificaciones|all'
        required: false
        default: 'reportes'
  push:
    branches: [ 'run-repair' ]

jobs:
  smoke-validate:
    runs-on: ubuntu-latest
    env:
      TARGET: ${{ github.event.inputs.target }}
    steps:
      - name: Smoke validate
        run: |
          echo "SMOKE: minimal repair-writeenv-runner executed"
          echo "If this succeeds, the original workflow contains the problematic block"
      - name: Prepare SSH key
        run: |
          echo "${{ secrets.EC2_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Minimal check - ensure SSH key works
        run: |
          # Attempt to list the home directory on the EC2 host to validate SSH connectivity
          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_REPORTES_HOST }} 'ls -lad $HOME' || true

      - name: Test decode on reportes host (base64 decode, show raw + hex)
        run: |
          echo "Testing base64 decode of MONGO_URI on remote host (no write)"
          # Sanitize secret on runner before encoding to avoid embedded CR/LF or literal "\n"
          MONGO_CLEAN=$(printf '%s' "${{ secrets.MONGO_URI }}" | tr -d '\r' | sed 's/\\n//g' | tr -d '\n')
          MONGO_B64=$(printf '%s' "$MONGO_CLEAN" | base64 -w0)
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_REPORTES_HOST }} <<EOF || echo "REMOTE-REPORTES: ssh failed"
            echo "--- DECODED-RAW ---"
            echo '$MONGO_B64' | base64 -d | sed -n 'l;p' || true
            echo "--- DECODED-HEX ---"
            echo '$MONGO_B64' | base64 -d | od -An -t x1 -v || true
          EOF | sed 's/^/REMOTE-DECODE-REPORTES: /' | tee remote-decode-reportes.log >> repair-reportes.log || true

      - name: Test decode on notificaciones host (base64 decode, show raw + hex)
        run: |
          echo "Testing base64 decode of MONGO_URI on notificaciones host (no write)"
          MONGO_CLEAN=$(printf '%s' "${{ secrets.MONGO_URI }}" | tr -d '\r' | sed 's/\\n//g' | tr -d '\n')
          MONGO_B64=$(printf '%s' "$MONGO_CLEAN" | base64 -w0)
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_NOTIFICACIONES_HOST }} <<EOF || echo "REMOTE-NOTIF: ssh failed"
            echo "--- DECODED-RAW ---"
            echo '$MONGO_B64' | base64 -d | sed -n 'l;p' || true
            echo "--- DECODED-HEX ---"
            echo '$MONGO_B64' | base64 -d | od -An -t x1 -v || true
          EOF | sed 's/^/REMOTE-DECODE-NOTIF: /' | tee remote-decode-notif.log >> repair-notificaciones.log || true

      - name: Remote write smoke test on reportes (non-destructive)
        run: |
          TARGET=${TARGET:-reportes}
          if [ "$TARGET" != "reportes" ] && [ "$TARGET" != "all" ]; then
            echo "Skipping remote write smoke (TARGET=$TARGET)"; exit 0
          fi
          echo "Attempting non-destructive remote write on reportes host ${{ secrets.EC2_REPORTES_HOST }}"
          # Perform a sanitized write on-host using runner-side base64 encoding and on-host decode/printf
          MONGO_CLEAN=$(printf '%s' "${{ secrets.MONGO_URI }}" | tr -d '\r' | sed 's/\\n//g' | tr -d '\n')
          MONGO_B64=$(printf '%s' "$MONGO_CLEAN" | base64 -w0)
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_REPORTES_HOST }} <<'REMOTE_EOF' || echo "REMOTE-REPORTES: ssh failed"
  echo '$MONGO_B64' > /tmp/mongo.b64 || true
  base64 -d /tmp/mongo.b64 | tr -d '\r\n' > /tmp/mongo.dec || true
  MONGO_URI="$(cat /tmp/mongo.dec)"
  printf "MONGO_URI='%s'\n" "$MONGO_URI" > "$HOME/micro-analytics.env"
  awk -F= '/^MONGO_URI/ {print $2}' "$HOME/micro-analytics.env" | sed "s/^'//; s/'$//" | sed -n 'l;p' || true
  awk -F= '/^MONGO_URI/ {print $2}' "$HOME/micro-analytics.env" | sed "s/^'//; s/'$//" | od -An -t x1 -v || true
  if awk -F= '/^MONGO_URI/ {print $2}' "$HOME/micro-analytics.env" | sed "s/^'//; s/'$//" | od -An -t x1 -v | grep -qw '0a'; then
    echo "ERROR: MONGO_URI contains LF bytes after write on reportes host"; exit 2
  fi
REMOTE_EOF | sed 's/^/REMOTE-DECODE-REPORTES: /' | tee remote-decode-reportes.log >> repair-reportes.log || true

<<<<<<< HEAD
      - name: Remote sanitized write smoke test on notificaciones (non-destructive)
        run: |
          TARGET=${TARGET:-reportes}
          if [ "$TARGET" != "notificaciones" ] && [ "$TARGET" != "all" ]; then
            echo "Skipping remote write smoke (TARGET=$TARGET)"; exit 0
          fi
          echo "Attempting sanitized remote write on notificaciones host ${{ secrets.EC2_NOTIFICACIONES_HOST }}"
          MONGO_CLEAN=$(printf '%s' "${{ secrets.MONGO_URI }}" | tr -d '\r' | sed 's/\\n//g' | tr -d '\n')
          MONGO_B64=$(printf '%s' "$MONGO_CLEAN" | base64 -w0)
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_NOTIFICACIONES_HOST }} <<'REMOTE_EOF' || echo "REMOTE-NOTIF: ssh failed"
  echo '$MONGO_B64' > /tmp/mongo.b64 || true
  base64 -d /tmp/mongo.b64 | tr -d '\r\n' > /tmp/mongo.dec || true
  MONGO_URI="$(cat /tmp/mongo.dec)"
  printf "MONGO_URI='%s'\n" "$MONGO_URI" > "$HOME/micro-notificaciones.env"
  # post-write sanitization
  perl -0777 -pe 's/(MONGO_URI=')(.+?)(')/$1.(($2)=~s/[\r\n]+//gr).$3/egs' -i "$HOME/micro-notificaciones.env" || true
  awk -F= '/^MONGO_URI/ {print $2}' "$HOME/micro-notificaciones.env" | sed "s/^'//; s/'$//" | sed -n 'l;p' || true
  awk -F= '/^MONGO_URI/ {print $2}' "$HOME/micro-notificaciones.env" | sed "s/^'//; s/'$//" | od -An -t x1 -v || true
  if awk -F= '/^MONGO_URI/ {print $2}' "$HOME/micro-notificaciones.env" | sed "s/^'//; s/'$//" | od -An -t x1 -v | grep -qw '0a'; then
    echo "ERROR: MONGO_URI contains LF bytes after write on notificaciones host"; exit 2
  fi
REMOTE_EOF | sed 's/^/REMOTE-DECODE-NOTIF: /' | tee remote-decode-notif.log >> repair-notificaciones.log || true
=======
      - name: Write envs on reportes host
        run: |
          TARGET=${TARGET:-reportes}
          if [ "$TARGET" != "reportes" ] && [ "$TARGET" != "all" ]; then
            echo "Skipping reportes host (TARGET=$TARGET)"; exit 0
          fi
          echo "Writing env files on reportes host ${{ secrets.EC2_REPORTES_HOST }}"
          MONGO_B64=$(printf '%s' "${{ secrets.MONGO_URI }}" | base64 -w0)
          REDIS_HOST_B64=$(printf '%s' "${{ secrets.REDIS_HOST }}" | base64 -w0)
          REDIS_PORT_B64=$(printf '%s' "${{ secrets.REDIS_PORT }}" | base64 -w0)
          REDIS_PW_B64=$(printf '%s' "${{ secrets.REDIS_PASSWORD }}" | base64 -w0)

          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_REPORTES_HOST }} <<EOF
  # Decode and sanitize incoming values
  MONGO_URI=$(echo '$MONGO_B64' | base64 -d | tr -d '\r\n')
  REDIS_HOST=$(echo '$REDIS_HOST_B64' | base64 -d | tr -d '\r\n')
  REDIS_PORT=$(echo '$REDIS_PORT_B64' | base64 -d | tr -d '\r\n')
  REDIS_PASSWORD=$(echo '$REDIS_PW_B64' | base64 -d | tr -d '\r\n')

  cat > "$HOME/micro-analytics.env" <<ENV
  MONGO_URI='$MONGO_URI'
  REDIS_HOST='$REDIS_HOST'
  REDIS_PORT='$REDIS_PORT'
  REDIS_PASSWORD='$REDIS_PASSWORD'
  ENV

  cat > "$HOME/micro-reportes-estudiantes.env" <<ENV
  MONGO_URI='$MONGO_URI'
  ENV

  cat > "$HOME/micro-reportes-maestros.env" <<ENV
  MONGO_URI='$MONGO_URI'
  ENV

  echo "Env files written on reportes host"
  # Ensure no embedded newlines remain inside quoted values (defensive)
  perl -0777 -pe "s/(MONGO_URI=')(.+?)(')/\$1.(\$2=~s/[\r\n]+//gr).\$3/egs" -i "$HOME/micro-analytics.env"
  perl -0777 -pe "s/(MONGO_URI=')(.+?)(')/\$1.(\$2=~s/[\r\n]+//gr).\$3/egs" -i "$HOME/micro-reportes-estudiantes.env"
  perl -0777 -pe "s/(MONGO_URI=')(.+?)(')/\$1.(\$2=~s/[\r\n]+//gr).\$3/egs" -i "$HOME/micro-reportes-maestros.env"
EOF

      - name: Debug env bytes on reportes host
        run: |
          TARGET=${TARGET:-reportes}
          if [ "$TARGET" != "reportes" ] && [ "$TARGET" != "all" ]; then
            echo "Skipping debug for reportes host (TARGET=$TARGET)"; exit 0
          fi
          echo "Collecting byte-level debug of MONGO_URI on reportes host ${{ secrets.EC2_REPORTES_HOST }}"
          # Run hexdump on the host and also emit the readable "visible" form so we can tell if there are literal backslash-n
          # NOTE: do NOT suppress stderr here so any SSH/hexdump failures are visible in the workflow run log.
          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_REPORTES_HOST }} <<'EOF'
            echo "--- micro-analytics.env MONGO_URI (raw) ---"
            awk -F= '/^MONGO_URI/ {print $2}' "$HOME/micro-analytics.env" | sed "s/^'//; s/'$//" | sed -n 'l;p' || true
            echo "--- micro-analytics.env MONGO_URI (hex bytes) ---"
            awk -F= '/^MONGO_URI/ {print $2}' "$HOME/micro-analytics.env" | sed "s/^'//; s/'$//" | od -An -t x1 -v || true

            echo "--- micro-reportes-estudiantes.env MONGO_URI (raw) ---"
            awk -F= '/^MONGO_URI/ {print $2}' "$HOME/micro-reportes-estudiantes.env" | sed "s/^'//; s/'$//" | sed -n 'l;p' || true
            echo "--- micro-reportes-estudiantes.env MONGO_URI (hex bytes) ---"
            awk -F= '/^MONGO_URI/ {print $2}' "$HOME/micro-reportes-estudiantes.env" | sed "s/^'//; s/'$//" | od -An -t x1 -v || true

            echo "--- micro-reportes-maestros.env MONGO_URI (raw) ---"
            awk -F= '/^MONGO_URI/ {print $2}' "$HOME/micro-reportes-maestros.env" | sed "s/^'//; s/'$//" | sed -n 'l;p' || true
            echo "--- micro-reportes-maestros.env MONGO_URI (hex bytes) ---"
            awk -F= '/^MONGO_URI/ {print $2}' "$HOME/micro-reportes-maestros.env" | sed "s/^'//; s/'$//" | od -An -t x1 -v || true
          EOF | sed 's/^/REPORTES-ENV: /' | tee repair-reportes-env-debug.log >> repair-reportes.log || true

      - name: Show env-debug file (for easier access in Actions UI)
        run: |
          TARGET=${TARGET:-reportes}
          if [ "$TARGET" != "reportes" ] && [ "$TARGET" != "all" ]; then
            echo "Skipping show env-debug for reportes host (TARGET=$TARGET)"; exit 0
          fi
          echo "--- repair-reportes-env-debug.log contents ---"
          if [ -f repair-reportes-env-debug.log ]; then sed -n '1,400p' repair-reportes-env-debug.log; else echo "(missing)"; fi

      - name: Write env on notificaciones host
        run: |
          TARGET=${TARGET:-reportes}
          if [ "$TARGET" != "notificaciones" ] && [ "$TARGET" != "all" ]; then
            echo "Skipping notificaciones host (TARGET=$TARGET)"; exit 0
          fi
          echo "Writing env file on notificaciones host ${{ secrets.EC2_NOTIFICACIONES_HOST }}"
          MONGO_B64=$(printf '%s' "${{ secrets.MONGO_URI }}" | base64 -w0)
          REDIS_HOST_B64=$(printf '%s' "${{ secrets.REDIS_HOST }}" | base64 -w0)
          REDIS_PORT_B64=$(printf '%s' "${{ secrets.REDIS_PORT }}" | base64 -w0)
          REDIS_PW_B64=$(printf '%s' "${{ secrets.REDIS_PASSWORD }}" | base64 -w0)

          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_NOTIFICACIONES_HOST }} <<EOF
  MONGO_URI=$(echo '$MONGO_B64' | base64 -d | tr -d '\r\n')
  REDIS_HOST=$(echo '$REDIS_HOST_B64' | base64 -d | tr -d '\r\n')
  REDIS_PORT=$(echo '$REDIS_PORT_B64' | base64 -d | tr -d '\r\n')
  REDIS_PASSWORD=$(echo '$REDIS_PW_B64' | base64 -d | tr -d '\r\n')

  cat > "$HOME/micro-notificaciones.env" <<ENV
  MONGO_URI='$MONGO_URI'
  REDIS_HOST='$REDIS_HOST'
  REDIS_PORT='$REDIS_PORT'
  REDIS_PASSWORD='$REDIS_PASSWORD'
  ENV

  echo "Env file written on notificaciones host"
EOF

      - name: Run fix script on reportes host
        run: |
          TARGET=${TARGET:-reportes}
          if [ "$TARGET" != "reportes" ] && [ "$TARGET" != "all" ]; then
            echo "Skipping fix script on reportes host (TARGET=$TARGET)"; exit 0
          fi
          echo "Running fix script on reportes host ${{ secrets.EC2_REPORTES_HOST }}"
          cat scripts/fix-deploy.sh | ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_REPORTES_HOST }} 'bash -s' | tee repair-reportes.log

      - name: Debug env bytes on notificaciones host
        run: |
          TARGET=${TARGET:-reportes}
          if [ "$TARGET" != "notificaciones" ] && [ "$TARGET" != "all" ]; then
            echo "Skipping debug for notificaciones host (TARGET=$TARGET)"; exit 0
          fi
          echo "Collecting byte-level debug of MONGO_URI on notificaciones host ${{ secrets.EC2_NOTIFICACIONES_HOST }}"
          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_NOTIFICACIONES_HOST }} <<'EOF' 2>/dev/null
            echo "--- micro-notificaciones.env MONGO_URI (hex bytes) ---"
            awk -F= '/^MONGO_URI/ {print $2}' "$HOME/micro-notificaciones.env" | sed "s/^'//; s/'$//" | od -An -t x1 -v || true
          EOF | sed 's/^/NOTIF-ENV: /' | tee repair-notificaciones-env-debug.log >> repair-notificaciones.log || true

      - name: Run fix script on notificaciones host
        run: |
          TARGET=${TARGET:-reportes}
          if [ "$TARGET" != "notificaciones" ] && [ "$TARGET" != "all" ]; then
            echo "Skipping fix script on notificaciones host (TARGET=$TARGET)"; exit 0
          fi
          echo "Running fix script on notificaciones host ${{ secrets.EC2_NOTIFICACIONES_HOST }}"
          cat scripts/fix-deploy.sh | ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_NOTIFICACIONES_HOST }} 'bash -s' | tee repair-notificaciones.log

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: repair-writeenv-logs
          path: repair-*.log

      - name: Upload env-debug artifacts (if any)
        uses: actions/upload-artifact@v4
        with:
          name: repair-env-debug
          path: repair-*-env-debug.log
      - name: Run fix script on notificaciones host
        if: ${{ github.event.inputs.target == 'notificaciones' || github.event.inputs.target == 'all' }}
        run: |
          echo "Running fix script on notificaciones host ${{ secrets.EC2_NOTIFICACIONES_HOST }}"
          cat scripts/fix-deploy.sh | ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_NOTIFICACIONES_HOST }} 'bash -s' | tee repair-notificaciones.log

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: repair-writeenv-logs
          path: repair-*.log
>>>>>>> origin/main
