name: ðŸš€ Deploy - Via Bastion SSH Tunnel

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  BASTION_IP: 52.6.170.44
  BASTION_USER: ubuntu

jobs:
  load-config:
    name: ðŸ“‹ Load Configuration
    runs-on: ubuntu-latest
    outputs:
      core-private: ${{ steps.load.outputs.core_private }}
      api-gateway-private: ${{ steps.load.outputs.api_gateway_private }}
      db-private: ${{ steps.load.outputs.db_private }}
      messaging-private: ${{ steps.load.outputs.messaging_private }}
      reportes-private: ${{ steps.load.outputs.reportes_private }}
      notificaciones-private: ${{ steps.load.outputs.notificaciones_private }}
      analytics-private: ${{ steps.load.outputs.analytics_private }}
      monitoring-private: ${{ steps.load.outputs.monitoring_private }}
      frontend-private: ${{ steps.load.outputs.frontend_private }}
      bastion-private: ${{ steps.load.outputs.bastion_private }}

    steps:
      - uses: actions/checkout@v3
      - id: load
        run: |
          python3 << 'PYTHON'
          import json
          import os
          with open('config/instance_ips.json', 'r') as f:
              instances = json.load(f)
          mapping = {
              'EC2-CORE': 'core', 'EC2-API-Gateway': 'api_gateway', 'EC2-DB': 'db',
              'EC2-Messaging': 'messaging', 'EC2-Reportes': 'reportes',
              'EC2-Notificaciones': 'notificaciones', 'EC2-Analytics': 'analytics',
              'EC2-Monitoring': 'monitoring', 'EC2-Frontend': 'frontend', 'EC-Bastion': 'bastion'
          }
          for instance_name, output_name in mapping.items():
              if instance_name in instances:
                  private_ip = instances[instance_name]['PrivateIpAddress']
                  print(f"::set-output name={output_name}_private::{private_ip}")
                  print(f"âœ… {instance_name}: {private_ip}")
          PYTHON

  deploy-core:
    name: "ðŸ³ EC2-CORE"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 25
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - name: Setup & Deploy via Bastion
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          SSH_OPTS="-o ConnectTimeout=15 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ~/.ssh/id_rsa"
          
          echo "ðŸš€ Deploying EC2-CORE via Bastion..."
          ssh $SSH_OPTS -J ${{ env.BASTION_USER }}@${{ env.BASTION_IP }} ${{ env.BASTION_USER }}@${{ needs.load-config.outputs.core-private }} bash -s << 'SCRIPT'
          cd /tmp || cd ~
          docker-compose -f docker-compose.ec2-core.yml down 2>/dev/null || true
          docker-compose -f docker-compose.ec2-core.yml up -d --no-build 2>&1 | head -10
          sleep 5 && docker-compose -f docker-compose.ec2-core.yml ps
          SCRIPT
          echo "âœ… EC2-CORE deployment complete"

  deploy-api-gateway:
    name: "ðŸŒ EC2-API-Gateway"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - name: Setup & Deploy via Bastion
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          SSH_OPTS="-o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa"
          
          echo "ðŸš€ Deploying EC2-API-Gateway via Bastion..."
          ssh $SSH_OPTS -J ${{ env.BASTION_USER }}@${{ env.BASTION_IP }} ${{ env.BASTION_USER }}@${{ needs.load-config.outputs.api-gateway-private }} bash -s << 'SCRIPT'
          cd /tmp || cd ~
          docker-compose -f docker-compose.api-gateway.yml down 2>/dev/null || true
          docker-compose -f docker-compose.api-gateway.yml up -d --no-build 2>&1 | head -10
          sleep 3 && docker-compose -f docker-compose.api-gateway.yml ps
          SCRIPT
          echo "âœ… API-Gateway deployment complete"

  deploy-db:
    name: "ðŸ—„ï¸  EC2-DB"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 20
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - name: Setup & Deploy via Bastion
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          SSH_OPTS="-o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa"
          
          echo "ðŸš€ Deploying EC2-DB via Bastion..."
          ssh $SSH_OPTS -J ${{ env.BASTION_USER }}@${{ env.BASTION_IP }} ${{ env.BASTION_USER }}@${{ needs.load-config.outputs.db-private }} bash -s << 'SCRIPT'
          cd /tmp || cd ~
          docker-compose -f docker-compose.ec2-db.yml down 2>/dev/null || true
          docker-compose -f docker-compose.ec2-db.yml up -d --no-build 2>&1 | head -10
          sleep 5 && docker-compose -f docker-compose.ec2-db.yml ps
          SCRIPT
          echo "âœ… DB deployment complete"

  deploy-messaging:
    name: "â±ï¸  EC2-Messaging"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - name: Setup & Deploy via Bastion
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          SSH_OPTS="-o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa"
          
          echo "ðŸš€ Deploying EC2-Messaging via Bastion..."
          ssh $SSH_OPTS -J ${{ env.BASTION_USER }}@${{ env.BASTION_IP }} ${{ env.BASTION_USER }}@${{ needs.load-config.outputs.messaging-private }} bash -s << 'SCRIPT'
          cd /tmp || cd ~
          docker-compose -f docker-compose.messaging.yml down 2>/dev/null || true
          docker-compose -f docker-compose.messaging.yml up -d --no-build 2>&1 | head -10
          sleep 3 && docker-compose -f docker-compose.messaging.yml ps
          SCRIPT
          echo "âœ… Messaging deployment complete"

  deploy-reportes:
    name: "ðŸ“„ EC2-Reportes"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - name: Setup & Deploy via Bastion
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          SSH_OPTS="-o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa"
          
          echo "ðŸš€ Deploying EC2-Reportes via Bastion..."
          ssh $SSH_OPTS -J ${{ env.BASTION_USER }}@${{ env.BASTION_IP }} ${{ env.BASTION_USER }}@${{ needs.load-config.outputs.reportes-private }} bash -s << 'SCRIPT'
          cd /tmp || cd ~
          docker-compose -f docker-compose.ec2-reportes.yml down 2>/dev/null || true
          docker-compose -f docker-compose.ec2-reportes.yml up -d --no-build 2>&1 | head -10
          sleep 3 && docker-compose -f docker-compose.ec2-reportes.yml ps
          SCRIPT
          echo "âœ… Reportes deployment complete"

  deploy-notificaciones:
    name: "ðŸ”” EC2-Notificaciones"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - name: Setup & Deploy via Bastion
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          SSH_OPTS="-o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa"
          
          echo "ðŸš€ Deploying EC2-Notificaciones via Bastion..."
          ssh $SSH_OPTS -J ${{ env.BASTION_USER }}@${{ env.BASTION_IP }} ${{ env.BASTION_USER }}@${{ needs.load-config.outputs.notificaciones-private }} bash -s << 'SCRIPT'
          cd /tmp || cd ~
          docker-compose -f docker-compose.ec2-notificaciones.yml down 2>/dev/null || true
          docker-compose -f docker-compose.ec2-notificaciones.yml up -d --no-build 2>&1 | head -10
          sleep 3 && docker-compose -f docker-compose.ec2-notificaciones.yml ps
          SCRIPT
          echo "âœ… Notificaciones deployment complete"

  deploy-analytics:
    name: "ðŸ“Š EC2-Analytics"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - name: Setup & Deploy via Bastion
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          SSH_OPTS="-o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa"
          
          echo "ðŸš€ Deploying EC2-Analytics via Bastion..."
          ssh $SSH_OPTS -J ${{ env.BASTION_USER }}@${{ env.BASTION_IP }} ${{ env.BASTION_USER }}@${{ needs.load-config.outputs.analytics-private }} bash -s << 'SCRIPT'
          cd /tmp || cd ~
          docker-compose -f docker-compose.ec2-analytics.yml down 2>/dev/null || true
          docker-compose -f docker-compose.ec2-analytics.yml up -d --no-build 2>&1 | head -10
          sleep 3 && docker-compose -f docker-compose.ec2-analytics.yml ps
          SCRIPT
          echo "âœ… Analytics deployment complete"

  deploy-monitoring:
    name: "ðŸ“ˆ EC2-Monitoring"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - name: Setup & Deploy via Bastion
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          SSH_OPTS="-o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa"
          
          echo "ðŸš€ Deploying EC2-Monitoring via Bastion..."
          ssh $SSH_OPTS -J ${{ env.BASTION_USER }}@${{ env.BASTION_IP }} ${{ env.BASTION_USER }}@${{ needs.load-config.outputs.monitoring-private }} bash -s << 'SCRIPT'
          cd /tmp || cd ~
          docker-compose -f docker-compose.ec2-monitoring.yml down 2>/dev/null || true
          docker-compose -f docker-compose.ec2-monitoring.yml up -d --no-build 2>&1 | head -10
          sleep 3 && docker-compose -f docker-compose.ec2-monitoring.yml ps
          SCRIPT
          echo "âœ… Monitoring deployment complete"

  deploy-frontend:
    name: "ðŸŽ¨ EC2-Frontend"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - name: Setup & Deploy via Bastion
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          SSH_OPTS="-o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa"
          
          echo "ðŸš€ Deploying EC2-Frontend via Bastion..."
          ssh $SSH_OPTS -J ${{ env.BASTION_USER }}@${{ env.BASTION_IP }} ${{ env.BASTION_USER }}@${{ needs.load-config.outputs.frontend-private }} bash -s << 'SCRIPT'
          cd /tmp || cd ~
          docker-compose -f docker-compose.ec2-frontend.yml down 2>/dev/null || true
          docker-compose -f docker-compose.ec2-frontend.yml up -d --no-build 2>&1 | head -10
          sleep 3 && docker-compose -f docker-compose.ec2-frontend.yml ps
          SCRIPT
          echo "âœ… Frontend deployment complete"

  deploy-bastion:
    name: "ðŸ›¡ï¸  EC-Bastion"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - name: Setup & Deploy Bastion (Direct SSH)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          SSH_OPTS="-o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa"
          
          echo "ðŸš€ Deploying Bastion (Direct SSH)..."
          ssh $SSH_OPTS ubuntu@${{ env.BASTION_IP }} bash -s << 'SCRIPT'
          cd /tmp || cd ~
          docker-compose -f docker-compose.bastion.yml down 2>/dev/null || true
          docker-compose -f docker-compose.bastion.yml up -d --no-build 2>&1 | head -10
          sleep 3 && docker-compose -f docker-compose.bastion.yml ps
          SCRIPT
          echo "âœ… Bastion deployment complete"

  status:
    name: "âœ… Done"
    needs: [deploy-core, deploy-api-gateway, deploy-db, deploy-messaging, deploy-reportes, deploy-notificaciones, deploy-analytics, deploy-monitoring, deploy-frontend, deploy-bastion]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - run: echo "ðŸŽ‰ Deployment workflow complete!"
