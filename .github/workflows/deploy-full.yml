name: Deploy Project - Full Pipeline

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/deploy-full.yml'
      - 'infrastructure-instances.config.js'
  workflow_dispatch:
    inputs:
      deploy_services:
        description: Deploy services to instances
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      environment:
        description: Environment (dev/staging/prod)
        required: false
        default: 'prod'
        type: choice
        options:
          - dev
          - staging
          - prod

jobs:
  discover-and-update:
    name: Discover IPs & Update Configuration
    runs-on: ubuntu-latest
    outputs:
      instances_json: ${{ steps.generate-config.outputs.config }}
      bastion_ip: ${{ steps.discover.outputs.bastion_public_ip }}
    
    steps:
    - uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: us-east-1

    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Discover EC2 instances with all IP types
      id: discover
      run: |
        # Get all instances with Project=lab-8-ec2 tag
        echo "Querying EC2 instances..."
        INSTANCES=$(aws ec2 describe-instances \
          --filters "Name=tag:Project,Values=lab-8-ec2" "Name=instance-state-name,Values=running" \
          --query 'Reservations[*].Instances[*].[
            Tags[?Key==`Name`].Value|[0],
            InstanceId,
            PrivateIpAddress,
            PublicIpAddress,
            State.Name
          ]' \
          --output json)
        
        echo "Raw instances data:"
        echo "$INSTANCES" | jq '.'
        
        # Get Elastic IPs
        echo "Querying Elastic IPs..."
        ELASTIC_IPS=$(aws ec2 describe-addresses \
          --query 'Addresses[*].[InstanceId, PublicIp, AllocationId]' \
          --output json)
        
        echo "Elastic IPs:"
        echo "$ELASTIC_IPS" | jq '.'
        
        # Create comprehensive instance map
        INSTANCE_MAP=$(echo "$INSTANCES" | jq -c '
          [.[][] | select(.[0] != null)] |
          map({
            name: .[0],
            instance_id: .[1],
            private_ip: .[2],
            public_ip: (.[3] // .[2]),
            state: .[4]
          }) |
          map({(.name): .}) |
          add
        ')
        
        # Enrich with Elastic IPs
        ENRICHED=$(echo "$INSTANCE_MAP" | jq \
          --argjson eips "$ELASTIC_IPS" '
          . as $instances |
          ($eips | map({(.[0]): .[1]}) | add) as $eip_map |
          to_entries | map(
            .value |= (. + {
              elastic_ip: ($eip_map[.instance_id] // .public_ip)
            })
          ) | from_entries
        ')
        
        echo "Final instance mapping:"
        echo "$ENRICHED" | jq '.'
        
        # Output for next steps
        echo "instances_json=$ENRICHED" >> $GITHUB_OUTPUT
        
        # Get Bastion IPs
        BASTION_PRIVATE=$(echo "$ENRICHED" | jq -r '.["EC-Bastion"].private_ip // "unknown"')
        BASTION_PUBLIC=$(echo "$ENRICHED" | jq -r '.["EC-Bastion"].public_ip // "unknown"')
        BASTION_ELASTIC=$(echo "$ENRICHED" | jq -r '.["EC-Bastion"].elastic_ip // "unknown"')
        
        echo "bastion_private_ip=$BASTION_PRIVATE" >> $GITHUB_OUTPUT
        echo "bastion_public_ip=$BASTION_PUBLIC" >> $GITHUB_OUTPUT
        echo "bastion_elastic_ip=$BASTION_ELASTIC" >> $GITHUB_OUTPUT
        
        echo ""
        echo "=== BASTION GATEWAY ==="
        echo "Private: $BASTION_PRIVATE"
        echo "Public: $BASTION_PUBLIC"
        echo "Elastic: $BASTION_ELASTIC"

    - name: Generate project configuration
      id: generate-config
      run: |
        INSTANCES='${{ steps.discover.outputs.instances_json }}'
        ENV='${{ github.event.inputs.environment || "prod" }}'
        
        # Generate Node.js config file
        cat > infrastructure-instances.config.js << 'EOF'
/**
 * AUTO-GENERATED: Instance Configuration with Dynamic IPs
 * Generated: $(date -u)
 * Do NOT edit manually - Updated by CI/CD pipeline
 */
module.exports = {
  environment: 'ENV_PLACEHOLDER',
  timestamp: '$(date -u)',
  
  // Instance IP mappings - Used for inter-service communication
  instances: IP_MAP_PLACEHOLDER,
  
  // Service routing configuration
  services: {
    frontend: {
      name: 'EC2-Frontend',
      ports: { http: 3000, https: 3001 },
      health: '/health'
    },
    api_gateway: {
      name: 'EC2-API-Gateway',
      ports: { http: 8080, https: 8443 },
      health: '/api/health'
    },
    core: {
      name: 'EC2-CORE',
      ports: { http: 8081, https: 8444 },
      health: '/api/status'
    },
    database: {
      name: 'EC2-DB',
      ports: { postgres: 5432 },
      health: null
    },
    messaging: {
      name: 'EC2-Messaging',
      ports: { amqp: 5672, http: 15672 },
      health: null
    },
    notifications: {
      name: 'EC2-Notificaciones',
      ports: { http: 8082, https: 8445 },
      health: '/notifications/health'
    },
    reports: {
      name: 'EC2-Reportes',
      ports: { http: 8083, https: 8446 },
      health: '/reports/health'
    },
    monitoring: {
      name: 'EC2-Monitoring',
      ports: { prometheus: 9090, grafana: 3000 },
      health: '/-/healthy'
    }
  },
  
  // Network configuration
  network: {
    bastion: {
      private_ip: 'BASTION_PRIVATE_PLACEHOLDER',
      public_ip: 'BASTION_PUBLIC_PLACEHOLDER',
      elastic_ip: 'BASTION_ELASTIC_PLACEHOLDER'
    },
    alb: {
      dns_name: 'lab-alb-2074b0bbcd4d7bbc.us-east-1.elb.amazonaws.com',
      targets: ['EC2-Frontend', 'EC2-API-Gateway', 'EC2-Reportes']
    }
  },
  
  // Helper function to get instance IP
  getInstanceIP: function(instanceName, ipType = 'private') {
    const instance = this.instances[instanceName];
    if (!instance) return null;
    
    switch(ipType.toLowerCase()) {
      case 'public': return instance.public_ip;
      case 'elastic': return instance.elastic_ip;
      case 'private':
      default: return instance.private_ip;
    }
  },
  
  // Helper function to get service URL
  getServiceURL: function(serviceName, protocol = 'http') {
    const service = this.services[serviceName];
    if (!service) return null;
    
    const instance = this.instances[service.name];
    if (!instance) return null;
    
    const ip = instance.private_ip; // Use private IP for internal communication
    const port = protocol === 'https' ? service.ports.https : service.ports.http;
    
    return `${protocol}://${ip}:${port}`;
  },
  
  // Connection string builders
  database: {
    postgres: {
      host: 'IP_PLACEHOLDER_DB',
      port: 5432,
      database: 'acompanamiento',
      connection_string: 'postgresql://user:pass@IP_PLACEHOLDER_DB:5432/acompanamiento'
    }
  },
  
  // Message queue configuration
  messaging: {
    rabbitmq: {
      host: 'IP_PLACEHOLDER_MESSAGING',
      port: 5672,
      amqp_uri: 'amqp://guest:guest@IP_PLACEHOLDER_MESSAGING:5672/'
    }
  }
};
EOF
        
        # Replace placeholders with actual data
        sed -i "s|ENV_PLACEHOLDER|$ENV|g" infrastructure-instances.config.js
        sed -i "s|IP_MAP_PLACEHOLDER|$(echo "$INSTANCES" | jq -c '.')|g" infrastructure-instances.config.js
        sed -i "s|BASTION_PRIVATE_PLACEHOLDER|${{ steps.discover.outputs.bastion_private_ip }}|g" infrastructure-instances.config.js
        sed -i "s|BASTION_PUBLIC_PLACEHOLDER|${{ steps.discover.outputs.bastion_public_ip }}|g" infrastructure-instances.config.js
        sed -i "s|BASTION_ELASTIC_PLACEHOLDER|${{ steps.discover.outputs.bastion_elastic_ip }}|g" infrastructure-instances.config.js
        sed -i "s|IP_PLACEHOLDER_DB|$(echo "$INSTANCES" | jq -r '.["EC2-DB"].private_ip')|g" infrastructure-instances.config.js
        sed -i "s|IP_PLACEHOLDER_MESSAGING|$(echo "$INSTANCES" | jq -r '.["EC2-Messaging"].private_ip')|g" infrastructure-instances.config.js
        
        echo "✓ infrastructure-instances.config.js generated"
        
        # Generate .env file for Docker
        cat > .env.generated << 'ENVEOF'
# Auto-generated environment variables
ENVIRONMENT=ENV_PLACEHOLDER
DEPLOYMENT_TIME=$(date -u)

# Instance IPs - Internal Communication
EC2_FRONTEND_PRIVATE=FRONTEND_PRIVATE_PLACEHOLDER
EC2_FRONTEND_PUBLIC=FRONTEND_PUBLIC_PLACEHOLDER
EC2_FRONTEND_ELASTIC=FRONTEND_ELASTIC_PLACEHOLDER

EC2_API_GATEWAY_PRIVATE=API_PRIVATE_PLACEHOLDER
EC2_API_GATEWAY_PUBLIC=API_PUBLIC_PLACEHOLDER
EC2_API_GATEWAY_ELASTIC=API_ELASTIC_PLACEHOLDER

EC2_CORE_PRIVATE=CORE_PRIVATE_PLACEHOLDER
EC2_CORE_PUBLIC=CORE_PUBLIC_PLACEHOLDER
EC2_CORE_ELASTIC=CORE_ELASTIC_PLACEHOLDER

EC2_DB_PRIVATE=DB_PRIVATE_PLACEHOLDER
EC2_DB_PUBLIC=DB_PUBLIC_PLACEHOLDER
EC2_DB_ELASTIC=DB_ELASTIC_PLACEHOLDER

EC2_MESSAGING_PRIVATE=MESSAGING_PRIVATE_PLACEHOLDER
EC2_MESSAGING_PUBLIC=MESSAGING_PUBLIC_PLACEHOLDER
EC2_MESSAGING_ELASTIC=MESSAGING_ELASTIC_PLACEHOLDER

# Service URLs - Use private IPs for internal communication
DATABASE_HOST=DB_PRIVATE_PLACEHOLDER
DATABASE_PORT=5432
DATABASE_URL=postgresql://user:pass@DB_PRIVATE_PLACEHOLDER:5432/acompanamiento

RABBITMQ_HOST=MESSAGING_PRIVATE_PLACEHOLDER
RABBITMQ_PORT=5672
RABBITMQ_URL=amqp://guest:guest@MESSAGING_PRIVATE_PLACEHOLDER:5672/

# API Gateway configuration
API_GATEWAY_HOST=API_PRIVATE_PLACEHOLDER
API_GATEWAY_PORT=8080

# Core service configuration
CORE_SERVICE_HOST=CORE_PRIVATE_PLACEHOLDER
CORE_SERVICE_PORT=8081

# Bastion gateway for external access
BASTION_HOST=BASTION_PUBLIC_PLACEHOLDER
BASTION_PORT=22
BASTION_USER=ubuntu
ENVEOF
        
        # Replace placeholders
        sed -i "s|ENV_PLACEHOLDER|$ENV|g" .env.generated
        
        FRONTEND_INST=$(echo "$INSTANCES" | jq -r '.["EC2-Frontend"]')
        sed -i "s|FRONTEND_PRIVATE_PLACEHOLDER|$(echo "$FRONTEND_INST" | jq -r '.private_ip')|g" .env.generated
        sed -i "s|FRONTEND_PUBLIC_PLACEHOLDER|$(echo "$FRONTEND_INST" | jq -r '.public_ip')|g" .env.generated
        sed -i "s|FRONTEND_ELASTIC_PLACEHOLDER|$(echo "$FRONTEND_INST" | jq -r '.elastic_ip')|g" .env.generated
        
        API_INST=$(echo "$INSTANCES" | jq -r '.["EC2-API-Gateway"]')
        sed -i "s|API_PRIVATE_PLACEHOLDER|$(echo "$API_INST" | jq -r '.private_ip')|g" .env.generated
        sed -i "s|API_PUBLIC_PLACEHOLDER|$(echo "$API_INST" | jq -r '.public_ip')|g" .env.generated
        sed -i "s|API_ELASTIC_PLACEHOLDER|$(echo "$API_INST" | jq -r '.elastic_ip')|g" .env.generated
        
        CORE_INST=$(echo "$INSTANCES" | jq -r '.["EC2-CORE"]')
        sed -i "s|CORE_PRIVATE_PLACEHOLDER|$(echo "$CORE_INST" | jq -r '.private_ip')|g" .env.generated
        sed -i "s|CORE_PUBLIC_PLACEHOLDER|$(echo "$CORE_INST" | jq -r '.public_ip')|g" .env.generated
        sed -i "s|CORE_ELASTIC_PLACEHOLDER|$(echo "$CORE_INST" | jq -r '.elastic_ip')|g" .env.generated
        
        DB_INST=$(echo "$INSTANCES" | jq -r '.["EC2-DB"]')
        sed -i "s|DB_PRIVATE_PLACEHOLDER|$(echo "$DB_INST" | jq -r '.private_ip')|g" .env.generated
        sed -i "s|DB_PUBLIC_PLACEHOLDER|$(echo "$DB_INST" | jq -r '.public_ip')|g" .env.generated
        sed -i "s|DB_ELASTIC_PLACEHOLDER|$(echo "$DB_INST" | jq -r '.elastic_ip')|g" .env.generated
        
        MSG_INST=$(echo "$INSTANCES" | jq -r '.["EC2-Messaging"]')
        sed -i "s|MESSAGING_PRIVATE_PLACEHOLDER|$(echo "$MSG_INST" | jq -r '.private_ip')|g" .env.generated
        sed -i "s|MESSAGING_PUBLIC_PLACEHOLDER|$(echo "$MSG_INST" | jq -r '.public_ip')|g" .env.generated
        sed -i "s|MESSAGING_ELASTIC_PLACEHOLDER|$(echo "$MSG_INST" | jq -r '.elastic_ip')|g" .env.generated
        
        sed -i "s|BASTION_PUBLIC_PLACEHOLDER|${{ steps.discover.outputs.bastion_public_ip }}|g" .env.generated
        
        echo "✓ .env.generated created"
        
        # Output config for next jobs
        echo "config=$(cat infrastructure-instances.config.js | jq -Rs '.')" >> $GITHUB_OUTPUT
        
        echo ""
        echo "=== GENERATED FILES ==="
        echo "infrastructure-instances.config.js:"
        head -30 infrastructure-instances.config.js
        echo ""
        echo ".env.generated:"
        head -20 .env.generated

    - name: Commit configuration updates
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        git add infrastructure-instances.config.js .env.generated
        
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore: Auto-update instance configuration with current IPs
          
          - Updated with discovered EC2 instance IPs
          - Includes private, public, and elastic IPs
          - Generated for environment: ${{ github.event.inputs.environment || 'prod' }}
          - Timestamp: $(date -u)"
          git push
        fi

  deploy-services:
    name: Deploy Services to Instances
    runs-on: ubuntu-latest
    needs: discover-and-update
    if: ${{ github.event.inputs.deploy_services == 'true' }}
    
    steps:
    - uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: us-east-1

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H github.com >> ~/.ssh/known_hosts 2>/dev/null || true

    - name: Deploy to all instances
      run: |
        INSTANCES='${{ needs.discover-and-update.outputs.instances_json }}'
        BASTION_IP='${{ needs.discover-and-update.outputs.bastion_ip }}'
        
        echo "Deploying to instances..."
        echo "$INSTANCES" | jq -r 'to_entries[] | "\(.key)|\(.value.private_ip)|\(.value.public_ip)"' | while IFS='|' read NAME PRIVATE PUBLIC; do
          
          [ -z "$NAME" ] && continue
          
          echo ""
          echo "=========================================="
          echo "Deploying to: $NAME"
          echo "  Private IP: $PRIVATE"
          echo "  Public IP: $PUBLIC"
          echo "=========================================="
          
          # Prepare deployment script
          cat > /tmp/deploy-${NAME}.sh << 'DEPLOY_SCRIPT'
#!/bin/bash
set -e

INSTANCE_NAME=$1
ENVIRONMENT=$2

echo "[$(date)] Starting deployment on $INSTANCE_NAME..."

# Update system
sudo apt-get update -y

# Install Docker if not present
if ! command -v docker &> /dev/null; then
  echo "Installing Docker..."
  sudo apt-get install -y docker.io
  sudo systemctl enable docker
  sudo systemctl start docker
  sudo usermod -aG docker ubuntu
fi

# Install Docker Compose if not present
if ! command -v docker-compose &> /dev/null; then
  echo "Installing Docker Compose..."
  sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  sudo chmod +x /usr/local/bin/docker-compose
fi

# Clone repository if needed
if [ ! -d "app" ]; then
  git clone https://github.com/$GITHUB_REPOSITORY.git app
fi

cd app
git pull origin main

# Deploy based on instance type
case $INSTANCE_NAME in
  EC2-Frontend)
    echo "Deploying Frontend service..."
    if [ -f "docker-compose.frontend.yml" ]; then
      docker-compose -f docker-compose.frontend.yml down 2>/dev/null || true
      docker-compose -f docker-compose.frontend.yml up -d
    fi
    ;;
  EC2-API-Gateway)
    echo "Deploying API Gateway service..."
    if [ -f "docker-compose.api-gateway.yml" ]; then
      docker-compose -f docker-compose.api-gateway.yml down 2>/dev/null || true
      docker-compose -f docker-compose.api-gateway.yml up -d
    fi
    ;;
  EC2-CORE)
    echo "Deploying CORE service..."
    if [ -f "docker-compose.core.yml" ]; then
      docker-compose -f docker-compose.core.yml down 2>/dev/null || true
      docker-compose -f docker-compose.core.yml up -d
    fi
    ;;
  EC2-DB)
    echo "Deploying Database service..."
    if [ -f "databases/docker-compose.yml" ]; then
      docker-compose -f databases/docker-compose.yml down 2>/dev/null || true
      docker-compose -f databases/docker-compose.yml up -d
    fi
    ;;
  EC2-Messaging)
    echo "Deploying Messaging service..."
    if [ -f "docker-compose.messaging.yml" ]; then
      docker-compose -f docker-compose.messaging.yml down 2>/dev/null || true
      docker-compose -f docker-compose.messaging.yml up -d
    fi
    ;;
  EC2-Notificaciones)
    echo "Deploying Notifications service..."
    if [ -f "docker-compose.notificaciones.yml" ]; then
      docker-compose -f docker-compose.notificaciones.yml down 2>/dev/null || true
      docker-compose -f docker-compose.notificaciones.yml up -d
    fi
    ;;
  EC2-Reportes)
    echo "Deploying Reports service..."
    if [ -f "docker-compose.reportes.yml" ]; then
      docker-compose -f docker-compose.reportes.yml down 2>/dev/null || true
      docker-compose -f docker-compose.reportes.yml up -d
    fi
    ;;
  EC2-Monitoring)
    echo "Deploying Monitoring service..."
    if [ -f "docker-compose.infrastructure.yml" ]; then
      docker-compose -f docker-compose.infrastructure.yml down 2>/dev/null || true
      docker-compose -f docker-compose.infrastructure.yml up -d
    fi
    ;;
  *)
    echo "Unknown instance: $INSTANCE_NAME"
    ;;
esac

echo "[$(date)] Deployment completed on $INSTANCE_NAME"
docker ps -a
DEPLOY_SCRIPT
          
          chmod +x /tmp/deploy-${NAME}.sh
          
          # Execute via SSH (direct or via Bastion)
          if [ ! -z "$BASTION_IP" ] && [ "$BASTION_IP" != "null" ] && [ "$BASTION_IP" != "unknown" ]; then
            echo "Using Bastion proxy: $BASTION_IP"
            scp -o StrictHostKeyChecking=no -o ProxyCommand="ssh -o StrictHostKeyChecking=no -W %h:%p ubuntu@$BASTION_IP" \
              /tmp/deploy-${NAME}.sh ubuntu@${PRIVATE}:/tmp/deploy.sh 2>/dev/null || true
            ssh -o StrictHostKeyChecking=no -o ProxyCommand="ssh -o StrictHostKeyChecking=no -W %h:%p ubuntu@$BASTION_IP" \
              ubuntu@${PRIVATE} "bash /tmp/deploy.sh '$NAME' '${{ github.event.inputs.environment || 'prod' }}'" 2>/dev/null || echo "Could not connect via Bastion"
          else
            echo "Direct connection to $PUBLIC"
            scp -o StrictHostKeyChecking=no -o ConnectTimeout=5 /tmp/deploy-${NAME}.sh ubuntu@${PUBLIC}:/tmp/deploy.sh 2>/dev/null || true
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 ubuntu@${PUBLIC} "bash /tmp/deploy.sh '$NAME' '${{ github.event.inputs.environment || 'prod' }}'" 2>/dev/null || echo "Could not connect to $PUBLIC"
          fi
        done

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [discover-and-update, deploy-services]
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "# Deployment Complete ✅"
        echo ""
        echo "## Instances Configuration"
        echo '```json'
        echo '${{ needs.discover-and-update.outputs.instances_json }}' | jq '.'
        echo '```'
        echo ""
        echo "## Bastion Gateway"
        echo "- IP: ${{ needs.discover-and-update.outputs.bastion_ip }}"
        echo ""
        echo "## Configuration Files Generated"
        echo "- infrastructure-instances.config.js (Node.js configuration)"
        echo "- .env.generated (Environment variables)"
        echo ""
        echo "All configuration files have been committed to the repository."
