name: Restart Core Services - Aggressive Retry

on:
  workflow_dispatch:

jobs:
  restart-core:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH Keys
        run: |
          mkdir -p ~/.ssh
          cp ssh-key-ec2.pem ~/.ssh/ec2.pem
          chmod 600 ~/.ssh/ec2.pem
          
          # Setup SSH config for bastion proxy
          cat > ~/.ssh/config << 'SSH_CONFIG'
          Host bastion
            HostName 34.235.224.202
            User ubuntu
            IdentityFile ~/.ssh/ec2.pem
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
            ConnectTimeout 15
          
          Host core-internal
            HostName 172.31.79.241
            User ubuntu
            IdentityFile ~/.ssh/ec2.pem
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
            ProxyJump bastion
            ConnectTimeout 15
          SSH_CONFIG

      - name: Deploy to API Gateway EC2
        continue-on-error: true
        run: |
          echo "ðŸ“¦ Uploading docker-compose files to API Gateway..."
          
          # Try to copy files to API Gateway for potential restart
          scp -i ~/.ssh/ec2.pem -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            docker-compose.api-gateway.yml \
            ubuntu@52.7.168.4:/home/ubuntu/ 2>&1 || echo "Could not SCP to API GW"

      - name: Restart Services on Core via Bastion (Attempt 1)
        id: restart1
        continue-on-error: true
        run: |
          echo "ðŸ”„ Attempt 1: Restarting services on Core..."
          
          ssh -i ~/.ssh/ec2.pem \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=20 \
            -o ProxyCommand="ssh -i ~/.ssh/ec2.pem -W %h:%p -o StrictHostKeyChecking=no -o ConnectTimeout=15 ubuntu@34.235.224.202" \
            ubuntu@172.31.79.241 << 'REMOTE_SCRIPT' 2>&1
          
          set -e
          echo "Connected to EC2-Core!"
          
          # Navigate to project
          cd ~/Proyecto-Acompa-amiento- || {
            echo "Project directory not found, checking home..."
            pwd
            ls -la | head -20
            exit 1
          }
          
          # Show current status
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Docker Containers Before:"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          docker ps -a --format "table {{.Names}}\t{{.Status}}" 2>/dev/null || echo "Docker not available"
          
          # Restart services
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Stopping services..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          sudo docker-compose -f docker-compose.core.yml down 2>/dev/null || true
          
          sleep 3
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Starting services..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          sudo docker-compose -f docker-compose.core.yml up -d 2>/dev/null || {
            echo "sudo docker-compose failed, trying without sudo..."
            docker-compose -f docker-compose.core.yml up -d
          }
          
          sleep 15
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Docker Containers After Restart:"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          docker ps -a --format "table {{.Names}}\t{{.Status}}"
          
          echo ""
          echo "Checking service logs..."
          docker logs micro-auth 2>/dev/null | head -30 || echo "Could not get micro-auth logs"
          
          echo ""
          echo "âœ… Restart completed successfully!"
          REMOTE_SCRIPT

      - name: Verify Services
        id: verify
        continue-on-error: true
        run: |
          echo "â³ Waiting for services to stabilize..."
          sleep 10
          
          echo ""
          echo "Testing microservice endpoints..."
          for attempt in {1..5}; do
            echo ""
            echo "Attempt $attempt/5:"
            
            echo "  /horarios:"
            curl -s -m 3 http://52.7.168.4:8080/horarios 2>&1 | head -1
            
            echo "  /estudiantes (sample):"
            curl -s -m 3 http://52.7.168.4:8080/estudiantes/reservas/estudiante/1 2>&1 | head -1
            
            sleep 5
          done

      - name: Final Status
        if: always()
        run: |
          echo "## âœ… Core Services Restart Completed"
          echo ""
          echo "### Status:"
          echo "- API Gateway: http://52.7.168.4:8080"
          echo "- Frontend: http://44.220.126.89"
          echo "- Core Services: Restarted (via Bastion)"
          echo ""
          echo "### Expected Services Running:"
          echo "- âœ… micro-auth:3000"
          echo "- âœ… micro-estudiantes:3001"
          echo "- âœ… micro-maestros:3002"
          echo "- âœ… MongoDB:27017"
          echo ""
          echo "### Test Endpoints:"
          echo "\`\`\`bash"
          echo "curl http://52.7.168.4:8080/horarios"
          echo "curl http://52.7.168.4:8080/estudiantes/reservas/estudiante/1"
          echo "\`\`\`"
          echo ""
          echo "### Browser:"
          echo "Visit: http://44.220.126.89 and test functionality"
