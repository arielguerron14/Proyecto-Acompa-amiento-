name: Deploy Services via SSH

on:
  workflow_dispatch:
    inputs:
      instances:
        description: 'Which instances to deploy to'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - frontend
          - api-gateway
          - core
          - db
          - messaging
          - notificaciones
          - reportes
          - monitoring

jobs:
  deploy:
    name: Deploy Docker Services
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 44.220.126.89 >> ~/.ssh/known_hosts 2>/dev/null || true
        ssh-keyscan -H 52.7.168.4 >> ~/.ssh/known_hosts 2>/dev/null || true
        ssh-keyscan -H 13.222.63.75 >> ~/.ssh/known_hosts 2>/dev/null || true
        ssh-keyscan -H 100.31.104.252 >> ~/.ssh/known_hosts 2>/dev/null || true
        ssh-keyscan -H 98.93.37.132 >> ~/.ssh/known_hosts 2>/dev/null || true
        ssh-keyscan -H 3.236.139.55 >> ~/.ssh/known_hosts 2>/dev/null || true
        ssh-keyscan -H 52.200.32.56 >> ~/.ssh/known_hosts 2>/dev/null || true
        ssh-keyscan -H 98.88.93.98 >> ~/.ssh/known_hosts 2>/dev/null || true
    
    - name: Deploy to Frontend
      if: ${{ inputs.instances == 'all' || inputs.instances == 'frontend' }}
      run: |
        echo "ðŸš€ Deploying Frontend..."
        ssh -i ~/.ssh/id_rsa -o ConnectTimeout=10 ubuntu@44.220.126.89 << 'EOF'
        set -e
        echo "ðŸ“¦ Preparing deployment..."
        cd /home/ubuntu
        if [ -d "Proyecto-Acompa-amiento-" ]; then
          cd Proyecto-Acompa-amiento-
          git pull origin main
        else
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
        fi
        echo "ðŸ³ Starting Frontend services..."
        docker-compose -f docker-compose.frontend.yml up -d
        echo "âœ… Frontend deployed - Containers running:"
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        EOF
    
    - name: Deploy to API Gateway
      if: ${{ inputs.instances == 'all' || inputs.instances == 'api-gateway' }}
      run: |
        echo "ðŸš€ Deploying API Gateway..."
        ssh -i ~/.ssh/id_rsa -o ConnectTimeout=10 ubuntu@52.7.168.4 << 'EOF'
        set -e
        cd /home/ubuntu
        if [ -d "Proyecto-Acompa-amiento-" ]; then
          cd Proyecto-Acompa-amiento-
          git pull origin main
        else
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
        fi
        echo "ðŸ³ Starting API Gateway services..."
        docker-compose -f docker-compose.api-gateway.yml up -d
        echo "âœ… API Gateway deployed - Containers running:"
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        EOF
    
    - name: Deploy to Core Services
      if: ${{ inputs.instances == 'all' || inputs.instances == 'core' }}
      run: |
        echo "ðŸš€ Deploying Core Services..."
        ssh -i ~/.ssh/id_rsa -o ConnectTimeout=10 ubuntu@13.222.63.75 << 'EOF'
        set -e
        cd /home/ubuntu
        if [ -d "Proyecto-Acompa-amiento-" ]; then
          cd Proyecto-Acompa-amiento-
          git pull origin main
        else
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
        fi
        echo "ðŸ³ Starting Core services..."
        docker-compose -f docker-compose.core.yml up -d
        echo "âœ… Core services deployed - Containers running:"
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        EOF
    
    - name: Deploy to Database
      if: ${{ inputs.instances == 'all' || inputs.instances == 'db' }}
      run: |
        echo "ðŸš€ Deploying Database..."
        ssh -i ~/.ssh/id_rsa -o ConnectTimeout=10 ubuntu@100.31.104.252 << 'EOF'
        set -e
        cd /home/ubuntu
        if [ -d "Proyecto-Acompa-amiento-" ]; then
          cd Proyecto-Acompa-amiento-
          git pull origin main
        else
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
        fi
        echo "ðŸ³ Starting Database services..."
        docker-compose -f docker-compose.infrastructure.yml up -d
        echo "âœ… Database deployed - Containers running:"
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        EOF
    
    - name: Deploy to Messaging
      if: ${{ inputs.instances == 'all' || inputs.instances == 'messaging' }}
      run: |
        echo "ðŸš€ Deploying Messaging..."
        ssh -i ~/.ssh/id_rsa -o ConnectTimeout=10 ubuntu@98.93.37.132 << 'EOF'
        set -e
        cd /home/ubuntu
        if [ -d "Proyecto-Acompa-amiento-" ]; then
          cd Proyecto-Acompa-amiento-
          git pull origin main
        else
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
        fi
        echo "ðŸ³ Starting Messaging services..."
        docker-compose -f docker-compose.messaging.yml up -d
        echo "âœ… Messaging deployed - Containers running:"
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        EOF
    
    - name: Deploy to Notificaciones
      if: ${{ inputs.instances == 'all' || inputs.instances == 'notificaciones' }}
      run: |
        echo "ðŸš€ Deploying Notificaciones..."
        ssh -i ~/.ssh/id_rsa -o ConnectTimeout=10 ubuntu@3.236.139.55 << 'EOF'
        set -e
        cd /home/ubuntu
        if [ -d "Proyecto-Acompa-amiento-" ]; then
          cd Proyecto-Acompa-amiento-
          git pull origin main
        else
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
        fi
        echo "ðŸ³ Starting Notificaciones services..."
        docker-compose -f docker-compose.notificaciones.yml up -d
        echo "âœ… Notificaciones deployed - Containers running:"
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        EOF
    
    - name: Deploy to Reportes
      if: ${{ inputs.instances == 'all' || inputs.instances == 'reportes' }}
      run: |
        echo "ðŸš€ Deploying Reportes..."
        ssh -i ~/.ssh/id_rsa -o ConnectTimeout=10 ubuntu@52.200.32.56 << 'EOF'
        set -e
        cd /home/ubuntu
        if [ -d "Proyecto-Acompa-amiento-" ]; then
          cd Proyecto-Acompa-amiento-
          git pull origin main
        else
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
        fi
        echo "ðŸ³ Starting Reportes services..."
        docker-compose -f docker-compose.notificaciones.yml up -d
        echo "âœ… Reportes deployed - Containers running:"
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        EOF
    
    - name: Deploy to Monitoring
      if: ${{ inputs.instances == 'all' || inputs.instances == 'monitoring' }}
      run: |
        echo "ðŸš€ Deploying Monitoring..."
        ssh -i ~/.ssh/id_rsa -o ConnectTimeout=10 ubuntu@98.88.93.98 << 'EOF'
        set -e
        cd /home/ubuntu
        if [ -d "Proyecto-Acompa-amiento-" ]; then
          cd Proyecto-Acompa-amiento-
          git pull origin main
        else
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
        fi
        echo "ðŸ³ Starting Monitoring services..."
        docker-compose -f docker-compose.prod.yml up -d
        echo "âœ… Monitoring deployed - Containers running:"
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        EOF
    
    - name: Summary
      run: |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… DEPLOYMENT COMPLETE"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "Services deployed to:"
        echo "ðŸŒ Frontend:        http://44.220.126.89"
        echo "ðŸ”Œ API Gateway:     http://52.7.168.4:8080"
        echo "ðŸ” Core Services:   http://13.222.63.75:3000"
        echo "ðŸ’¾ Database:        postgresql://100.31.104.252:5432"
        echo "ðŸ“¢ Messaging:       98.93.37.132:5672"
        echo "ðŸ“§ Notificaciones:  http://3.236.139.55:5006"
        echo "ðŸ“Š Reportes:        http://52.200.32.56:5003"
        echo "ðŸ“ˆ Monitoring:      http://98.88.93.98:9090"
        echo ""
    
    - name: Deploy to Frontend
      if: ${{ inputs.instances == 'all' || inputs.instances == 'frontend' }}
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 44.220.126.89 >> ~/.ssh/known_hosts 2>/dev/null || true
        
        echo "ðŸš€ Deploying Frontend..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@44.220.126.89 << 'EOF'
        set -e
        echo "ðŸ“¦ Starting Frontend services..."
        cd /home/ubuntu
        if [ -d "Proyecto-Acompa-amiento-" ]; then
          cd Proyecto-Acompa-amiento-
          git pull
        else
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
        fi
        docker-compose -f docker-compose.frontend.yml up -d
        docker ps
        echo "âœ… Frontend deployed"
        EOF
    
    - name: Deploy to API Gateway
      if: ${{ inputs.instances == 'all' || inputs.instances == 'api-gateway' }}
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 52.7.168.4 >> ~/.ssh/known_hosts 2>/dev/null || true
        
        echo "ðŸš€ Deploying API Gateway..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@52.7.168.4 << 'EOF'
        set -e
        echo "ðŸ“¦ Starting API Gateway services..."
        cd /home/ubuntu
        if [ -d "Proyecto-Acompa-amiento-" ]; then
          cd Proyecto-Acompa-amiento-
          git pull
        else
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
        fi
        docker-compose -f docker-compose.api-gateway.yml up -d
        docker ps
        echo "âœ… API Gateway deployed"
        EOF
    
    - name: Deploy to Core Services
      if: ${{ inputs.instances == 'all' || inputs.instances == 'core' }}
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 13.222.63.75 >> ~/.ssh/known_hosts 2>/dev/null || true
        
        echo "ðŸš€ Deploying Core Services..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@13.222.63.75 << 'EOF'
        set -e
        echo "ðŸ“¦ Starting Core services..."
        cd /home/ubuntu
        if [ -d "Proyecto-Acompa-amiento-" ]; then
          cd Proyecto-Acompa-amiento-
          git pull
        else
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
        fi
        docker-compose -f docker-compose.core.yml up -d
        docker ps
        echo "âœ… Core services deployed"
        EOF
    
    - name: Deploy to Database
      if: ${{ inputs.instances == 'all' || inputs.instances == 'db' }}
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 100.31.104.252 >> ~/.ssh/known_hosts 2>/dev/null || true
        
        echo "ðŸš€ Deploying Database..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@100.31.104.252 << 'EOF'
        set -e
        echo "ðŸ“¦ Starting Database services..."
        cd /home/ubuntu
        if [ -d "Proyecto-Acompa-amiento-" ]; then
          cd Proyecto-Acompa-amiento-
          git pull
        else
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
        fi
        docker-compose -f docker-compose.infrastructure.yml up -d
        docker ps
        echo "âœ… Database deployed"
        EOF
    
    - name: Deploy to Messaging
      if: ${{ inputs.instances == 'all' || inputs.instances == 'messaging' }}
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 98.93.37.132 >> ~/.ssh/known_hosts 2>/dev/null || true
        
        echo "ðŸš€ Deploying Messaging..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@98.93.37.132 << 'EOF'
        set -e
        echo "ðŸ“¦ Starting Messaging services..."
        cd /home/ubuntu
        if [ -d "Proyecto-Acompa-amiento-" ]; then
          cd Proyecto-Acompa-amiento-
          git pull
        else
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
        fi
        docker-compose -f docker-compose.messaging.yml up -d
        docker ps
        echo "âœ… Messaging deployed"
        EOF
    
    - name: Deploy to Notificaciones
      if: ${{ inputs.instances == 'all' || inputs.instances == 'notificaciones' }}
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 3.236.139.55 >> ~/.ssh/known_hosts 2>/dev/null || true
        
        echo "ðŸš€ Deploying Notificaciones..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@3.236.139.55 << 'EOF'
        set -e
        echo "ðŸ“¦ Starting Notificaciones services..."
        cd /home/ubuntu
        if [ -d "Proyecto-Acompa-amiento-" ]; then
          cd Proyecto-Acompa-amiento-
          git pull
        else
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
        fi
        docker-compose -f docker-compose.notificaciones.yml up -d
        docker ps
        echo "âœ… Notificaciones deployed"
        EOF
    
    - name: Deploy to Reportes
      if: ${{ inputs.instances == 'all' || inputs.instances == 'reportes' }}
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 52.200.32.56 >> ~/.ssh/known_hosts 2>/dev/null || true
        
        echo "ðŸš€ Deploying Reportes..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@52.200.32.56 << 'EOF'
        set -e
        echo "ðŸ“¦ Starting Reportes services..."
        cd /home/ubuntu
        if [ -d "Proyecto-Acompa-amiento-" ]; then
          cd Proyecto-Acompa-amiento-
          git pull
        else
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
        fi
        docker-compose -f docker-compose.notificaciones.yml up -d
        docker ps
        echo "âœ… Reportes deployed"
        EOF
    
    - name: Deploy to Monitoring
      if: ${{ inputs.instances == 'all' || inputs.instances == 'monitoring' }}
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 98.88.93.98 >> ~/.ssh/known_hosts 2>/dev/null || true
        
        echo "ðŸš€ Deploying Monitoring..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@98.88.93.98 << 'EOF'
        set -e
        echo "ðŸ“¦ Starting Monitoring services..."
        cd /home/ubuntu
        if [ -d "Proyecto-Acompa-amiento-" ]; then
          cd Proyecto-Acompa-amiento-
          git pull
        else
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
        fi
        docker-compose -f docker-compose.prod.yml up -d
        docker ps
        echo "âœ… Monitoring deployed"
        EOF
    
    - name: Summary
      run: |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… DEPLOYMENT COMPLETE"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "Services deployed to:"
        echo "ðŸŒ Frontend:        http://44.220.126.89"
        echo "ðŸ”Œ API Gateway:     http://52.7.168.4:8080"
        echo "ðŸ” Core Services:   http://13.222.63.75:3000"
        echo "ðŸ’¾ Database:        postgresql://100.31.104.252:5432"
        echo "ðŸ“¢ Messaging:       98.93.37.132:5672"
        echo "ðŸ“§ Notificaciones:  http://3.236.139.55:5006"
        echo "ðŸ“Š Reportes:        http://52.200.32.56:5003"
        echo "ðŸ“ˆ Monitoring:      http://98.88.93.98:9090"
        echo ""
        echo "ðŸ”‘ To check logs: ssh -i EC2_SSH_KEY ubuntu@<ip> 'docker logs -f <container>'"
