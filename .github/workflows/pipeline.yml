name: CI/CD Pipeline (build, push to Docker Hub, deploy via SSH)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REPO_PREFIX: proyecto-acomp

jobs:
  build-and-push:
    name: Test → Build → Push to Docker Hub
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Configure AWS (for ECR)
        if: ${{ secrets.AWS_ACCESS_KEY_ID && secrets.AWS_SECRET_ACCESS_KEY && secrets.AWS_REGION }}
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Log in to ECR (if AWS creds present)
        if: ${{ secrets.AWS_ACCESS_KEY_ID && secrets.AWS_SECRET_ACCESS_KEY && secrets.AWS_REGION }}
        uses: docker/login-action@v2
        with:
          ecr: auto
          logout: true

      - name: Log in to Docker Hub (if Docker secrets present)
        if: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          logout: true

      - name: Debug Docker Hub secret presence
        if: ${{ always() }}
        run: |
          set -euo pipefail
          if [[ -n "${{ secrets.DOCKERHUB_USERNAME }}" ]]; then echo "DOCKERHUB_USERNAME present"; else echo "DOCKERHUB_USERNAME missing"; fi
          if [[ -n "${{ secrets.DOCKERHUB_TOKEN }}" ]]; then echo "DOCKERHUB_TOKEN present"; else echo "DOCKERHUB_TOKEN missing"; fi

      - name: Setup Node.js (for tests)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Run tests per service (if present)
        shell: bash
        run: |
          set -euo pipefail
          # Discover services: prefer folder 'microservicios' if present, otherwise top-level 'micro-*'
          if [[ -d microservicios ]]; then
            SRCDIR="microservicios"
            SERVICES=("$(ls -1 "$SRCDIR")")
          else
            SERVICES=( $(ls -1 | grep '^micro-' || true) )
          fi
          for svc in ${SERVICES[@]}; do
            if [[ -f "$svc/package.json" ]]; then
              echo "Running tests for $svc"
              pushd "$svc" >/dev/null
              if npm ci --no-audit --prefer-offline; then
                echo "npm ci succeeded"
              else
                echo "npm ci failed; falling back to npm install"
                npm install --no-audit --prefer-offline
              fi
              if node -e "try{const p=require('./package.json'); process.exit(!(p.scripts && p.scripts.test));}catch(e){process.exit(1);}"
              then
                npm test --silent -- --detectOpenHandles --runInBand || { echo "Tests failed in $svc"; exit 1; }
              else
                echo "[SKIP] $svc has no test script"
              fi
              popd >/dev/null
            else
              echo "No package.json for $svc; skipping tests"
            fi
          done

      - name: Build & push Docker images (sha + latest)
        shell: bash
        env:
          GIT_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          # Discover services same as tests
          if [[ -d microservicios ]]; then
            DIRS=(microservicios/*)
          else
            DIRS=(micro-*)
          fi

          # Determine available registries
          PUSH_TO_DOCKERHUB=false
          if [[ -n "${{ secrets.DOCKERHUB_USERNAME }}" && -n "${{ secrets.DOCKERHUB_TOKEN }}" ]]; then
            PUSH_TO_DOCKERHUB=true
            DOCKERHUB_USER="${{ secrets.DOCKERHUB_USERNAME }}"
          fi

          PUSH_TO_ECR=false
          if [[ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" && -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" && -n "${{ secrets.AWS_REGION }}" ]]; then
            PUSH_TO_ECR=true
            AWS_REGION="${{ secrets.AWS_REGION }}"
            AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
            ECR_REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          fi

          for svcdir in "${DIRS[@]}"; do
            svc=$(basename "$svcdir")
            # Skip if not a directory
            if [[ ! -d "$svcdir" ]]; then continue; fi
            DOCKERFILE="$svcdir/Dockerfile"
            if [[ ! -f "$DOCKERFILE" ]]; then
              echo "Skipping $svc: no Dockerfile"
              continue
            fi

            REPO="${{ env.REPO_PREFIX }}-$svc"
            LOCAL_IMAGE="local/${REPO}:${GIT_SHA::8}"

            echo "Building $svc -> $LOCAL_IMAGE"
            docker build -f "$DOCKERFILE" -t "$LOCAL_IMAGE" "$svcdir"

            if [[ "$PUSH_TO_DOCKERHUB" == "true" ]]; then
              IMAGE_dh_latest="${DOCKERHUB_USER}/${REPO}:latest"
              IMAGE_dh_sha="${DOCKERHUB_USER}/${REPO}:${GIT_SHA::8}"
              docker tag "$LOCAL_IMAGE" "$IMAGE_dh_sha"
              docker tag "$LOCAL_IMAGE" "$IMAGE_dh_latest"
              echo "Pushing to Docker Hub: $IMAGE_dh_sha"
              docker push "$IMAGE_dh_sha"
              echo "Pushing to Docker Hub: $IMAGE_dh_latest"
              docker push "$IMAGE_dh_latest"
            fi

            if [[ "$PUSH_TO_ECR" == "true" ]]; then
              # Ensure ECR repository exists (safe to run; ignore errors on create)
              aws ecr describe-repositories --repository-names "$REPO" >/dev/null 2>&1 || aws ecr create-repository --repository-name "$REPO" >/dev/null 2>&1 || true
              IMAGE_ecr_latest="${ECR_REGISTRY}/${REPO}:latest"
              IMAGE_ecr_sha="${ECR_REGISTRY}/${REPO}:${GIT_SHA::8}"
              docker tag "$LOCAL_IMAGE" "$IMAGE_ecr_sha"
              docker tag "$LOCAL_IMAGE" "$IMAGE_ecr_latest"
              echo "Pushing to ECR: $IMAGE_ecr_sha"
              docker push "$IMAGE_ecr_sha"
              echo "Pushing to ECR: $IMAGE_ecr_latest"
              docker push "$IMAGE_ecr_latest"
            fi
          done

  deploy:
    name: Deploy to EC2 via SSH
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Validate required deploy secrets
        run: |
          # Accept either EC2_SSH_KEY or EC2_KEY (some repos use different names)
          if [[ -z "${{ secrets.EC2_HOST }}" || -z "${{ secrets.EC2_USER }}" || ( -z "${{ secrets.EC2_SSH_KEY }}" && -z "${{ secrets.EC2_KEY }}" ) ]]; then
            echo "EC2_HOST, EC2_USER or EC2_SSH_KEY/EC2_KEY secrets are missing; skipping deploy"; exit 78
          fi

      - name: Deploy (ssh) - pull images and run compose
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY || secrets.EC2_KEY }}
          port: 22
          script: |
            set -euo pipefail
            echo "Logging into Docker Hub on remote"
            if [[ -n "${{ secrets.DOCKERHUB_USERNAME }}" && -n "${{ secrets.DOCKERHUB_TOKEN }}" ]]; then
              printf '%s' "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin || true
            fi
            # Attempt docker compose pull/up in home directory (assumes docker-compose.yml present on remote)
            cd ~/ || true
            if [[ -f docker-compose.yml ]]; then
              docker compose pull || true
              docker compose up -d --remove-orphans
            else
              echo "docker-compose.yml not found in home directory of remote host; attempting docker pull for known images"
              # As fallback, pull images built in this workflow (using REPO_PREFIX and services pattern)
              for svcdir in micro-*; do
                if [[ -d "$svcdir" ]]; then
                  svc=$(basename "$svcdir")
                  if [[ -n "${{ secrets.DOCKERHUB_USERNAME }}" ]]; then
                    docker pull "${{ secrets.DOCKERHUB_USERNAME }}/${{ env.REPO_PREFIX }}-$svc:latest" || true
                  else
                    echo "No Docker Hub username available; skipping pull for $svc"
                  fi
                fi
              done
            fi
