name: Build and Deploy Messaging Services

on:
  push:
    branches: [ main ]
    paths:
      - messaging/**

jobs:
  deploy-ec2:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set permissions for private key
      run: |
        echo "${{ secrets.EC2_KEY }}" > key.pem
        chmod 600 key.pem

    - name: Deploy to EC2
      run: |
        ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@${{ secrets.MESSAGING_HOST }} << 'EOF'
        set -e
        
        echo "=== System Update ==="
        sudo apt-get update -y
        
        echo "=== Installing Docker ==="
        if ! command -v docker &> /dev/null; then
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo usermod -aG docker ubuntu
          sudo systemctl start docker
          sudo systemctl enable docker
        fi
        
        echo "=== Installing Docker Compose V2 ==="
        sudo mkdir -p /usr/local/lib/docker/cli-plugins
        sudo curl -SL https://github.com/docker/compose/releases/download/v2.27.0/docker-compose-linux-x86_64 \
          -o /usr/local/lib/docker/cli-plugins/docker-compose
        sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
        sudo ln -sf /usr/local/lib/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose 2>/dev/null || true
        
        echo "=== Cloning/Updating Repository ==="
        if [ ! -d "$HOME/Proyecto-Acompa-amiento-" ]; then
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git "$HOME/Proyecto-Acompa-amiento-"
        else
          cd "$HOME/Proyecto-Acompa-amiento-"
          git pull origin main
        fi
        
        echo "=== Full cleanup of messaging directory ==="
        cd "$HOME/Proyecto-Acompa-amiento-/messaging"
        
        # Kill all containers related to messaging
        sudo docker ps -a --format '{{.Names}}' | grep -E 'proyecto-|local-' | xargs -r sudo docker kill || true
        sudo docker ps -a --format '{{.Names}}' | grep -E 'proyecto-|local-' | xargs -r sudo docker rm -f || true
        
        # Remove old networks
        sudo docker network rm messaging-network 2>/dev/null || true
        
        # Remove old volumes
        sudo docker volume ls --format '{{.Name}}' | grep -E 'zookeeper|kafka|rabbitmq' | xargs -r sudo docker volume rm || true
        
        # Full prune
        sudo docker system prune -af --volumes || true
        
        echo "=== Remove any old docker-compose files ==="
        rm -f docker-compose.override.yml || true
        
        # Verify we have the correct docker-compose.yml
        if [ ! -f "docker-compose.yml" ]; then
          echo "ERROR: docker-compose.yml not found!"
          exit 1
        fi
        
        echo "=== Building and starting services ==="
        sudo docker-compose up -d --build
        
        echo "=== Waiting for services to be healthy ==="
        sleep 25
        
        echo "=== Checking running containers ==="
        sudo docker ps --format 'table {{.ID}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}\t{{.Names}}'
        
        echo "=== Checking service status ==="
        sudo docker-compose ps
        
        echo "=== Service logs ==="
        sudo docker-compose logs --tail=50
        
        echo "=== Success! ==="
        echo "Zookeeper: ${{ secrets.MESSAGING_HOST }}:2181"
        echo "Kafka: ${{ secrets.MESSAGING_HOST }}:9092"
        echo "RabbitMQ: ${{ secrets.MESSAGING_HOST }}:5672 (Management: http://${{ secrets.MESSAGING_HOST }}:15672)"
        EOF

