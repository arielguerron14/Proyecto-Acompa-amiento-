name: Deploy Messaging

on:
  push:
    branches: [ main ]
    paths:
      - messaging/**
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Inspect messaging folder (debug)
        run: |
          echo "Listing messaging/ content:"
          ls -la messaging || true

      - name: Check for Dockerfile
        id: check
        run: |
          if [ -f messaging/Dockerfile ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Build and Push Messaging Image
        if: steps.check.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./messaging
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/messaging:latest

      - name: Skip build if no Dockerfile
        if: steps.check.outputs.exists == 'false'
        run: |
          echo "No Dockerfile found in messaging/ ‚Äî skipping build and push step."

      - name: Deploy Messaging on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_MESSAGING_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          port: 22
          script: |
            set -euo pipefail
            export DEBIAN_FRONTEND=noninteractive

            echo "üê≥ Ensure Docker & Compose"
            sudo apt-get update
            sudo apt-get install -y git docker.io docker-compose || true
            sudo systemctl enable docker || true
            sudo systemctl start docker || true

            echo "üîê Docker Hub Login"
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin || true

            echo "üì¶ Clone or update repository"
            if [ ! -d "$HOME/Proyecto-Acompa-amiento-" ]; then
              git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git "$HOME/Proyecto-Acompa-amiento-" || true
            else
              git -C "$HOME/Proyecto-Acompa-amiento-" pull || true
            fi

            cd "$HOME/Proyecto-Acompa-amiento-/messaging" || (echo "messaging dir missing" && ls -la "$HOME/Proyecto-Acompa-amiento-" && exit 1)

            echo "‚¨áÔ∏è Pull messaging image"
            sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/messaging:latest || true
            sudo docker tag ${{ secrets.DOCKERHUB_USERNAME }}/messaging:latest messaging:latest || true

            echo "üßπ Stop old containers"
            sudo docker-compose down || true

            echo "üöÄ Start messaging service"
            sudo docker-compose pull || true
            sudo docker-compose up -d || true

            echo "--- DOCKER PS ---"
            sudo docker ps -a --format 'table {{.ID}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}\t{{.Names}}' || true
