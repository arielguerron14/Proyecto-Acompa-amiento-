name: ðŸš€ Deploy - Direct SSH to Public IPs

on:
  workflow_dispatch:
    inputs:
      rebuild_images:
        description: 'Rebuild Docker images'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  AWS_REGION: us-east-1

jobs:
  load-config:
    name: ðŸ“‹ Load Configuration
    runs-on: ubuntu-latest
    outputs:
      core-ip: ${{ steps.load.outputs.core_public }}
      api-gateway-ip: ${{ steps.load.outputs.api_gateway_public }}
      db-ip: ${{ steps.load.outputs.db_public }}
      messaging-ip: ${{ steps.load.outputs.messaging_public }}
      reportes-ip: ${{ steps.load.outputs.reportes_public }}
      notificaciones-ip: ${{ steps.load.outputs.notificaciones_public }}
      analytics-ip: ${{ steps.load.outputs.analytics_public }}
      monitoring-ip: ${{ steps.load.outputs.monitoring_public }}
      frontend-ip: ${{ steps.load.outputs.frontend_public }}
      bastion-ip: ${{ steps.load.outputs.bastion_public }}

    steps:
      - uses: actions/checkout@v3
      - id: load
        run: |
          python3 << 'PYTHON'
          import json
          with open('config/instance_ips.json', 'r') as f:
              instances = json.load(f)
          mapping = {
              'EC2-CORE': 'core', 'EC2-API-Gateway': 'api_gateway', 'EC2-DB': 'db',
              'EC2-Messaging': 'messaging', 'EC2-Reportes': 'reportes',
              'EC2-Notificaciones': 'notificaciones', 'EC2-Analytics': 'analytics',
              'EC2-Monitoring': 'monitoring', 'EC2-Frontend': 'frontend', 'EC-Bastion': 'bastion'
          }
          for instance_name, output_name in mapping.items():
              if instance_name in instances:
                  print(f"::set-output name={output_name}_public::{instances[instance_name]['PublicIpAddress']}")
                  print(f"âœ… {instance_name}: {instances[instance_name]['PublicIpAddress']}")
          PYTHON

  deploy-core:
    name: "ðŸ³ EC2-CORE"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 25
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - name: Setup & Deploy
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          SSH_OPTS="-o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa"
          echo "ðŸš€ Deploying EC2-CORE (${{ needs.load-config.outputs.core-ip }})..."
          ssh $SSH_OPTS ubuntu@${{ needs.load-config.outputs.core-ip }} bash -s << 'SCRIPT'
          cd /tmp || cd ~
          docker-compose -f docker-compose.ec2-core.yml down 2>/dev/null || true
          docker-compose -f docker-compose.ec2-core.yml up -d --no-build 2>&1 | head -10
          sleep 5 && docker-compose -f docker-compose.ec2-core.yml ps
          SCRIPT
          echo "âœ… EC2-CORE deployment complete"

  deploy-api-gateway:
    name: "ðŸŒ EC2-API-Gateway"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - name: Setup & Deploy
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          SSH_OPTS="-o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa"
          echo "ðŸš€ Deploying EC2-API-Gateway (${{ needs.load-config.outputs.api-gateway-ip }})..."
          ssh $SSH_OPTS ubuntu@${{ needs.load-config.outputs.api-gateway-ip }} bash -s << 'SCRIPT'
          cd /tmp || cd ~
          docker-compose -f docker-compose.api-gateway.yml down 2>/dev/null || true
          docker-compose -f docker-compose.api-gateway.yml up -d --no-build 2>&1 | head -10
          sleep 3 && docker-compose -f docker-compose.api-gateway.yml ps
          SCRIPT
          echo "âœ… API-Gateway deployment complete"

  deploy-db:
    name: "ðŸ—„ï¸  EC2-DB"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 20
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - name: Setup & Deploy
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          SSH_OPTS="-o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa"
          echo "ðŸš€ Deploying EC2-DB (${{ needs.load-config.outputs.db-ip }})..."
          ssh $SSH_OPTS ubuntu@${{ needs.load-config.outputs.db-ip }} bash -s << 'SCRIPT'
          cd /tmp || cd ~
          docker-compose -f docker-compose.ec2-db.yml down 2>/dev/null || true
          docker-compose -f docker-compose.ec2-db.yml up -d --no-build 2>&1 | head -10
          sleep 5 && docker-compose -f docker-compose.ec2-db.yml ps
          SCRIPT
          echo "âœ… DB deployment complete"

  deploy-messaging:
    name: "â±ï¸  EC2-Messaging"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - name: Setup & Deploy
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          SSH_OPTS="-o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa"
          echo "ðŸš€ Deploying EC2-Messaging (${{ needs.load-config.outputs.messaging-ip }})..."
          ssh $SSH_OPTS ubuntu@${{ needs.load-config.outputs.messaging-ip }} bash -s << 'SCRIPT'
          cd /tmp || cd ~
          docker-compose -f docker-compose.messaging.yml down 2>/dev/null || true
          docker-compose -f docker-compose.messaging.yml up -d --no-build 2>&1 | head -10
          sleep 3 && docker-compose -f docker-compose.messaging.yml ps
          SCRIPT
          echo "âœ… Messaging deployment complete"

  deploy-reportes:
    name: "ðŸ“„ EC2-Reportes"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - name: Setup & Deploy
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          SSH_OPTS="-o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa"
          echo "ðŸš€ Deploying EC2-Reportes (${{ needs.load-config.outputs.reportes-ip }})..."
          ssh $SSH_OPTS ubuntu@${{ needs.load-config.outputs.reportes-ip }} bash -s << 'SCRIPT'
          cd /tmp || cd ~
          docker-compose -f docker-compose.ec2-reportes.yml down 2>/dev/null || true
          docker-compose -f docker-compose.ec2-reportes.yml up -d --no-build 2>&1 | head -10
          sleep 3 && docker-compose -f docker-compose.ec2-reportes.yml ps
          SCRIPT
          echo "âœ… Reportes deployment complete"

  deploy-notificaciones:
    name: "ðŸ”” EC2-Notificaciones"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - name: Setup & Deploy
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          SSH_OPTS="-o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa"
          echo "ðŸš€ Deploying EC2-Notificaciones (${{ needs.load-config.outputs.notificaciones-ip }})..."
          ssh $SSH_OPTS ubuntu@${{ needs.load-config.outputs.notificaciones-ip }} bash -s << 'SCRIPT'
          cd /tmp || cd ~
          docker-compose -f docker-compose.ec2-notificaciones.yml down 2>/dev/null || true
          docker-compose -f docker-compose.ec2-notificaciones.yml up -d --no-build 2>&1 | head -10
          sleep 3 && docker-compose -f docker-compose.ec2-notificaciones.yml ps
          SCRIPT
          echo "âœ… Notificaciones deployment complete"

  deploy-analytics:
    name: "ðŸ“Š EC2-Analytics"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - name: Setup & Deploy
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          SSH_OPTS="-o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa"
          echo "ðŸš€ Deploying EC2-Analytics (${{ needs.load-config.outputs.analytics-ip }})..."
          ssh $SSH_OPTS ubuntu@${{ needs.load-config.outputs.analytics-ip }} bash -s << 'SCRIPT'
          cd /tmp || cd ~
          docker-compose -f docker-compose.ec2-analytics.yml down 2>/dev/null || true
          docker-compose -f docker-compose.ec2-analytics.yml up -d --no-build 2>&1 | head -10
          sleep 3 && docker-compose -f docker-compose.ec2-analytics.yml ps
          SCRIPT
          echo "âœ… Analytics deployment complete"

  deploy-monitoring:
    name: "ðŸ“ˆ EC2-Monitoring"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - name: Setup & Deploy
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          SSH_OPTS="-o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa"
          echo "ðŸš€ Deploying EC2-Monitoring (${{ needs.load-config.outputs.monitoring-ip }})..."
          ssh $SSH_OPTS ubuntu@${{ needs.load-config.outputs.monitoring-ip }} bash -s << 'SCRIPT'
          cd /tmp || cd ~
          docker-compose -f docker-compose.ec2-monitoring.yml down 2>/dev/null || true
          docker-compose -f docker-compose.ec2-monitoring.yml up -d --no-build 2>&1 | head -10
          sleep 3 && docker-compose -f docker-compose.ec2-monitoring.yml ps
          SCRIPT
          echo "âœ… Monitoring deployment complete"

  deploy-frontend:
    name: "ðŸŽ¨ EC2-Frontend"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - name: Setup & Deploy
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          SSH_OPTS="-o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa"
          echo "ðŸš€ Deploying EC2-Frontend (${{ needs.load-config.outputs.frontend-ip }})..."
          ssh $SSH_OPTS ubuntu@${{ needs.load-config.outputs.frontend-ip }} bash -s << 'SCRIPT'
          cd /tmp || cd ~
          docker-compose -f docker-compose.ec2-frontend.yml down 2>/dev/null || true
          docker-compose -f docker-compose.ec2-frontend.yml up -d --no-build 2>&1 | head -10
          sleep 3 && docker-compose -f docker-compose.ec2-frontend.yml ps
          SCRIPT
          echo "âœ… Frontend deployment complete"

  deploy-bastion:
    name: "ðŸ›¡ï¸  EC-Bastion"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - name: Setup & Deploy
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          SSH_OPTS="-o ConnectTimeout=15 -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa"
          echo "ðŸš€ Deploying Bastion (${{ needs.load-config.outputs.bastion-ip }})..."
          ssh $SSH_OPTS ubuntu@${{ needs.load-config.outputs.bastion-ip }} bash -s << 'SCRIPT'
          cd /tmp || cd ~
          docker-compose -f docker-compose.bastion.yml down 2>/dev/null || true
          docker-compose -f docker-compose.bastion.yml up -d --no-build 2>&1 | head -10
          sleep 3 && docker-compose -f docker-compose.bastion.yml ps
          SCRIPT
          echo "âœ… Bastion deployment complete"

  status:
    name: "âœ… Done"
    needs: [deploy-core, deploy-api-gateway, deploy-db, deploy-messaging, deploy-reportes, deploy-notificaciones, deploy-analytics, deploy-monitoring, deploy-frontend, deploy-bastion]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - run: echo "ðŸŽ‰ Deployment workflow complete!"
