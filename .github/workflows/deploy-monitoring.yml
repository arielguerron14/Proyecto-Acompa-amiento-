name: Deploy Monitoring Stack to AWS EC2-Monitoring

on:
  workflow_dispatch:
    inputs:
      ec2_monitoring_private_ip:
        description: 'IP privada de instancia EC2-Monitoring (ej: 172.31.71.151)'
        required: true
        type: string

env:
  EC2_MONITORING_SSH_KEY: ${{ secrets.AWS_EC2_DB_SSH_PRIVATE_KEY }}
  EC2_MONITORING_SSH_USER: ubuntu

jobs:
  deploy:
    name: Deploy Monitoring Stack
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set EC2 variables
        run: |
          echo "EC2_MONITORING_IP=${{ github.event.inputs.ec2_monitoring_private_ip }}" >> $GITHUB_ENV

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/aws-ec2-monitoring.pem << 'EOF'
          ${{ env.EC2_MONITORING_SSH_KEY }}
          EOF
          chmod 600 ~/.ssh/aws-ec2-monitoring.pem
          cat > ~/.ssh/config << 'SSHCONFIG'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
            LogLevel=QUIET
          SSHCONFIG

      - name: Deploy Monitoring Stack via SSH
        run: |
          ssh -i ~/.ssh/aws-ec2-monitoring.pem \
            -o ConnectTimeout=10 \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            ubuntu@${{ env.EC2_MONITORING_IP }} << 'SSHEOF'
            
            echo "=== Verificando Docker y Docker Compose ==="
            if ! command -v docker &> /dev/null; then
              echo "Docker no encontrado, instalando..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker ubuntu
              echo "Docker instalado correctamente"
            else
              echo "Docker ya estÃ¡ instalado"
              docker --version
            fi
            
            if ! command -v docker-compose &> /dev/null; then
              echo "Docker Compose no encontrado, instalando..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
              echo "Docker Compose instalado correctamente"
            else
              echo "Docker Compose ya estÃ¡ instalado"
              docker-compose --version
            fi
            
            echo "=== Clonando repositorio ==="
            cd /tmp
            rm -rf Proyecto-Acompa-amiento-
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-/monitoring
            
            echo "=== Deteniendo stack anterior ==="
            docker-compose down 2>/dev/null || true
            
            echo "=== Construyendo imÃ¡genes Docker ==="
            docker-compose build --no-cache
            
            echo "=== Desplegando Prometheus y Grafana ==="
            docker-compose up -d
            
            echo "=== Esperando a que los servicios inicien ==="
            sleep 15
            
            echo "=== Estado de contenedores ==="
            docker-compose ps
            
            echo "=== Logs de Prometheus ==="
            docker-compose logs --tail=20 prometheus
            
            echo "=== Logs de Grafana ==="
            docker-compose logs --tail=20 grafana
            
            echo "=== Verificando conectividad ==="
            echo "Intentando conexiÃ³n a Prometheus (localhost:9090)..."
            timeout 5 bash -c 'cat < /dev/null > /dev/tcp/localhost/9090' 2>/dev/null && echo "âœ“ Prometheus accesible" || echo "âš  Prometheus no accesible"
            
            echo "Intentando conexiÃ³n a Grafana (localhost:3000)..."
            timeout 5 bash -c 'cat < /dev/null > /dev/tcp/localhost/3000' 2>/dev/null && echo "âœ“ Grafana accesible" || echo "âš  Grafana no accesible"
            
            echo "=== Despliegue del stack de monitoring completado ==="
            echo ""
            echo "ðŸŽ¯ Servicios disponibles:"
            echo "  - Prometheus: http://172.31.71.151:9090"
            echo "  - Grafana: http://172.31.71.151:3000 (usuario: admin, contraseÃ±a: admin)"
          SSHEOF

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/aws-ec2-monitoring.pem
