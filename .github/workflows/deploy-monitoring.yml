name: Deploy Monitoring

on:
  push:
    branches: [ "main" ]
    paths:
      - "monitoring/**"
  workflow_dispatch:
    inputs:
      deploy:
        description: "Run the deploy step to AWS (true/false). Defaults to 'false'."
        required: false
        default: 'false'

jobs:
  deploy-aws:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Deploy Monitoring to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_MONITORING_HOST }} << 'EOF'

          set -e

          sudo apt update -y

          # Docker
          if ! command -v docker &> /dev/null; then
            sudo apt install -y docker.io
            sudo systemctl enable docker
            sudo systemctl start docker
          fi

          # docker-compose BINARIO (NO plugin)
          if ! command -v docker-compose &> /dev/null; then
            sudo curl -L https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-linux-x86_64 \
              -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi

          # Repo
          if [ ! -d "$HOME/Proyecto-Acompa-amiento-" ]; then
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          else
            git -C Proyecto-Acompa-amiento- pull || true
          fi

          cd Proyecto-Acompa-amiento-/monitoring

          sudo docker-compose down || true
          echo "Building monitoring images (if necessary)"
          sudo docker-compose build --pull || true
          echo "Starting monitoring stack"
          sudo docker-compose up -d || true

          sudo docker ps -a
          EOF
