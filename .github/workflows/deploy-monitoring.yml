name: Build, Push, and Deploy Monitoring

on:
  push:
    branches: [ main ]
    paths:
      - monitoring/**

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and Push Prometheus Image
      uses: docker/build-push-action@v5
      with:
        context: ./monitoring/prometheus
        file: ./monitoring/prometheus/Dockerfile
        push: true
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/prometheus:latest

    - name: Build and Push Grafana Image
      uses: docker/build-push-action@v5
      with:
        context: ./monitoring/grafana
        file: ./monitoring/grafana/Dockerfile
        push: true
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/grafana:latest

  deploy-ec2:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set permissions for private key
      run: |
        echo "${{ secrets.EC2_KEY }}" > key.pem
        chmod 600 key.pem

    - name: Deploy to EC2
      run: |
        ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@${{ secrets.MONITORING_HOST }} << 'EOF'
        set -e
        
        echo "=== Updating System ==="
        sudo apt-get update -y
        
        echo "=== Installing Docker ==="
        if ! command -v docker &> /dev/null; then
          sudo apt-get install -y docker.io curl
          sudo usermod -aG docker ubuntu || true
          sudo systemctl start docker
          sudo systemctl enable docker
        fi
        
        echo "=== Installing Docker Compose V2 ==="
        if ! command -v docker-compose &> /dev/null; then
          sudo mkdir -p /usr/local/lib/docker/cli-plugins
          sudo curl -SL https://github.com/docker/compose/releases/download/v2.27.0/docker-compose-linux-x86_64 \
            -o /usr/local/lib/docker/cli-plugins/docker-compose
          sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
          sudo ln -sf /usr/local/lib/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose || true
        fi
        
        echo "=== Logging in to Docker Hub ==="
        echo "${{ secrets.DOCKERHUB_TOKEN }}" | sudo docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
        
        echo "=== Cloning/Updating Repository ==="
        if [ ! -d "$HOME/Proyecto-Acompa-amiento-" ]; then
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git "$HOME/Proyecto-Acompa-amiento-"
        else
          cd "$HOME/Proyecto-Acompa-amiento-"
          git pull origin main
        fi
        
        echo "=== Deploying Monitoring Services ==="
        cd "$HOME/Proyecto-Acompa-amiento-/monitoring"
        
        sudo docker-compose down || true
        sudo docker-compose pull
        sudo docker-compose up -d
        
        echo "=== Waiting for Services to Start ==="
        sleep 10
        
        echo "=== Docker Images ==="
        sudo docker images | grep -E 'prometheus|grafana' || echo "No images found"
        
        echo "=== Running Containers ==="
        sudo docker ps --format 'table {{.ID}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}\t{{.Names}}'
        
        echo "=== Service Status ==="
        sudo docker-compose ps
        
        echo "=== Container Logs (last 50 lines) ==="
        sudo docker-compose logs --tail=50
        EOF
