name: CD - Deploy services to EC2 via SSH

# Trigger when the CI workflow completes successfully, or run manually via workflow_dispatch.
# Uses appleboy/ssh-action to perform docker pull / stop / rm / run on each target EC2 host.
# Requires secrets: EC2_USER, EC2_KEY, DOCKERHUB_USERNAME, and per-host secrets (e.g. FRONTEND_HOST)

on:
  workflow_run:
    workflows: ["CI - Build and push Docker images to Docker Hub"]
    types: [completed]
  workflow_dispatch:
    inputs:
      services:
        description: 'Comma-separated list of services to deploy (default: all)'
        required: false
        default: 'all'

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy services via SSH
    runs-on: ubuntu-latest
    env:
      # Use a lowercase repository prefix to ensure Docker tags are valid
      REPO_PREFIX: proyecto-acomp
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: frontend-web
            host_secret: FRONTEND_HOST
            dir: ./frontend-web
            container: acomp-frontend
            ports: "3000:3000"
          - name: api-gateway
            host_secret: API_GATEWAY_HOST
            dir: ./api-gateway
            container: acomp-api-gateway
            ports: "8080:8080"
          - name: micro-core
            host_secret: MICRO_CORE_HOST
            dir: ./micro-core
            container: acomp-micro-core
            ports: "3002:3002"
          - name: micro-auth
            host_secret: MICRO_CORE_HOST
            dir: ./micro-auth
            container: acomp-micro-auth
            ports: "3001:3001"
          - name: micro-reportes
            host_secret: REPORTES_HOST
            dir: ./micro-reportes
            container: acomp-micro-reportes
            ports: "3003:3003"
          - name: micro-notificaciones
            host_secret: NOTIFICACIONES_HOST
            dir: ./micro-notificaciones
            container: acomp-micro-notificaciones
            ports: "3004:3004"
          - name: messaging
            host_secret: MESSAGING_HOST
            dir: ./messaging
            container: acomp-messaging
            ports: "3005:3005"
          # monitoring does not have a Dockerfile / image to build yet; excluded from automated deploys
          - name: databases
            host_secret: DATABASES_HOST
            dir: ./databases
            container: acomp-databases
            ports: "5432:5432"

    steps:
      - name: Check which services to run (dispatch filter)
        id: svc-filter
        run: |
          echo "services_input=${{ github.event.inputs.services || 'all' }}" >> $GITHUB_OUTPUT

      - name: Skip service if not selected (manual dispatch)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.services != 'all' && !contains(github.event.inputs.services, matrix.name) }}
        run: |
          echo "Skipping ${{ matrix.name }} as not in input services"
          exit 78

      - name: Set image tags
        run: |
          SHA=${{ github.event.workflow_run.head_sha || github.sha }}
          echo "IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/${{ env.REPO_PREFIX }}-${{ matrix.name }}:$SHA" >> $GITHUB_OUTPUT
          echo "IMAGE_LATEST=${{ secrets.DOCKERHUB_USERNAME }}/${{ env.REPO_PREFIX }}-${{ matrix.name }}:latest" >> $GITHUB_OUTPUT

      - name: Resolve host from secrets
        id: resolve-host
        run: |
          case "${{ matrix.host_secret }}" in
            FRONTEND_HOST) HOST="${{ secrets.FRONTEND_HOST }}" ;;
            API_GATEWAY_HOST) HOST="${{ secrets.API_GATEWAY_HOST }}" ;;
            MICRO_CORE_HOST) HOST="${{ secrets.MICRO_CORE_HOST }}" ;;
            REPORTES_HOST) HOST="${{ secrets.REPORTES_HOST }}" ;;
            NOTIFICACIONES_HOST) HOST="${{ secrets.NOTIFICACIONES_HOST }}" ;;
            MESSAGING_HOST) HOST="${{ secrets.MESSAGING_HOST }}" ;;
            MONITORING_HOST) HOST="${{ secrets.MONITORING_HOST }}" ;;
            DATABASES_HOST) HOST="${{ secrets.DATABASES_HOST }}" ;;
            *) echo "Unknown host secret: ${{ matrix.host_secret }}" >&2 ; exit 1 ;;
          esac
          echo "host=$HOST" >> $GITHUB_OUTPUT

      - name: "Debug: show resolved host"
        run: |
          echo "Resolved host: ${{ steps.resolve-host.outputs.host }}"

      - name: Check SSH port from runner
        run: |
          echo "Checking TCP connectivity to ${{ steps.resolve-host.outputs.host }}:22 from the runner"
          sudo apt-get update -y >/dev/null
          sudo apt-get install -y netcat >/dev/null
          nc -vz -w5 "${{ steps.resolve-host.outputs.host }}" 22 || (echo "ERROR: port 22 unreachable from the runner to ${{ steps.resolve-host.outputs.host }}" && exit 1)

      - name: Deploy to host via SSH
        uses: appleboy/ssh-action@v0.1.9
        with:
          debug: true
          host: ${{ steps.resolve-host.outputs.host }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          port: 22
          script: |
            set -euo pipefail
            IMAGE="${IMAGE}"
            IMAGE_LATEST="${IMAGE_LATEST}"
            echo "Pulling $IMAGE on remote host ${{ steps.resolve-host.outputs.host }}"
            # login to Docker Hub on remote (non-echoing)
            if [ -n "${DOCKERHUB_USERNAME:-}" ]; then
              printf '%s' "${DOCKERHUB_TOKEN}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin || true
            fi
            docker pull "$IMAGE" || docker pull "$IMAGE_LATEST"
            echo "Stopping old container (${matrix.container}) if exists"
            docker stop "${{ matrix.container }}" || true
            docker rm "${{ matrix.container }}" || true
            echo "Running new container (${matrix.container})"
            docker run -d --name "${{ matrix.container }}" --restart always -p ${{ matrix.ports }} $IMAGE
            echo "Cleaning up dangling images"
            docker image prune -f || true
