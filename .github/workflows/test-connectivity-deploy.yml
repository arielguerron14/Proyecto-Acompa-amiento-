name: Test Connectivity & Deploy

on:
  workflow_dispatch:
    inputs:
      test_only:
        description: 'Solo probar conectividad (sin desplegar)'
        required: false
        default: 'false'

jobs:
  test-connectivity:
    runs-on: ubuntu-latest
    outputs:
      all_reachable: ${{ steps.check.outputs.all_reachable }}
      instances_data: ${{ steps.encode_ips.outputs.encoded_ips }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/labsuser.pem
          chmod 600 ~/.ssh/labsuser.pem
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Get Instance IPs
        id: get-ips
        env:
          FRONTEND_IP: ${{ secrets.EC2_FRONTEND_IP }}
          API_GATEWAY_IP: ${{ secrets.EC2_API_GATEWAY_IP }}
          CORE_IP: ${{ secrets.EC2_CORE_IP }}
          DB_IP: ${{ secrets.EC2_DB_IP }}
          MESSAGING_IP: ${{ secrets.EC2_MESSAGING_IP }}
          NOTIFICACIONES_IP: ${{ secrets.EC2_NOTIFICACIONES_IP }}
          REPORTES_IP: ${{ secrets.EC2_REPORTES_IP }}
          MONITORING_IP: ${{ secrets.EC2_MONITORING_IP }}
          BASTION_IP: ${{ secrets.EC2_BASTION_IP }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          # Setup SSH key
          mkdir -p ~/.ssh
          echo "$EC2_SSH_KEY" > ~/.ssh/labsuser.pem
          chmod 600 ~/.ssh/labsuser.pem
          
          # IPs desde secretos (estas son las p√∫blicas)
          INSTANCES=(
            "frontend|$FRONTEND_IP"
            "api-gateway|$API_GATEWAY_IP"
            "core|$CORE_IP"
            "db|$DB_IP"
            "messaging|$MESSAGING_IP"
            "notificaciones|$NOTIFICACIONES_IP"
            "reportes|$REPORTES_IP"
            "monitoring|$MONITORING_IP"
            "bastion|$BASTION_IP"
          )
          
          # Detectar IPs din√°micamente desde cada instancia
          echo "üîç Detectando IPs p√∫blicas y privadas de instancias..."
          echo "" > /tmp/ips.txt
          
          for INSTANCE in "${INSTANCES[@]}"; do
            NAME="${INSTANCE%%|*}"
            PUBLIC_IP="${INSTANCE##*|}"
            
            if [ -z "$PUBLIC_IP" ]; then
              echo "‚è≠Ô∏è  $NAME: IP vac√≠o en secretos, saltando"
              continue
            fi
            
            echo "üîó Conectando a $NAME ($PUBLIC_IP)..."
            
            # Detectar IP privada de la instancia
            PRIVATE_IP=$(ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@$PUBLIC_IP "hostname -I | awk '{print \$1}'" 2>/dev/null || echo "")
            
            if [ -z "$PRIVATE_IP" ]; then
              echo "‚ö†Ô∏è  $NAME: No se pudo obtener IP privada, usando solo p√∫blica"
              echo "$PUBLIC_IP" >> /tmp/ips.txt
            else
              echo "‚úÖ $NAME: PUBLIC=$PUBLIC_IP PRIVATE=$PRIVATE_IP"
              # Guardar en formato: name|public_ip|private_ip
              echo "$NAME|$PUBLIC_IP|$PRIVATE_IP" >> /tmp/ips.txt
            fi
          done
          
          echo ""
          echo "üìã IPs Detectadas:"
          cat /tmp/ips.txt

      - name: Test SSH Connectivity
        id: check
        continue-on-error: true
        run: |
          # Extraer solo IPs p√∫blicas para prueba
          INSTANCES=$(cat /tmp/ips.txt | awk -F'|' '{print $2}' | grep -v '^$')
          REACHABLE=0
          TOTAL=0
          UNREACHABLE=""
          
          for IP in $INSTANCES; do
            TOTAL=$((TOTAL + 1))
            echo "üîç Probando conectividad a $IP..."
            
            if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@$IP "echo ‚úÖ Acceso exitoso" 2>&1; then
              REACHABLE=$((REACHABLE + 1))
              echo "‚úÖ $IP - ACCESIBLE"
            else
              echo "‚ùå $IP - NO ACCESIBLE"
              UNREACHABLE="$UNREACHABLE $IP"
            fi
          done
          
          echo ""
          echo "üìä Resumen: $REACHABLE/$TOTAL instancias accesibles"
          
          if [ $REACHABLE -eq $TOTAL ] && [ $TOTAL -gt 0 ]; then
            echo "all_reachable=true" >> $GITHUB_OUTPUT
          else
            echo "all_reachable=false" >> $GITHUB_OUTPUT
          fi
          
          echo "unreachable=$UNREACHABLE" >> $GITHUB_OUTPUT
          echo "reachable_count=$REACHABLE" >> $GITHUB_OUTPUT
          echo "total_count=$TOTAL" >> $GITHUB_OUTPUT

      - name: Connectivity Report
        run: |
          echo "## üìã Reporte de Conectividad"
          echo ""
          echo "‚úÖ Accesibles: ${{ steps.check.outputs.reachable_count }}/${{ steps.check.outputs.total_count }}"
          echo ""
          if [ "${{ steps.check.outputs.all_reachable }}" == "true" ]; then
            echo "üéâ **TODAS LAS INSTANCIAS ACCESIBLES** - Listo para desplegar"
          else
            echo "‚ö†Ô∏è Instancias no accesibles:${{ steps.check.outputs.unreachable }}"
          fi

      - name: Encode IPs for Deployment
        id: encode_ips
        run: |
          # Codificar el archivo de IPs en base64 para pasar al siguiente job
          if [ -f /tmp/ips.txt ]; then
            ENCODED=$(cat /tmp/ips.txt | base64 -w 0)
            echo "encoded_ips=$ENCODED" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: test-connectivity
    runs-on: ubuntu-latest
    if: ${{ needs.test-connectivity.outputs.all_reachable == 'true' && github.event.inputs.test_only != 'true' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/labsuser.pem
          chmod 600 ~/.ssh/labsuser.pem

      - name: Discover & Assign Instances
        id: instances
        env:
          INSTANCES_DATA: ${{ needs.test-connectivity.outputs.instances_data }}
        run: |
          echo "üîç Leyendo IPs detectadas din√°micamente..."
          
          # Decodificar el archivo de IPs
          if [ -n "$INSTANCES_DATA" ]; then
            echo "$INSTANCES_DATA" | base64 -d > /tmp/ips.txt
          fi
          
          # Asignar IPs por nombre de instancia
          FRONTEND_IP=$(grep "^frontend|" /tmp/ips.txt 2>/dev/null | cut -d'|' -f2 || echo "")
          API_IP=$(grep "^api-gateway|" /tmp/ips.txt 2>/dev/null | cut -d'|' -f2 || echo "")
          CORE_IP=$(grep "^core|" /tmp/ips.txt 2>/dev/null | cut -d'|' -f2 || echo "")
          DB_IP=$(grep "^db|" /tmp/ips.txt 2>/dev/null | cut -d'|' -f2 || echo "")
          MESSAGING_IP=$(grep "^messaging|" /tmp/ips.txt 2>/dev/null | cut -d'|' -f2 || echo "")
          NOTIFICACIONES_IP=$(grep "^notificaciones|" /tmp/ips.txt 2>/dev/null | cut -d'|' -f2 || echo "")
          REPORTES_IP=$(grep "^reportes|" /tmp/ips.txt 2>/dev/null | cut -d'|' -f2 || echo "")
          MONITORING_IP=$(grep "^monitoring|" /tmp/ips.txt 2>/dev/null | cut -d'|' -f2 || echo "")
          BASTION_IP=$(grep "^bastion|" /tmp/ips.txt 2>/dev/null | cut -d'|' -f2 || echo "")
          
          echo ""
          echo "‚úÖ IPs Asignadas (detectadas din√°micamente):"
          echo "  Frontend: $FRONTEND_IP"
          echo "  API Gateway: $API_IP"
          echo "  Core: $CORE_IP"
          echo "  Database: $DB_IP"
          echo "  Messaging: $MESSAGING_IP"
          echo "  Notificaciones: $NOTIFICACIONES_IP"
          echo "  Reportes: $REPORTES_IP"
          echo "  Monitoring: $MONITORING_IP"
          echo "  Bastion: $BASTION_IP"
          
          echo "frontend_ip=$FRONTEND_IP" >> $GITHUB_OUTPUT
          echo "api_ip=$API_IP" >> $GITHUB_OUTPUT
          echo "core_ip=$CORE_IP" >> $GITHUB_OUTPUT
          echo "db_ip=$DB_IP" >> $GITHUB_OUTPUT
          echo "messaging_ip=$MESSAGING_IP" >> $GITHUB_OUTPUT
          echo "notificaciones_ip=$NOTIFICACIONES_IP" >> $GITHUB_OUTPUT
          echo "reportes_ip=$REPORTES_IP" >> $GITHUB_OUTPUT
          echo "monitoring_ip=$MONITORING_IP" >> $GITHUB_OUTPUT
          echo "bastion_ip=$BASTION_IP" >> $GITHUB_OUTPUT

      - name: Install Docker & Deploy to Frontend
        continue-on-error: true
        run: |
          IP="${{ steps.instances.outputs.frontend_ip }}"
          if [ -z "$IP" ]; then
            echo "‚ùå Frontend IP no encontrada"
            exit 1
          fi
          echo "üöÄ Desplegando en FRONTEND ($IP)..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@$IP << 'DEPLOY'
          set -e
          # Install Docker if not already installed
          if ! command -v docker &> /dev/null; then
            echo "üì¶ Instalando Docker..."
            sudo apt-get update -qq
            sudo apt-get install -y -qq docker.io
            sudo usermod -aG docker ubuntu
          fi
          
          # Install docker-compose if not already installed
          if ! command -v docker-compose &> /dev/null; then
            echo "üì¶ Instalando docker-compose..."
            sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi
          
          # Start Docker service
          sudo systemctl start docker || true
          sudo systemctl enable docker || true
          
          echo "üì¶ Clonando repositorio..."
          cd /home/ubuntu
          if [ -d "Proyecto-Acompa-amiento-" ]; then
            cd Proyecto-Acompa-amiento-
            git pull origin main
          else
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          echo "üê≥ Construyendo im√°genes Docker..."
          sudo docker-compose -f docker-compose.frontend.yml build --no-cache
          echo "üê≥ Iniciando contenedores..."
          sudo docker-compose -f docker-compose.frontend.yml down 2>/dev/null || true
          sudo docker-compose -f docker-compose.frontend.yml up -d
          echo "‚úÖ Frontend desplegado exitosamente"
          sudo docker ps | grep frontend
          DEPLOY

      - name: Install Docker & Deploy to API Gateway
        continue-on-error: true
        run: |
          IP="${{ steps.instances.outputs.api_ip }}"
          if [ -z "$IP" ]; then
            echo "‚ùå API Gateway IP no encontrada"
            exit 1
          fi
          echo "üöÄ Desplegando en API GATEWAY ($IP)..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@$IP << 'DEPLOY'
          set -e
          # Install Docker if not already installed
          if ! command -v docker &> /dev/null; then
            echo "üì¶ Instalando Docker..."
            sudo apt-get update -qq
            sudo apt-get install -y -qq docker.io
            sudo usermod -aG docker ubuntu
          fi
          
          # Install docker-compose if not already installed
          if ! command -v docker-compose &> /dev/null; then
            echo "üì¶ Instalando docker-compose..."
            sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi
          
          # Start Docker service
          sudo systemctl start docker || true
          sudo systemctl enable docker || true
          
          echo "üì¶ Clonando repositorio..."
          cd /home/ubuntu
          if [ -d "Proyecto-Acompa-amiento-" ]; then
            cd Proyecto-Acompa-amiento-
            git pull origin main
          else
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          echo "üê≥ Construyendo im√°genes Docker..."
          sudo docker-compose -f docker-compose.api-gateway.yml build --no-cache
          echo "üê≥ Iniciando contenedores..."
          sudo docker-compose -f docker-compose.api-gateway.yml down 2>/dev/null || true
          sudo docker-compose -f docker-compose.api-gateway.yml up -d
          echo "‚úÖ API Gateway desplegado exitosamente"
          sudo docker ps | grep api
          DEPLOY

      - name: Install Docker & Deploy to Core Services
        continue-on-error: true
        run: |
          IP="${{ steps.instances.outputs.core_ip }}"
          if [ -z "$IP" ]; then
            echo "‚è≠Ô∏è Core IP no encontrada (skipping)"
            exit 0
          fi
          echo "üöÄ Desplegando en CORE SERVICES ($IP)..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@$IP << 'DEPLOY'
          set -e
          # Install Docker if not already installed
          if ! command -v docker &> /dev/null; then
            echo "üì¶ Instalando Docker..."
            sudo apt-get update -qq
            sudo apt-get install -y -qq docker.io
            sudo usermod -aG docker ubuntu
          fi
          
          # Install docker-compose if not already installed
          if ! command -v docker-compose &> /dev/null; then
            echo "üì¶ Instalando docker-compose..."
            sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi
          
          # Start Docker service
          sudo systemctl start docker || true
          sudo systemctl enable docker || true
          
          echo "üì¶ Clonando repositorio..."
          cd /home/ubuntu
          if [ -d "Proyecto-Acompa-amiento-" ]; then
            cd Proyecto-Acompa-amiento-
            git pull origin main
          else
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          echo "üê≥ Construyendo im√°genes Docker..."
          sudo docker-compose -f docker-compose.core.yml build --no-cache
          echo "üê≥ Iniciando contenedores..."
          sudo docker-compose -f docker-compose.core.yml down 2>/dev/null || true
          sudo docker-compose -f docker-compose.core.yml up -d
          echo "‚úÖ Core Services desplegado exitosamente"
          sudo docker ps | grep core
          DEPLOY

      - name: Install Docker & Deploy to Database
        continue-on-error: true
        run: |
          IP="${{ steps.instances.outputs.db_ip }}"
          if [ -z "$IP" ]; then
            echo "‚è≠Ô∏è Database IP no encontrada (skipping)"
            exit 0
          fi
          echo "üöÄ Desplegando en DATABASE ($IP)..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@$IP << 'DEPLOY'
          set -e
          # Install Docker if not already installed
          if ! command -v docker &> /dev/null; then
            echo "üì¶ Instalando Docker..."
            sudo apt-get update -qq
            sudo apt-get install -y -qq docker.io
            sudo usermod -aG docker ubuntu
          fi
          
          # Install docker-compose if not already installed
          if ! command -v docker-compose &> /dev/null; then
            echo "üì¶ Instalando docker-compose..."
            sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi
          
          # Start Docker service
          sudo systemctl start docker || true
          sudo systemctl enable docker || true
          
          echo "üì¶ Clonando repositorio..."
          cd /home/ubuntu
          if [ -d "Proyecto-Acompa-amiento-" ]; then
            cd Proyecto-Acompa-amiento-
            git pull origin main
          else
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          echo "üê≥ Construyendo im√°genes Docker..."
          sudo docker-compose -f docker-compose.infrastructure.yml build --no-cache
          echo "üê≥ Iniciando contenedores..."
          sudo docker-compose -f docker-compose.infrastructure.yml down 2>/dev/null || true
          sudo docker-compose -f docker-compose.infrastructure.yml up -d
          echo "‚úÖ Database desplegado exitosamente"
          sudo docker ps | grep -i postgres
          DEPLOY

      - name: Install Docker & Deploy to Messaging
        continue-on-error: true
        run: |
          IP="${{ steps.instances.outputs.messaging_ip }}"
          if [ -z "$IP" ]; then
            echo "‚è≠Ô∏è Messaging IP no encontrada (skipping)"
            exit 0
          fi
          echo "üöÄ Desplegando en MESSAGING ($IP)..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@$IP << 'DEPLOY'
          set -e
          # Install Docker if not already installed
          if ! command -v docker &> /dev/null; then
            echo "üì¶ Instalando Docker..."
            sudo apt-get update -qq
            sudo apt-get install -y -qq docker.io
            sudo usermod -aG docker ubuntu
          fi
          
          # Install docker-compose if not already installed
          if ! command -v docker-compose &> /dev/null; then
            echo "üì¶ Instalando docker-compose..."
            sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi
          
          # Start Docker service
          sudo systemctl start docker || true
          sudo systemctl enable docker || true
          
          echo "üì¶ Clonando repositorio..."
          cd /home/ubuntu
          if [ -d "Proyecto-Acompa-amiento-" ]; then
            cd Proyecto-Acompa-amiento-
            git pull origin main
          else
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          echo "üê≥ Construyendo im√°genes Docker..."
          sudo docker-compose -f docker-compose.messaging.yml build --no-cache
          echo "üê≥ Iniciando contenedores..."
          sudo docker-compose -f docker-compose.messaging.yml down 2>/dev/null || true
          sudo docker-compose -f docker-compose.messaging.yml up -d
          echo "‚úÖ Messaging desplegado exitosamente"
          sudo docker ps | grep rabbit
          DEPLOY

      - name: Install Docker & Deploy to Notificaciones
        continue-on-error: true
        run: |
          IP="${{ steps.instances.outputs.notificaciones_ip }}"
          if [ -z "$IP" ]; then
            echo "‚è≠Ô∏è Notificaciones IP no encontrada (skipping)"
            exit 0
          fi
          echo "üöÄ Desplegando en NOTIFICACIONES ($IP)..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@$IP << 'DEPLOY'
          set -e
          # Install Docker if not already installed
          if ! command -v docker &> /dev/null; then
            echo "üì¶ Instalando Docker..."
            sudo apt-get update -qq
            sudo apt-get install -y -qq docker.io
            sudo usermod -aG docker ubuntu
          fi
          
          # Install docker-compose if not already installed
          if ! command -v docker-compose &> /dev/null; then
            echo "üì¶ Instalando docker-compose..."
            sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi
          
          # Start Docker service
          sudo systemctl start docker || true
          sudo systemctl enable docker || true
          
          echo "üì¶ Clonando repositorio..."
          cd /home/ubuntu
          if [ -d "Proyecto-Acompa-amiento-" ]; then
            cd Proyecto-Acompa-amiento-
            git pull origin main
          else
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          echo "üê≥ Construyendo im√°genes Docker..."
          sudo docker-compose -f docker-compose.notificaciones.yml build --no-cache
          echo "üê≥ Iniciando contenedores..."
          sudo docker-compose -f docker-compose.notificaciones.yml down 2>/dev/null || true
          sudo docker-compose -f docker-compose.notificaciones.yml up -d
          echo "‚úÖ Notificaciones desplegado exitosamente"
          sudo docker ps | grep notifi
          DEPLOY

      - name: Install Docker & Deploy to Reportes
        continue-on-error: true
        run: |
          IP="${{ steps.instances.outputs.reportes_ip }}"
          if [ -z "$IP" ]; then
            echo "‚è≠Ô∏è Reportes IP no encontrada (skipping)"
            exit 0
          fi
          echo "üöÄ Desplegando en REPORTES ($IP)..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@$IP << 'DEPLOY'
          set -e
          # Install Docker if not already installed
          if ! command -v docker &> /dev/null; then
            echo "üì¶ Instalando Docker..."
            sudo apt-get update -qq
            sudo apt-get install -y -qq docker.io
            sudo usermod -aG docker ubuntu
          fi
          
          # Install docker-compose if not already installed
          if ! command -v docker-compose &> /dev/null; then
            echo "üì¶ Instalando docker-compose..."
            sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi
          
          # Start Docker service
          sudo systemctl start docker || true
          sudo systemctl enable docker || true
          
          echo "üì¶ Clonando repositorio..."
          cd /home/ubuntu
          if [ -d "Proyecto-Acompa-amiento-" ]; then
            cd Proyecto-Acompa-amiento-
            git pull origin main
          else
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          echo "üê≥ Construyendo im√°genes Docker..."
          sudo docker-compose -f docker-compose.reportes.yml build --no-cache
          echo "üê≥ Iniciando contenedores..."
          sudo docker-compose -f docker-compose.reportes.yml down 2>/dev/null || true
          sudo docker-compose -f docker-compose.reportes.yml up -d
          echo "‚úÖ Reportes desplegado exitosamente"
          sudo docker ps
          DEPLOY

      - name: Install Docker & Deploy to Monitoring
        continue-on-error: true
        run: |
          IP="${{ steps.instances.outputs.monitoring_ip }}"
          if [ -z "$IP" ]; then
            echo "‚è≠Ô∏è Monitoring IP no encontrada (skipping)"
            exit 0
          fi
          echo "üöÄ Desplegando en MONITORING ($IP)..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@$IP << 'DEPLOY'
          set -e
          # Install Docker if not already installed
          if ! command -v docker &> /dev/null; then
            echo "üì¶ Instalando Docker..."
            sudo apt-get update -qq
            sudo apt-get install -y -qq docker.io
            sudo usermod -aG docker ubuntu
          fi
          
          # Install docker-compose if not already installed
          if ! command -v docker-compose &> /dev/null; then
            echo "üì¶ Instalando docker-compose..."
            sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi
          
          # Start Docker service
          sudo systemctl start docker || true
          sudo systemctl enable docker || true
          
          echo "üì¶ Clonando repositorio..."
          cd /home/ubuntu
          if [ -d "Proyecto-Acompa-amiento-" ]; then
            cd Proyecto-Acompa-amiento-
            git pull origin main
          else
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          echo "üê≥ Construyendo im√°genes Docker..."
          sudo docker-compose -f monitoring/docker-compose.yml build --no-cache
          echo "üê≥ Iniciando contenedores..."
          sudo docker-compose -f monitoring/docker-compose.yml down 2>/dev/null || true
          sudo docker-compose -f monitoring/docker-compose.yml up -d
          echo "‚úÖ Monitoring desplegado exitosamente"
          sudo docker ps
          DEPLOY

      - name: Prepare Bastion (Jump Host)
        continue-on-error: true
        run: |
          IP="${{ steps.instances.outputs.bastion_ip }}"
          if [ -z "$IP" ]; then
            echo "‚è≠Ô∏è Bastion IP no encontrada (skipping)"
            exit 0
          fi
          echo "üöÄ Preparando BASTION ($IP)..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@$IP << 'DEPLOY'
          set -e
          echo "üì¶ Clonando repositorio..."
          cd /home/ubuntu
          if [ -d "Proyecto-Acompa-amiento-" ]; then
            cd Proyecto-Acompa-amiento-
            git pull origin main
          else
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          echo "‚úÖ Bastion listo (acceso jump host)"
          DEPLOY

      - name: Deployment Summary
        if: always()
        run: |
          echo "## üéØ Resumen de Despliegue Completo"
          echo ""
          echo "| Servicio | IP | Estado |"
          echo "|----------|-------|--------|"
          echo "| üåê Frontend | ${{ steps.instances.outputs.frontend_ip }} | ‚úÖ |"
          echo "| üîå API Gateway | ${{ steps.instances.outputs.api_ip }} | ‚úÖ |"
          echo "| üíª Core Services | ${{ steps.instances.outputs.core_ip }} | ‚úÖ |"
          echo "| üóÑÔ∏è Database | ${{ steps.instances.outputs.db_ip }} | ‚úÖ |"
          echo "| üì® Messaging | ${{ steps.instances.outputs.messaging_ip }} | ‚úÖ |"
          echo "| üîî Notificaciones | ${{ steps.instances.outputs.notificaciones_ip }} | ‚úÖ |"
          echo "| üìä Reportes | ${{ steps.instances.outputs.reportes_ip }} | ‚úÖ |"
          echo "| üìà Monitoring | ${{ steps.instances.outputs.monitoring_ip }} | ‚úÖ |"
          echo "| üö™ Bastion | ${{ steps.instances.outputs.bastion_ip }} | ‚úÖ |"
          echo ""
          echo "**Total: 9/9 servicios desplegados**"
          echo "Verifica los logs arriba para detalles de cada despliegue"
