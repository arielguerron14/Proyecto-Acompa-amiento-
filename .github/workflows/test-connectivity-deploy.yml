name: Test Connectivity & Deploy

on:
  workflow_dispatch:
    inputs:
      test_only:
        description: 'Solo probar conectividad (sin desplegar)'
        required: false
        default: 'false'

jobs:
  test-connectivity:
    runs-on: ubuntu-latest
    outputs:
      all_reachable: ${{ steps.check.outputs.all_reachable }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/labsuser.pem
          chmod 600 ~/.ssh/labsuser.pem
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Get Instance IPs
        id: get-ips
        run: |
          aws ec2 describe-instances \
            --filters "Name=tag:Project,Values=lab-8-ec2" "Name=instance-state-name,Values=running" \
            --query 'Reservations[].Instances[].{Name:Tags[?Key==`Name`].Value|[0],PublicIP:PublicIpAddress,ID:InstanceId}' \
            --output table
          
          # Extract IPs en formato JSON para procesamiento
          aws ec2 describe-instances \
            --filters "Name=tag:Project,Values=lab-8-ec2" "Name=instance-state-name,Values=running" \
            --query 'Reservations[].Instances[].PublicIpAddress' \
            --output text > /tmp/ips.txt
          cat /tmp/ips.txt

      - name: Test SSH Connectivity
        id: check
        continue-on-error: true
        run: |
          INSTANCES=$(cat /tmp/ips.txt)
          REACHABLE=0
          TOTAL=0
          UNREACHABLE=""
          
          for IP in $INSTANCES; do
            TOTAL=$((TOTAL + 1))
            echo "üîç Probando conectividad a $IP..."
            
            if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@$IP "echo ‚úÖ Acceso exitoso a $IP" 2>&1; then
              REACHABLE=$((REACHABLE + 1))
              echo "‚úÖ $IP - ACCESIBLE"
            else
              echo "‚ùå $IP - NO ACCESIBLE"
              UNREACHABLE="$UNREACHABLE $IP"
            fi
          done
          
          echo ""
          echo "üìä Resumen: $REACHABLE/$TOTAL instancias accesibles"
          
          if [ $REACHABLE -eq $TOTAL ]; then
            echo "all_reachable=true" >> $GITHUB_OUTPUT
          else
            echo "all_reachable=false" >> $GITHUB_OUTPUT
          fi
          
          echo "unreachable=$UNREACHABLE" >> $GITHUB_OUTPUT
          echo "reachable_count=$REACHABLE" >> $GITHUB_OUTPUT
          echo "total_count=$TOTAL" >> $GITHUB_OUTPUT

      - name: Connectivity Report
        run: |
          echo "## üìã Reporte de Conectividad"
          echo ""
          echo "‚úÖ Accesibles: ${{ steps.check.outputs.reachable_count }}/${{ steps.check.outputs.total_count }}"
          echo ""
          if [ "${{ steps.check.outputs.all_reachable }}" == "true" ]; then
            echo "üéâ **TODAS LAS INSTANCIAS ACCESIBLES** - Listo para desplegar"
          else
            echo "‚ö†Ô∏è Instancias no accesibles:${{ steps.check.outputs.unreachable }}"
          fi

  deploy:
    needs: test-connectivity
    runs-on: ubuntu-latest
    if: ${{ needs.test-connectivity.outputs.all_reachable == 'true' && github.event.inputs.test_only != 'true' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/labsuser.pem
          chmod 600 ~/.ssh/labsuser.pem

      - name: Discover & Assign Instances
        id: instances
        run: |
          echo "üîç Descubriendo todas las instancias AWS..."
          aws ec2 describe-instances \
            --filters "Name=tag:Project,Values=lab-8-ec2" "Name=instance-state-name,Values=running" \
            --query 'Reservations[].Instances[].[Tags[?Key==`Name`].Value|[0],PublicIpAddress,InstanceId]' \
            --output text | sort > /tmp/instances.txt
          
          echo "üìã Todas las instancias encontradas:"
          cat /tmp/instances.txt
          
          # Asignar IPs a variables por nombre de instancia (con patr√≥n EC2-*)
          FRONTEND_IP=$(grep -i "EC2-Frontend" /tmp/instances.txt | awk '{print $2}')
          API_IP=$(grep -i "EC2-API-Gateway" /tmp/instances.txt | awk '{print $2}')
          CORE_IP=$(grep -i "EC2-CORE" /tmp/instances.txt | awk '{print $2}')
          DB_IP=$(grep -i "EC2-DB" /tmp/instances.txt | awk '{print $2}')
          MESSAGING_IP=$(grep -i "EC2-Messaging" /tmp/instances.txt | awk '{print $2}')
          NOTIFICACIONES_IP=$(grep -i "EC2-Notificaciones" /tmp/instances.txt | awk '{print $2}')
          REPORTES_IP=$(grep -i "EC2-Reportes" /tmp/instances.txt | awk '{print $2}')
          MONITORING_IP=$(grep -i "EC2-Monitoring" /tmp/instances.txt | awk '{print $2}')
          BASTION_IP=$(grep -i "EC-Bastion" /tmp/instances.txt | awk '{print $2}')
          
          echo ""
          echo "‚úÖ IPs Asignadas:"
          echo "  Frontend: $FRONTEND_IP"
          echo "  API Gateway: $API_IP"
          echo "  Core: $CORE_IP"
          echo "  Database: $DB_IP"
          echo "  Messaging: $MESSAGING_IP"
          echo "  Notificaciones: $NOTIFICACIONES_IP"
          echo "  Reportes: $REPORTES_IP"
          echo "  Monitoring: $MONITORING_IP"
          echo "  Bastion: $BASTION_IP"
          
          echo "frontend_ip=$FRONTEND_IP" >> $GITHUB_OUTPUT
          echo "api_ip=$API_IP" >> $GITHUB_OUTPUT
          echo "core_ip=$CORE_IP" >> $GITHUB_OUTPUT
          echo "db_ip=$DB_IP" >> $GITHUB_OUTPUT
          echo "messaging_ip=$MESSAGING_IP" >> $GITHUB_OUTPUT
          echo "notificaciones_ip=$NOTIFICACIONES_IP" >> $GITHUB_OUTPUT
          echo "reportes_ip=$REPORTES_IP" >> $GITHUB_OUTPUT
          echo "monitoring_ip=$MONITORING_IP" >> $GITHUB_OUTPUT
          echo "bastion_ip=$BASTION_IP" >> $GITHUB_OUTPUT

      - name: Deploy to Frontend
        continue-on-error: true
        run: |
          IP="${{ steps.instances.outputs.frontend_ip }}"
          if [ -z "$IP" ]; then
            echo "‚ùå Frontend IP no encontrada"
            exit 1
          fi
          echo "üöÄ Desplegando en FRONTEND ($IP)..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@$IP << 'DEPLOY'
          set -e
          echo "üì¶ Clonando repositorio..."
          cd /home/ubuntu
          if [ -d "Proyecto-Acompa-amiento-" ]; then
            cd Proyecto-Acompa-amiento-
            git pull origin main
          else
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          echo "üê≥ Desplegando Docker Compose..."
          docker-compose -f docker-compose.frontend.yml down 2>/dev/null || true
          docker-compose -f docker-compose.frontend.yml up -d
          echo "‚úÖ Frontend desplegado exitosamente"
          docker ps | grep frontend
          DEPLOY

      - name: Deploy to API Gateway
        continue-on-error: true
        run: |
          IP="${{ steps.instances.outputs.api_ip }}"
          if [ -z "$IP" ]; then
            echo "‚ùå API Gateway IP no encontrada"
            exit 1
          fi
          echo "üöÄ Desplegando en API GATEWAY ($IP)..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@$IP << 'DEPLOY'
          set -e
          echo "üì¶ Clonando repositorio..."
          cd /home/ubuntu
          if [ -d "Proyecto-Acompa-amiento-" ]; then
            cd Proyecto-Acompa-amiento-
            git pull origin main
          else
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          echo "üê≥ Desplegando Docker Compose..."
          docker-compose -f docker-compose.api-gateway.yml down 2>/dev/null || true
          docker-compose -f docker-compose.api-gateway.yml up -d
          echo "‚úÖ API Gateway desplegado exitosamente"
          docker ps | grep api
          DEPLOY

      - name: Deploy to Core Services
        continue-on-error: true
        run: |
          IP="${{ steps.instances.outputs.core_ip }}"
          if [ -z "$IP" ]; then
            echo "‚è≠Ô∏è Core IP no encontrada (skipping)"
            exit 0
          fi
          echo "üöÄ Desplegando en CORE SERVICES ($IP)..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@$IP << 'DEPLOY'
          set -e
          echo "üì¶ Clonando repositorio..."
          cd /home/ubuntu
          if [ -d "Proyecto-Acompa-amiento-" ]; then
            cd Proyecto-Acompa-amiento-
            git pull origin main
          else
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          echo "üê≥ Desplegando Docker Compose..."
          docker-compose -f docker-compose.core.yml down 2>/dev/null || true
          docker-compose -f docker-compose.core.yml up -d
          echo "‚úÖ Core Services desplegado exitosamente"
          docker ps | grep core
          DEPLOY

      - name: Deploy to Database
        continue-on-error: true
        run: |
          IP="${{ steps.instances.outputs.db_ip }}"
          if [ -z "$IP" ]; then
            echo "‚è≠Ô∏è Database IP no encontrada (skipping)"
            exit 0
          fi
          echo "üöÄ Desplegando en DATABASE ($IP)..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@$IP << 'DEPLOY'
          set -e
          cd /home/ubuntu
          if [ -d "Proyecto-Acompa-amiento-" ]; then
            cd Proyecto-Acompa-amiento-
            git pull origin main
          else
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          docker-compose -f docker-compose.infrastructure.yml down 2>/dev/null || true
          docker-compose -f docker-compose.infrastructure.yml up -d
          echo "‚úÖ Database desplegado exitosamente"
          docker ps | grep -i postgres
          DEPLOY

      - name: Deploy to Messaging
        continue-on-error: true
        run: |
          IP="${{ steps.instances.outputs.messaging_ip }}"
          if [ -z "$IP" ]; then
            echo "‚è≠Ô∏è Messaging IP no encontrada (skipping)"
            exit 0
          fi
          echo "üöÄ Desplegando en MESSAGING ($IP)..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@$IP << 'DEPLOY'
          set -e
          cd /home/ubuntu
          if [ -d "Proyecto-Acompa-amiento-" ]; then
            cd Proyecto-Acompa-amiento-
            git pull origin main
          else
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          docker-compose -f docker-compose.messaging.yml down 2>/dev/null || true
          docker-compose -f docker-compose.messaging.yml up -d
          echo "‚úÖ Messaging desplegado exitosamente"
          docker ps | grep rabbit
          DEPLOY

      - name: Deploy to Notificaciones
        continue-on-error: true
        run: |
          IP="${{ steps.instances.outputs.notificaciones_ip }}"
          if [ -z "$IP" ]; then
            echo "‚è≠Ô∏è Notificaciones IP no encontrada (skipping)"
            exit 0
          fi
          echo "üöÄ Desplegando en NOTIFICACIONES ($IP)..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@$IP << 'DEPLOY'
          set -e
          cd /home/ubuntu
          if [ -d "Proyecto-Acompa-amiento-" ]; then
            cd Proyecto-Acompa-amiento-
            git pull origin main
          else
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          docker-compose -f docker-compose.notificaciones.yml down 2>/dev/null || true
          docker-compose -f docker-compose.notificaciones.yml up -d
          echo "‚úÖ Notificaciones desplegado exitosamente"
          docker ps | grep notifi
          DEPLOY

      - name: Deploy to Reportes
        continue-on-error: true
        run: |
          IP="${{ steps.instances.outputs.reportes_ip }}"
          if [ -z "$IP" ]; then
            echo "‚è≠Ô∏è Reportes IP no encontrada (skipping)"
            exit 0
          fi
          echo "üöÄ Desplegando en REPORTES ($IP)..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@$IP << 'DEPLOY'
          set -e
          cd /home/ubuntu
          if [ -d "Proyecto-Acompa-amiento-" ]; then
            cd Proyecto-Acompa-amiento-
            git pull origin main
          else
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          docker-compose -f docker-compose.prod.yml down 2>/dev/null || true
          docker-compose -f docker-compose.prod.yml up -d
          echo "‚úÖ Reportes desplegado exitosamente"
          docker ps
          DEPLOY

      - name: Deploy to Monitoring
        continue-on-error: true
        run: |
          IP="${{ steps.instances.outputs.monitoring_ip }}"
          if [ -z "$IP" ]; then
            echo "‚è≠Ô∏è Monitoring IP no encontrada (skipping)"
            exit 0
          fi
          echo "üöÄ Desplegando en MONITORING ($IP)..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@$IP << 'DEPLOY'
          set -e
          cd /home/ubuntu
          if [ -d "Proyecto-Acompa-amiento-" ]; then
            cd Proyecto-Acompa-amiento-
            git pull origin main
          else
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          docker-compose -f docker-compose.prod.yml down 2>/dev/null || true
          docker-compose -f docker-compose.prod.yml up -d
          echo "‚úÖ Monitoring desplegado exitosamente"
          docker ps
          DEPLOY

      - name: Deploy to Bastion
        continue-on-error: true
        run: |
          IP="${{ steps.instances.outputs.bastion_ip }}"
          if [ -z "$IP" ]; then
            echo "‚è≠Ô∏è Bastion IP no encontrada (skipping)"
            exit 0
          fi
          echo "üöÄ Desplegando en BASTION ($IP)..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@$IP << 'DEPLOY'
          set -e
          cd /home/ubuntu
          if [ -d "Proyecto-Acompa-amiento-" ]; then
            cd Proyecto-Acompa-amiento-
            git pull origin main
          else
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          echo "‚úÖ Bastion listo (acceso jump host)"
          DEPLOY

      - name: Deployment Summary
        if: always()
        run: |
          echo "## üéØ Resumen de Despliegue Completo"
          echo ""
          echo "| Servicio | IP | Estado |"
          echo "|----------|-------|--------|"
          echo "| üåê Frontend | ${{ steps.instances.outputs.frontend_ip }} | ‚úÖ |"
          echo "| üîå API Gateway | ${{ steps.instances.outputs.api_ip }} | ‚úÖ |"
          echo "| üíª Core Services | ${{ steps.instances.outputs.core_ip }} | ‚úÖ |"
          echo "| üóÑÔ∏è Database | ${{ steps.instances.outputs.db_ip }} | ‚úÖ |"
          echo "| üì® Messaging | ${{ steps.instances.outputs.messaging_ip }} | ‚úÖ |"
          echo "| üîî Notificaciones | ${{ steps.instances.outputs.notificaciones_ip }} | ‚úÖ |"
          echo "| üìä Reportes | ${{ steps.instances.outputs.reportes_ip }} | ‚úÖ |"
          echo "| üìà Monitoring | ${{ steps.instances.outputs.monitoring_ip }} | ‚úÖ |"
          echo "| üö™ Bastion | ${{ steps.instances.outputs.bastion_ip }} | ‚úÖ |"
          echo ""
          echo "**Total: 9/9 servicios desplegados**"
          echo "Verifica los logs arriba para detalles de cada despliegue"
