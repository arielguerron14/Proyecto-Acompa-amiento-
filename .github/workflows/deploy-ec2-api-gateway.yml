name: Deploy EC2-API-Gateway Services (api-gateway)

on:
  workflow_dispatch:
    inputs:
      instance_name:
        description: 'EC2 Instance name to deploy (default: EC2-API-Gateway)'
        required: false
        default: 'EC2-API-Gateway'
      skip_verification:
        description: 'Skip health verification (true/false)'
        required: false
        default: 'false'

env:
  INSTANCE_NAME: ${{ github.event.inputs.instance_name || 'EC2-API-Gateway' }}
  INSTANCE_USER: ubuntu
  REPO_URL: https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
  AWS_REGION: us-east-1

jobs:
  deploy-api-gateway:
    runs-on: ubuntu-latest
    name: Deploy API Gateway to EC2-API-Gateway

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Discover EC2 instances and IPs
        run: |
          echo "üîç Discovering EC2 instances..."

          INSTANCE_INFO=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=${{ env.INSTANCE_NAME }}" \
                      "Name=instance-state-name,Values=running" \
            --query 'Reservations[].Instances[].[PublicIpAddress, PrivateIpAddress, InstanceId, InstanceType, Tags[?Key==`Name`].Value|[0]]' \
            --output json)

          PUBLIC_IP=$(echo "$INSTANCE_INFO" | jq -r '.[0][0]')
          PRIVATE_IP=$(echo "$INSTANCE_INFO" | jq -r '.[0][1]')
          INSTANCE_ID=$(echo "$INSTANCE_INFO" | jq -r '.[0][2]')
          INSTANCE_TYPE=$(echo "$INSTANCE_INFO" | jq -r '.[0][3]')

          echo "INSTANCE_PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_ENV
          echo "INSTANCE_PRIVATE_IP=$PRIVATE_IP" >> $GITHUB_ENV
          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_ENV
          echo "INSTANCE_TYPE=$INSTANCE_TYPE" >> $GITHUB_ENV

          if [ -z "$PUBLIC_IP" ] || [ "$PUBLIC_IP" == "null" ]; then
            echo "‚ùå ERROR: Could not find instance with name: ${{ env.INSTANCE_NAME }}"
            aws ec2 describe-instances \
              --filters "Name=instance-state-name,Values=running" \
              --query 'Reservations[].Instances[].[InstanceId, InstanceType, PublicIpAddress, Tags[?Key==`Name`].Value|[0]]' \
              --output table
            exit 1
          fi

          echo "‚úÖ Instance discovered:" && \
          echo "   Name:       ${{ env.INSTANCE_NAME }}" && \
          echo "   ID:         $INSTANCE_ID" && \
          echo "   Type:       $INSTANCE_TYPE" && \
          echo "   Public IP:  $PUBLIC_IP" && \
          echo "   Private IP: $PRIVATE_IP"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.INSTANCE_PUBLIC_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Verify SSH connection
        run: |
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ env.INSTANCE_USER }}@${{ env.INSTANCE_PUBLIC_IP }} "echo '‚úÖ SSH connection successful'; whoami"

      - name: Detect instance and prepare environment
        run: |
          echo "Instance Name:   ${{ env.INSTANCE_NAME }}"
          echo "Instance ID:     ${{ env.INSTANCE_ID }}"
          echo "Instance Type:   ${{ env.INSTANCE_TYPE }}"
          echo "Public IP:       ${{ env.INSTANCE_PUBLIC_IP }}"
          echo "Private IP:      ${{ env.INSTANCE_PRIVATE_IP }}"
          echo "Services:        api-gateway"

      - name: Discover dependent EC2 instances
        id: discover_deps
        run: |
          echo "üîç Discovering EC2-CORE instance..."
          CORE_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=EC2-CORE" \
                      "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].PrivateIpAddress' \
            --output text)
          
          if [ -z "$CORE_IP" ] || [ "$CORE_IP" == "None" ]; then
            echo "‚ö†Ô∏è EC2-CORE not found, using localhost fallback"
            CORE_IP="localhost"
          else
            echo "‚úÖ Found EC2-CORE at $CORE_IP"
          fi
          
          echo "CORE_IP=$CORE_IP" >> $GITHUB_OUTPUT

          echo "üîç Discovering EC2-Reportes instance..."
          REPORTES_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=EC2-Reportes" \
                      "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].PrivateIpAddress' \
            --output text)

          if [ -z "$REPORTES_IP" ] || [ "$REPORTES_IP" == "None" ]; then
            echo "‚ö†Ô∏è EC2-Reportes not found, defaulting to CORE_IP"
            REPORTES_IP="$CORE_IP"
          else
            echo "‚úÖ Found EC2-Reportes at $REPORTES_IP"
          fi

          echo "REPORTES_IP=$REPORTES_IP" >> $GITHUB_OUTPUT
          
          echo "üîç Discovering EC2-Frontend instance..."
          FRONTEND_PUBLIC_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=EC2-Frontend" \
                      "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          
          if [ -z "$FRONTEND_PUBLIC_IP" ] || [ "$FRONTEND_PUBLIC_IP" == "None" ]; then
            echo "‚ö†Ô∏è EC2-Frontend not found, using localhost fallback"
            FRONTEND_PUBLIC_IP="localhost"
          else
            echo "‚úÖ Found EC2-Frontend at $FRONTEND_PUBLIC_IP"
          fi
          
          echo "FRONTEND_PUBLIC_IP=$FRONTEND_PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "CORS_ORIGIN=http://$FRONTEND_PUBLIC_IP:5500" >> $GITHUB_OUTPUT

      - name: Deploy and configure api-gateway
        run: |
          CORE_HOST="${{ steps.discover_deps.outputs.CORE_IP }}"
          REPORTES_HOST="${{ steps.discover_deps.outputs.REPORTES_IP }}"
          CORS_ORIGIN="${{ steps.discover_deps.outputs.CORS_ORIGIN }}"
          FRONTEND_PUBLIC_IP="${{ steps.discover_deps.outputs.FRONTEND_PUBLIC_IP }}"
          
          echo "üîó Routing to EC2-CORE: $CORE_HOST"
          echo "üìë Routing reportes to: $REPORTES_HOST"
          echo "üîì CORS Origin: $CORS_ORIGIN"
          echo "üåê Frontend Public IP: $FRONTEND_PUBLIC_IP"
          
          ssh -o StrictHostKeyChecking=no ${{ env.INSTANCE_USER }}@${{ env.INSTANCE_PUBLIC_IP }} bash -s "$CORE_HOST" "$REPORTES_HOST" "$CORS_ORIGIN" "$FRONTEND_PUBLIC_IP" << 'SSHEOF'
          CORE_HOST="$1"
          REPORTES_HOST="$2"
          CORS_ORIGIN="$3"
          FRONTEND_PUBLIC_IP="$4"
          set -e

          echo "=== EC2-API-Gateway Deployment Started ==="
          echo "Hostname: $(hostname)"
          echo "IP Address: $(hostname -I)"

          echo "üì¶ Updating system packages..."
          sudo apt-get update -qq || true

          echo "üê≥ Checking Docker installation..."
          if ! command -v docker &> /dev/null; then
            sudo apt-get install -y docker.io docker-compose git
            sudo systemctl enable docker
            sudo systemctl start docker
            sudo usermod -aG docker ubuntu
          fi

          echo "üê≥ Setting up Docker Compose..."
          if docker compose version &> /dev/null 2>&1; then
            export DC="docker compose"
          elif command -v docker-compose &> /dev/null; then
            export DC="docker-compose"
          else
            sudo apt-get install -y docker-compose-plugin 2>/dev/null || {
              curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /tmp/docker-compose
              sudo mv /tmp/docker-compose /usr/local/bin/
              sudo chmod +x /usr/local/bin/docker-compose
              export DC="docker-compose"
            }
          fi
          echo "‚úÖ Using: $DC"

          if [ ! -d ~/projeto-acompanamiento ]; then
            cd ~ && git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git projeto-acompanamiento
          else
            cd ~/projeto-acompanamiento && git pull origin main
          fi

          cd ~/projeto-acompanamiento

          echo "üî® Building api-gateway image..."
          $DC build api-gateway --no-cache 2>&1 | tail -20 || echo "‚ö†Ô∏è Build notes"

          echo "üöÄ Starting api-gateway with environment variables..."
          echo "   CORE_HOST=$CORE_HOST"
          echo "   REPORTES_HOST=$REPORTES_HOST"
          echo "   CORS_ORIGIN=$CORS_ORIGIN"
          
          # Create .env.local to ensure variables are loaded
          cat > .env.local << 'ENVEOF'
CORE_HOST=$CORE_HOST
REPORTES_HOST=$REPORTES_HOST
CORS_ORIGIN=$CORS_ORIGIN
CORS_WHITELIST=$CORS_ORIGIN
FRONTEND_PUBLIC_IP=$FRONTEND_PUBLIC_IP
NODE_ENV=production
DOCKER_DEPLOYMENT=true
API_GATEWAY_PORT=8080
PORT=8080
LOG_LEVEL=debug
ENVEOF
          
          echo "üìù Created .env.local with:"
          cat .env.local | grep -E "CORE_HOST|REPORTES_HOST|CORS_ORIGIN" || true
          
          # Stop old container if exists
          $DC down api-gateway 2>/dev/null || true
          sleep 2
          
          # Start with env files
          $DC up -d api-gateway
          
          echo "üìù Service discovery configured:"
          echo "   - EC2-CORE routing: $CORE_HOST"
          echo "   - CORS allowed origin: $CORS_ORIGIN"

          echo "‚è≥ Waiting for api-gateway to initialize (25 seconds)..."
          sleep 25

          echo "‚úÖ Current container status:" && $DC ps
          echo "=== EC2-API-Gateway Deployment Completed ==="
          SSHEOF

      - name: Health check - api-gateway
        if: ${{ github.event.inputs.skip_verification != 'true' }}
        continue-on-error: true
        run: |
          echo "üîç Checking api-gateway container..."
          ssh -o StrictHostKeyChecking=no ${{ env.INSTANCE_USER }}@${{ env.INSTANCE_PUBLIC_IP }} << 'EOF' || true
          cd ~/projeto-acompanamiento
          if docker compose version &>/dev/null 2>&1; then DC="docker compose"; elif command -v docker-compose &>/dev/null 2>&1; then DC="docker-compose"; else exit 0; fi
          $DC ps | grep api-gateway || true
          EOF

      - name: Verify all services and generate report
        if: always()
        run: |
          echo "üìä Final service status on ${{ env.INSTANCE_NAME }}:"
          ssh -o StrictHostKeyChecking=no ${{ env.INSTANCE_USER }}@${{ env.INSTANCE_PUBLIC_IP }} << 'EOF' || true
          cd ~/projeto-acompanamiento

          if docker compose version &>/dev/null 2>&1; then
            DC="docker compose"
          elif command -v docker-compose &>/dev/null 2>&1; then
            DC="docker-compose"
          else
            DC="docker compose"
          fi

          echo "=== Docker Containers Status ==="
          $DC ps

          echo -e "\n=== API Gateway Service (expected running) ==="
          echo "- api-gateway"

          echo -e "\n‚úÖ EC2-API-Gateway deployment completed"
          EOF
