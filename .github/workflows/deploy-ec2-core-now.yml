name: Deploy EC2-CORE NOW

on:
  workflow_dispatch:

env:
  EC2_CORE_PUBLIC_IP: 13.216.12.61
  SSH_USER: ubuntu

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_EC2_DB_SSH_PRIVATE_KEY }}" > ~/.ssh/key.pem
          chmod 600 ~/.ssh/key.pem
          ssh-keyscan -H ${{ env.EC2_CORE_PUBLIC_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy
        run: |
          ssh -i ~/.ssh/key.pem -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.EC2_CORE_PUBLIC_IP }} "bash -s" << 'DEPLOY'
          set -e
          sudo mkdir -p /opt/microservices
          sudo chown -R $USER:$USER /opt/microservices
          cd /opt/microservices
          echo "ðŸ§¹ Cleaning old deployments..."
          docker rm -f micro-auth micro-estudiantes micro-maestros 2>/dev/null || true
          docker rmi micro-auth micro-estudiantes micro-maestros 2>/dev/null || true
          echo "ðŸ“¥ Cloning repository..."
          if [ -d "proyecto" ]; then
            cd proyecto; git pull origin main; cd ..
          else
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git proyecto
          fi
          echo "ðŸ—ï¸ Building Docker images..."
          cd proyecto
          docker build -f micro-auth/Dockerfile -t micro-auth:latest . --quiet
          docker build -f micro-estudiantes/Dockerfile -t micro-estudiantes:latest . --quiet
          docker build -f micro-maestros/Dockerfile -t micro-maestros:latest . --quiet
          cd /opt/microservices
          echo "ðŸ“ Creating docker-compose.yml..."
          cat > docker-compose.yml << 'COMPOSE'
          version: '3.8'
          services:
            micro-auth:
              image: micro-auth:latest
              container_name: micro-auth
              ports:
                - "3000:3000"
              environment:
                NODE_ENV: production
                PORT: 3000
                MONGO_URL: mongodb://admin:mongodb123@172.31.79.193:27017/acompanamiento?authSource=admin
                POSTGRES_URL: postgresql://postgres:postgres123@172.31.79.193:5432/acompanamiento
                REDIS_URL: redis://:redis123@172.31.79.193:6379
              restart: unless-stopped
              networks:
                - core
              healthcheck:
                test: ["CMD-SHELL", "curl -f http://localhost:3000/health || exit 1"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 40s
            micro-estudiantes:
              image: micro-estudiantes:latest
              container_name: micro-estudiantes
              ports:
                - "3001:3001"
              environment:
                NODE_ENV: production
                PORT: 3001
                MONGO_URL: mongodb://admin:mongodb123@172.31.79.193:27017/acompanamiento?authSource=admin
                POSTGRES_URL: postgresql://postgres:postgres123@172.31.79.193:5432/acompanamiento
                REDIS_URL: redis://:redis123@172.31.79.193:6379
                AUTH_SERVICE: http://172.31.78.183:3000
              restart: unless-stopped
              networks:
                - core
              healthcheck:
                test: ["CMD-SHELL", "curl -f http://localhost:3001/health || exit 1"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 40s
            micro-maestros:
              image: micro-maestros:latest
              container_name: micro-maestros
              ports:
                - "3002:3002"
              environment:
                NODE_ENV: production
                PORT: 3002
                MONGO_URL: mongodb://admin:mongodb123@172.31.79.193:27017/acompanamiento?authSource=admin
                POSTGRES_URL: postgresql://postgres:postgres123@172.31.79.193:5432/acompanamiento
                REDIS_URL: redis://:redis123@172.31.79.193:6379
                AUTH_SERVICE: http://172.31.78.183:3000
              restart: unless-stopped
              networks:
                - core
              healthcheck:
                test: ["CMD-SHELL", "curl -f http://localhost:3002/health || exit 1"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 40s
          networks:
            core:
              driver: bridge
          COMPOSE
          echo "ðŸš€ Starting services..."
          docker-compose up -d
          sleep 45
          echo "ðŸ“Š Service Status:"
          docker ps -a
          DEPLOY
