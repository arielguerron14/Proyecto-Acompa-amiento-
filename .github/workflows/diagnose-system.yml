name: Diagnose System Status

on:
  workflow_dispatch:

env:
  SSH_KEY: ${{ secrets.AWS_EC2_DB_SSH_PRIVATE_KEY }}

jobs:
  diagnose:
    name: Diagnose System Status
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/key.pem << 'EOF'
          ${{ env.SSH_KEY }}
          EOF
          chmod 600 ~/.ssh/key.pem
          cat > ~/.ssh/config << 'EOF'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
            LogLevel=QUIET
          EOF

      - name: Check Microservices Status
        continue-on-error: true
        run: |
          echo ""
          echo "=================================================="
          echo "üîç Checking Microservices Status"
          echo "=================================================="
          
          ssh -i ~/.ssh/key.pem ubuntu@100.24.118.233 << 'DIAGCHECK'
          set +e
          
          echo ""
          echo "--- Running Containers ---"
          docker ps -a
          
          echo ""
          echo "--- Auth Service Logs (last 50 lines) ---"
          docker logs --tail=50 micro-auth 2>&1 | tail -30
          
          echo ""
          echo "--- Estudiantes Service Logs (last 50 lines) ---"
          docker logs --tail=50 micro-estudiantes 2>&1 | tail -30
          
          echo ""
          echo "--- Maestros Service Logs (last 50 lines) ---"
          docker logs --tail=50 micro-maestros 2>&1 | tail -30
          
          echo ""
          echo "--- Health Checks ---"
          echo "Auth service:"
          curl -s http://localhost:3000/health | head -5
          echo ""
          echo "Estudiantes service:"
          curl -s http://localhost:3001/health | head -5
          echo ""
          echo "Maestros service:"
          curl -s http://localhost:3002/health | head -5
          
          DIAGCHECK

      - name: Check API Gateway Status
        continue-on-error: true
        run: |
          echo ""
          echo "=================================================="
          echo "üîç Checking API Gateway Status"
          echo "=================================================="
          
          ssh -i ~/.ssh/key.pem ubuntu@100.49.159.65 << 'GATEWAYCHECK'
          set +e
          
          echo ""
          echo "--- Running Containers ---"
          docker ps -a
          
          echo ""
          echo "--- API Gateway Logs (last 50 lines) ---"
          docker logs --tail=50 acompanamiento-gateway 2>&1 | tail -30
          
          echo ""
          echo "--- Health Check ---"
          curl -s http://localhost:8080/health | head -5
          
          echo ""
          echo "--- Test /horarios endpoint ---"
          curl -v http://localhost:8080/horarios 2>&1 | head -20
          
          echo ""
          echo "--- Check network connectivity to microservices ---"
          echo "Testing connectivity to auth service (100.24.118.233:3000)..."
          timeout 5 bash -c 'cat < /dev/null > /dev/tcp/100.24.118.233/3000' 2>&1 && echo "‚úì Connected" || echo "‚úó Not reachable"
          
          echo "Testing connectivity to estudiantes service (100.24.118.233:3001)..."
          timeout 5 bash -c 'cat < /dev/null > /dev/tcp/100.24.118.233/3001' 2>&1 && echo "‚úì Connected" || echo "‚úó Not reachable"
          
          echo "Testing connectivity to maestros service (100.24.118.233:3002)..."
          timeout 5 bash -c 'cat < /dev/null > /dev/tcp/100.24.118.233/3002' 2>&1 && echo "‚úì Connected" || echo "‚úó Not reachable"
          
          GATEWAYCHECK

      - name: Check Frontend Status
        continue-on-error: true
        run: |
          echo ""
          echo "=================================================="
          echo "üîç Checking Frontend Status"
          echo "=================================================="
          
          ssh -i ~/.ssh/key.pem ubuntu@44.210.241.99 << 'FRONTENDCHECK'
          set +e
          
          echo ""
          echo "--- Running Containers ---"
          docker ps -a
          
          echo ""
          echo "--- Frontend Logs (last 50 lines) ---"
          docker logs --tail=50 acompanamiento-frontend 2>&1 | tail -30
          
          echo ""
          echo "--- Health Check ---"
          curl -s http://localhost/health | head -5
          
          echo ""
          echo "--- Test /api/health proxy ---"
          curl -s http://localhost/api/health | head -5
          
          FRONTENDCHECK

      - name: Check Database Status
        continue-on-error: true
        run: |
          echo ""
          echo "=================================================="
          echo "üîç Checking Database Status"
          echo "=================================================="
          
          ssh -i ~/.ssh/key.pem ubuntu@98.84.26.109 << 'DBCHECK'
          set +e
          
          echo ""
          echo "--- Running Containers ---"
          docker ps -a
          
          echo ""
          echo "--- Database Logs ---"
          echo "MongoDB:"
          docker logs --tail=10 mongodb 2>&1
          
          echo ""
          echo "PostgreSQL:"
          docker logs --tail=10 postgres 2>&1
          
          echo ""
          echo "Redis:"
          docker logs --tail=10 redis 2>&1
          
          DBCHECK

      - name: Summary
        run: |
          echo ""
          echo "=================================================="
          echo "üìä Diagnosis Complete"
          echo "=================================================="
          echo ""
          echo "Check the logs above for:"
          echo "  ‚Ä¢ Which containers are running/stopped"
          echo "  ‚Ä¢ Error messages in logs"
          echo "  ‚Ä¢ Database connection errors"
          echo "  ‚Ä¢ Network connectivity issues"
          echo ""

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/key.pem
