name: Restart via Bastion SSH Proxy

on:
  workflow_dispatch:

jobs:
  restart:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup SSH Key
        env:
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          cat >> ~/.ssh/config << 'EOF'
          Host bastion
            HostName 34.235.224.202
            User ubuntu
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          
          Host core
            HostName 172.31.71.182
            User ubuntu
            IdentityFile ~/.ssh/id_rsa
            ProxyCommand ssh -W %h:%p bastion
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF

      - name: Add known hosts
        run: |
          ssh-keyscan -H 34.235.224.202 >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Restart Core Services
        continue-on-error: true
        run: |
          echo "=== Testing Bastion ===" 
          timeout 10 ssh bastion "echo 'Bastion OK'" || echo "Bastion unreachable"
          
          echo "=== Testing Core via Bastion ==="
          timeout 30 ssh core "cd ~/Proyecto-Acompa-amiento- && docker ps -a --format 'table {{.Names}}\t{{.Status}}'" || echo "Core via proxy failed"
          
          echo "=== Restarting Services ==="
          timeout 60 ssh core "
          cd ~/Proyecto-Acompa-amiento-
          echo 'Stopping...'
          sudo docker-compose -f docker-compose.core.yml down 2>/dev/null || true
          sleep 3
          echo 'Starting...'
          sudo docker-compose -f docker-compose.core.yml up -d 2>/dev/null || true
          sleep 15
          echo 'Final status:'
          docker ps -a --format 'table {{.Names}}\t{{.Status}}'
          " || echo "Restart via proxy failed"

      - name: Test Services
        continue-on-error: true
        run: |
          sleep 5
          echo "=== API Gateway Health ==="
          curl -s http://52.7.168.4:8080/health | head -c 200
          echo ""
          echo "=== Horarios Endpoint ==="
          curl -s http://52.7.168.4:8080/horarios | head -c 200
          echo ""
          echo "=== Estudiantes Endpoint ==="
          curl -s http://52.7.168.4:8080/estudiantes/reservas/estudiante/1 | head -c 200
