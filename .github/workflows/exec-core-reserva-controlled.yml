name: Exec EC2 Reserva Controlled Test

on:
  workflow_dispatch:

env:
  EC2_CORE_PUBLIC_IP: 13.216.12.61
  SSH_USER: ubuntu

jobs:
  controlled-reserva:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_EC2_DB_SSH_PRIVATE_KEY }}" > ~/.ssh/key.pem
          chmod 600 ~/.ssh/key.pem
          ssh-keyscan -H ${{ env.EC2_CORE_PUBLIC_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Run controlled test (stream logs, curl 60s, node client)
        run: |
          ssh -i ~/.ssh/key.pem -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.EC2_CORE_PUBLIC_IP }} << 'SSH'
          set -euo pipefail
          echo "=== Controlled reservation test: start streaming logs & run tests ==="

          TIMESTAMP=$(date +%s)
          EMAIL="test.reserva.control.$TIMESTAMP@example.com"
          PASSWORD='Test123!'

          # Start streaming logs to temp files (background)
          echo "Starting background log streamers"
          mkdir -p /tmp/test-logs
          docker logs --details -f api-gateway > /tmp/test-logs/api-gateway.log 2>&1 & echo $! > /tmp/test-logs/api-gateway.pid || true
          docker logs --details -f micro-estudiantes > /tmp/test-logs/micro-estudiantes.log 2>&1 & echo $! > /tmp/test-logs/micro-estudiantes.pid || true

          sleep 1

          echo "Registering user (if not exists): $EMAIL"
          REGISTER=$(curl -sS -X POST http://localhost:8080/api/auth/register -H 'Content-Type: application/json' -d "{\"email\":\"$EMAIL\",\"password\":\"$PASSWORD\",\"name\":\"Controlled Test\"}" ) || true
          echo "Register response: $REGISTER"

          echo "Logging in user"
          LOGIN=$(curl -sS -X POST http://localhost:8080/api/auth/login -H 'Content-Type: application/json' -d "{\"email\":\"$EMAIL\",\"password\":\"$PASSWORD\"}") || true
          echo "Login response: $LOGIN"
          TOKEN=$(echo "$LOGIN" | python3 -c "import sys,json; print(json.load(sys.stdin).get('token',''))") || true
          echo "Token length: ${#TOKEN}"

          if [ -z "$TOKEN" ]; then
            echo "ERROR: token not found; proceeding to gather logs anyway"
          fi

          # Payload
          RES_BODY=$(cat <<-JSON
          {
            "fecha": "$(date -u -d '+1 day' --iso-8601=seconds)",
            "asunto": "Controlled Test Reserva",
            "descripcion": "Controlled test: curl 60s and node client"
          }
          JSON
          )

          echo "--- Running curl (verbose) with --max-time 60 ---"
          if [ -n "$TOKEN" ]; then
            curl -v --max-time 60 -X POST http://localhost:8080/api/estudiantes/reservar \
              -H "Authorization: Bearer $TOKEN" -H 'Content-Type: application/json' -d "$RES_BODY" 2>&1 || true
          else
            echo "Skipping curl: no token"
          fi

          echo "--- Running Node client POST (fetch) ---"
          if [ -n "$TOKEN" ]; then
            node -e "(async ()=>{ try { const res = await fetch('http://localhost:8080/api/estudiantes/reservar',{ method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer ${TOKEN}' }, body: JSON.stringify({ fecha: new Date(Date.now()+86400000).toISOString(), asunto:'node-client', descripcion:'node client test' }) }); const txt = await res.text(); console.log('NODECLIENT status',res.status,'bodyLen',Buffer.byteLength(txt),'bodySample',txt.slice(0,1000)); } catch(e) { console.error('NODECLIENT error',e); process.exit(2); } })();"
          else
            echo "Skipping node client: no token"
          fi

          # Give some time for logs to flush
          sleep 2

          echo "--- Stopping background log streamers and collecting logs ---"
          if [ -f /tmp/test-logs/api-gateway.pid ]; then kill "$(cat /tmp/test-logs/api-gateway.pid)" || true; fi
          if [ -f /tmp/test-logs/micro-estudiantes.pid ]; then kill "$(cat /tmp/test-logs/micro-estudiantes.pid)" || true; fi

          echo "=== API Gateway log tail (last 2000 lines) ==="
          tail -n 2000 /tmp/test-logs/api-gateway.log || true

          echo "=== micro-estudiantes log tail (last 2000 lines) ==="
          tail -n 2000 /tmp/test-logs/micro-estudiantes.log || true

          echo "=== Inspecting api-gateway health ==="
          docker inspect --format '{{json .State.Health}}' api-gateway || true

          echo "=== Done controlled test ==="
          SSH