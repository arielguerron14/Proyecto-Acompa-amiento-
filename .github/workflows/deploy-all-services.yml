name: üöÄ Deploy All Services (Full Stack)

on:
  workflow_dispatch:
    inputs:
      skip_db:
        description: 'Skip DB deployment (already running)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  deploy-order:
    name: Determine Deployment Order
    runs-on: ubuntu-latest
    outputs:
      skip_db: ${{ inputs.skip_db }}
    steps:
      - run: echo "üöÄ Full Stack Deployment Starting"

  deploy-db:
    name: 1Ô∏è‚É£ Deploy EC2-DB
    needs: deploy-order
    if: needs.deploy-order.outputs.skip_db == 'false'
    uses: ./.github/workflows/deploy-ec2-db.yml
    secrets: inherit

  deploy-messaging:
    name: 2Ô∏è‚É£ Deploy EC2-Messaging
    needs: deploy-db
    if: always() && (needs.deploy-db.result == 'success' || needs.deploy-order.outputs.skip_db == 'true')
    uses: ./.github/workflows/deploy-ec2-messaging.yml
    secrets: inherit

  deploy-core:
    name: 3Ô∏è‚É£ Deploy EC2-CORE
    needs: deploy-messaging
    if: always() && needs.deploy-messaging.result == 'success'
    uses: ./.github/workflows/deploy-ec2-core.yml
    secrets: inherit

  deploy-api-gateway:
    name: 4Ô∏è‚É£ Deploy EC2-API-Gateway
    needs: deploy-core
    if: always() && needs.deploy-core.result == 'success'
    uses: ./.github/workflows/deploy-ec2-api-gateway.yml
    secrets: inherit

  deploy-frontend:
    name: 5Ô∏è‚É£ Deploy EC2-Frontend
    needs: deploy-api-gateway
    if: always() && needs.deploy-api-gateway.result == 'success'
    uses: ./.github/workflows/deploy-ec2-frontend.yml
    secrets: inherit

  deploy-reportes:
    name: 6Ô∏è‚É£ Deploy EC2-Reportes
    needs: deploy-frontend
    if: always() && needs.deploy-frontend.result == 'success'
    uses: ./.github/workflows/deploy-ec2-reportes.yml
    secrets: inherit

  deploy-notificaciones:
    name: 7Ô∏è‚É£ Deploy EC2-Notificaciones
    needs: deploy-reportes
    if: always() && needs.deploy-reportes.result == 'success'
    uses: ./.github/workflows/deploy-ec2-notificaciones.yml
    secrets: inherit

  summary:
    name: üìä Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-db, deploy-messaging, deploy-core, deploy-api-gateway, deploy-frontend, deploy-reportes, deploy-notificaciones]
    if: always()
    steps:
      - name: ‚úÖ Deployment Complete
        run: |
          cat << 'EOF'
          
          ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
          ‚ïë          ‚úÖ FULL STACK DEPLOYMENT COMPLETED               ‚ïë
          ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
          
          üìä Deployment Summary:
          
          1Ô∏è‚É£  EC2-DB (MongoDB, PostgreSQL, Redis)
              Status: ${{ needs.deploy-db.result }}
              IP: 44.222.119.15 (Private: 172.31.79.193)
          
          2Ô∏è‚É£  EC2-Messaging (Kafka, RabbitMQ)
              Status: ${{ needs.deploy-messaging.result }}
              IP: 3.235.24.36 (Private: 172.31.73.6)
          
          3Ô∏è‚É£  EC2-CORE (Auth, Estudiantes, Maestros)
              Status: ${{ needs.deploy-core.result }}
              IP: 13.216.12.61 (Private: 172.31.78.183)
          
          4Ô∏è‚É£  EC2-API-Gateway
              Status: ${{ needs.deploy-api-gateway.result }}
              IP: 52.71.188.181 (Private: 172.31.76.105)
              URL: http://52.71.188.181:8080
          
          5Ô∏è‚É£  EC2-Frontend
              Status: ${{ needs.deploy-frontend.result }}
              IP: 107.21.124.81 (Private: 172.31.69.203)
              URL: http://107.21.124.81
          
          6Ô∏è‚É£  EC2-Reportes
              Status: ${{ needs.deploy-reportes.result }}
              IP: 54.175.62.79 (Private: 172.31.69.133)
          
          7Ô∏è‚É£  EC2-Notificaciones
              Status: ${{ needs.deploy-notificaciones.result }}
              IP: 100.31.143.213 (Private: 172.31.65.57)
          
          ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
          
          üåê Application URLs:
            ‚Ä¢ Frontend: http://107.21.124.81
            ‚Ä¢ API Gateway: http://52.71.188.181:8080
            ‚Ä¢ Monitoring: http://54.198.235.28:3000 (Grafana)
          
          üìä Database Access (Internal VPC):
            ‚Ä¢ MongoDB: 172.31.79.193:27017
            ‚Ä¢ PostgreSQL: 172.31.79.193:5432
            ‚Ä¢ Redis: 172.31.79.193:6379
          
          üîê Default Credentials:
            ‚Ä¢ MongoDB: admin / mongodb123
            ‚Ä¢ PostgreSQL: postgres / postgres123
            ‚Ä¢ Redis: redis123
          
          ‚úÖ All services deployed successfully!
          
          EOF
