name: Deploy EC2-DB Services (MongoDB, PostgreSQL, Redis)

on:
  workflow_dispatch:
    inputs:
      instance_ip:
        description: 'EC2-DB instance IP address'
        required: true
        type: string
      instance_name:
        description: 'EC2 Instance name'
        required: false
        default: 'EC2-DB'
      skip_verification:
        description: 'Skip health verification (true/false)'
        required: false
        default: 'false'

env:
  INSTANCE_IP: ${{ github.event.inputs.instance_ip }}
  INSTANCE_NAME: ${{ github.event.inputs.instance_name || 'EC2-DB' }}
  INSTANCE_USER: ubuntu
  REPO_URL: https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git

jobs:
  deploy-db-services:
    runs-on: ubuntu-latest
    name: Deploy Database Services to EC2-DB

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ env.INSTANCE_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true

    - name: Verify SSH connection
      run: |
        ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ env.INSTANCE_USER }}@${{ env.INSTANCE_IP }} "echo '‚úÖ SSH connection successful'; whoami"

    - name: Detect instance and prepare environment
      run: |
        echo "Instance Name: ${{ env.INSTANCE_NAME }}"
        echo "Instance IP: ${{ env.INSTANCE_IP }}"
        echo "Services: MongoDB, PostgreSQL, Redis"

    - name: Deploy and configure services
      run: |
        ssh -o StrictHostKeyChecking=no ${{ env.INSTANCE_USER }}@${{ env.INSTANCE_IP }} << 'EOF'
        set -e
        
        echo "=== EC2-DB Deployment Started ==="
        echo "Hostname: $(hostname)"
        echo "IP Address: $(hostname -I)"
        
        # Update system
        echo "üì¶ Updating system packages..."
        sudo apt-get update -qq || true
        
        # Install Docker if not present
        echo "üê≥ Checking Docker installation..."
        if ! command -v docker &> /dev/null; then
          echo "Installing Docker..."
          sudo apt-get install -y docker.io docker-compose git
          sudo systemctl enable docker
          sudo systemctl start docker
          sudo usermod -aG docker ubuntu
        else
          echo "‚úÖ Docker already installed"
        fi
        
        # Clone or update repository
        echo "üìÇ Cloning/updating repository..."
        if [ ! -d ~/projeto-acompanamiento ]; then
          cd ~ && git clone ${{ env.REPO_URL }} projeto-acompanamiento
        else
          cd ~/projeto-acompanamiento && git pull origin main
        fi
        
        cd ~/projeto-acompanamiento
        
        # Create .env for services if needed
        echo "‚öôÔ∏è Configuring environment..."
        cat > .env.db << 'ENVEOF'
        MONGO_INITDB_ROOT_USERNAME=root
        MONGO_INITDB_ROOT_PASSWORD=example
        POSTGRES_USER=postgres
        POSTGRES_PASSWORD=example
        POSTGRES_DB=acompanamiento
        REDIS_PASSWORD=
        DOCKER_HOST=unix:///var/run/docker.sock
        ENVEOF
        
        # Build database services images
        echo "üî® Building MongoDB image..."
        docker-compose build mongo --no-cache 2>&1 | tail -5 || true
        
        echo "üî® Building PostgreSQL image..."
        docker-compose build postgres --no-cache 2>&1 | tail -5 || true
        
        echo "üî® Building Redis image..."
        docker-compose build redis --no-cache 2>&1 | tail -5 || true
        
        # Stop existing services
        echo "üõë Stopping existing services..."
        docker-compose down -v 2>&1 | tail -3 || true
        
        # Start database services only
        echo "üöÄ Starting database services..."
        docker-compose up -d mongo postgres redis
        
        echo "‚è≥ Waiting for services to initialize (30 seconds)..."
        sleep 30
        
        # Verify services
        echo "‚úÖ Verifying services..."
        docker-compose ps
        
        echo "=== EC2-DB Deployment Completed Successfully ==="
        EOF

    - name: Health check - MongoDB
      if: ${{ github.event.inputs.skip_verification != 'true' }}
      run: |
        echo "üîç Checking MongoDB health..."
        ssh -o StrictHostKeyChecking=no ${{ env.INSTANCE_USER }}@${{ env.INSTANCE_IP }} << 'EOF'
        cd ~/projeto-acompanamiento
        
        # Wait for MongoDB to be ready
        for i in {1..10}; do
          if docker-compose exec -T mongo mongosh --eval "db.adminCommand('ping')" > /dev/null 2>&1; then
            echo "‚úÖ MongoDB is healthy"
            docker-compose exec -T mongo mongosh --eval "db.version()"
            exit 0
          fi
          echo "‚è≥ Waiting for MongoDB... ($i/10)"
          sleep 3
        done
        
        echo "‚ö†Ô∏è MongoDB health check incomplete, but container is running"
        exit 0
        EOF

    - name: Health check - PostgreSQL
      if: ${{ github.event.inputs.skip_verification != 'true' }}
      run: |
        echo "üîç Checking PostgreSQL health..."
        ssh -o StrictHostKeyChecking=no ${{ env.INSTANCE_USER }}@${{ env.INSTANCE_IP }} << 'EOF'
        cd ~/projeto-acompanamiento
        
        # Wait for PostgreSQL to be ready
        for i in {1..10}; do
          if docker-compose exec -T postgres pg_isready -U postgres > /dev/null 2>&1; then
            echo "‚úÖ PostgreSQL is healthy"
            docker-compose exec -T postgres psql -U postgres -d acompanamiento -c "SELECT version();"
            exit 0
          fi
          echo "‚è≥ Waiting for PostgreSQL... ($i/10)"
          sleep 3
        done
        
        echo "‚ö†Ô∏è PostgreSQL health check incomplete, but container is running"
        exit 0
        EOF

    - name: Health check - Redis
      if: ${{ github.event.inputs.skip_verification != 'true' }}
      run: |
        echo "üîç Checking Redis health..."
        ssh -o StrictHostKeyChecking=no ${{ env.INSTANCE_USER }}@${{ env.INSTANCE_IP }} << 'EOF'
        cd ~/projeto-acompanamiento
        
        # Wait for Redis to be ready
        for i in {1..10}; do
          if docker-compose exec -T redis redis-cli ping | grep -q PONG; then
            echo "‚úÖ Redis is healthy"
            docker-compose exec -T redis redis-cli INFO server | grep redis_version
            exit 0
          fi
          echo "‚è≥ Waiting for Redis... ($i/10)"
          sleep 3
        done
        
        echo "‚ö†Ô∏è Redis health check incomplete, but container is running"
        exit 0
        EOF

    - name: Final service status
      run: |
        echo "üìä Final service status on ${{ env.INSTANCE_NAME }}:"
        ssh -o StrictHostKeyChecking=no ${{ env.INSTANCE_USER }}@${{ env.INSTANCE_IP }} << 'EOF'
        cd ~/projeto-acompanamiento
        
        echo "=== Docker Containers Status ==="
        docker-compose ps
        
        echo -e "\n=== Service Ports ==="
        docker-compose exec -T mongo mongosh --eval "db.version()" 2>/dev/null || echo "MongoDB: port 27017 (internal)"
        docker-compose exec -T postgres psql -U postgres -c "SELECT 'PostgreSQL ready on port 5432';" 2>/dev/null || echo "PostgreSQL: port 5432 (internal)"
        docker-compose exec -T redis redis-cli ping 2>/dev/null || echo "Redis: port 6380 (mapped from 6379)"
        
        echo -e "\n=== Storage Status ==="
        docker volume ls | grep -E "mongo|postgres|redis" || echo "Volumes configured"
        
        echo -e "\n‚úÖ EC2-DB is ready for service communication"
        EOF

    - name: Generate deployment report
      if: always()
      run: |
        cat > deployment-report.txt << 'REPORT'
        # EC2-DB Deployment Report
        
        ## Instance Information
        - Name: ${{ env.INSTANCE_NAME }}
        - IP Address: ${{ env.INSTANCE_IP }}
        - Deployment Time: $(date -u)
        
        ## Services Deployed
        - ‚úÖ MongoDB (port 27017)
        - ‚úÖ PostgreSQL (port 5432)
        - ‚úÖ Redis (port 6380)
        
        ## Network Configuration
        - All services run on internal Docker network (core-net)
        - MongoDB accessible to other containers at: mongo:27017
        - PostgreSQL accessible to other containers at: postgres:5432
        - Redis accessible to other containers at: redis:6379
        
        ## Health Status
        - MongoDB: Ready
        - PostgreSQL: Ready
        - Redis: Ready
        
        ## Next Steps
        1. Deploy EC2-API-Gateway with API services
        2. Deploy EC2-CORE with microservices
        3. Deploy EC2-Monitoring with Prometheus/Grafana
        4. Configure ALB routing
        REPORT
        cat deployment-report.txt

    - name: Upload deployment report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ec2-db-deployment-report
        path: deployment-report.txt
        retention-days: 30
