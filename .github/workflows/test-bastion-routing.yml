name: Restart Core Services Direct via Bastion

on:
  workflow_dispatch:

jobs:
  restart:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup SSH Key
        env:
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Test Bastion & Routes
        continue-on-error: true
        run: |
          ssh-keyscan -H 34.235.224.202 >> ~/.ssh/known_hosts 2>/dev/null || true
          
          echo "=== Test Bastion Connection ==="
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@34.235.224.202 "echo 'Bastion OK'; ip route; echo '---'; ping -c 2 172.31.79.241 || echo 'Ping to Core failed'"
          
          echo ""
          echo "=== Try Direct SSH to Core from Bastion ==="
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@34.235.224.202 "ssh -i ~/.ssh/vockey.pem -o ConnectTimeout=5 -o StrictHostKeyChecking=no ubuntu@172.31.79.241 'docker ps -a' || echo 'SSH to Core from Bastion failed'"

      - name: Try Port Forwarding
        continue-on-error: true
        run: |
          echo "=== SSH Tunnel to Core Docker ==="
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -L 2375:172.31.79.241:2375 ubuntu@34.235.224.202 "sleep 30" &
          sleep 5
          docker -H tcp://localhost:2375 ps -a || echo "Docker tunnel failed"

      - name: Test Services
        continue-on-error: true
        run: |
          sleep 5
          echo "=== API Gateway ==="
          curl -s http://52.7.168.4:8080/health | head -c 200
          echo ""
          echo "=== Horarios ==="
          curl -s http://52.7.168.4:8080/horarios | head -c 200
          echo ""
