name: Deploy API Gateway to AWS EC2-API-Gateway

on:
  workflow_dispatch:
    inputs:
      ec2_api_gateway_private_ip:
        description: 'IP privada de instancia EC2-API-Gateway (ej: 172.31.76.105)'
        required: true
        type: string
      ec2_core_private_ip:
        description: 'IP privada de instancia EC2-CORE (ej: 172.31.78.183)'
        required: true
        type: string

env:
  EC2_API_GATEWAY_SSH_KEY: ${{ secrets.AWS_EC2_DB_SSH_PRIVATE_KEY }}
  EC2_API_GATEWAY_SSH_USER: ubuntu

jobs:
  deploy:
    name: Deploy API Gateway
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set EC2 variables
        run: |
          echo "EC2_API_GATEWAY_IP=${{ github.event.inputs.ec2_api_gateway_private_ip }}" >> $GITHUB_ENV
          echo "EC2_CORE_IP=${{ github.event.inputs.ec2_core_private_ip }}" >> $GITHUB_ENV

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/aws-ec2-api-gateway.pem << 'EOF'
          ${{ env.EC2_API_GATEWAY_SSH_KEY }}
          EOF
          chmod 600 ~/.ssh/aws-ec2-api-gateway.pem
          cat > ~/.ssh/config << 'SSHCONFIG'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
            LogLevel=QUIET
          SSHCONFIG

      - name: Deploy API Gateway via SSH
        run: |
          ssh -i ~/.ssh/aws-ec2-api-gateway.pem \
            -o ConnectTimeout=10 \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            ubuntu@${{ env.EC2_API_GATEWAY_IP }} << 'SSHEOF'
            
            echo "=== Verificando Docker ==="
            if ! command -v docker &> /dev/null; then
              echo "Docker no encontrado, instalando..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker ubuntu
              echo "Docker instalado correctamente"
            else
              echo "Docker ya está instalado"
              docker --version
            fi
            
            echo "=== Deteniendo contenedor existente ==="
            docker stop acompanamiento-gateway 2>/dev/null || true
            
            echo "=== Removiendo contenedor existente ==="
            docker rm acompanamiento-gateway 2>/dev/null || true
            
            echo "=== Clonando repositorio ==="
            cd /tmp
            rm -rf Proyecto-Acompa-amiento-
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
            
            echo "=== Construyendo imagen Docker ==="
            docker build -t api-gateway:latest -f api-gateway/Dockerfile ./api-gateway
            
            echo "=== Desplegando API Gateway ==="
            docker run -d \
              --name acompanamiento-gateway \
              --restart unless-stopped \
              -p 8080:8080 \
              -e NODE_ENV=production \
              -e PORT=8080 \
              -e AUTH_SERVICE_URL=http://172.31.78.183:3000 \
              -e MAESTROS_SERVICE_URL=http://172.31.78.183:3002 \
              -e ESTUDIANTES_SERVICE_URL=http://172.31.78.183:3001 \
              api-gateway:latest
            
            echo "=== Estado de contenedor ==="
            docker ps
            
            echo "=== Logs de API Gateway ==="
            docker logs --tail=30 acompanamiento-gateway
            
            echo "=== Verificando conectividad a microservicios ==="
            echo "Intentando conexión a Auth Service (172.31.78.183:3000)..."
            timeout 5 bash -c 'cat < /dev/null > /dev/tcp/172.31.78.183/3000' 2>/dev/null && echo "✓ Auth Service accesible" || echo "⚠ Auth Service no accesible"
            
            echo "Intentando conexión a Maestros Service (172.31.78.183:3002)..."
            timeout 5 bash -c 'cat < /dev/null > /dev/tcp/172.31.78.183/3002' 2>/dev/null && echo "✓ Maestros Service accesible" || echo "⚠ Maestros Service no accesible"
            
            echo "Intentando conexión a Estudiantes Service (172.31.78.183:3001)..."
            timeout 5 bash -c 'cat < /dev/null > /dev/tcp/172.31.78.183/3001' 2>/dev/null && echo "✓ Estudiantes Service accesible" || echo "⚠ Estudiantes Service no accesible"
            
            echo "=== Despliegue de API Gateway completado ==="
          SSHEOF

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/aws-ec2-api-gateway.pem
