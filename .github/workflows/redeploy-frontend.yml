name: Redeploy Frontend (Quick Fix)

on:
  workflow_dispatch:

env:
  SSH_KEY: ${{ secrets.AWS_EC2_DB_SSH_PRIVATE_KEY }}

jobs:
  redeploy-frontend:
    name: Redeploy Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/key.pem << 'EOF'
          ${{ env.SSH_KEY }}
          EOF
          chmod 600 ~/.ssh/key.pem
          cat > ~/.ssh/config << 'EOF'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
            LogLevel=QUIET
          EOF

      - name: Redeploy Frontend
        run: |
          echo ""
          echo "=================================================="
          echo "ðŸ”§ Redeploying Frontend with Latest Code"
          echo "=================================================="
          ssh -i ~/.ssh/key.pem -o ConnectTimeout=10 ubuntu@44.210.134.93 << 'FRONTENDFIX'
          set -e
          
          echo "Step 1: Stop existing frontend container..."
          docker stop acompanamiento-frontend 2>/dev/null || true
          sleep 2
          
          echo "Step 2: Remove existing container..."
          docker rm acompanamiento-frontend 2>/dev/null || true
          sleep 2
          
          echo "Step 3: Remove old image to force rebuild..."
          docker rmi frontend-web:latest 2>/dev/null || true
          
          echo "Step 4: Clone latest code..."
          cd /tmp
          rm -rf Proyecto-Acompa-amiento-
          
          # Try with SSH key if available, fall back to HTTPS
          if [ -f ~/.ssh/id_rsa ]; then
            echo "Using SSH key for git clone..."
            git clone git@github.com:arielguerron14/Proyecto-Acompa-amiento-.git
          else
            echo "Using HTTPS for git clone (no SSH key)..."
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          fi
          
          cd Proyecto-Acompa-amiento-
          
          echo ""
          echo "Step 5: Verify directory structure..."
          pwd
          ls -la frontend-web/Dockerfile || echo "âš ï¸  Dockerfile not found!"
          ls -la frontend-web/js/config.js || echo "âš ï¸  config.js not found!"
          
          echo ""
          echo "Step 6: Build frontend image..."
          docker build -t frontend-web:latest -f frontend-web/Dockerfile .
          
          echo ""
          echo "Step 7: Start frontend with API Gateway configuration..."
          docker run -d \
            --name acompanamiento-frontend \
            --restart unless-stopped \
            -p 80:80 \
            -p 3000:3000 \
            -e API_GATEWAY_URL=http://100.48.66.29:8080 \
            frontend-web:latest
          
          echo ""
          echo "Step 8: Wait for container to start..."
          sleep 5
          
          echo ""
          echo "Step 9: Check container status..."
          docker ps | grep frontend
          
          echo ""
          echo "Step 10: Check frontend logs..."
          docker logs --tail=30 acompanamiento-frontend 2>&1 || echo "Logs not available yet"
          
          echo ""
          echo "âœ… Frontend redeployed successfully!"
          FRONTENDFIX

      - name: Verify Frontend
        continue-on-error: true
        run: |
          echo ""
          echo "=================================================="
          echo "Testing Frontend After Redeploy"
          echo "=================================================="
          
          echo "Testing frontend homepage..."
          curl -I http://44.210.134.93 2>&1 | head -10
          
          echo ""
          echo "Testing API proxy health check..."
          curl -s http://44.210.134.93/api/health 2>&1 | head -5

      - name: Final Status
        run: |
          echo ""
          echo "=================================================="
          echo "âœ… FRONTEND REDEPLOY COMPLETED"
          echo "=================================================="
          echo ""
          echo "Frontend redeployed at: http://44.210.134.93"
          echo ""
          echo "Changes made:"
          echo "  â€¢ Updated API configuration to use /api proxy"
          echo "  â€¢ Frontend server now proxies requests to API Gateway"
          echo "  â€¢ No more CORS issues between frontend and gateway"
          echo ""
          echo "Try testing at: http://44.210.134.93"
          echo ""

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/key.pem
