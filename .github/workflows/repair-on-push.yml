name: Repair on push (run-repair)

on:
  push:
    branches:
      - run-repair

jobs:
  write-env-and-repair:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare SSH key
        run: |
          echo "${{ secrets.EC2_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Validate MONGO_URI
        run: |
          if [ -z "${{ secrets.MONGO_URI }}" ]; then
            echo "ERROR: Required secret MONGO_URI is not set."; exit 1
          fi

      - name: Write envs on reportes host
        run: |
          echo "Writing env files on reportes host ${{ secrets.EC2_REPORTES_HOST }}"
          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_REPORTES_HOST }} << 'EOF'
cat > "$HOME/micro-analytics.env" <<ENV
MONGO_URI='${{ secrets.MONGO_URI }}'
REDIS_HOST='${{ secrets.REDIS_HOST }}'
REDIS_PORT='${{ secrets.REDIS_PORT }}'
REDIS_PASSWORD='${{ secrets.REDIS_PASSWORD }}'
ENV

cat > "$HOME/micro-reportes-estudiantes.env" <<ENV
MONGO_URI='${{ secrets.MONGO_URI }}'
ENV

cat > "$HOME/micro-reportes-maestros.env" <<ENV
MONGO_URI='${{ secrets.MONGO_URI }}'
ENV

EOF

      - name: Write env on notificaciones host
        run: |
          echo "Writing env file on notificaciones host ${{ secrets.EC2_NOTIFICACIONES_HOST }}"
          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_NOTIFICACIONES_HOST }} << 'EOF'
cat > "$HOME/micro-notificaciones.env" <<ENV
MONGO_URI='${{ secrets.MONGO_URI }}'
REDIS_HOST='${{ secrets.REDIS_HOST }}'
REDIS_PORT='${{ secrets.REDIS_PORT }}'
REDIS_PASSWORD='${{ secrets.REDIS_PASSWORD }}'
ENV
EOF

      - name: Run fix script on reportes host
        run: |
          echo "Running fix script on reportes host ${{ secrets.EC2_REPORTES_HOST }}"
          cat scripts/fix-deploy.sh | ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_REPORTES_HOST }} 'bash -s' | tee repair-reportes.log

      - name: Run fix script on notificaciones host
        run: |
          echo "Running fix script on notificaciones host ${{ secrets.EC2_NOTIFICACIONES_HOST }}"
          cat scripts/fix-deploy.sh | ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_NOTIFICACIONES_HOST }} 'bash -s' | tee repair-notificaciones.log

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: repair-writeenv-logs
          path: repair-*.log
