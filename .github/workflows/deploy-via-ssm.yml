name: üöÄ Deploy - AWS SSM (Secure & Direct)

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

jobs:
  deploy-all-services:
    name: "Deploy All 10 Microservices"
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      matrix:
        service:
          - { name: "EC2-CORE", instance: "EC2-CORE", docker_file: "docker-compose.ec2-core.yml" }
          - { name: "EC2-API-Gateway", instance: "EC2-API-Gateway", docker_file: "docker-compose.api-gateway.yml" }
          - { name: "EC2-DB", instance: "EC2-DB", docker_file: "docker-compose.ec2-db.yml" }
          - { name: "EC2-Messaging", instance: "EC2-Messaging", docker_file: "docker-compose.messaging.yml" }
          - { name: "EC2-Reportes", instance: "EC2-Reportes", docker_file: "docker-compose.ec2-reportes.yml" }
          - { name: "EC2-Notificaciones", instance: "EC2-Notificaciones", docker_file: "docker-compose.ec2-notificaciones.yml" }
          - { name: "EC2-Analytics", instance: "EC2-Analytics", docker_file: "docker-compose.ec2-analytics.yml" }
          - { name: "EC2-Monitoring", instance: "EC2-Monitoring", docker_file: "docker-compose.ec2-monitoring.yml" }
          - { name: "EC2-Frontend", instance: "EC2-Frontend", docker_file: "docker-compose.ec2-frontend.yml" }
          - { name: "EC-Bastion", instance: "EC-Bastion", docker_file: "docker-compose.bastion.yml" }

    steps:
      - uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get EC2 Instance ID
        id: instance
        run: |
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=${{ matrix.service.instance }}" \
            --region ${{ env.AWS_REGION }} \
            --query 'Reservations[0].Instances[0].InstanceId' \
            --output text)
          
          if [ -z "$INSTANCE_ID" ] || [ "$INSTANCE_ID" = "None" ]; then
            echo "ERROR: Could not find instance with name: ${{ matrix.service.instance }}"
            exit 1
          fi
          
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "‚úÖ Found instance: $INSTANCE_ID"

      - name: Deploy ${{ matrix.service.name }}
        continue-on-error: true
        run: |
          echo "üöÄ Deploying ${{ matrix.service.name }} (Instance: ${{ steps.instance.outputs.instance_id }})..."
          
          # Send deployment command via SSM
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --instance-ids "${{ steps.instance.outputs.instance_id }}" \
            --parameters 'commands=[
              "cd /tmp || cd ~",
              "docker-compose -f ${{ matrix.service.docker_file }} down 2>/dev/null || true",
              "docker-compose -f ${{ matrix.service.docker_file }} up -d --no-build 2>&1 | head -20",
              "sleep 3",
              "docker-compose -f ${{ matrix.service.docker_file }} ps"
            ]' \
            --region ${{ env.AWS_REGION }} \
            --query 'Command.CommandId' \
            --output text)
          
          echo "Command sent: $COMMAND_ID"
          
          # Wait for command to complete
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ steps.instance.outputs.instance_id }}" \
              --region ${{ env.AWS_REGION }} \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            
            if [ "$STATUS" = "Success" ] || [ "$STATUS" = "Failed" ]; then
              # Get the command output
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "${{ steps.instance.outputs.instance_id }}" \
                --region ${{ env.AWS_REGION }} \
                --query 'StandardOutputContent' \
                --output text
              
              if [ "$STATUS" = "Success" ]; then
                echo "‚úÖ ${{ matrix.service.name }} deployment complete"
                exit 0
              else
                echo "‚ùå ${{ matrix.service.name }} deployment failed"
                exit 1
              fi
            fi
            
            echo "‚è≥ Waiting for command completion (attempt $i/60)..."
            sleep 5
          done
          
          echo "‚è±Ô∏è  Command timed out after 5 minutes"
          exit 1

  status:
    name: "‚úÖ Deployment Summary"
    runs-on: ubuntu-latest
    needs: deploy-all-services
    if: always()
    steps:
      - run: echo "üéâ All deployment jobs completed!"
