name: Deploy Project to AWS EC2 Instances

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy (staging or prod)'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - prod
      deploy_services:
        description: 'Services to deploy (all or specific)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - microservices-only
          - databases-only
          - frontend-only

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
      BASTION_USER: ubuntu
      SERVICES_USER: ubuntu

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          
          # Write PEM key with proper line endings
          cat > ~/.ssh/bastion-key.pem << 'EOF'
          ${{ secrets.AWS_BASTION_PRIVATE_KEY }}
          EOF
          
          # Fix line endings (handle Windows CRLF)
          dos2unix ~/.ssh/bastion-key.pem 2>/dev/null || sed -i 's/\r$//' ~/.ssh/bastion-key.pem
          
          chmod 600 ~/.ssh/bastion-key.pem
          
          # Validate SSH key
          echo "ğŸ” Validating SSH key format..."
          if ssh-keygen -y -f ~/.ssh/bastion-key.pem > /dev/null 2>&1; then
            echo "âœ… SSH key is valid"
          else
            echo "âŒ ERROR: SSH key is invalid or corrupted"
            echo "ğŸ“ Please check DEPLOY_AWS_SETUP.md for correct key format"
            exit 1
          fi
          
          # Add known hosts to avoid SSH prompts
          echo "ğŸ“ Adding known hosts..."
          ssh-keyscan -H ${{ secrets.AWS_BASTION_PUBLIC_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Load AWS instance IPs from config
        id: load-config
        run: |
          python3 << 'PYTHON_EOF'
          import json
          import os
          
          # Load instance IPs configuration
          with open('config/instance_ips.json', 'r') as f:
              config = json.load(f)
          
          # Extract key IPs
          api_gateway_ip = config.get('api-gateway', {}).get('host', 'localhost')
          
          print(f"api_gateway_ip={api_gateway_ip}")
          
          # For AWS, we'd extract from boto3, but for now using SSH tunnel discovery
          PYTHON_EOF

      - name: ğŸš€ Deploy Frontend
        if: ${{ inputs.deploy_services == 'all' || inputs.deploy_services == 'frontend-only' }}
        run: |
          echo "ğŸ“¦ Deploying frontend to EC2-Frontend..."
          FRONTEND_IP="${{ secrets.AWS_FRONTEND_PRIVATE_IP }}"
          BASTION_IP="${{ secrets.AWS_BASTION_PUBLIC_IP }}"
          
          if [ -z "$FRONTEND_IP" ] || [ -z "$BASTION_IP" ]; then
            echo "âŒ ERROR: Missing AWS secrets (AWS_FRONTEND_PRIVATE_IP or AWS_BASTION_PUBLIC_IP)"
            echo "ğŸ“ Please see DEPLOY_AWS_SETUP.md for secret configuration"
            exit 1
          fi
          
          ssh -i ~/.ssh/bastion-key.pem \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            -o ProxyCommand="ssh -i ~/.ssh/bastion-key.pem -o StrictHostKeyChecking=no -W %h:%p ${{ env.BASTION_USER }}@$BASTION_IP" \
            ${{ env.SERVICES_USER }}@${FRONTEND_IP} << 'DEPLOY_FRONTEND'
          
          set -e
          
          echo "ğŸ“¦ Installing system dependencies..."
          sudo apt-get update -qq

          # Remove old Node.js to avoid dpkg overwrite conflicts
          sudo apt-get purge -y nodejs libnode-dev npm 2>/dev/null || true
          sudo rm -rf /usr/lib/node_modules /usr/include/node /usr/share/doc/nodejs /usr/share/doc/libnode* 2>/dev/null || true
          sudo apt-get autoremove -y 2>/dev/null || true

          # Install Node.js 20.x
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y -qq nodejs git curl
          
          # Verify npm is installed
          if ! command -v npm &> /dev/null; then
            echo "âš ï¸  npm not found, installing separately..."
            sudo apt-get install -y npm
          fi
          
          sudo npm install -g pm2

          echo "ğŸ”„ Pulling latest code..."
          if [ -d /home/ubuntu/Proyecto-Acompa-amiento- ]; then
            cd /home/ubuntu/Proyecto-Acompa-amiento-
            git pull origin main
          else
            cd /home/ubuntu
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
                    echo "ğŸ“ Moving to frontend-web directory..."
          cd /home/ubuntu/Proyecto-Acompa-amiento-/apps/frontend-web
                    echo "ğŸ“¥ Installing dependencies..."
          npm install --legacy-peer-deps --no-audit --no-fund
          
          echo "ğŸ”¨ Building project..."
          npm run build 2>/dev/null || echo "âš ï¸  No build script, skipping"
          
          echo "ğŸš€ Starting Frontend server with PM2..."
          APIGW_PUBLIC_IP="${{ secrets.AWS_APIGW_PUBLIC_IP }}"
          pm2 delete "frontend" 2>/dev/null || true
          export API_GATEWAY_URL="http://184.72.179.150:8080"
          pm2 start server.js --name "frontend" --env production --update-env
          pm2 save
          pm2 show frontend
          
          echo "âœ… Frontend deployment complete (API Gateway: http://${APIGW_PUBLIC_IP}:8080)"
          
          DEPLOY_FRONTEND

      - name: ğŸš€ Deploy API Gateway
        if: ${{ inputs.deploy_services == 'all' || inputs.deploy_services == 'microservices-only' }}
        run: |
          echo "ğŸ“¦ Deploying API Gateway to EC2-APIGateway..."
          APIGW_IP="${{ secrets.AWS_APIGW_PRIVATE_IP }}"
          BASTION_IP="${{ secrets.AWS_BASTION_PUBLIC_IP }}"
          
          if [ -z "$APIGW_IP" ] || [ -z "$BASTION_IP" ]; then
            echo "âŒ ERROR: Missing AWS secrets (AWS_APIGW_PRIVATE_IP or AWS_BASTION_PUBLIC_IP)"
            exit 1
          fi
          
          ssh -i ~/.ssh/bastion-key.pem \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            -o ProxyCommand="ssh -i ~/.ssh/bastion-key.pem -o StrictHostKeyChecking=no -W %h:%p ${{ env.BASTION_USER }}@$BASTION_IP" \
            ${{ env.SERVICES_USER }}@${APIGW_IP} << 'DEPLOY_APIGW'
          
          set -e
          
          echo "ğŸ“¦ Installing system dependencies..."
          sudo apt-get update -qq

          # Remove old Node.js to avoid dpkg overwrite conflicts
          sudo apt-get purge -y nodejs libnode-dev npm 2>/dev/null || true
          sudo rm -rf /usr/lib/node_modules /usr/include/node /usr/share/doc/nodejs /usr/share/doc/libnode* 2>/dev/null || true
          sudo apt-get autoremove -y 2>/dev/null || true

          # Install Node.js 20.x
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y -qq nodejs git curl
          
          # Verify npm is installed
          if ! command -v npm &> /dev/null; then
            echo "âš ï¸  npm not found, installing separately..."
            sudo apt-get install -y npm
          fi
          
          sudo npm install -g pm2

          echo "ğŸ”„ Pulling latest code..."
          if [ -d /home/ubuntu/Proyecto-Acompa-amiento- ]; then
              cd /home/ubuntu/Proyecto-Acompa-amiento-
              git pull origin main
            else
              cd /home/ubuntu
              git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
              cd Proyecto-Acompa-amiento-
            fi
          
            echo "ğŸ“¥ Installing dependencies (API Gateway)..."
            cd /home/ubuntu/Proyecto-Acompa-amiento-/apps/api-gateway
            npm install --legacy-peer-deps
          
            echo "ğŸš€ Starting API Gateway..."
            pm2 delete "api-gateway" 2>/dev/null || true
            pm2 start server.js --name "api-gateway" --env production
            pm2 save
          
            echo "âœ… API Gateway deployment complete"
          
          DEPLOY_APIGW

      - name: ğŸš€ Deploy Core Microservices (Auth, Estudiantes, Maestros)
        if: ${{ inputs.deploy_services == 'all' || inputs.deploy_services == 'microservices-only' }}
        run: |
          echo "ğŸ“¦ Deploying Core Microservices to EC2-CORE..."
          CORE_IP="${{ secrets.AWS_CORE_PRIVATE_IP }}"
          BASTION_IP="${{ secrets.AWS_BASTION_PUBLIC_IP }}"
          
          if [ -z "$CORE_IP" ] || [ -z "$BASTION_IP" ]; then
            echo "âŒ ERROR: Missing AWS secrets (AWS_CORE_PRIVATE_IP or AWS_BASTION_PUBLIC_IP)"
            exit 1
          fi
          
          ssh -i ~/.ssh/bastion-key.pem \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            -o ProxyCommand="ssh -i ~/.ssh/bastion-key.pem -o StrictHostKeyChecking=no -W %h:%p ${{ env.BASTION_USER }}@$BASTION_IP" \
            ${{ env.SERVICES_USER }}@${CORE_IP} << 'DEPLOY_CORE'
          
          set -e
          
          echo "ğŸ“¦ Installing system dependencies..."
          sudo apt-get update -qq

          # Remove old Node.js to avoid dpkg overwrite conflicts
          sudo apt-get purge -y nodejs libnode-dev npm 2>/dev/null || true
          sudo rm -rf /usr/lib/node_modules /usr/include/node /usr/share/doc/nodejs /usr/share/doc/libnode* 2>/dev/null || true
          sudo apt-get autoremove -y 2>/dev/null || true

          # Install Node.js 20.x (required by microservices)
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y -qq nodejs git docker.io docker-compose
          
          # Verify npm is installed
          if ! command -v npm &> /dev/null; then
            echo "âš ï¸  npm not found, installing separately..."
            sudo apt-get install -y npm
          fi
          
          sudo usermod -aG docker $USER 2>/dev/null || true
          sudo systemctl start docker 2>/dev/null || true

          echo "ğŸ”„ Pulling latest code..."
          if [ -d /home/ubuntu/Proyecto-Acompa-amiento- ]; then
            cd /home/ubuntu/Proyecto-Acompa-amiento-
            git pull origin main
          else
            cd /home/ubuntu
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          
          echo "ğŸ“¥ Installing dependencies..."
          npm install --legacy-peer-deps

          echo "ğŸ§¹ Cleaning disk and Docker cache to free space..."
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true
          sudo journalctl --vacuum-size=200M || true
          sudo docker system prune -af || true
          sudo docker builder prune -af || true
          sudo docker volume prune -f || true
          sudo rm -rf /var/lib/docker/tmp/* || true
          df -h

          echo "ğŸ³ Starting core microservices (Auth, Estudiantes, Maestros)..."
          export ENVIRONMENT=prod
          export COMPOSE_PROJECT_NAME=acompanamiento-core
          
          # Only start core services (micro-core doesn't exist)
          docker-compose up -d micro-auth micro-estudiantes micro-maestros
          
          echo "â³ Waiting for services to stabilize..."
          sleep 10
          
          echo "ğŸ“Š Service status:"
          docker-compose ps micro-auth micro-estudiantes micro-maestros
          
          echo "âœ… Core microservices deployment complete"
          
          DEPLOY_CORE

      - name: ğŸš€ Deploy Reportes Microservices
        if: ${{ inputs.deploy_services == 'all' || inputs.deploy_services == 'microservices-only' }}
        run: |
          echo "ğŸ“¦ Deploying Reportes to EC2-Reportes..."
          REPORTES_IP="${{ secrets.AWS_REPORTES_PRIVATE_IP }}"
          BASTION_IP="${{ secrets.AWS_BASTION_PUBLIC_IP }}"
          
          if [ -z "$REPORTES_IP" ] || [ -z "$BASTION_IP" ]; then
            echo "âŒ ERROR: Missing AWS secrets (AWS_REPORTES_PRIVATE_IP)"
            echo "âš ï¸  Skipping reportes deployment"
            exit 0
          fi
          
          ssh -i ~/.ssh/bastion-key.pem \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            -o ProxyCommand="ssh -i ~/.ssh/bastion-key.pem -o StrictHostKeyChecking=no -W %h:%p ${{ env.BASTION_USER }}@$BASTION_IP" \
            ${{ env.SERVICES_USER }}@${REPORTES_IP} << 'DEPLOY_REPORTES'
          
          set -e
          
          echo "ğŸ“¦ Installing system dependencies..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq nodejs npm git docker.io docker-compose > /dev/null 2>&1 || echo "âš ï¸  Some packages already installed"
          sudo usermod -aG docker $USER 2>/dev/null || true
          sudo systemctl start docker 2>/dev/null || true

          echo "ğŸ”„ Pulling latest code..."
          if [ -d /home/ubuntu/Proyecto-Acompa-amiento- ]; then
            cd /home/ubuntu/Proyecto-Acompa-amiento-
            git pull origin main
          else
            cd /home/ubuntu
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          
          echo "ğŸ“¥ Installing dependencies..."
          npm install --legacy-peer-deps
          
          echo "ğŸ³ Starting reportes microservices..."
          export ENVIRONMENT=prod
          export COMPOSE_PROJECT_NAME=acompanamiento-reportes
          
          docker-compose up -d micro-reportes-estudiantes micro-reportes-maestros
          
          echo "â³ Waiting for services to stabilize..."
          sleep 10
          
          echo "ğŸ“Š Service status:"
          docker-compose ps micro-reportes-estudiantes micro-reportes-maestros
          
          echo "âœ… Reportes deployment complete"
          
          DEPLOY_REPORTES

      - name: ğŸš€ Deploy Notificaciones
        if: ${{ inputs.deploy_services == 'all' || inputs.deploy_services == 'microservices-only' }}
        run: |
          echo "ğŸ“¦ Deploying Notificaciones to EC2-Notificaciones..."
          NOTIF_IP="${{ secrets.AWS_NOTIFICACIONES_PRIVATE_IP }}"
          BASTION_IP="${{ secrets.AWS_BASTION_PUBLIC_IP }}"
          
          if [ -z "$NOTIF_IP" ] || [ -z "$BASTION_IP" ]; then
            echo "âŒ ERROR: Missing AWS secrets (AWS_NOTIFICACIONES_PRIVATE_IP)"
            echo "âš ï¸  Skipping notificaciones deployment"
            exit 0
          fi
          
          ssh -i ~/.ssh/bastion-key.pem \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            -o ProxyCommand="ssh -i ~/.ssh/bastion-key.pem -o StrictHostKeyChecking=no -W %h:%p ${{ env.BASTION_USER }}@$BASTION_IP" \
            ${{ env.SERVICES_USER }}@${NOTIF_IP} << 'DEPLOY_NOTIF'
          
          set -e
          
          echo "ğŸ“¦ Installing system dependencies..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq nodejs npm git docker.io docker-compose > /dev/null 2>&1 || echo "âš ï¸  Some packages already installed"
          sudo usermod -aG docker $USER 2>/dev/null || true
          sudo systemctl start docker 2>/dev/null || true

          echo "ğŸ”„ Pulling latest code..."
          if [ -d /home/ubuntu/Proyecto-Acompa-amiento- ]; then
            cd /home/ubuntu/Proyecto-Acompa-amiento-
            git pull origin main
          else
            cd /home/ubuntu
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          
          echo "ğŸ“¥ Installing dependencies..."
          npm install --legacy-peer-deps
          
          echo "ğŸ³ Starting notificaciones microservice..."
          export ENVIRONMENT=prod
          export COMPOSE_PROJECT_NAME=acompanamiento-notif
          
          docker-compose up -d micro-notificaciones
          
          echo "â³ Waiting for service to stabilize..."
          sleep 10
          
          echo "ğŸ“Š Service status:"
          docker-compose ps micro-notificaciones
          
          echo "âœ… Notificaciones deployment complete"
          
          DEPLOY_NOTIF

      - name: ğŸš€ Deploy Messaging (Kafka, RabbitMQ, MQTT)
        if: ${{ inputs.deploy_services == 'all' || inputs.deploy_services == 'databases-only' }}
        run: |
          echo "ğŸ“¦ Deploying Messaging to EC2-Messaging..."
          MESSAGING_IP="${{ secrets.AWS_MESSAGING_PRIVATE_IP }}"
          BASTION_IP="${{ secrets.AWS_BASTION_PUBLIC_IP }}"
          
          if [ -z "$MESSAGING_IP" ] || [ -z "$BASTION_IP" ]; then
            echo "âŒ ERROR: Missing AWS secrets (AWS_MESSAGING_PRIVATE_IP)"
            echo "âš ï¸  Skipping messaging deployment"
            exit 0
          fi
          
          ssh -i ~/.ssh/bastion-key.pem \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            -o ProxyCommand="ssh -i ~/.ssh/bastion-key.pem -o StrictHostKeyChecking=no -W %h:%p ${{ env.BASTION_USER }}@$BASTION_IP" \
            ${{ env.SERVICES_USER }}@${MESSAGING_IP} << 'DEPLOY_MESSAGING'
          
          set -e
          
          echo "ğŸ“¦ Installing system dependencies..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq docker.io docker-compose git > /dev/null 2>&1 || echo "âš ï¸  Some packages already installed"
          sudo usermod -aG docker $USER 2>/dev/null || true
          sudo systemctl start docker 2>/dev/null || true

          echo "ğŸ”„ Pulling latest code..."
          if [ -d /home/ubuntu/Proyecto-Acompa-amiento- ]; then
            cd /home/ubuntu/Proyecto-Acompa-amiento-
            git pull origin main
          else
            cd /home/ubuntu
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          
          echo "ğŸ³ Starting messaging services (Kafka, RabbitMQ)..."
          export ENVIRONMENT=prod
          export COMPOSE_PROJECT_NAME=acompanamiento-messaging
          
          docker-compose up -d kafka zookeeper rabbitmq
          
          echo "â³ Waiting for services to stabilize..."
          sleep 15
          
          echo "ğŸ“Š Service status:"
          docker-compose ps kafka zookeeper rabbitmq
          
          echo "âœ… Messaging services deployment complete"
          
          DEPLOY_MESSAGING

      - name: ğŸš€ Deploy Monitoring (Prometheus, Grafana)
        if: ${{ inputs.deploy_services == 'all' || inputs.deploy_services == 'microservices-only' }}
        run: |
          echo "ğŸ“¦ Deploying Monitoring to EC2-Monitoring..."
          MONITORING_IP="${{ secrets.AWS_MONITORING_PRIVATE_IP }}"
          BASTION_IP="${{ secrets.AWS_BASTION_PUBLIC_IP }}"
          
          if [ -z "$MONITORING_IP" ] || [ -z "$BASTION_IP" ]; then
            echo "âŒ ERROR: Missing AWS secrets (AWS_MONITORING_PRIVATE_IP)"
            echo "âš ï¸  Skipping monitoring deployment"
            exit 0
          fi
          
          ssh -i ~/.ssh/bastion-key.pem \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            -o ProxyCommand="ssh -i ~/.ssh/bastion-key.pem -o StrictHostKeyChecking=no -W %h:%p ${{ env.BASTION_USER }}@$BASTION_IP" \
            ${{ env.SERVICES_USER }}@${MONITORING_IP} << 'DEPLOY_MONITORING'
          
          set -e
          
          echo "ğŸ“¦ Installing system dependencies..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq docker.io docker-compose git > /dev/null 2>&1 || echo "âš ï¸  Some packages already installed"
          sudo usermod -aG docker $USER 2>/dev/null || true
          sudo systemctl start docker 2>/dev/null || true

          echo "ğŸ”„ Pulling latest code..."
          if [ -d /home/ubuntu/Proyecto-Acompa-amiento- ]; then
            cd /home/ubuntu/Proyecto-Acompa-amiento-
            git pull origin main
          else
            cd /home/ubuntu
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          
          echo "ğŸ³ Starting monitoring services (Prometheus, Grafana)..."
          export ENVIRONMENT=prod
          export COMPOSE_PROJECT_NAME=acompanamiento-monitoring
          
          docker-compose up -d prometheus grafana
          
          echo "â³ Waiting for services to stabilize..."
          sleep 15
          
          echo "ğŸ“Š Service status:"
          docker-compose ps prometheus grafana
          
          echo "âœ… Monitoring services deployment complete"
          
          DEPLOY_MONITORING

      - name: ğŸš€ Deploy Databases
        if: ${{ inputs.deploy_services == 'all' || inputs.deploy_services == 'databases-only' }}
        run: |
          echo "ğŸ“¦ Deploying Databases to EC2-DB..."
          DB_IP="${{ secrets.AWS_DB_PRIVATE_IP }}"
          BASTION_IP="${{ secrets.AWS_BASTION_PUBLIC_IP }}"
          
          if [ -z "$DB_IP" ] || [ -z "$BASTION_IP" ]; then
            echo "âŒ ERROR: Missing AWS secrets (AWS_DB_PRIVATE_IP or AWS_BASTION_PUBLIC_IP)"
            exit 1
          fi
          
          ssh -i ~/.ssh/bastion-key.pem \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            -o ProxyCommand="ssh -i ~/.ssh/bastion-key.pem -o StrictHostKeyChecking=no -W %h:%p ${{ env.BASTION_USER }}@$BASTION_IP" \
            ${{ env.SERVICES_USER }}@${DB_IP} << 'DEPLOY_DATABASES'
          
          set -e
          
          echo "ğŸ“¦ Installing system dependencies..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq nodejs npm git docker.io docker-compose > /dev/null 2>&1 || echo "âš ï¸  Some packages already installed"
          sudo usermod -aG docker $USER 2>/dev/null || true
          sudo systemctl start docker 2>/dev/null || true
          
          echo "ğŸ”„ Pulling latest code..."
          if [ -d /home/ubuntu/Proyecto-Acompa-amiento- ]; then
            cd /home/ubuntu/Proyecto-Acompa-amiento-
            git pull origin main
          else
            cd /home/ubuntu
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
          fi
          
          echo "ğŸ³ Creating database data directories..."
          sudo mkdir -p /data/postgres /data/mongo
          sudo chown -R $USER:$USER /data
          
           # Start Docker service if not running
           sudo systemctl start docker 2>/dev/null || true
         
          echo "ğŸ³ Starting databases with Docker Compose..."
          export ENVIRONMENT=prod
          export COMPOSE_PROJECT_NAME=acompanamiento-db
          
          docker-compose up -d mongo postgres
          
          echo "â³ Waiting for databases to start..."
          sleep 15
          
          echo "ğŸ“Š Database status:"
          docker-compose ps mongo postgres
          
          echo "âœ… Databases deployment complete"
          
          DEPLOY_DATABASES

      - name: ğŸ¥ Health Check
        if: success()
        run: |
          echo "ğŸ¥ Running health checks..."
          
          BASTION_IP="${{ secrets.AWS_BASTION_PUBLIC_IP }}"
          APIGW_IP="${{ secrets.AWS_APIGW_PRIVATE_IP }}"
          
          # Test bastion connectivity
          echo "âœ“ Testing Bastion host..."
          ssh -i ~/.ssh/bastion-key.pem \
            -o ConnectTimeout=5 \
            ${{ env.BASTION_USER }}@${BASTION_IP} "echo 'âœ“ Bastion host is reachable'"
          
          # Test API Gateway
          echo "âœ“ Testing API Gateway health..."
          ssh -i ~/.ssh/bastion-key.pem \
            -o ProxyCommand="ssh -i ~/.ssh/bastion-key.pem -W %h:%p ${{ env.BASTION_USER }}@${BASTION_IP}" \
            ${{ env.SERVICES_USER }}@${APIGW_IP} \
            "curl -s http://localhost:8080/health || echo 'âš ï¸  Health check endpoint not available yet'"
          
          echo "âœ… Health checks completed"

      - name: ğŸ“Š Deployment Summary
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š DEPLOYMENT SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Environment:  ${{ inputs.environment }}"
          echo "Services:     ${{ inputs.deploy_services }}"
          echo "Timestamp:    $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          echo ""
          echo "Deployment Status: ${{ job.status }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“ Next steps:"
          echo "1. Verify services are running via SSH:"
          echo "   ssh -i bastion-key.pem ubuntu@${{ secrets.AWS_BASTION_PUBLIC_IP }}"
          echo ""
          echo "2. Check service logs:"
          echo "   docker-compose logs -f <service-name>"
          echo ""
          echo "3. Test API Gateway:"
          echo "   curl http://<API_GATEWAY_IP>:8080/health"
          echo ""
          echo "4. Access monitoring (if Grafana deployed):"
          echo "   http://<MONITORING_IP>:3001"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
