name: Deploy Orchestrator - Full Infrastructure

on:
  workflow_dispatch:
    inputs:
      start_stage:
        description: 'Start from stage (1-4)'
        required: false
        default: '1'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'

env:
  INSTANCE_USER: ubuntu
  AWS_REGION: us-east-1

jobs:
  stage-1-infrastructure:
    if: ${{ github.event.inputs.start_stage <= '1' || github.event.inputs.start_stage == '' }}
    runs-on: ubuntu-latest
    name: Stage 1 - Database & Infrastructure
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Deploy EC2-DB (MongoDB, PostgreSQL, Redis)
      run: |
        echo "ğŸ“¦ Stage 1: Deploying databases and infrastructure..."
        gh workflow run deploy-ec2-db.yml -f instance_name=EC2-DB
        echo "â³ Waiting for EC2-DB deployment (120 seconds)..."
        sleep 120

    - name: Verify EC2-DB deployment
      run: |
        echo "âœ… EC2-DB deployment initiated"
        echo "ğŸ“Š Status: Databases should be ready"

  stage-2-messaging:
    needs: stage-1-infrastructure
    if: ${{ github.event.inputs.start_stage <= '2' || github.event.inputs.start_stage == '' }}
    runs-on: ubuntu-latest
    name: Stage 2 - Messaging Services

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Deploy EC2-Messaging (Kafka, Zookeeper, RabbitMQ)
      run: |
        echo "ğŸ“¦ Stage 2: Deploying messaging infrastructure..."
        gh workflow run deploy-ec2-messaging.yml -f instance_name=EC2-Messaging
        echo "â³ Waiting for EC2-Messaging deployment (120 seconds)..."
        sleep 120

    - name: Verify EC2-Messaging deployment
      run: |
        echo "âœ… EC2-Messaging deployment initiated"
        echo "ğŸ“Š Status: Message brokers should be ready"

  stage-3-core-services:
    needs: stage-2-messaging
    if: ${{ github.event.inputs.start_stage <= '3' || github.event.inputs.start_stage == '' }}
    runs-on: ubuntu-latest
    name: Stage 3 - Core Microservices

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Deploy EC2-CORE (Auth, Students, Teachers, Analytics, SOAP Bridge)
      run: |
        echo "ğŸ“¦ Stage 3: Deploying core microservices..."
        gh workflow run deploy-ec2-core.yml -f instance_name=EC2-CORE
        echo "â³ Waiting for EC2-CORE deployment (120 seconds)..."
        sleep 120

    - name: Deploy EC2-Notificaciones (Notifications)
      run: |
        echo "ğŸ“¦ Deploying notifications service..."
        gh workflow run deploy-ec2-notificaciones.yml -f instance_name=EC2-Notificaciones
        echo "â³ Waiting for EC2-Notificaciones deployment (90 seconds)..."
        sleep 90

    - name: Deploy EC2-Reportes (Student & Teacher Reports)
      run: |
        echo "ğŸ“¦ Deploying reports services..."
        gh workflow run deploy-ec2-reportes.yml -f instance_name=EC2-Reportes
        echo "â³ Waiting for EC2-Reportes deployment (90 seconds)..."
        sleep 90

    - name: Verify Stage 3 deployment
      run: |
        echo "âœ… Core microservices deployment initiated"
        echo "ğŸ“Š Status: All microservices should be connecting to distributed infrastructure"

  stage-4-frontend-and-gateway:
    needs: stage-3-core-services
    if: ${{ github.event.inputs.start_stage <= '4' || github.event.inputs.start_stage == '' }}
    runs-on: ubuntu-latest
    name: Stage 4 - API Gateway & Frontend

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Deploy EC2-API-Gateway (Main entry point)
      run: |
        echo "ğŸ“¦ Stage 4: Deploying API Gateway..."
        gh workflow run deploy-ec2-api-gateway.yml -f instance_name=EC2-API-Gateway
        echo "â³ Waiting for EC2-API-Gateway deployment (90 seconds)..."
        sleep 90

    - name: Deploy EC2-Frontend (React SPA)
      run: |
        echo "ğŸ“¦ Deploying frontend application..."
        gh workflow run deploy-ec2-frontend.yml -f instance_name=EC2-Frontend
        echo "â³ Waiting for EC2-Frontend deployment (60 seconds)..."
        sleep 60

    - name: Deploy EC2-Monitoring (Prometheus & Grafana)
      run: |
        echo "ğŸ“¦ Deploying monitoring stack..."
        gh workflow run deploy-ec2-monitoring.yml -f instance_name=EC2-Monitoring
        echo "â³ Waiting for EC2-Monitoring deployment (60 seconds)..."
        sleep 60

    - name: Verify Stage 4 deployment
      run: |
        echo "âœ… Frontend and gateway deployment initiated"
        echo "ğŸ“Š Status: Application should be fully operational"

  deployment-summary:
    needs: [stage-1-infrastructure, stage-2-messaging, stage-3-core-services, stage-4-frontend-and-gateway]
    if: always()
    runs-on: ubuntu-latest
    name: Deployment Summary

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Generate deployment report
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘    DEPLOYMENT ORCHESTRATION COMPLETE                   â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ“Š DEPLOYMENT SUMMARY"
        echo "===================="
        echo ""
        echo "Stage 1 - Infrastructure:"
        echo "  âœ“ EC2-DB (MongoDB, PostgreSQL, Redis)"
        echo ""
        echo "Stage 2 - Messaging:"
        echo "  âœ“ EC2-Messaging (Kafka, Zookeeper, RabbitMQ)"
        echo ""
        echo "Stage 3 - Core Services:"
        echo "  âœ“ EC2-CORE (Auth, Students, Teachers, Analytics, SOAP)"
        echo "  âœ“ EC2-Notificaciones (Notifications)"
        echo "  âœ“ EC2-Reportes (Student & Teacher Reports)"
        echo ""
        echo "Stage 4 - Frontend & Monitoring:"
        echo "  âœ“ EC2-API-Gateway (Port 8080)"
        echo "  âœ“ EC2-Frontend (Port 5500)"
        echo "  âœ“ EC2-Monitoring (Prometheus 9090, Grafana 3000)"
        echo ""
        echo "ğŸ”— SERVICE DISCOVERY & CONNECTIVITY"
        echo "===================================="
        
        # Get all EC2 instances
        aws ec2 describe-instances \
          --filters "Name=instance-state-name,Values=running" \
                    "Name=tag:Name,Values=EC2-*" \
          --query 'Reservations[].Instances[].[Tags[?Key==`Name`].Value|[0], PrivateIpAddress, PublicIpAddress]' \
          --output table
        
        echo ""
        echo "ğŸ“ DEPLOYMENT ORDER & DEPENDENCIES"
        echo "==================================="
        echo ""
        echo "1ï¸âƒ£  EC2-DB (Independent)"
        echo "    â””â”€ Provides: MongoDB, PostgreSQL, Redis"
        echo ""
        echo "2ï¸âƒ£  EC2-Messaging (Independent)"
        echo "    â””â”€ Provides: Kafka, Zookeeper, RabbitMQ"
        echo ""
        echo "3ï¸âƒ£  EC2-CORE (Depends on: DB, Messaging)"
        echo "    â”œâ”€ micro-auth â†’ connects to DB"
        echo "    â”œâ”€ micro-estudiantes â†’ connects to DB + Messaging"
        echo "    â”œâ”€ micro-maestros â†’ connects to DB + Messaging"
        echo "    â”œâ”€ micro-analytics â†’ connects to Messaging"
        echo "    â””â”€ micro-soap-bridge â†’ connects to DB"
        echo ""
        echo "3ï¸âƒ£  EC2-Notificaciones (Depends on: DB, Messaging)"
        echo "    â””â”€ micro-notificaciones â†’ connects to DB + Messaging"
        echo ""
        echo "3ï¸âƒ£  EC2-Reportes (Depends on: DB, Messaging)"
        echo "    â”œâ”€ micro-reportes-estudiantes â†’ connects to DB + Messaging"
        echo "    â””â”€ micro-reportes-maestros â†’ connects to DB + Messaging"
        echo ""
        echo "4ï¸âƒ£  EC2-API-Gateway (Depends on: Core Services)"
        echo "    â””â”€ Entry point routing to core microservices (port 8080)"
        echo ""
        echo "4ï¸âƒ£  EC2-Frontend (Independent)"
        echo "    â””â”€ React SPA served on port 5500"
        echo ""
        echo "4ï¸âƒ£  EC2-Monitoring (Independent)"
        echo "    â”œâ”€ Prometheus (port 9090)"
        echo "    â””â”€ Grafana (port 3000)"
        echo ""
        echo "ğŸŒ ARCHITECTURE OVERVIEW"
        echo "========================"
        echo ""
        echo "  ALB (Load Balancer)"
        echo "    â”œâ”€ â†’ EC2-Frontend (port 5500)"
        echo "    â””â”€ â†’ EC2-API-Gateway (port 8080)"
        echo "         â”œâ”€ â†’ EC2-CORE Services"
        echo "         â”‚    â”œâ”€ micro-auth:3000"
        echo "         â”‚    â”œâ”€ micro-estudiantes:3001"
        echo "         â”‚    â””â”€ micro-maestros:3002"
        echo "         â”œâ”€ â†’ EC2-Notificaciones"
        echo "         â”‚    â””â”€ micro-notificaciones:3009"
        echo "         â””â”€ â†’ EC2-Reportes"
        echo "              â”œâ”€ micro-reportes-estudiantes:5003"
        echo "              â””â”€ micro-reportes-maestros:5004"
        echo ""
        echo "ğŸ’¾ Shared Infrastructure:"
        echo "  EC2-DB:"
        echo "    â”œâ”€ MongoDB:27017"
        echo "    â”œâ”€ PostgreSQL:5432"
        echo "    â””â”€ Redis:6379"
        echo ""
        echo "  EC2-Messaging:"
        echo "    â”œâ”€ Kafka:9092"
        echo "    â”œâ”€ Zookeeper:2181"
        echo "    â””â”€ RabbitMQ:5672"
        echo ""
        echo "ğŸ“ˆ Monitoring:"
        echo "  EC2-Monitoring:"
        echo "    â”œâ”€ Prometheus:9090 (metrics collection)"
        echo "    â””â”€ Grafana:3000 (visualization)"
        echo ""
        echo "âœ… All instances deployed with cross-instance service discovery enabled"
        echo "âœ… Microservices configured to use remote database and messaging brokers"
        echo "âœ… Environment variables automatically injected from AWS EC2 tags"
        echo ""
        echo "ğŸš€ NEXT STEPS"
        echo "============="
        echo "1. Verify all EC2 instances are running"
        echo "2. Check AWS Security Groups allow inter-instance communication"
        echo "3. Test API endpoints: curl http://<ALB>/auth/register"
        echo "4. Access Grafana for monitoring: http://<EC2-Monitoring-IP>:3000"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: Check deployment status
      if: failure()
      run: |
        echo "âš ï¸  Some deployment stages may have encountered issues"
        echo "Review the individual workflow runs for detailed logs"
        echo "You can resume from a specific stage using the start_stage input"
