name: Deploy Notificaciones & SOAP Bridge to AWS EC2-Notificaciones

on:
  workflow_dispatch:
    inputs:
      ec2_notificaciones_private_ip:
        description: 'IP privada de instancia EC2-Notificaciones (ej: 172.31.65.57)'
        required: true
        type: string
      ec2_db_private_ip:
        description: 'IP privada de instancia EC2-DB (ej: 172.31.79.193)'
        required: true
        type: string

env:
  EC2_NOTIFICACIONES_SSH_KEY: ${{ secrets.AWS_EC2_DB_SSH_PRIVATE_KEY }}
  EC2_NOTIFICACIONES_SSH_USER: ubuntu

jobs:
  deploy:
    name: Deploy Notificaciones & SOAP Bridge
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set EC2 variables
        run: |
          echo "EC2_NOTIFICACIONES_IP=${{ github.event.inputs.ec2_notificaciones_private_ip }}" >> $GITHUB_ENV
          echo "EC2_DB_IP=${{ github.event.inputs.ec2_db_private_ip }}" >> $GITHUB_ENV

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/aws-ec2-notificaciones.pem << 'EOF'
          ${{ env.EC2_NOTIFICACIONES_SSH_KEY }}
          EOF
          chmod 600 ~/.ssh/aws-ec2-notificaciones.pem
          cat > ~/.ssh/config << 'SSHCONFIG'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
            LogLevel=QUIET
          SSHCONFIG

      - name: Deploy Notificaciones & SOAP Bridge via SSH
        run: |
          ssh -i ~/.ssh/aws-ec2-notificaciones.pem \
            -o ConnectTimeout=10 \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            ubuntu@${{ env.EC2_NOTIFICACIONES_IP }} << 'SSHEOF'
            
            echo "=== Verificando Docker ==="
            if ! command -v docker &> /dev/null; then
              echo "Docker no encontrado, instalando..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker ubuntu
              echo "Docker instalado correctamente"
            else
              echo "Docker ya está instalado"
              docker --version
            fi
            
            echo "=== Deteniendo contenedores existentes ==="
            docker stop acompanamiento-notificaciones 2>/dev/null || true
            docker stop acompanamiento-soap-bridge 2>/dev/null || true
            
            echo "=== Removiendo contenedores existentes ==="
            docker rm acompanamiento-notificaciones 2>/dev/null || true
            docker rm acompanamiento-soap-bridge 2>/dev/null || true
            
            echo "=== Clonando repositorio ==="
            cd /tmp
            rm -rf Proyecto-Acompa-amiento-
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
            
            echo "=== Construyendo imágenes Docker ==="
            echo "Construyendo micro-notificaciones..."
            docker build -t micro-notificaciones:latest -f micro-notificaciones/Dockerfile .
            
            echo "Construyendo micro-soap-bridge..."
            docker build -t micro-soap-bridge:latest -f micro-soap-bridge/Dockerfile .
            
            echo "=== Desplegando micro-notificaciones ==="
            docker run -d \
              --name acompanamiento-notificaciones \
              --restart unless-stopped \
              -p 5006:5006 \
              -e NODE_ENV=production \
              -e PORT=5006 \
              -e DB_POSTGRES_HOST=172.31.79.193 \
              -e DB_POSTGRES_USER=postgres \
              -e DB_POSTGRES_PASSWORD=postgres \
              -e DB_POSTGRES_DB=acompanamiento \
              -e DB_MONGO_URI=mongodb://172.31.79.193:27017/acompanamiento \
              -e REDIS_URL=redis://172.31.79.193:6379 \
              micro-notificaciones:latest
            
            echo "=== Desplegando micro-soap-bridge ==="
            docker run -d \
              --name acompanamiento-soap-bridge \
              --restart unless-stopped \
              -p 5008:5008 \
              -e NODE_ENV=production \
              -e PORT=5008 \
              -e DB_POSTGRES_HOST=172.31.79.193 \
              -e DB_POSTGRES_USER=postgres \
              -e DB_POSTGRES_PASSWORD=postgres \
              -e DB_POSTGRES_DB=acompanamiento \
              -e DB_MONGO_URI=mongodb://172.31.79.193:27017/acompanamiento \
              -e REDIS_URL=redis://172.31.79.193:6379 \
              micro-soap-bridge:latest
            
            echo "=== Estado de contenedores ==="
            docker ps
            
            echo "=== Logs de micro-notificaciones ==="
            docker logs --tail=30 acompanamiento-notificaciones
            
            echo "=== Logs de micro-soap-bridge ==="
            docker logs --tail=30 acompanamiento-soap-bridge
            
            echo "=== Verificando conectividad a bases de datos ==="
            echo "Intentando conexión a PostgreSQL (172.31.79.193:5432)..."
            timeout 5 bash -c 'cat < /dev/null > /dev/tcp/172.31.79.193/5432' 2>/dev/null && echo "✓ PostgreSQL accesible" || echo "⚠ PostgreSQL no accesible"
            
            echo "Intentando conexión a MongoDB (172.31.79.193:27017)..."
            timeout 5 bash -c 'cat < /dev/null > /dev/tcp/172.31.79.193/27017' 2>/dev/null && echo "✓ MongoDB accesible" || echo "⚠ MongoDB no accesible"
            
            echo "Intentando conexión a Redis (172.31.79.193:6379)..."
            timeout 5 bash -c 'cat < /dev/null > /dev/tcp/172.31.79.193/6379' 2>/dev/null && echo "✓ Redis accesible" || echo "⚠ Redis no accesible"
            
            echo "=== Despliegue completado ==="
          SSHEOF

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/aws-ec2-notificaciones.pem
