name: Deploy All Services (Automated)

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'config/instance_ips.json'

env:
  AWS_REGION: us-east-1

jobs:
  # ============================================================================
  # PHASE 1: WAIT FOR INSTANCES
  # ============================================================================
  wait-instances:
    name: Verify Instance IPs Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v3

      - name: Verify instance_ips.json exists
        run: |
          python3 << 'PYSCRIPT'
          import json
          import sys
          
          try:
              with open('config/instance_ips.json', 'r') as f:
                  ips = json.load(f)
              
              required_instances = [
                  'EC2-DB', 'EC2-CORE', 'EC2-API-Gateway', 
                  'EC2-Frontend', 'EC-Bastion'
              ]
              
              print(f"‚úÖ Found instance_ips.json with {len(ips)} instances")
              
              found = [name for name in required_instances if name in ips]
              missing = set(required_instances) - set(found)
              
              if missing:
                  print(f"‚ö†Ô∏è  Missing instances in config: {', '.join(missing)}")
                  print("‚ÑπÔ∏è  Available instances:", ', '.join(ips.keys()))
              else:
                  print(f"‚úÖ All required instances configured!")
                  for name in required_instances:
                      print(f"   - {name}: {ips[name]['PublicIpAddress']}")
              
          except FileNotFoundError:
              print("‚ùå config/instance_ips.json not found!")
              print("Please run 'terraform output' to generate instance_ips.json")
              sys.exit(1)
          except Exception as e:
              print(f"‚ùå Error: {e}")
              sys.exit(1)
          PYSCRIPT

  # ============================================================================
  # PHASE 2: DEPLOY DATABASES
  # ============================================================================
  deploy-db:
    name: Deploy Databases (MongoDB, PostgreSQL, Redis)
    needs: wait-instances
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v3

      - name: Install dependencies
        run: pip install paramiko boto3

      - name: Get EC2-DB IP
        run: |
          python3 << 'PYSCRIPT'
          import json
          
          with open('config/instance_ips.json', 'r') as f:
              ips = json.load(f)
          
          db_ip = ips['EC2-DB']['PublicIpAddress']
          print(f"INSTANCE_IP={db_ip}")
          with open('instance_ip.txt', 'w') as f:
              f.write(db_ip)
          print(f"‚úÖ Found EC2-DB: {db_ip}")
          PYSCRIPT

      - name: Deploy Databases
        env:
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          python3 << 'PYSCRIPT'
          import paramiko
          import io
          import os
          import time
          
          with open('instance_ip.txt', 'r') as f:
              target_host = f.read().strip()
          
          ssh_key_str = os.environ.get("EC2_SSH_KEY", "")
          if not ssh_key_str:
              print("‚ùå EC2_SSH_KEY not set")
              exit(1)
          
          print(f"üîó Connecting to EC2-DB ({target_host})...")
          ssh = paramiko.SSHClient()
          ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
          
          # Retry connection up to 5 times
          max_retries = 5
          for attempt in range(max_retries):
              try:
                  key = paramiko.RSAKey.from_private_key(io.StringIO(ssh_key_str))
                  ssh.connect(target_host, username='ubuntu', pkey=key, timeout=30)
                  print("‚úÖ Connected")
                  break
              except Exception as e:
                  if attempt < max_retries - 1:
                      print(f"‚è≥ Connection attempt {attempt + 1} failed: {str(e)[:50]}")
                      print(f"   Retrying in 10 seconds...")
                      time.sleep(10)
                  else:
                      print(f"‚ùå Failed to connect after {max_retries} attempts: {e}")
                      exit(1)
          
          try:
              # MongoDB
              print("\nüì¶ Deploying MongoDB...")
              commands = [
                  "docker pull mongo:6.0",
                  "docker stop mongo 2>/dev/null || true",
                  "docker rm mongo 2>/dev/null || true",
                  "docker volume create mongo_data 2>/dev/null || true",
                  'docker run -d --name mongo -p 27017:27017 -e MONGO_INITDB_ROOT_USERNAME=root -e MONGO_INITDB_ROOT_PASSWORD=example -v mongo_data:/data/db mongo:6.0 --auth',
              ]
              
              # PostgreSQL
              print("üì¶ Deploying PostgreSQL...")
              commands.extend([
                  "docker pull postgres:15-alpine",
                  "docker stop postgres 2>/dev/null || true",
                  "docker rm postgres 2>/dev/null || true",
                  "docker volume create postgres_data 2>/dev/null || true",
                  'docker run -d --name postgres -p 5432:5432 -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=postgres -v postgres_data:/var/lib/postgresql/data postgres:15-alpine',
              ])
              
              # Redis
              print("üì¶ Deploying Redis...")
              commands.extend([
                  "docker pull redis:7-alpine",
                  "docker stop redis 2>/dev/null || true",
                  "docker rm redis 2>/dev/null || true",
                  "docker volume create redis_data 2>/dev/null || true",
                  "docker run -d --name redis -p 6379:6379 -v redis_data:/data redis:7-alpine",
              ])
              
              # Wait for services
              commands.extend([
                  "echo '‚è≥ Waiting for services to be ready...'",
                  "sleep 15",
                  "docker ps -a",
              ])
              
              for cmd in commands:
                  print(f"  ‚Üí {cmd[:80]}")
                  stdin, stdout, stderr = ssh.exec_command(cmd)
                  output = stdout.read().decode().strip()
                  if output:
                      print(f"    {output[:100]}")
                  error = stderr.read().decode().strip()
                  if error and 'already in use' not in error:
                      print(f"    ‚ö†Ô∏è  {error[:100]}")
              
              print("\n‚úÖ Databases deployed successfully!")
              ssh.close()
              
          except Exception as e:
              print(f"‚ùå Failed: {e}")
              exit(1)
          PYSCRIPT

  # ============================================================================
  # PHASE 3: DEPLOY MICROSERVICES
  # ============================================================================
  deploy-core:
    name: Deploy Microservices (EC2-CORE)
    needs: deploy-db
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v3

      - name: Install dependencies
        run: pip install paramiko boto3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Get IPs
        run: |
          python3 << 'PYSCRIPT'
          import json
          
          with open('config/instance_ips.json', 'r') as f:
              ips = json.load(f)
          
          instances_info = {}
          for name in ['EC2-CORE', 'EC2-DB']:
              if name in ips:
                  instances_info[name] = {
                      'public': ips[name]['PublicIpAddress'],
                      'private': ips[name]['PrivateIpAddress']
                  }
                  print(f"{name}: public={ips[name]['PublicIpAddress']}, private={ips[name]['PrivateIpAddress']}")
          
          with open('ips.txt', 'w') as f:
              json.dump(instances_info, f)
          PYSCRIPT

      - name: Deploy Microservices
        env:
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          python3 << 'PYSCRIPT'
          import paramiko
          import io
          import os
          import json
          import time
          
          with open('ips.txt', 'r') as f:
              ips = json.load(f)
          
          core_ip = ips['EC2-CORE']['public']
          db_private_ip = ips['EC2-DB']['private']
          docker_user = os.environ.get("DOCKER_USERNAME", "")
          ssh_key_str = os.environ.get("EC2_SSH_KEY", "")
          
          print(f"üîó Connecting to EC2-CORE ({core_ip})...")
          ssh = paramiko.SSHClient()
          ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
          
          try:
              key = paramiko.RSAKey.from_private_key(io.StringIO(ssh_key_str))
              ssh.connect(core_ip, username='ubuntu', pkey=key, timeout=30)
              print("‚úÖ Connected")
              
              commands = [
                  "docker network create core-net 2>/dev/null || true",
                  f"docker pull {docker_user}/micro-auth:latest",
                  f"docker pull {docker_user}/micro-estudiantes:latest",
                  f"docker pull {docker_user}/micro-maestros:latest",
                  "docker stop micro-auth micro-estudiantes micro-maestros 2>/dev/null || true",
                  "docker rm micro-auth micro-estudiantes micro-maestros 2>/dev/null || true",
                  f'docker run -d --name micro-auth --network core-net -p 0.0.0.0:3000:3000 -e PORT=3000 -e MONGODB_URI="mongodb://root:example@{db_private_ip}:27017/auth?authSource=admin" -e NODE_ENV=production {docker_user}/micro-auth:latest',
                  "sleep 3",
                  f'docker run -d --name micro-estudiantes --network core-net -p 0.0.0.0:3001:3001 -e PORT=3001 -e MONGODB_URI="mongodb://root:example@{db_private_ip}:27017/estudiantes?authSource=admin" -e NODE_ENV=production {docker_user}/micro-estudiantes:latest',
                  "sleep 3",
                  f'docker run -d --name micro-maestros --network core-net -p 0.0.0.0:3002:3002 -e PORT=3002 -e MONGODB_URI="mongodb://root:example@{db_private_ip}:27017/maestros?authSource=admin" -e NODE_ENV=production {docker_user}/micro-maestros:latest',
                  "sleep 5",
                  "docker ps -a",
              ]
              
              for cmd in commands:
                  print(f"  ‚Üí {cmd[:80]}")
                  stdin, stdout, stderr = ssh.exec_command(cmd)
                  output = stdout.read().decode().strip()
                  if output:
                      print(f"    ‚úì {output[:100]}")
              
              print("\n‚úÖ Microservices deployed!")
              ssh.close()
              
          except Exception as e:
              print(f"‚ùå Failed: {e}")
              exit(1)
          PYSCRIPT

  # ============================================================================
  # PHASE 4: DEPLOY API GATEWAY
  # ============================================================================
  deploy-api-gateway:
    name: Deploy API Gateway
    needs: deploy-core
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v3

      - name: Install dependencies
        run: pip install paramiko boto3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Get IPs
        run: |
          python3 << 'PYSCRIPT'
          import json
          
          with open('config/instance_ips.json', 'r') as f:
              ips = json.load(f)
          
          instances_info = {}
          for name in ['EC2-API-Gateway', 'EC2-CORE']:
              if name in ips:
                  instances_info[name] = {
                      'public': ips[name]['PublicIpAddress'],
                      'private': ips[name]['PrivateIpAddress']
                  }
          
          with open('ips.txt', 'w') as f:
              json.dump(instances_info, f)
          PYSCRIPT

      - name: Deploy API Gateway
        env:
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          python3 << 'PYSCRIPT'
          import paramiko
          import io
          import os
          import json
          
          with open('ips.txt', 'r') as f:
              ips = json.load(f)
          
          gateway_ip = ips['EC2-API-Gateway']['public']
          core_private_ip = ips['EC2-CORE']['private']
          docker_user = os.environ.get("DOCKER_USERNAME", "")
          ssh_key_str = os.environ.get("EC2_SSH_KEY", "")
          
          print(f"üîó Connecting to EC2-API-Gateway ({gateway_ip})...")
          ssh = paramiko.SSHClient()
          ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
          
          try:
              key = paramiko.RSAKey.from_private_key(io.StringIO(ssh_key_str))
              ssh.connect(gateway_ip, username='ubuntu', pkey=key, timeout=30)
              print("‚úÖ Connected")
              
              commands = [
                  f"docker pull {docker_user}/api-gateway:latest",
                  "docker stop api-gateway 2>/dev/null || true",
                  "docker rm api-gateway 2>/dev/null || true",
                  f'docker run -d --name api-gateway -p 8080:8080 -e CORE_HOST={core_private_ip} -e NODE_ENV=production {docker_user}/api-gateway:latest',
                  "sleep 5",
                  "docker ps -a",
              ]
              
              for cmd in commands:
                  print(f"  ‚Üí {cmd[:80]}")
                  stdin, stdout, stderr = ssh.exec_command(cmd)
                  output = stdout.read().decode().strip()
                  if output:
                      print(f"    ‚úì {output[:100]}")
              
              print("\n‚úÖ API Gateway deployed!")
              ssh.close()
              
          except Exception as e:
              print(f"‚ùå Failed: {e}")
              exit(1)
          PYSCRIPT

  # ============================================================================
  # PHASE 5: VERIFY DEPLOYMENT
  # ============================================================================
  verify-deployment:
    name: Verify All Services are Running
    needs: deploy-api-gateway
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v3

      - name: Install dependencies
        run: pip install requests

      - name: Verify Services
        run: |
          python3 << 'PYSCRIPT'
          import json
          import requests
          import time
          
          with open('config/instance_ips.json', 'r') as f:
              ips = json.load(f)
          
          gateway_ip = ips['EC2-API-Gateway']['PublicIpAddress']
          
          print(f"üîç Verifying deployment on {gateway_ip}...")
          
          # Wait for API Gateway to be ready
          for attempt in range(30):
              try:
                  response = requests.get(f"http://{gateway_ip}:8080/health", timeout=5)
                  if response.status_code == 200:
                      print(f"‚úÖ API Gateway is responding!")
                      data = response.json()
                      print(f"   Status: {data.get('status')}")
                      print(f"   Message: {data.get('message')}")
                      break
              except:
                  if attempt < 29:
                      print(f"‚è≥ Waiting for API Gateway ({attempt + 1}/30)...")
                      time.sleep(5)
                  else:
                      print("‚ùå API Gateway not responding after 2.5 minutes")
                      exit(1)
          
          # Test auth endpoint
          print("\nüîç Testing auth endpoint...")
          try:
              response = requests.post(
                  f"http://{gateway_ip}:8080/auth/health",
                  timeout=5
              )
              if response.status_code == 200:
                  print("‚úÖ Auth service is responding!")
                  print(f"   Response: {response.json()}")
              else:
                  print(f"‚ö†Ô∏è  Auth service returned {response.status_code}")
          except Exception as e:
              print(f"‚ö†Ô∏è  Auth health check failed: {e}")
          
          print("\n‚úÖ Deployment verification complete!")
          print(f"üéâ API Gateway URL: http://{gateway_ip}:8080")
          PYSCRIPT

  # ============================================================================
  # FINAL REPORT
  # ============================================================================
  summary:
    name: Deployment Summary
    needs: verify-deployment
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Print Summary
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë         üéâ DEPLOYMENT COMPLETED SUCCESSFULLY üéâ              ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo "‚úÖ Phase 1: Instances ready"
          echo "‚úÖ Phase 2: Databases deployed (MongoDB, PostgreSQL, Redis)"
          echo "‚úÖ Phase 3: Microservices deployed (auth, estudiantes, maestros)"
          echo "‚úÖ Phase 4: API Gateway deployed"
          echo "‚úÖ Phase 5: All services verified"
          echo ""
          echo "NEXT STEPS:"
          echo "1. Get API Gateway IP from EC2 console"
          echo "2. Test API: curl http://<API-GATEWAY-IP>:8080/health"
          echo "3. Register user: curl -X POST http://<API-GATEWAY-IP>:8080/auth/register"
          echo ""
