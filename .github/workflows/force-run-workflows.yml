name: Force Run All Workflows

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to dispatch workflows (branch or tag)'
        required: true
        default: 'main'
      workflows:
        description: 'Comma-separated workflow filenames to dispatch (optional). If omitted, all will be dispatched.'
        required: false

permissions:
  actions: write
  contents: read

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger workflows
        uses: actions/github-script@v6
        with:
          script: |
            // Read workflow_dispatch inputs from the event payload
            const ref = (context.payload && context.payload.inputs && context.payload.inputs.ref) || 'main';
            const wfInput = (context.payload && context.payload.inputs && context.payload.inputs.workflows) || '';
            let workflows = [];
            if (wfInput) {
              workflows = wfInput.split(',').map(s => s.trim()).filter(Boolean);
            } else {
              workflows = [
                'frontend.yml',
                'api-gateway.yml',
                'deploy-databases.yml',
                'deploy-messaging.yml',
                'deploy-monitoring.yml',
                'micro-auth.yml',
                'micro-estudiantes.yml',
                'micro-maestros.yml',
                'micro-notificaciones.yml',
                'micro-reportes-estudiantes.yml',
                'micro-reportes-maestros.yml',
                'micro-analytics.yml',
                'micro-soap-bridge.yml'
              ];
            }

            for (const wf of workflows) {
              console.log(`Dispatching ${wf} -> ${ref}`);
              try {
                await github.request('POST /repos/{owner}/{repo}/actions/workflows/{workflow_id}/dispatches', {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: wf,
                  ref
                });
                console.log(`Triggered ${wf}`);
              } catch (err) {
                console.error(`Failed to trigger ${wf}: ${err.message}`);
              }
            }
