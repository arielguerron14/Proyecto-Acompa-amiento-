name: Fix Reportes Routing in API Gateway

on:
  workflow_dispatch:

env:
  SSH_KEY: ${{ secrets.AWS_EC2_DB_SSH_PRIVATE_KEY }}

jobs:
  fix-routing:
    name: Deploy API Gateway and Reportes Route Fixes
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ env.SSH_KEY }}" > ~/.ssh/key.pem
          
          # Check if key was created
          if [ ! -f ~/.ssh/key.pem ]; then
            echo "ERROR: SSH key file was not created!"
            echo "SSH_KEY length: ${#SSH_KEY}"
            exit 1
          fi
          
          # Check key format
          if ! grep -q "BEGIN RSA PRIVATE KEY\|BEGIN EC PRIVATE KEY\|BEGIN OPENSSH PRIVATE KEY" ~/.ssh/key.pem; then
            echo "WARNING: SSH key might not be in valid format"
            head -1 ~/.ssh/key.pem
          fi
          
          chmod 600 ~/.ssh/key.pem
          chmod 700 ~/.ssh
          
          # Test SSH key validity
          if ! ssh-keygen -l -f ~/.ssh/key.pem >/dev/null 2>&1; then
            echo "ERROR: SSH key is invalid or corrupted"
            exit 1
          fi
          
          cat > ~/.ssh/config << 'EOF'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
            LogLevel=QUIET
            IdentitiesOnly=yes
            User ubuntu
            ConnectTimeout=15
          EOF
          chmod 600 ~/.ssh/config
          
          echo "✅ SSH setup complete and validated"

      - name: Deploy API Gateway Fix (API Gateway Server)
        run: |
          echo "=================================================="
          echo "Deploying API Gateway with Reportes Routing Fix"
          echo "=================================================="
          
          echo "Testing SSH connection with verbose output..."
          ssh -vvv -i ~/.ssh/key.pem -o ConnectTimeout=15 ubuntu@100.49.159.65 "echo SSH connection successful" 2>&1 | head -50
          
          if [ $? -ne 0 ]; then
            echo "❌ SSH connection failed"
            echo "Checking if servers are reachable via ping..."
            ping -c 1 100.49.159.65 || echo "Cannot ping 100.49.159.65"
            exit 1
          fi
          
          echo "✅ SSH connection successful"
          echo "Deploying API Gateway..."
          ssh -i ~/.ssh/key.pem ubuntu@100.49.159.65 << 'SCRIPT'
          cd /tmp
          rm -rf Proyecto-Acompa-amiento-
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
          
          docker build -t api-gateway:latest -f api-gateway/Dockerfile .
          docker stop api-gateway 2>/dev/null || true
          docker kill api-gateway 2>/dev/null || true
          sleep 1
          docker rm -f api-gateway 2>/dev/null || true
          sleep 2
          docker system prune -f 2>/dev/null || true
          sleep 3
          
          docker run -d --name api-gateway --restart unless-stopped \
            -p 8080:8080 \
            -e PORT=8080 \
            -e AUTH_SERVICE=http://13.223.196.229:3000 \
            -e MAESTROS_SERVICE=http://13.223.196.229:3002 \
            -e ESTUDIANTES_SERVICE=http://13.223.196.229:3001 \
            -e REPORTES_EST_SERVICE=http://100.28.217.159:5003 \
            -e REPORTES_MAEST_SERVICE=http://100.28.217.159:5004 \
            api-gateway:latest
          
          sleep 5
          docker ps | grep api-gateway
          echo "✅ API Gateway deployed!"
          SCRIPT

      - name: Deploy Reportes Services Route Fixes (Database Server)
        run: |
          echo "=================================================="
          echo "Deploying Reportes Services with Route Fixes"
          echo "=================================================="
          
          echo "Testing SSH connection to database server..."
          ssh -i ~/.ssh/key.pem -o ConnectTimeout=10 -o StrictHostKeyChecking=no ubuntu@98.84.26.109 "echo SSH connection successful" || exit 1
          
          echo "Deploying Reportes Services..."
          ssh -i ~/.ssh/key.pem -o ConnectTimeout=10 ubuntu@98.84.26.109 << 'SCRIPT'
          cd /tmp
          rm -rf Proyecto-Acompa-amiento-
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
          
          docker build -t micro-reportes-estudiantes:latest -f micro-reportes-estudiantes/Dockerfile .
          docker build -t micro-reportes-maestros:latest -f micro-reportes-maestros/Dockerfile .
          
          docker stop micro-reportes-estudiantes micro-reportes-maestros 2>/dev/null || true
          docker kill micro-reportes-estudiantes micro-reportes-maestros 2>/dev/null || true
          sleep 1
          docker rm -f micro-reportes-estudiantes micro-reportes-maestros 2>/dev/null || true
          sleep 2
          
          docker run -d --name micro-reportes-estudiantes --restart unless-stopped \
            -p 5003:5003 \
            -e PORT=5003 \
            -e MONGO_URI=mongodb://localhost:27017/micro-reportes-estudiantes \
            micro-reportes-estudiantes:latest
          
          docker run -d --name micro-reportes-maestros --restart unless-stopped \
            -p 5004:5004 \
            -e PORT=5004 \
            -e MONGO_URI=mongodb://localhost:27017/micro-reportes-maestros \
            micro-reportes-maestros:latest
          
          sleep 8
          docker ps | grep micro-reportes
          curl -s http://localhost:5003/health || echo "Reportes EST check"
          echo "✅ Reportes services deployed!"
          SCRIPT

      - name: Verify All Services
        continue-on-error: true
        run: |
          echo "=================================================="
          echo "System Verification After Routing Fixes"
          echo "=================================================="
          
          echo "Testing API Gateway health..."
          curl -s http://100.49.159.65:8080/health | jq . || echo "API Gateway health check"
          
          echo ""
          echo "Testing Reportes Estudiantes service directly..."
          curl -s http://98.84.26.109:5003/health | jq . || echo "Reportes EST health check"
          
          echo ""
          echo "Testing Reportes endpoint through API Gateway..."
          curl -s http://100.49.159.65:8080/api/reportes/estudiantes/reporte/test123 | jq . || echo "Testing /api/reportes routing"
          
          echo ""
          echo "Testing legacy reportes endpoint..."
          curl -s http://100.49.159.65:8080/reportes/reporte/test123 | jq . || echo "Testing /reportes routing"

      - name: Final Status
        run: |
          echo "=================================================="
          echo "✅ ROUTING FIX DEPLOYMENT COMPLETE"
          echo "=================================================="
          echo ""
          echo "Updated Services:"
          echo "  • API Gateway: 100.49.159.65:8080"
          echo "    - Added /api/reportes/* route proxy"
          echo "    - Kept /reportes/* for backward compatibility"
          echo ""
          echo "  • Micro-Reportes-Estudiantes: 98.84.26.109:5003"
          echo "    - Added /api/reportes/estudiantes/* routes"
          echo "    - Kept /registrar and /reporte/:id for compatibility"
          echo ""
          echo "  • Micro-Reportes-Maestros: 98.84.26.109:5004"
          echo "    - Added /api/reportes/maestros/* routes"
          echo "    - Kept legacy routes for compatibility"
          echo ""
          echo "The frontend should now correctly access:"
          echo "  GET /api/reportes/estudiantes/reporte/{id}"

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/key.pem
