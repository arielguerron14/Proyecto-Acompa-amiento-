name: Repair dispatch runner

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Target group: core|frontend|reportes|notificaciones|all'
        required: false
        default: 'all'

jobs:
  repair:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare SSH key
        run: |
          echo "${{ secrets.EC2_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.MONGO_URI }}" ]; then
            echo "ERROR: Required secret MONGO_URI is not set. Add it to repository secrets before running.";
            exit 1
          fi
          echo "MONGO_URI is set. Proceeding..."

      - name: Repair hosts (core/frontend/reportes/notificaciones)
        run: |
          set -e
          TARGET=${{ github.event.inputs.target || 'all' }}

          run_fix() {
            HOST=$1
            NAME=$2
            if [ -z "$HOST" ]; then
              echo "$NAME host not set; skipping"; return
            fi
            echo "Running fix script on $NAME host $HOST"
            cat scripts/fix-deploy.sh | ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@$HOST 'bash -s' | tee repair-$NAME.log
            echo "Uploading repair-$NAME.log"
            ls -l repair-$NAME.log || true
          }

          if [ "$TARGET" = "core" ] || [ "$TARGET" = "all" ]; then run_fix "${{ secrets.EC2_CORE_HOST }}" core; fi
          if [ "$TARGET" = "frontend" ] || [ "$TARGET" = "all" ]; then run_fix "${{ secrets.EC2_FRONTEND_HOST }}" frontend; fi
          if [ "$TARGET" = "reportes" ] || [ "$TARGET" = "all" ]; then
            echo "Writing env files on reportes host ${{ secrets.EC2_REPORTES_HOST }}"
            # Sanitize and base64-encode secrets on the runner before sending
            MONGO_CLEAN=$(printf '%s' "${{ secrets.MONGO_URI }}" | tr -d '\r' | sed 's/\\n//g' | tr -d '\n')
            MONGO_B64=$(printf '%s' "$MONGO_CLEAN" | base64 -w0)
            REDIS_HOST_B64=$(printf '%s' "${{ secrets.REDIS_HOST }}" | base64 -w0)
            REDIS_PORT_B64=$(printf '%s' "${{ secrets.REDIS_PORT }}" | base64 -w0)
            REDIS_PW_B64=$(printf '%s' "${{ secrets.REDIS_PASSWORD }}" | base64 -w0)

            ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_REPORTES_HOST }} <<'REMOTE_EOF'
  # Write base64 payloads to temp, decode on-host and force single-line values
  echo '$MONGO_B64' > /tmp/mongo.b64 || true
  base64 -d /tmp/mongo.b64 | tr -d '\r\n' > /tmp/mongo.dec || true
  MONGO_URI="$(cat /tmp/mongo.dec)"

  echo '$REDIS_HOST_B64' > /tmp/redis_host.b64 || true
  base64 -d /tmp/redis_host.b64 | tr -d '\r\n' > /tmp/redis_host.dec || true
  REDIS_HOST="$(cat /tmp/redis_host.dec)"

  echo '$REDIS_PORT_B64' > /tmp/redis_port.b64 || true
  base64 -d /tmp/redis_port.b64 | tr -d '\r\n' > /tmp/redis_port.dec || true
  REDIS_PORT="$(cat /tmp/redis_port.dec)"

  echo '$REDIS_PW_B64' > /tmp/redis_pw.b64 || true
  base64 -d /tmp/redis_pw.b64 | tr -d '\r\n' > /tmp/redis_pw.dec || true
  REDIS_PASSWORD="$(cat /tmp/redis_pw.dec)"

  printf "MONGO_URI='%s'\nREDIS_HOST='%s'\nREDIS_PORT='%s'\nREDIS_PASSWORD='%s'\n" "$MONGO_URI" "$REDIS_HOST" "$REDIS_PORT" "$REDIS_PASSWORD" > "$HOME/micro-analytics.env"
  printf "MONGO_URI='%s'\n" "$MONGO_URI" > "$HOME/micro-reportes-estudiantes.env"
  printf "MONGO_URI='%s'\n" "$MONGO_URI" > "$HOME/micro-reportes-maestros.env"

  # Emit debug and verify no LF bytes
  awk -F= '/^MONGO_URI/ {print $2}' "$HOME/micro-analytics.env" | sed "s/^'//; s/'$//" | sed -n 'l;p' || true
  awk -F= '/^MONGO_URI/ {print $2}' "$HOME/micro-analytics.env" | sed "s/^'//; s/'$//" | od -An -t x1 -v || true

  if awk -F= '/^MONGO_URI/ {print $2}' "$HOME/micro-analytics.env" | sed "s/^'//; s/'$//" | od -An -t x1 -v | grep -qw '0a'; then
    echo "ERROR: MONGO_URI contains LF bytes after write on reportes host"; exit 2
  fi
REMOTE_EOF | sed 's/^/REMOTE-DECODE-REPORTES: /' | tee remote-decode-reportes.log >> repair-reportes.log || true
            run_fix "${{ secrets.EC2_REPORTES_HOST }}" reportes;
          fi
          if [ "$TARGET" = "notificaciones" ] || [ "$TARGET" = "all" ]; then
            echo "Writing env file on notificaciones host ${{ secrets.EC2_NOTIFICACIONES_HOST }}"
            ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_NOTIFICACIONES_HOST }} << 'EOF'
cat > "$HOME/micro-notificaciones.env" <<ENV
MONGO_URI='${{ secrets.MONGO_URI }}'
REDIS_HOST='${{ secrets.REDIS_HOST }}'
REDIS_PORT='${{ secrets.REDIS_PORT }}'
REDIS_PASSWORD='${{ secrets.REDIS_PASSWORD }}'
ENV
EOF
            run_fix "${{ secrets.EC2_NOTIFICACIONES_HOST }}" notificaciones;
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: repair-logs
          path: repair-*.log
