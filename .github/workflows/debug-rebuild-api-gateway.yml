name: Debug & Rebuild API Gateway

on:
  workflow_dispatch:
    inputs:
      debug_logs:
        description: 'Show full debug logs'
        required: false
        default: 'true'

env:
  SSH_KEY: ${{ secrets.AWS_EC2_DB_SSH_PRIVATE_KEY }}

jobs:
  debug-rebuild:
    name: Debug & Rebuild API Gateway
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/key.pem << 'EOF'
          ${{ env.SSH_KEY }}
          EOF
          chmod 600 ~/.ssh/key.pem
          cat > ~/.ssh/config << 'EOF'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
            LogLevel=QUIET
          EOF

      - name: Debug & Rebuild API Gateway
        run: |
          echo ""
          echo "=================================================="
          echo "ðŸ”§ DEBUG: API Gateway Status Check"
          echo "=================================================="
          ssh -i ~/.ssh/key.pem -o ConnectTimeout=10 ubuntu@100.49.159.65 << 'DEBUGFIX'
          set -e
          
          echo ""
          echo "Step 1: Check current container status..."
          docker ps -a | grep -i gateway || echo "No gateway container found"
          
          echo ""
          echo "Step 2: Check container logs (last 50 lines)..."
          docker logs --tail=50 acompanamiento-gateway 2>&1 || echo "No logs available"
          
          echo ""
          echo "Step 3: Check if auth routes are mentioned in logs..."
          docker logs acompanamiento-gateway 2>&1 | grep -i "auth\|mounted" || echo "No auth/mounted messages found"
          
          echo ""
          echo "Step 4: Inspect container environment variables..."
          docker inspect acompanamiento-gateway | grep -E "AUTH_SERVICE|MAESTROS_SERVICE|ESTUDIANTES_SERVICE" || echo "No service env vars found"
          
          echo ""
          echo "Step 5: Stop and remove old container..."
          docker stop acompanamiento-gateway 2>/dev/null || true
          sleep 2
          docker rm acompanamiento-gateway 2>/dev/null || true
          sleep 2
          
          echo ""
          echo "Step 6: Remove old image to force rebuild..."
          docker rmi api-gateway:latest 2>/dev/null || true
          
          echo ""
          echo "Step 7: Clone latest code..."
          cd /tmp
          rm -rf Proyecto-Acompa-amiento-
          git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
          cd Proyecto-Acompa-amiento-
          
          echo ""
          echo "Step 8: Verify directory structure..."
          pwd
          ls -la api-gateway/Dockerfile
          ls -la api-gateway/src/routes/authRoutes.js || echo "âš ï¸  authRoutes.js not found!"
          ls -la api-gateway/src/utils/httpForward.js || echo "âš ï¸  httpForward.js not found!"
          
          echo ""
          echo "Step 9: Build API Gateway image (fresh)..."
          docker build -t api-gateway:latest -f api-gateway/Dockerfile ./api-gateway
          
          echo ""
          echo "Step 10: Start API Gateway with PUBLIC IP addresses..."
          docker run -d \
            --name acompanamiento-gateway \
            --restart unless-stopped \
            -p 8080:8080 \
            -e NODE_ENV=production \
            -e PORT=8080 \
            -e AUTH_SERVICE=http://100.24.118.233:3000 \
            -e MAESTROS_SERVICE=http://100.24.118.233:3002 \
            -e ESTUDIANTES_SERVICE=http://100.24.118.233:3001 \
            api-gateway:latest
          
          echo ""
          echo "Step 11: Wait for container to start..."
          sleep 5
          
          echo ""
          echo "Step 12: Check new container logs (startup phase)..."
          docker logs acompanamiento-gateway 2>&1 | tail -40
          
          echo ""
          echo "Step 13: Verify routes are registered..."
          docker logs acompanamiento-gateway 2>&1 | grep -i "auth\|mounted\|listening" || echo "âš ï¸  No startup messages found"
          
          echo ""
          echo "âœ… API Gateway rebuild and debug completed!"
          DEBUGFIX

      - name: Test API Gateway Health
        run: |
          echo ""
          echo "=================================================="
          echo "Testing API Gateway"
          echo "=================================================="
          
          echo "Testing health endpoint..."
          curl -v http://100.49.159.65:8080/health 2>&1 | head -20
          
          echo ""
          echo "Testing registration endpoint..."
          curl -v -X POST http://100.49.159.65:8080/auth/register \
            -H "Content-Type: application/json" \
            -d '{"nombre":"Test","email":"test@example.com","password":"123456","rol":"Estudiante"}' 2>&1 | head -30

      - name: Final Status
        run: |
          echo ""
          echo "=================================================="
          echo "âœ… DEBUG & REBUILD COMPLETED"
          echo "=================================================="
          echo ""
          echo "API Gateway should now be accessible at: http://100.49.159.65:8080"
          echo ""
          echo "Check logs with:"
          echo "  ssh -i key.pem ubuntu@100.49.159.65 'docker logs acompanamiento-gateway'"
          echo ""

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/key.pem
