name: Project Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Environment (dev/staging/prod)
        required: false
        default: production
      skip_verification:
        description: Skip endpoint verification
        required: false
        default: 'false'

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      instances: ${{ steps.find.outputs.instances }}
      bastion: ${{ steps.find.outputs.bastion }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Find instances
        id: find
        run: |
          # Get instances with tag Project=lab-8-ec2
          INSTANCES=$(aws ec2 describe-instances \
            --filters "Name=tag:Project,Values=lab-8-ec2" "Name=instance-state-name,Values=running" \
            --query 'Reservations[*].Instances[*].[Tags[?Key==`Name`].Value|[0],PrivateIpAddress,PublicIpAddress]' \
            --output json)
          
          # Convert to compact object format
          INSTANCES_MAP=$(echo "$INSTANCES" | jq -c '[.[][] | {name: .[0], private_ip: .[1], public_ip: .[2]}] | map({(.name): {private_ip, public_ip}}) | add')
          
          echo "Found instances:"
          echo "$INSTANCES_MAP" | jq '.'
          echo "instances=$INSTANCES_MAP" >> $GITHUB_OUTPUT
          
          # Get Bastion IP
          BASTION=$(echo "$INSTANCES_MAP" | jq -r '.["EC-Bastion"].public_ip // "unknown"')
          echo "bastion=$BASTION" >> $GITHUB_OUTPUT
          echo "Bastion IP: $BASTION"

  verify:
    runs-on: ubuntu-latest
    needs: discover
    if: ${{ github.event.inputs.skip_verification == 'false' }}
    
    steps:
      - name: Verify endpoints
        run: |
          INSTANCES='${{ needs.discover.outputs.instances }}'
          echo "Verifying connectivity to instances..."
          echo "$INSTANCES" | jq 'to_entries[] | "\(.key): \(.value.public_ip)"' -r
          
          echo "$INSTANCES" | jq -r 'to_entries[] | .value.public_ip' | while read IP; do
            [ -z "$IP" ] && continue
            echo "Testing $IP..."
            for PORT in 22 80 443 8080; do
              timeout 2 bash -c "cat < /dev/null > /dev/tcp/$IP/$PORT" 2>/dev/null && \
                echo "✓ Port $PORT open" || echo "✗ Port $PORT closed"
            done
          done

  summary:
    runs-on: ubuntu-latest
    needs: [discover, verify]
    if: always()
    
    steps:
      - name: Report
        run: |
          echo "# Deployment Summary"
          echo ""
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo ""
          echo "## Discovered Instances"
          echo '```'
          echo '${{ needs.discover.outputs.instances }}' | jq '.'
          echo '```'
          echo ""
          echo "Bastion: ${{ needs.discover.outputs.bastion }}"
