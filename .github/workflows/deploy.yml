name: Deploy to EC2_CORE Only

on:
  workflow_dispatch:
    inputs:
      rebuild_docker:
        description: 'Rebuild Docker images'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      environment:
        description: 'Environment'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AWS_REGION: us-east-1
  DOCKER_BUILDKIT: 1

jobs:
  deploy-ec2-core:
    name: Deploy EC2_CORE
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Docker Hub Login
        run: |
          echo "Haciendo login en Docker Hub..."
          echo "Reco16888" | docker login -u caguerronp@uce.edu.ec --password-stdin

      - name: Build and Push micro-auth
        run: |
          docker build -t caguerronp/micro-auth:latest ./micro-auth
          docker push caguerronp/micro-auth:latest

      - name: Build and Push micro-estudiantes
        run: |
          docker build -t caguerronp/micro-estudiantes:latest ./micro-estudiantes
          docker push caguerronp/micro-estudiantes:latest

      - name: Build and Push micro-maestros
        run: |
          docker build -t caguerronp/micro-maestros:latest ./micro-maestros
          docker push caguerronp/micro-maestros:latest

      - name: Build and Push micro-core
        run: |
          docker build -t caguerronp/micro-core:latest ./micro-core
          docker push caguerronp/micro-core:latest

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Discover EC2_CORE and Deploy
        run: |
          set -e

          INSTANCE="EC2_CORE"
          TAG_NAME="EC2-CORE"
          GITHUB_REPO="${{ github.repository }}"
          GITHUB_REF="${{ github.ref }}"

          echo "ðŸ” Discovering EC2_CORE instance..."

          INSTANCE_DATA=$(aws ec2 describe-instances \
            --region $AWS_REGION \
            --filters "Name=instance-state-name,Values=running" "Name=tag:Name,Values=$TAG_NAME" \
            --query 'Reservations[0].Instances[0]' \
            --output json)

          if [ "$INSTANCE_DATA" = "null" ] || [ -z "$INSTANCE_DATA" ]; then
            echo "âŒ EC2_CORE not found"
            exit 1
          fi

          PUBLIC_IP=$(echo "$INSTANCE_DATA" | jq -r '.PublicIpAddress')
          PRIVATE_IP=$(echo "$INSTANCE_DATA" | jq -r '.PrivateIpAddress')

          echo "âœ… EC2_CORE found"
          echo "   Public IP:  $PUBLIC_IP"
          echo "   Private IP: $PRIVATE_IP"

          echo "ðŸ” Setting up SSH..."
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $PUBLIC_IP >> ~/.ssh/known_hosts 2>/dev/null || true

          echo "ðŸ§¹ Cleaning EC2_CORE..."
          ssh ubuntu@$PUBLIC_IP <<CLEANSSH
          set -e
          docker system prune -af --volumes || true
          rm -rf ~/app ~/app-build ~/docker-images || true
          mkdir -p ~/app ~/docker-images
          CLEANSSH

          echo "ðŸ“¦ Sending docker-compose..."
          scp ./docker-compose.ec2-core.yml ubuntu@$PUBLIC_IP:~/app/docker-compose.yml

          echo "ðŸš€ Deploying on EC2_CORE..."

          ssh ubuntu@$PUBLIC_IP bash -s <<BUILDSSH
          set -e

          export INSTANCE="$INSTANCE"
          export PRIVATE_IP="$PRIVATE_IP"
          export GITHUB_REPO="$GITHUB_REPO"
          export GITHUB_REF="$GITHUB_REF"

          echo "================================================"
          echo "ðŸ”§ EC2 CORE DEPLOYMENT"
          echo "================================================"
          echo "Instance: \$INSTANCE"
          echo "Repo:     \$GITHUB_REPO"
          echo "IP:       \$PRIVATE_IP"
          echo "================================================"

          cd ~
          git clone --depth 1 https://github.com/\$GITHUB_REPO.git app-build
          cd app-build
          git checkout \${GITHUB_REF#refs/heads/}



          echo "ðŸš€ Starting services..."
          cd ~/app
          docker-compose down || true
          docker-compose up -d

          echo "â³ Waiting for services..."
          sleep 25

          echo "ðŸ“‹ Containers:"
          docker-compose ps

          echo "================================================"
          echo "âœ… DEPLOYMENT FINISHED"
          echo "================================================"
          BUILDSSH

      - name: Verify deployment
        if: always()
        continue-on-error: true
        run: |
          echo "ðŸ” Verifying services..."
