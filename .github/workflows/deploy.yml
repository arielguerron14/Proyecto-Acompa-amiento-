name: Deploy to EC2

on:
  workflow_dispatch:
    inputs:
      instance:
        description: 'Instance to deploy'
        required: true
        default: 'EC2_CORE'
        type: choice
        options:
          - EC2_CORE
          - EC2_DB
          - EC2_API_GATEWAY
          - EC2_FRONTEND
          - EC2_MESSAGING
          - EC2_MONITORING
      rebuild_docker:
        description: 'Rebuild Docker images'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      environment:
        description: 'Environment'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AWS_REGION: us-east-1
  DOCKER_BUILDKIT: 1

jobs:
  deploy-ec2:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: Get EC2 IP
        id: get-ip
        run: |
          case "${{ github.event.inputs.instance }}" in
            EC2_CORE)
              echo "ip=13.216.12.61" >> $GITHUB_OUTPUT
              ;;
            EC2_DB)
              echo "ip=3.238.204.241" >> $GITHUB_OUTPUT
              ;;
            EC2_API_GATEWAY)
              echo "ip=52.71.188.181" >> $GITHUB_OUTPUT
              ;;
            EC2_FRONTEND)
              echo "ip=107.21.124.81" >> $GITHUB_OUTPUT
              ;;
            EC2_MESSAGING)
              echo "ip=44.221.50.177" >> $GITHUB_OUTPUT
              ;;
            EC2_MONITORING)
              echo "ip=54.198.235.28" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "ip=0.0.0.0" >> $GITHUB_OUTPUT
              ;;
          esac
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ steps.get-ip.outputs.ip }} >> ~/.ssh/known_hosts 2>/dev/null || true
          echo "SSH setup complete"
      
      - name: Build Docker Images
        if: github.event.inputs.rebuild_docker == 'true'
        run: |
          mkdir -p /tmp
          
          # Build microservices
          for SERVICE in api-gateway micro-auth micro-estudiantes micro-maestros frontend-web; do
            if [ -f "./$SERVICE/Dockerfile" ]; then
              echo "Building $SERVICE..."
              if [ "$SERVICE" = "frontend-web" ]; then
                docker build --no-cache -t $SERVICE:latest -f ./$SERVICE/Dockerfile ./$SERVICE
              else
                docker build --no-cache -t $SERVICE:latest -f ./$SERVICE/Dockerfile .
              fi
              docker save $SERVICE:latest -o /tmp/$SERVICE.tar
            fi
          done
          
          # Build infrastructure services
          # Zookeeper
          if [ -f "./messaging/zookeeper/Dockerfile" ]; then
            echo "Building zookeeper..."
            docker build --no-cache -t proyecto-zookeeper:1.0 -f ./messaging/zookeeper/Dockerfile ./messaging
            docker save proyecto-zookeeper:1.0 -o /tmp/proyecto-zookeeper.tar
          fi
          
          # Kafka
          if [ -f "./messaging/kafka/Dockerfile" ]; then
            echo "Building kafka..."
            docker build --no-cache -t proyecto-kafka:1.0 -f ./messaging/kafka/Dockerfile ./messaging
            docker save proyecto-kafka:1.0 -o /tmp/proyecto-kafka.tar
          fi
          
          # RabbitMQ
          if [ -f "./messaging/rabbitmq/Dockerfile" ]; then
            echo "Building rabbitmq..."
            docker build --no-cache -t proyecto-rabbitmq:1.0 -f ./messaging/rabbitmq/Dockerfile ./messaging
            docker save proyecto-rabbitmq:1.0 -o /tmp/proyecto-rabbitmq.tar
          fi
          
          # Prometheus
          if [ -f "./monitoring/prometheus/Dockerfile" ]; then
            echo "Building prometheus..."
            docker build --no-cache -t proyecto-prometheus:1.0 -f ./monitoring/prometheus/Dockerfile ./monitoring
            docker save proyecto-prometheus:1.0 -o /tmp/proyecto-prometheus.tar
          fi
          
          # Grafana
          if [ -f "./monitoring/grafana/Dockerfile" ]; then
            echo "Building grafana..."
            docker build --no-cache -t proyecto-grafana:1.0 -f ./monitoring/grafana/Dockerfile ./monitoring
            docker save proyecto-grafana:1.0 -o /tmp/proyecto-grafana.tar
          fi
          
          echo "Docker images built successfully"
          ls -lh /tmp/*.tar 2>/dev/null || echo "Warning: No tar files found"
      
      - name: Transfer files to EC2
        run: |
          IP=${{ steps.get-ip.outputs.ip }}
          INSTANCE=${{ github.event.inputs.instance }}
          
          # Aggressively clean space on EC2
          echo "Cleaning EC2 instance..."
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=30 ubuntu@$IP << 'CLEANUP'
          set -e
          echo "=== Cleaning old docker resources ==="
          docker system prune -af --volumes 2>/dev/null || true
          
          echo "=== Cleaning old .tar files ==="
          rm -f /tmp/*.tar /tmp/*.tar.gz 2>/dev/null || true
          rm -f ~/docker-images/*.tar 2>/dev/null || true
          
          echo "=== Disk usage before cleanup ==="
          df -h / | tail -1
          
          echo "=== Creating app directory ==="
          mkdir -p ~/docker-images ~/app
          
          echo "=== Disk usage after cleanup ==="
          df -h / | tail -1
          CLEANUP
          
          # Transfer Docker images to EC2 home directory
          echo "Transferring Docker images..."
          for FILE in /tmp/*.tar; do
            if [ -f "$FILE" ]; then
              echo "  Transferring $(basename $FILE)..."
              scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=30 -C "$FILE" ubuntu@$IP:~/docker-images/ || true
            fi
          done
          
          # Transfer appropriate docker-compose.yml based on instance
          if [ "$INSTANCE" = "EC2_CORE" ]; then
            COMPOSE_FILE="./docker-compose.ec2-core.yml"
          elif [ "$INSTANCE" = "EC2_API_GATEWAY" ]; then
            COMPOSE_FILE="./docker-compose.api-gateway.yml"
          elif [ "$INSTANCE" = "EC2_FRONTEND" ]; then
            COMPOSE_FILE="./docker-compose.frontend.yml"
          elif [ "$INSTANCE" = "EC2_MESSAGING" ]; then
            COMPOSE_FILE="./messaging/docker-compose.yml"
          elif [ "$INSTANCE" = "EC2_MONITORING" ]; then
            COMPOSE_FILE="./monitoring/docker-compose.yml"
          elif [ "$INSTANCE" = "EC2_DB" ]; then
            COMPOSE_FILE="./databases/docker-compose.yml"
          else
            COMPOSE_FILE="./docker-compose.yml"
          fi
          
          if [ -f "$COMPOSE_FILE" ]; then
            scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=30 "$COMPOSE_FILE" ubuntu@$IP:~/app/docker-compose.yml
          else
            echo "⚠️ Warning: $COMPOSE_FILE not found, skipping docker-compose transfer"
          fi
      
      - name: Deploy services
        run: |
          IP=${{ steps.get-ip.outputs.ip }}
          REBUILD=${{ github.event.inputs.rebuild_docker }}
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=30 ubuntu@$IP bash -s "$REBUILD" << 'ENDSSH'
          set -e
          REBUILD=$1
          
          echo "=== Phase 0: Install docker-compose if needed ==="
          if ! command -v docker-compose &> /dev/null; then
            echo "Installing docker-compose..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            docker-compose --version
          fi
          
          echo "=== Phase 1: Remove old containers ==="
          docker-compose -f ~/app/docker-compose.yml down 2>/dev/null || true

          echo "=== Phase 2: Remove old images (if rebuild_docker=true) ==="
          if [ "$REBUILD" = "true" ]; then
            echo "Removing old images to prevent caching issues..."
            docker rmi api-gateway:latest 2>/dev/null || true
            docker rmi micro-auth:latest 2>/dev/null || true
            docker rmi micro-estudiantes:latest 2>/dev/null || true
            docker rmi micro-maestros:latest 2>/dev/null || true
            docker rmi frontend-web:latest 2>/dev/null || true
            docker rmi proyecto-kafka:1.0 2>/dev/null || true
            docker rmi proyecto-zookeeper:1.0 2>/dev/null || true
            docker rmi proyecto-rabbitmq:1.0 2>/dev/null || true
            docker rmi proyecto-prometheus:1.0 2>/dev/null || true
            docker rmi proyecto-grafana:1.0 2>/dev/null || true
            docker image prune -f
          fi

          echo "=== Phase 3: Load new images (if rebuild_docker=true) ==="
          if [ "$REBUILD" = "true" ]; then
            echo "Loading images from ~/docker-images..."
            for FILE in ~/docker-images/*.tar; do
              if [ -f "$FILE" ]; then
                echo "Loading $(basename $FILE)..."
                docker load -i "$FILE" || echo "Warning: Failed to load $FILE"
                rm -f "$FILE"
              fi
            done
            
            echo "Loading images from /tmp..."
            for FILE in /tmp/*.tar; do
              if [ -f "$FILE" ]; then
                echo "Loading $(basename $FILE)..."
                docker load -i "$FILE" || echo "Warning: Failed to load $FILE"
                rm -f "$FILE"
              fi
            done
            
            echo "Images loaded successfully"
            docker images | grep -E 'proyecto|api-gateway|micro|frontend' || echo "No images found"
          else
            echo "Skipping image load (rebuild_docker=false)"
          fi
          
          echo "=== Phase 4: Deploy with docker-compose ==="
          cd ~/app
          docker-compose config > /dev/null && echo "✓ docker-compose.yml is valid"
          docker-compose up -d --pull=missing
          
          echo "=== Phase 5: Verify deployment ==="
          sleep 5
          docker-compose ps
          docker-compose logs --tail=30
          ENDSSH