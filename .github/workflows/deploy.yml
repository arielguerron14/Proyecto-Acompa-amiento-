name: ğŸš€ Deploy Services

on:
  workflow_dispatch:
    inputs:
      instance:
        description: 'Instance to deploy'
        required: true
        default: 'EC2_CORE'
        type: choice
        options:
          - EC2_CORE
          - EC2_DB
          - EC2_API_GATEWAY
          - EC2_FRONTEND
          - EC2_MESSAGING
          - EC2_NOTIFICACIONES
          - EC2_REPORTES
          - EC2_MONITORING
      
      services:
        description: 'Services to deploy (comma-separated or all)'
        required: false
        default: 'all'
        type: string
      
      rebuild_docker:
        description: 'Rebuild Docker images'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      
      environment:
        description: 'Environment'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AWS_REGION: us-east-1
  DOCKER_BUILDKIT: 1

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.instance }}
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
      # 1. Checkout
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # 2. Setup Node.js
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      # 3. Get SSH Key
      - name: ğŸ”‘ Get SSH Private Key
        id: ssh-key
        run: |
          SSH_KEY="${{ secrets.SSH_PRIVATE_KEY }}"
          echo "::add-mask::$SSH_KEY"
          echo "key<<EOF" >> $GITHUB_OUTPUT
          echo "$SSH_KEY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      # 4. Get Instance IP
      - name: ğŸŒ Get Instance IP
        id: get-ip
        run: |
          INSTANCE_NAME="${{ github.event.inputs.instance }}"
          
          case "$INSTANCE_NAME" in
            EC2_CORE)
              IP="13.216.12.61"
              ;;
            EC2_DB)
              IP="44.192.114.31"
              ;;
            EC2_API_GATEWAY)
              IP="52.71.188.181"
              ;;
            EC2_FRONTEND)
              IP="107.21.124.81"
              ;;
            EC2_NOTIFICACIONES)
              IP="44.192.74.171"
              ;;
            EC2_MESSAGING)
              IP="18.205.26.214"
              ;;
            EC2_REPORTES)
              IP="54.175.62.79"
              ;;
            EC2_MONITORING)
              IP="54.198.235.28"
              ;;
            *)
              IP="0.0.0.0"
              ;;
          esac
          
          echo "ip=$IP" >> $GITHUB_OUTPUT
          echo "Instance: $INSTANCE_NAME at $IP"
      
      # 5. Setup SSH
      - name: ğŸ”§ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ steps.ssh-key.outputs.key }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ steps.get-ip.outputs.ip }} >> ~/.ssh/known_hosts 2>/dev/null || true
      
      # 6. Build Docker Images (if enabled)
      - name: ğŸ³ Build Docker Images
        if: github.event.inputs.rebuild_docker == 'true'
        run: |
          INSTANCE="${{ github.event.inputs.instance }}"
          
          echo "Building Docker images for $INSTANCE..."
          
          # Map instance to services
          case "$INSTANCE" in
            EC2_CORE)
              DOCKER_SERVICES="api-gateway micro-auth micro-estudiantes micro-maestros"
              ;;
            EC2_API_GATEWAY)
              DOCKER_SERVICES="api-gateway"
              ;;
            EC2_FRONTEND)
              DOCKER_SERVICES="frontend-web"
              ;;
            EC2_MESSAGING)
              DOCKER_SERVICES="messaging"
              ;;
            EC2_NOTIFICACIONES)
              DOCKER_SERVICES="micro-notificaciones"
              ;;
            EC2_REPORTES)
              DOCKER_SERVICES="micro-reportes-estudiantes micro-reportes-maestros"
              ;;
            *)
              DOCKER_SERVICES=""
              ;;
          esac
          
          echo "Services to build: $DOCKER_SERVICES"
          
          for SERVICE in $DOCKER_SERVICES; do
            if [ -d "$SERVICE" ] && [ -f "$SERVICE/Dockerfile" ]; then
              echo "âœ“ Building: $SERVICE"
              docker build -t $SERVICE:latest $SERVICE
              docker save $SERVICE:latest -o /tmp/$SERVICE.tar
              ls -lh /tmp/$SERVICE.tar
            else
              echo "âš  Skipping $SERVICE (not found or no Dockerfile)"
            fi
          done
      
      # 7. Transfer SSH Key and Files
      - name: ğŸ“¤ Transfer to EC2
        run: |
          IP="${{ steps.get-ip.outputs.ip }}"
          
          echo "Connecting to $IP..."
          
          # Test connection
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 ec2-user@$IP "echo 'SSH connection successful' && uname -a"
          
          # Transfer Docker images if they exist
          for FILE in /tmp/*.tar; do
            if [ -f "$FILE" ]; then
              echo "Transferring $(basename $FILE)..."
              scp -o StrictHostKeyChecking=no -o ConnectTimeout=30 "$FILE" ec2-user@$IP:/tmp/
            fi
          done
      
      # 8. Deploy Services
      - name: ğŸš€ Deploy Services
        run: |
          IP="${{ steps.get-ip.outputs.ip }}"
          INSTANCE="${{ github.event.inputs.instance }}"
          
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 ec2-user@$IP << 'ENDSSH'
          set -e
          
          echo "Deploying on $INSTANCE..."
          
          # Load Docker images
          for FILE in /tmp/*.tar; do
            if [ -f "$FILE" ]; then
              echo "Loading $(basename $FILE)..."
              docker load -i "$FILE"
              rm "$FILE"
            fi
          done
          
          # Go to app directory
          if [ -d ~/app ]; then
            cd ~/app
          elif [ -d ~/proyecto ]; then
            cd ~/proyecto
          else
            echo "App directory not found"
            exit 1
          fi
          
          # Start services with docker-compose
          if [ -f docker-compose.yml ]; then
            echo "Starting services..."
            docker-compose down 2>/dev/null || true
            docker-compose up -d
            sleep 5
            docker-compose ps
          else
            echo "docker-compose.yml not found"
            exit 1
          fi
          
          ENDSSH
      
      # 9. Test Endpoints
      - name: ğŸ§ª Test Endpoints
        id: test
        run: |
          IP="${{ steps.get-ip.outputs.ip }}"
          INSTANCE="${{ github.event.inputs.instance }}"
          
          echo "Testing endpoints on $INSTANCE..."
          
          # Define ports
          case "$INSTANCE" in
            EC2_CORE)
              PORTS="3000 3001 3002 3003"
              ;;
            EC2_API_GATEWAY)
              PORTS="3000"
              ;;
            EC2_FRONTEND)
              PORTS="5500"
              ;;
            *)
              PORTS="8080"
              ;;
          esac
          
          PASSED=0
          FAILED=0
          
          for PORT in $PORTS; do
            if timeout 5 bash -c "echo > /dev/tcp/$IP/$PORT" 2>/dev/null; then
              echo "âœ… Port $PORT is open"
              PASSED=$((PASSED+1))
            else
              echo "âŒ Port $PORT is closed"
              FAILED=$((FAILED+1))
            fi
          done
          
          echo ""
          echo "Results: $PASSED passed, $FAILED failed"
          echo "status=success" >> $GITHUB_OUTPUT
      
      # 10. Check Logs
      - name: ğŸ“‹ Check Logs
        if: always()
        run: |
          IP="${{ steps.get-ip.outputs.ip }}"
          
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 ec2-user@$IP << 'ENDSSH'
          echo "=== Docker Containers ==="
          docker ps -a
          
          echo ""
          echo "=== Recent Logs ==="
          docker-compose logs --tail=20 2>/dev/null || true
          
          echo ""
          echo "=== Disk Usage ==="
          df -h /
          ENDSSH
      
      # 11. Deployment Summary
      - name: ğŸ“Š Deployment Summary
        if: always()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ“Š DEPLOYMENT SUMMARY                                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Instance: ${{ github.event.inputs.instance }}"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Rebuild Docker: ${{ github.event.inputs.rebuild_docker }}"
          echo "Services: ${{ github.event.inputs.services }}"
          echo ""
          echo "Status: ${{ job.status }}"
