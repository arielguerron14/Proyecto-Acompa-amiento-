name: Deploy Reportes Stack to AWS EC2-Reportes

on:
  workflow_dispatch:
    inputs:
      ec2_reportes_private_ip:
        description: 'IP privada de instancia EC2-Reportes (ej: 172.31.69.133)'
        required: true
        type: string
      ec2_db_private_ip:
        description: 'IP privada de instancia EC2-DB (ej: 172.31.79.193)'
        required: true
        type: string

env:
  EC2_REPORTES_SSH_KEY: ${{ secrets.AWS_EC2_DB_SSH_PRIVATE_KEY }}
  EC2_REPORTES_SSH_USER: ubuntu

jobs:
  deploy:
    name: Deploy Reportes Stack
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set EC2 variables
        run: |
          echo "EC2_REPORTES_IP=${{ github.event.inputs.ec2_reportes_private_ip }}" >> $GITHUB_ENV
          echo "EC2_DB_IP=${{ github.event.inputs.ec2_db_private_ip }}" >> $GITHUB_ENV

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/aws-ec2-reportes.pem << 'EOF'
          ${{ env.EC2_REPORTES_SSH_KEY }}
          EOF
          chmod 600 ~/.ssh/aws-ec2-reportes.pem
          cat > ~/.ssh/config << 'SSHCONFIG'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
            LogLevel=QUIET
          SSHCONFIG

      - name: Deploy Reportes Stack via SSH
        run: |
          ssh -i ~/.ssh/aws-ec2-reportes.pem \
            -o ConnectTimeout=10 \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            ubuntu@${{ env.EC2_REPORTES_IP }} << 'SSHEOF'
            
            echo "=== Verificando Docker ==="
            if ! command -v docker &> /dev/null; then
              echo "Docker no encontrado, instalando..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker ubuntu
              echo "Docker instalado correctamente"
            else
              echo "Docker ya estÃ¡ instalado"
              docker --version
            fi
            
            echo "=== Deteniendo contenedores existentes ==="
            docker stop acompanamiento-analytics 2>/dev/null || true
            docker stop acompanamiento-reportes-estudiantes 2>/dev/null || true
            docker stop acompanamiento-reportes-maestros 2>/dev/null || true
            
            echo "=== Removiendo contenedores existentes ==="
            docker rm acompanamiento-analytics 2>/dev/null || true
            docker rm acompanamiento-reportes-estudiantes 2>/dev/null || true
            docker rm acompanamiento-reportes-maestros 2>/dev/null || true
            
            echo "=== Clonando repositorio ==="
            cd /tmp
            rm -rf Proyecto-Acompa-amiento-
            git clone https://github.com/arielguerron14/Proyecto-Acompa-amiento-.git
            cd Proyecto-Acompa-amiento-
            
            echo "=== Construyendo imÃ¡genes Docker ==="
            echo "Construyendo micro-analytics..."
            docker build -t micro-analytics:latest -f micro-analytics/Dockerfile .
            
            echo "Construyendo micro-reportes-estudiantes..."
            docker build -t micro-reportes-estudiantes:latest -f micro-reportes-estudiantes/Dockerfile .
            
            echo "Construyendo micro-reportes-maestros..."
            docker build -t micro-reportes-maestros:latest -f micro-reportes-maestros/Dockerfile .
            
            echo "=== Desplegando micro-analytics ==="
            docker run -d \
              --name acompanamiento-analytics \
              --restart unless-stopped \
              -p 5007:5007 \
              -e NODE_ENV=production \
              -e PORT=5007 \
              -e DB_POSTGRES_HOST=172.31.79.193 \
              -e DB_POSTGRES_USER=postgres \
              -e DB_POSTGRES_PASSWORD=postgres \
              -e DB_POSTGRES_DB=acompanamiento \
              -e DB_MONGO_URI=mongodb://172.31.79.193:27017/acompanamiento \
              -e REDIS_URL=redis://172.31.79.193:6379 \
              micro-analytics:latest
            
            echo "=== Desplegando micro-reportes-estudiantes ==="
            docker run -d \
              --name acompanamiento-reportes-estudiantes \
              --restart unless-stopped \
              -p 5003:5003 \
              -e NODE_ENV=production \
              -e PORT=5003 \
              -e DB_POSTGRES_HOST=172.31.79.193 \
              -e DB_POSTGRES_USER=postgres \
              -e DB_POSTGRES_PASSWORD=postgres \
              -e DB_POSTGRES_DB=acompanamiento \
              -e DB_MONGO_URI=mongodb://172.31.79.193:27017/acompanamiento \
              -e REDIS_URL=redis://172.31.79.193:6379 \
              micro-reportes-estudiantes:latest
            
            echo "=== Desplegando micro-reportes-maestros ==="
            docker run -d \
              --name acompanamiento-reportes-maestros \
              --restart unless-stopped \
              -p 5004:5004 \
              -e NODE_ENV=production \
              -e PORT=5004 \
              -e DB_POSTGRES_HOST=172.31.79.193 \
              -e DB_POSTGRES_USER=postgres \
              -e DB_POSTGRES_PASSWORD=postgres \
              -e DB_POSTGRES_DB=acompanamiento \
              -e DB_MONGO_URI=mongodb://172.31.79.193:27017/acompanamiento \
              -e REDIS_URL=redis://172.31.79.193:6379 \
              micro-reportes-maestros:latest
            
            echo "=== Estado de contenedores ==="
            docker ps
            
            echo "=== Logs de micro-analytics ==="
            docker logs --tail=30 acompanamiento-analytics
            
            echo "=== Logs de micro-reportes-estudiantes ==="
            docker logs --tail=30 acompanamiento-reportes-estudiantes
            
            echo "=== Logs de micro-reportes-maestros ==="
            docker logs --tail=30 acompanamiento-reportes-maestros
            
            echo "=== Verificando conectividad a bases de datos ==="
            echo "Intentando conexiÃ³n a PostgreSQL (172.31.79.193:5432)..."
            timeout 5 bash -c 'cat < /dev/null > /dev/tcp/172.31.79.193/5432' 2>/dev/null && echo "âœ“ PostgreSQL accesible" || echo "âš  PostgreSQL no accesible"
            
            echo "Intentando conexiÃ³n a MongoDB (172.31.79.193:27017)..."
            timeout 5 bash -c 'cat < /dev/null > /dev/tcp/172.31.79.193/27017' 2>/dev/null && echo "âœ“ MongoDB accesible" || echo "âš  MongoDB no accesible"
            
            echo "Intentando conexiÃ³n a Redis (172.31.79.193:6379)..."
            timeout 5 bash -c 'cat < /dev/null > /dev/tcp/172.31.79.193/6379' 2>/dev/null && echo "âœ“ Redis accesible" || echo "âš  Redis no accesible"
            
            echo "=== Despliegue del stack de reportes completado ==="
            echo ""
            echo "ðŸŽ¯ Servicios disponibles:"
            echo "  - Analytics: localhost:5007"
            echo "  - Reportes Estudiantes: localhost:5003"
            echo "  - Reportes Maestros: localhost:5004"
          SSHEOF

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/aws-ec2-reportes.pem
