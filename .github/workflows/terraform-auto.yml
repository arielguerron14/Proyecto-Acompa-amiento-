name: Terraform Auto (Inventory + Plan)

on:
  push:
    branches: [main]
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-auto.yml'
  workflow_dispatch:  # TambiÃ©n permite disparo manual

jobs:
  inventory:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Create output dir
        run: mkdir -p artifact

      - name: Caller identity
        run: aws sts get-caller-identity --output json > artifact/caller_identity.json

      - name: Describe EC2 instances
        run: aws ec2 describe-instances --region us-east-1 --output json > artifact/ec2_instances.json || true

      - name: Describe VPCs
        run: aws ec2 describe-vpcs --region us-east-1 --output json > artifact/vpcs.json || true

      - name: List S3 buckets
        run: aws s3api list-buckets --output json > artifact/s3_buckets.json || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aws-inventory
          path: artifact

  plan:
    runs-on: ubuntu-latest
    needs: inventory
    environment: staging
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Download inventory artifact
        uses: actions/download-artifact@v4
        with:
          name: aws-inventory
          path: artifact

      - uses: hashicorp/setup-terraform@v3

      - name: Detect VPC, Subnet, keypair, and AMI
        run: |
          # Try to read inventory artifact
          if [ -f artifact/vpcs.json ]; then
            VPC_ID=$(jq -r '.Vpcs[] | select(.IsDefault==true) | .VpcId' artifact/vpcs.json || true)
          fi
          if [ -z "$VPC_ID" ] || [ "$VPC_ID" = "null" ]; then
            VPC_ID=$(aws ec2 describe-vpcs --filters Name=is-default,Values=true --query 'Vpcs[0].VpcId' --output text || true)
          fi
          echo "Found VPC: $VPC_ID"
          
          SUBNET_ID=$(aws ec2 describe-subnets --filters Name=vpc-id,Values=$VPC_ID Name=availability-zone,Values=us-east-1f --query 'Subnets[0].SubnetId' --output text || true)
          if [ -z "$SUBNET_ID" ] || [ "$SUBNET_ID" = "None" ]; then
            SUBNET_ID=$(aws ec2 describe-subnets --filters Name=vpc-id,Values=$VPC_ID --query 'Subnets[0].SubnetId' --output text || true)
          fi
          echo "Found Subnet: $SUBNET_ID"
          
          KEY_NAME=$(aws ec2 describe-key-pairs --query 'KeyPairs[0].KeyName' --output text || true)
          echo "Found KeyPair: $KEY_NAME"
          
          # Lookup latest Ubuntu 24.04 AMI
          AMI_ID=$(aws ec2 describe-images --owners 099720109477 --filters "Name=name,Values=ubuntu/images/hvm-ssd/ubuntu-noble-24.04-amd64-server-*" --region us-east-1 --query 'sort_by(Images, &CreationDate)[-1].ImageId' --output text || true)
          if [ -z "$AMI_ID" ] || [ "$AMI_ID" = "None" ]; then
            AMI_ID=$(aws ec2 describe-images --owners 099720109477 --filters "Name=name,Values=ubuntu/images/hvm-ssd/ubuntu-*-amd64-server-*" --region us-east-1 --query 'sort_by(Images, &CreationDate)[-1].ImageId' --output text || true)
          fi
          echo "Found Ubuntu AMI: $AMI_ID"
          
          echo "TF_VAR_existing_vpc_id=$VPC_ID" >> $GITHUB_ENV
          echo "TF_VAR_subnet_id=$SUBNET_ID" >> $GITHUB_ENV
          echo "TF_VAR_ssh_key_name=$KEY_NAME" >> $GITHUB_ENV
          echo "TF_VAR_azs=[\"us-east-1f\"]" >> $GITHUB_ENV
          echo "TF_VAR_instance_type=t3.small" >> $GITHUB_ENV
          echo "TF_VAR_create_instances=true" >> $GITHUB_ENV
          echo "TF_VAR_create_security_group=true" >> $GITHUB_ENV
          echo "TF_VAR_ami_id=$AMI_ID" >> $GITHUB_ENV
          echo "TF_VAR_eip_instances=[\"EC-Bastion\",\"EC2-Frontend\",\"EC2-API-Gateway\",\"EC2-Reportes\",\"EC2-Monitoring\"]" >> $GITHUB_ENV

      - name: Terraform Init
        run: cd terraform && terraform init

      - name: Terraform Plan
        run: cd terraform && terraform plan -out=tfplan

      - name: Save plan output
        run: |
          cd terraform
          terraform show tfplan > ../tfplan.txt || true

      - name: Upload plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-output
          path: tfplan.txt
          retention-days: 7

      - name: Comment Plan in Summary
        run: |
          echo "## ðŸ“‹ Terraform Plan Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** staging" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** us-east-1" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Plan saved to artifacts" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ To apply: Use workflow_dispatch with apply=true" >> $GITHUB_STEP_SUMMARY
