name: Deploy Core Services (Auth + Estudiantes + Maestros)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'prod'

env:
  AWS_REGION: us-east-1
  REGISTRY: docker.io

permissions:
  id-token: write
  contents: read

jobs:
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build api-gateway
        run: |
          echo "ğŸ“¦ Building api-gateway..."
          docker build -f api-gateway/Dockerfile -t api-gateway:latest .

      - name: ğŸ—ï¸ Build micro-auth
        run: |
          echo "ğŸ“¦ Building micro-auth..."
          docker build -f micro-auth/Dockerfile -t micro-auth:latest .

      - name: ğŸ—ï¸ Build micro-estudiantes
        run: |
          echo "ğŸ“¦ Building micro-estudiantes..."
          docker build -f micro-estudiantes/Dockerfile -t micro-estudiantes:latest .

      - name: ğŸ—ï¸ Build micro-maestros
        run: |
          echo "ğŸ“¦ Building micro-maestros..."
          docker build -f micro-maestros/Dockerfile -t micro-maestros:latest .

      - name: ğŸ’¾ Save Docker Images
        run: |
          echo "ğŸ’¾ Saving images..."
          docker save api-gateway:latest > /tmp/api-gateway.tar
          docker save micro-auth:latest > /tmp/micro-auth.tar
          docker save micro-estudiantes:latest > /tmp/micro-estudiantes.tar
          docker save micro-maestros:latest > /tmp/micro-maestros.tar
          
          echo "âœ… Images saved:"
          ls -lh /tmp/*.tar

      - name: ğŸ“¤ Upload Images
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: /tmp/*.tar
          retention-days: 1

  deploy:
    name: Deploy to EC2_CORE
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ“¥ Download Images
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: /tmp

      - name: ğŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          aws secretsmanager get-secret-value \
            --secret-id "AWS_EC2_SSH_PRIVATE_KEY" \
            --query 'SecretString' \
            --output text > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: ğŸ” Get EC2_CORE IP
        id: get-ip
        run: |
          pwsh -Command @"
          `$config = Get-Content infrastructure.config.js -Raw | ConvertFrom-Json
          `$publicIp = `$config.PUBLIC['EC2_CORE_IP']
          echo "ip=`$publicIp" | Out-File -FilePath `$env:GITHUB_OUTPUT -Append
          Write-Host "âœ… EC2_CORE IP: `$publicIp"
          "@

      - name: ğŸ“¤ Transfer Images to EC2
        run: |
          echo "ğŸ“¤ Transferring Docker images..."
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no /tmp/*.tar ec2-user@${{ steps.get-ip.outputs.ip }}:/tmp/

      - name: ğŸ“¤ Transfer .env File
        run: |
          echo "ğŸ“ Transferring .env.prod.core..."
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no .env.prod.core ec2-user@${{ steps.get-ip.outputs.ip }}:~/.env

      - name: ğŸš€ Deploy Services on EC2
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ec2-user@${{ steps.get-ip.outputs.ip }} << 'EOF'
          set -e
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸš€ DEPLOYING CORE SERVICES ON EC2_CORE                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Load images
          echo "ğŸ“¥ Loading Docker images..."
          docker load < /tmp/api-gateway.tar
          docker load < /tmp/micro-auth.tar
          docker load < /tmp/micro-estudiantes.tar
          docker load < /tmp/micro-maestros.tar
          
          echo "âœ… Images loaded:"
          docker images | grep -E "api-gateway|micro-auth|micro-estudiantes|micro-maestros"
          
          # Create directories
          echo ""
          echo "ğŸ“ Creating service directories..."
          mkdir -p ~/EC2_CORE ~/EC2_AUTH ~/EC2_ESTUDIANTES ~/EC2_MAESTROS
          
          # Copy .env
          cp ~/.env ~/EC2_CORE/.env
          
          # Stop existing containers if any
          echo ""
          echo "ğŸ›‘ Stopping existing containers..."
          docker stop ec2-core ec2-auth ec2-estudiantes ec2-maestros 2>/dev/null || true
          docker rm ec2-core ec2-auth ec2-estudiantes ec2-maestros 2>/dev/null || true
          
          # Start containers
          echo ""
          echo "ğŸš€ Starting services..."
          
          docker run -d \
            --name ec2-core \
            --env-file ~/EC2_CORE/.env \
            -p 3000:3000 \
            api-gateway:latest
          
          docker run -d \
            --name ec2-auth \
            --env-file ~/EC2_CORE/.env \
            -p 3001:3001 \
            micro-auth:latest
          
          docker run -d \
            --name ec2-estudiantes \
            --env-file ~/EC2_CORE/.env \
            -p 3002:3002 \
            micro-estudiantes:latest
          
          docker run -d \
            --name ec2-maestros \
            --env-file ~/EC2_CORE/.env \
            -p 3003:3003 \
            micro-maestros:latest
          
          echo ""
          echo "âœ… Containers started:"
          docker ps --filter "name=ec2-" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          EOF

      - name: â±ï¸ Wait for Services to Initialize
        run: sleep 10

      - name: ğŸ“Š Check Logs
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ec2-user@${{ steps.get-ip.outputs.ip }} << 'EOF'
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ“Š SERVICE LOGS                                          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          echo ""
          echo "ğŸ“„ api-gateway logs (last 20 lines):"
          docker logs --tail 20 ec2-core
          
          echo ""
          echo "ğŸ“„ micro-auth logs (last 20 lines):"
          docker logs --tail 20 ec2-auth
          
          echo ""
          echo "ğŸ“„ micro-estudiantes logs (last 20 lines):"
          docker logs --tail 20 ec2-estudiantes
          
          echo ""
          echo "ğŸ“„ micro-maestros logs (last 20 lines):"
          docker logs --tail 20 ec2-maestros
          
          EOF

      - name: ğŸŒ Test Endpoints
        run: |
          pwsh -Command @"
          `$ip = '${{ steps.get-ip.outputs.ip }}'
          `$endpoints = @(
              @{ port = 3000; name = 'api-gateway'; path = '/health' },
              @{ port = 3001; name = 'micro-auth'; path = '/health' },
              @{ port = 3002; name = 'micro-estudiantes'; path = '/health' },
              @{ port = 3003; name = 'micro-maestros'; path = '/health' }
          )
          
          Write-Host ""
          Write-Host "`e[36mâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—`e[0m"
          Write-Host "`e[36mâ•‘  ğŸŒ TESTING ENDPOINTS                                     â•‘`e[0m"
          Write-Host "`e[36mâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`e[0m"
          Write-Host ""
          
          `$passed = 0
          `$failed = 0
          
          foreach (`$endpoint in `$endpoints) {
              `$url = "http://`$ip`:$(`$endpoint.port)`$(`$endpoint.path)"
              Write-Host "`e[36mğŸ” Testing `$(`$endpoint.name):`e[0m"
              Write-Host "   URL: `$url"
              
              try {
                  `$response = Invoke-WebRequest -Uri `$url -TimeoutSec 5 -ErrorAction SilentlyContinue
                  if (`$response.StatusCode -eq 200) {
                      Write-Host "`e[32m   âœ… Status: 200 OK`e[0m"
                      `$passed++
                  } else {
                      Write-Host "`e[33m   âš ï¸  Status: `$(`$response.StatusCode)`e[0m"
                      `$failed++
                  }
              } catch {
                  Write-Host "`e[31m   âŒ Failed: `$_`e[0m"
                  `$failed++
              }
              Write-Host ""
          }
          
          Write-Host "`e[36mğŸ“Š Results: `e[32m`$passed passed`e[0m, `e[31m`$failed failed`e[0m"
          Write-Host ""
          
          if (`$failed -gt 0) {
              exit 1
          }
          "@

      - name: âœ… Deployment Summary
        if: success()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âœ… DEPLOYMENT SUCCESSFUL                                 â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Services deployed on EC2_CORE:"
          echo "  â€¢ api-gateway:3000 - âœ… Running"
          echo "  â€¢ micro-auth:3001 - âœ… Running"
          echo "  â€¢ micro-estudiantes:3002 - âœ… Running"
          echo "  â€¢ micro-maestros:3003 - âœ… Running"
          echo ""
          echo "ğŸ“Š All endpoints responding correctly"
          echo "ğŸ‰ Ready to work with other instances"

      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âŒ DEPLOYMENT FAILED                                      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Check the logs above for details"
          exit 1
