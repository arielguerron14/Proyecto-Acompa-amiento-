name: ğŸš€ Deploy via SSH (Sequential Jobs)

on:
  workflow_dispatch:
    inputs:
      rebuild_images:
        description: 'Rebuild Docker images from source'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  AWS_REGION: us-east-1
  DOCKER_REGISTRY: docker.io

jobs:
  # =========================================================================
  # LOAD INSTANCE IPS FROM CONFIG
  # =========================================================================
  load-config:
    name: ğŸ“‹ Load Configuration
    runs-on: ubuntu-latest
    outputs:
      bastion-public: ${{ steps.load.outputs.bastion_public }}
      bastion-private: ${{ steps.load.outputs.bastion_private }}
      api-gateway-public: ${{ steps.load.outputs.api_gateway_public }}
      api-gateway-private: ${{ steps.load.outputs.api_gateway_private }}
      core-public: ${{ steps.load.outputs.core_public }}
      core-private: ${{ steps.load.outputs.core_private }}
      reportes-public: ${{ steps.load.outputs.reportes_public }}
      reportes-private: ${{ steps.load.outputs.reportes_private }}
      notificaciones-public: ${{ steps.load.outputs.notificaciones_public }}
      notificaciones-private: ${{ steps.load.outputs.notificaciones_private }}
      messaging-public: ${{ steps.load.outputs.messaging_public }}
      messaging-private: ${{ steps.load.outputs.messaging_private }}
      db-public: ${{ steps.load.outputs.db_public }}
      db-private: ${{ steps.load.outputs.db_private }}
      analytics-public: ${{ steps.load.outputs.analytics_public }}
      analytics-private: ${{ steps.load.outputs.analytics_private }}
      monitoring-public: ${{ steps.load.outputs.monitoring_public }}
      monitoring-private: ${{ steps.load.outputs.monitoring_private }}
      frontend-public: ${{ steps.load.outputs.frontend_public }}
      frontend-private: ${{ steps.load.outputs.frontend_private }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Load instance IPs
        id: load
        run: |
          python3 << 'PYTHON'
          import json
          
          with open('config/instance_ips.json', 'r') as f:
              instances = json.load(f)
          
          # Map instance names to output names
          mapping = {
              'EC-Bastion': 'bastion',
              'EC2-API-Gateway': 'api_gateway',
              'EC2-CORE': 'core',
              'EC2-Reportes': 'reportes',
              'EC2-Notificaciones': 'notificaciones',
              'EC2-Messaging': 'messaging',
              'EC2-DB': 'db',
              'EC2-Analytics': 'analytics',
              'EC2-Monitoring': 'monitoring',
              'EC2-Frontend': 'frontend'
          }
          
          for instance_name, output_name in mapping.items():
              if instance_name in instances:
                  public_ip = instances[instance_name]['PublicIpAddress']
                  private_ip = instances[instance_name]['PrivateIpAddress']
                  
                  print(f"::set-output name={output_name}_public::{public_ip}")
                  print(f"::set-output name={output_name}_private::{private_ip}")
                  print(f"âœ… {instance_name}: {public_ip}")
              else:
                  print(f"âš ï¸  {instance_name} not found in config")
          PYTHON

  # =========================================================================
  # 1. DEPLOY EC2-MESSAGING (Kafka, Zookeeper, RabbitMQ)
  # =========================================================================
  deploy-messaging:
    name: "â±ï¸  1. Deploy EC2-Messaging"
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.load-config.outputs.messaging-public }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy Kafka, Zookeeper, RabbitMQ
        run: |
          ssh -i ~/.ssh/id_rsa ec2-user@${{ needs.load-config.outputs.messaging-public }} << 'DEPLOY'
          set -e
          
          echo "================================"
          echo "ğŸ“¦ EC2-Messaging Deployment"
          echo "================================"
          
          # Stop old services
          docker stop zookeeper kafka rabbitmq 2>/dev/null || true
          docker rm zookeeper kafka rabbitmq 2>/dev/null || true
          docker network create msg-net 2>/dev/null || true
          
          # Build or pull images
          if [ "${{ github.event.inputs.rebuild_images }}" = "true" ]; then
            echo "ğŸ”¨ Building images from source..."
            docker build -t proyecto-zookeeper:1.0 . || docker pull confluentinc/cp-zookeeper:7.0.0
            docker build -t proyecto-kafka:1.0 . || docker pull confluentinc/cp-kafka:7.0.0
            docker build -t proyecto-rabbitmq:1.0 . || docker pull rabbitmq:3.12-management
          else
            echo "ğŸ“¥ Pulling pre-built images..."
            docker pull proyecto-zookeeper:1.0 2>/dev/null || docker pull confluentinc/cp-zookeeper:7.0.0
            docker pull proyecto-kafka:1.0 2>/dev/null || docker pull confluentinc/cp-kafka:7.0.0
            docker pull proyecto-rabbitmq:1.0 2>/dev/null || docker pull rabbitmq:3.12-management
          fi
          
          # Start services
          docker run -d --name zookeeper --network msg-net -p 2181:2181 \
            -e ZOO_CFG_SERVER_1=zookeeper:2888:3888 \
            proyecto-zookeeper:1.0 || true
          
          sleep 5
          
          docker run -d --name kafka --network msg-net -p 9092:9092 \
            -e KAFKA_BROKER_ID=1 \
            -e KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181 \
            -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092 \
            proyecto-kafka:1.0 || true
          
          docker run -d --name rabbitmq --network msg-net -p 5672:5672 -p 15672:15672 \
            -e RABBITMQ_DEFAULT_USER=admin \
            -e RABBITMQ_DEFAULT_PASS=admin \
            proyecto-rabbitmq:1.0 || true
          
          sleep 10
          docker ps -a | grep -E "zookeeper|kafka|rabbitmq"
          
          echo "âœ… EC2-Messaging deployment complete"
          DEPLOY

  # =========================================================================
  # 2. DEPLOY EC2-DB (MongoDB, PostgreSQL, Redis)
  # =========================================================================
  deploy-db:
    name: "ğŸ—„ï¸  2. Deploy EC2-DB"
    needs: [load-config, deploy-messaging]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.load-config.outputs.db-public }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy MongoDB, PostgreSQL, Redis
        run: |
          ssh -i ~/.ssh/id_rsa ec2-user@${{ needs.load-config.outputs.db-public }} << 'DEPLOY'
          set -e
          
          echo "================================"
          echo "ğŸ—„ï¸  EC2-DB Deployment"
          echo "================================"
          
          # Stop old services
          docker stop mongo postgres redis 2>/dev/null || true
          docker rm mongo postgres redis 2>/dev/null || true
          docker volume create mongo_data postgres_data redis_data 2>/dev/null || true
          
          # Pull images
          docker pull mongo:latest
          docker pull postgres:latest
          docker pull redis:latest
          
          # Start services
          docker run -d --name mongo -p 27017:27017 \
            -e MONGO_INITDB_ROOT_USERNAME=admin \
            -e MONGO_INITDB_ROOT_PASSWORD=acompanamiento \
            -v mongo_data:/data/db \
            mongo:latest --auth --bind_ip_all
          
          docker run -d --name postgres -p 5432:5432 \
            -e POSTGRES_USER=admin \
            -e POSTGRES_PASSWORD=acompanamiento \
            -e POSTGRES_DB=acompanamiento \
            -v postgres_data:/var/lib/postgresql/data \
            postgres:latest
          
          docker run -d --name redis -p 6379:6379 \
            -v redis_data:/data \
            redis:latest redis-server --appendonly yes
          
          sleep 15
          docker ps -a | grep -E "mongo|postgres|redis"
          
          echo "âœ… EC2-DB deployment complete"
          DEPLOY

  # =========================================================================
  # 3. DEPLOY EC2-CORE (4 Microservices)
  # =========================================================================
  deploy-core:
    name: "ğŸ³ 3. Deploy EC2-CORE"
    needs: [load-config, deploy-db]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.load-config.outputs.core-public }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy Core Microservices
        env:
          DB_PRIVATE_IP: ${{ needs.load-config.outputs.db-private }}
          DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
        run: |
          ssh -i ~/.ssh/id_rsa ec2-user@${{ needs.load-config.outputs.core-public }} << 'DEPLOY'
          set -e
          
          echo "================================"
          echo "ğŸ³ EC2-CORE Deployment"
          echo "================================"
          
          DB_IP="${{ env.DB_PRIVATE_IP }}"
          DOCKER_USER="${{ env.DOCKER_USER }}"
          
          # Stop old services
          docker stop micro-auth micro-estudiantes micro-maestros micro-core 2>/dev/null || true
          docker rm micro-auth micro-estudiantes micro-maestros micro-core 2>/dev/null || true
          docker network create core-net 2>/dev/null || true
          
          # Services array: (name:port:db_name)
          services=("micro-auth:3000:authdb" "micro-estudiantes:3001:estudiantesdb" "micro-maestros:3002:maestrosdb" "micro-core:3003:coredb")
          
          for service_info in "${services[@]}"; do
            IFS=':' read -r name port db_name <<< "$service_info"
            
            echo "  ğŸ“¦ Deploying $name on port $port..."
            
            if [ "${{ github.event.inputs.rebuild_images }}" = "true" ]; then
              docker build -t $DOCKER_USER/$name:latest . || docker pull $DOCKER_USER/$name:latest
            else
              docker pull $DOCKER_USER/$name:latest
            fi
            
            docker run -d --name $name --network core-net -p $port:$port \
              -e MONGODB_HOST=$DB_IP \
              -e MONGODB_PORT=27017 \
              -e DB_NAME=$db_name \
              $DOCKER_USER/$name:latest
            
            sleep 3
          done
          
          sleep 10
          docker ps -a | grep micro-
          
          echo "âœ… EC2-CORE deployment complete"
          DEPLOY

  # =========================================================================
  # 4. DEPLOY EC2-API-GATEWAY
  # =========================================================================
  deploy-api-gateway:
    name: "ğŸŒ 4. Deploy EC2-API-Gateway"
    needs: [load-config, deploy-core]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.load-config.outputs.api-gateway-public }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy API Gateway
        env:
          CORE_PRIVATE_IP: ${{ needs.load-config.outputs.core-private }}
          DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
        run: |
          ssh -i ~/.ssh/id_rsa ec2-user@${{ needs.load-config.outputs.api-gateway-public }} << 'DEPLOY'
          set -e
          
          echo "================================"
          echo "ğŸŒ EC2-API-Gateway Deployment"
          echo "================================"
          
          CORE_IP="${{ env.CORE_PRIVATE_IP }}"
          DOCKER_USER="${{ env.DOCKER_USER }}"
          
          docker stop api-gateway 2>/dev/null || true
          docker rm api-gateway 2>/dev/null || true
          
          if [ "${{ github.event.inputs.rebuild_images }}" = "true" ]; then
            docker build -t $DOCKER_USER/api-gateway:latest . || docker pull $DOCKER_USER/api-gateway:latest
          else
            docker pull $DOCKER_USER/api-gateway:latest
          fi
          
          docker run -d --name api-gateway -p 8080:8080 \
            -e CORE_HOST=$CORE_IP \
            -e CORE_PORT=3000 \
            $DOCKER_USER/api-gateway:latest
          
          sleep 10
          docker ps -a | grep api-gateway
          
          echo "âœ… EC2-API-Gateway deployment complete"
          DEPLOY

  # =========================================================================
  # 5. DEPLOY EC2-REPORTES (2 Services)
  # =========================================================================
  deploy-reportes:
    name: "ğŸ“„ 5. Deploy EC2-Reportes"
    needs: [load-config, deploy-db]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.load-config.outputs.reportes-public }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy Reports Services
        env:
          DB_PRIVATE_IP: ${{ needs.load-config.outputs.db-private }}
          DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
        run: |
          ssh -i ~/.ssh/id_rsa ec2-user@${{ needs.load-config.outputs.reportes-public }} << 'DEPLOY'
          set -e
          
          echo "================================"
          echo "ğŸ“„ EC2-Reportes Deployment"
          echo "================================"
          
          DB_IP="${{ env.DB_PRIVATE_IP }}"
          DOCKER_USER="${{ env.DOCKER_USER }}"
          
          docker stop micro-reportes-estudiantes micro-reportes-maestros 2>/dev/null || true
          docker rm micro-reportes-estudiantes micro-reportes-maestros 2>/dev/null || true
          
          reports=("micro-reportes-estudiantes:3005:reportes_estudiantes" "micro-reportes-maestros:3006:reportes_maestros")
          
          for report_info in "${reports[@]}"; do
            IFS=':' read -r name port db_name <<< "$report_info"
            
            echo "  ğŸ“¦ Deploying $name on port $port..."
            
            if [ "${{ github.event.inputs.rebuild_images }}" = "true" ]; then
              docker build -t $DOCKER_USER/$name:latest . || docker pull $DOCKER_USER/$name:latest
            else
              docker pull $DOCKER_USER/$name:latest
            fi
            
            docker run -d --name $name -p $port:$port \
              -e MONGODB_HOST=$DB_IP \
              -e MONGODB_PORT=27017 \
              -e DB_NAME=$db_name \
              $DOCKER_USER/$name:latest
            
            sleep 3
          done
          
          sleep 10
          docker ps -a | grep reportes
          
          echo "âœ… EC2-Reportes deployment complete"
          DEPLOY

  # =========================================================================
  # 6. DEPLOY EC2-NOTIFICACIONES
  # =========================================================================
  deploy-notificaciones:
    name: "ğŸ”” 6. Deploy EC2-Notificaciones"
    needs: [load-config, deploy-db, deploy-messaging]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.load-config.outputs.notificaciones-public }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy Notifications
        env:
          DB_PRIVATE_IP: ${{ needs.load-config.outputs.db-private }}
          MESSAGING_PRIVATE_IP: ${{ needs.load-config.outputs.messaging-private }}
          DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
        run: |
          ssh -i ~/.ssh/id_rsa ec2-user@${{ needs.load-config.outputs.notificaciones-public }} << 'DEPLOY'
          set -e
          
          echo "================================"
          echo "ğŸ”” EC2-Notificaciones Deployment"
          echo "================================"
          
          DB_IP="${{ env.DB_PRIVATE_IP }}"
          MSG_IP="${{ env.MESSAGING_PRIVATE_IP }}"
          DOCKER_USER="${{ env.DOCKER_USER }}"
          
          docker stop micro-notificaciones 2>/dev/null || true
          docker rm micro-notificaciones 2>/dev/null || true
          
          if [ "${{ github.event.inputs.rebuild_images }}" = "true" ]; then
            docker build -t $DOCKER_USER/micro-notificaciones:latest . || docker pull $DOCKER_USER/micro-notificaciones:latest
          else
            docker pull $DOCKER_USER/micro-notificaciones:latest
          fi
          
          docker run -d --name micro-notificaciones -p 5005:5005 \
            -e MONGODB_HOST=$DB_IP \
            -e MONGODB_PORT=27017 \
            -e MQTT_HOST=$MSG_IP \
            -e MQTT_PORT=1883 \
            $DOCKER_USER/micro-notificaciones:latest
          
          sleep 10
          docker ps -a | grep notificaciones
          
          echo "âœ… EC2-Notificaciones deployment complete"
          DEPLOY

  # =========================================================================
  # 7. DEPLOY EC2-ANALYTICS
  # =========================================================================
  deploy-analytics:
    name: "ğŸ“Š 7. Deploy EC2-Analytics"
    needs: [load-config, deploy-db]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.load-config.outputs.analytics-public }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy Analytics
        env:
          DB_PRIVATE_IP: ${{ needs.load-config.outputs.db-private }}
          DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
        run: |
          ssh -i ~/.ssh/id_rsa ec2-user@${{ needs.load-config.outputs.analytics-public }} << 'DEPLOY'
          set -e
          
          echo "================================"
          echo "ğŸ“Š EC2-Analytics Deployment"
          echo "================================"
          
          DB_IP="${{ env.DB_PRIVATE_IP }}"
          DOCKER_USER="${{ env.DOCKER_USER }}"
          
          docker stop micro-analytics 2>/dev/null || true
          docker rm micro-analytics 2>/dev/null || true
          
          if [ "${{ github.event.inputs.rebuild_images }}" = "true" ]; then
            docker build -t $DOCKER_USER/micro-analytics:latest . || docker pull $DOCKER_USER/micro-analytics:latest
          else
            docker pull $DOCKER_USER/micro-analytics:latest
          fi
          
          docker run -d --name micro-analytics -p 3004:3004 \
            -e MONGODB_HOST=$DB_IP \
            -e MONGODB_PORT=27017 \
            $DOCKER_USER/micro-analytics:latest
          
          sleep 10
          docker ps -a | grep analytics
          
          echo "âœ… EC2-Analytics deployment complete"
          DEPLOY

  # =========================================================================
  # 8. DEPLOY EC2-MONITORING (Prometheus, Grafana)
  # =========================================================================
  deploy-monitoring:
    name: "ğŸ“ˆ 8. Deploy EC2-Monitoring"
    needs: [load-config, deploy-core]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.load-config.outputs.monitoring-public }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy Monitoring Stack
        run: |
          ssh -i ~/.ssh/id_rsa ec2-user@${{ needs.load-config.outputs.monitoring-public }} << 'DEPLOY'
          set -e
          
          echo "================================"
          echo "ğŸ“ˆ EC2-Monitoring Deployment"
          echo "================================"
          
          docker stop prometheus grafana 2>/dev/null || true
          docker rm prometheus grafana 2>/dev/null || true
          docker volume create prometheus_data grafana_data 2>/dev/null || true
          
          docker pull prom/prometheus:latest
          docker pull grafana/grafana:latest
          
          docker run -d --name prometheus -p 9090:9090 \
            -v prometheus_data:/prometheus \
            -v /etc/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml \
            prom/prometheus:latest --config.file=/etc/prometheus/prometheus.yml
          
          docker run -d --name grafana -p 3000:3000 \
            -e GF_SECURITY_ADMIN_PASSWORD=admin \
            -v grafana_data:/var/lib/grafana \
            grafana/grafana:latest
          
          sleep 10
          docker ps -a | grep -E "prometheus|grafana"
          
          echo "âœ… EC2-Monitoring deployment complete"
          DEPLOY

  # =========================================================================
  # 9. DEPLOY EC2-FRONTEND
  # =========================================================================
  deploy-frontend:
    name: "ğŸ¨ 9. Deploy EC2-Frontend"
    needs: [load-config, deploy-api-gateway]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.load-config.outputs.frontend-public }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy Frontend
        env:
          API_PRIVATE_IP: ${{ needs.load-config.outputs.api-gateway-private }}
          DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
        run: |
          ssh -i ~/.ssh/id_rsa ec2-user@${{ needs.load-config.outputs.frontend-public }} << 'DEPLOY'
          set -e
          
          echo "================================"
          echo "ğŸ¨ EC2-Frontend Deployment"
          echo "================================"
          
          API_IP="${{ env.API_PRIVATE_IP }}"
          DOCKER_USER="${{ env.DOCKER_USER }}"
          
          docker stop frontend-web 2>/dev/null || true
          docker rm frontend-web 2>/dev/null || true
          
          if [ "${{ github.event.inputs.rebuild_images }}" = "true" ]; then
            docker build -t $DOCKER_USER/frontend-web:latest . || docker pull $DOCKER_USER/frontend-web:latest
          else
            docker pull $DOCKER_USER/frontend-web:latest
          fi
          
          docker run -d --name frontend-web -p 5500:5500 \
            -e API_GATEWAY_HOST=$API_IP \
            -e API_GATEWAY_PORT=8080 \
            $DOCKER_USER/frontend-web:latest
          
          sleep 10
          docker ps -a | grep frontend
          
          echo "âœ… EC2-Frontend deployment complete"
          DEPLOY

  # =========================================================================
  # 10. DEPLOY EC-BASTION (Final Step)
  # =========================================================================
  deploy-bastion:
    name: "ğŸ›¡ï¸  10. Deploy EC-Bastion"
    needs: [load-config, deploy-frontend]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.load-config.outputs.bastion-public }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy Bastion Host
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
        run: |
          ssh -i ~/.ssh/id_rsa ec2-user@${{ needs.load-config.outputs.bastion-public }} << 'DEPLOY'
          set -e
          
          echo "================================"
          echo "ğŸ›¡ï¸  EC-Bastion Deployment"
          echo "================================"
          
          DOCKER_USER="${{ env.DOCKER_USER }}"
          
          docker stop bastion-host 2>/dev/null || true
          docker rm bastion-host 2>/dev/null || true
          
          if [ "${{ github.event.inputs.rebuild_images }}" = "true" ]; then
            docker build -t $DOCKER_USER/bastion-host:latest . || docker pull $DOCKER_USER/bastion-host:latest
          else
            docker pull $DOCKER_USER/bastion-host:latest
          fi
          
          docker run -d --name bastion-host -p 22:22 \
            $DOCKER_USER/bastion-host:latest
          
          sleep 5
          docker ps -a | grep bastion
          
          echo "âœ… EC-Bastion deployment complete"
          DEPLOY

  # =========================================================================
  # FINAL VERIFICATION & SUMMARY
  # =========================================================================
  verification:
    name: "âœ… Final Verification"
    needs: [load-config, deploy-bastion]
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Print deployment summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                                    â•‘"
          echo "â•‘    âœ… DEPLOYMENT COMPLETE - ALL 10 INSTANCES DEPLOYED!            â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š DEPLOYED SERVICES:"
          echo "   âœ… EC-Bastion:           bastion-host:latest"
          echo "   âœ… EC2-Messaging:        zookeeper:1.0, kafka:1.0, rabbitmq:1.0"
          echo "   âœ… EC2-DB:               mongo:latest, postgres:latest, redis:latest"
          echo "   âœ… EC2-CORE:             micro-auth, micro-estudiantes, micro-maestros, micro-core"
          echo "   âœ… EC2-API-Gateway:      api-gateway:latest"
          echo "   âœ… EC2-Reportes:         micro-reportes-estudiantes, micro-reportes-maestros"
          echo "   âœ… EC2-Notificaciones:   micro-notificaciones:latest"
          echo "   âœ… EC2-Analytics:        micro-analytics:latest"
          echo "   âœ… EC2-Monitoring:       prometheus:latest, grafana:latest"
          echo "   âœ… EC2-Frontend:         frontend-web:latest"
          echo ""
          echo "ğŸ“ SERVICE URLs:"
          echo "   ğŸ¨ Frontend:      http://${{ needs.load-config.outputs.frontend-public }}:5500"
          echo "   ğŸŒ API Gateway:   http://${{ needs.load-config.outputs.api-gateway-public }}:8080"
          echo "   ğŸ“ˆ Grafana:       http://${{ needs.load-config.outputs.monitoring-public }}:3000 (admin/admin)"
          echo "   ğŸ“Š Prometheus:    http://${{ needs.load-config.outputs.monitoring-public }}:9090"
          echo ""
          echo "â±ï¸  Total deployment time: ~30 minutes (sequential execution)"
          echo ""
