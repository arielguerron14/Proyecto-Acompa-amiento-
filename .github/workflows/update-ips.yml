name: Update AWS Instance IPs

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  # Cada hora

jobs:
  update-ips:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Fetch and update instance IPs
        run: |
          echo "ğŸ”„ Fetching EC2 instances from AWS..."
          
          # Obtener todas las instancias en ejecuciÃ³n
          aws ec2 describe-instances \
            --filters "Name=instance-state-name,Values=running" \
            --query 'Reservations[*].Instances[*].[Tags[?Key==`Name`].Value|[0],InstanceId,PublicIpAddress,PrivateIpAddress]' \
            --output text --region us-east-1 > instances.txt
          
          cat instances.txt
          
          # Actualizar config/instance_ips.json
          echo "ğŸ“ Updating config/instance_ips.json..."
          python3 << 'EOF'
          import json
          import subprocess
          import sys
          
          # Leer instancias de AWS
          result = subprocess.run(['aws', 'ec2', 'describe-instances', 
                                  '--filters', 'Name=instance-state-name,Values=running',
                                  '--query', 'Reservations[*].Instances[*]',
                                  '--region', 'us-east-1'], 
                                 capture_output=True, text=True)
          data = json.loads(result.stdout)
          
          instances = {}
          for reservation in data:
              for inst in reservation:
                  name = None
                  if inst.get('Tags'):
                      for tag in inst['Tags']:
                          if tag['Key'] == 'Name':
                              name = tag['Value']
                              break
                  
                  if name:
                      instances[name] = {
                          'InstanceId': inst['InstanceId'],
                          'Name': name,
                          'PublicIpAddress': inst.get('PublicIpAddress', 'N/A'),
                          'PrivateIpAddress': inst.get('PrivateIpAddress', 'N/A'),
                          'Type': inst.get('InstanceType', 'unknown')
                      }
          
          # Guardar en config/instance_ips.json
          with open('config/instance_ips.json', 'w') as f:
              json.dump(instances, f, indent=4)
          
          print(f"âœ… Updated {len(instances)} instances in config/instance_ips.json")
          for name, info in instances.items():
              print(f"  - {name}: {info['PublicIpAddress']}")
          EOF
          
      - name: Update .ssh/config
        run: |
          echo "ğŸ” Updating .ssh/config with new IPs..."
          python3 << 'EOF'
          import json
          import re
          
          # Mapeo de nombres de instancias a host SSH
          MAPPING = {
              'EC-Bastion': 'bastion',
              'EC2-CORE': 'core',
              'EC2-DB': 'db',
              'EC2-Frontend': 'frontend',
              'EC2-API-Gateway': 'api-gateway',
              'EC2-Messaging': 'messaging',
              'EC2-Monitoring': 'monitoring',
              'EC2-Notificaciones': 'notificaciones',
              'EC2-Reportes': 'reportes',
          }
          
          # Leer instancias
          with open('config/instance_ips.json', 'r') as f:
              instances = json.load(f)
          
          # Leer .ssh/config
          with open('.ssh/config', 'r') as f:
              config_lines = f.readlines()
          
          # Actualizar cada host
          for inst_name, ssh_host in MAPPING.items():
              if inst_name in instances:
                  new_ip = instances[inst_name]['PublicIpAddress']
                  
                  # Buscar la secciÃ³n del host
                  i = 0
                  while i < len(config_lines):
                      if config_lines[i].strip().startswith(f'Host {ssh_host}'):
                          # Buscar HostName en las siguientes lÃ­neas
                          j = i + 1
                          while j < len(config_lines) and (config_lines[j].startswith('    ') or config_lines[j].startswith('\t')):
                              if config_lines[j].strip().startswith('HostName'):
                                  indent = len(config_lines[j]) - len(config_lines[j].lstrip())
                                  config_lines[j] = ' ' * indent + f'HostName {new_ip}\n'
                                  print(f"âœ… Updated SSH host '{ssh_host}': {new_ip}")
                                  break
                              j += 1
                          break
                      i += 1
          
          # Guardar .ssh/config
          with open('.ssh/config', 'w') as f:
              f.writelines(config_lines)
          EOF

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global credential.helper store
          echo "https://x-access-token:${GITHUB_TOKEN}@github.com" > ~/.git-credentials
          
          git pull --rebase origin main || true
          
          git add config/instance_ips.json .ssh/config .env.aws 2>/dev/null || true
          
          if git diff --cached --quiet; then
            echo "âœ… No changes to commit"
          else
            git commit -m "chore: Update instance IPs from AWS [automated]"
            git push origin main || true
            echo "âœ… Changes pushed successfully"
          fi