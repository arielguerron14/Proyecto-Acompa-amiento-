name: Update Instance IPs and Routes


on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Choose environment: local or prod'
        required: true
        default: local
        type: string

jobs:
  update-ips:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Python dependencies
        run: |
          pip install pyyaml boto3 -q

      - name: Update IPs and routes for selected environment
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          AWS_DEFAULT_REGION: us-east-1
        run: |
          ENV_INPUT="${{ inputs.environment }}"
          echo "Selected environment: $ENV_INPUT"
          if [ "$ENV_INPUT" = "local" ]; then
            echo "üîÑ Setting local IPs and routes..."
            python3 << 'EOF'
import json
local_config = {
    "api-gateway": {"host": "localhost", "port": 8080},
    "auth": {"host": "localhost", "port": 3000},
    "estudiantes": {"host": "localhost", "port": 3001},
    "maestros": {"host": "localhost", "port": 3002},
    "reportes-estudiantes": {"host": "localhost", "port": 5003},
    "reportes-maestros": {"host": "localhost", "port": 5004},
    "mongo": {"host": "localhost", "port": 27017}
}
with open('config/instance_ips.json', 'w') as f:
    json.dump(local_config, f, indent=4)
print("‚úÖ Local IPs and routes updated in config/instance_ips.json")
EOF
            echo "üîÑ Syncing local IPs to .env files..."
            python3 sync-ips-to-env.py --local
            echo "‚úÖ Local .env files updated"
          else
            echo "üîÑ Fetching instance IPs from AWS using credentials..."
            python3 << 'EOF'
import json
import boto3
import os
import sys
try:
    session = boto3.Session(
        aws_access_key_id=os.environ.get('AWS_ACCESS_KEY_ID'),
        aws_secret_access_key=os.environ.get('AWS_SECRET_ACCESS_KEY'),
        aws_session_token=os.environ.get('AWS_SESSION_TOKEN'),
        region_name=os.environ.get('AWS_DEFAULT_REGION', 'us-east-1')
    )
    ec2 = session.client('ec2')
    response = ec2.describe_instances(Filters=[{'Name': 'instance-state-name', 'Values': ['running']}])
    instances = {}
    print("üìã Found instances from AWS:")
    for reservation in response.get('Reservations', []):
        for instance in reservation.get('Instances', []):
            instance_id = instance['InstanceId']
            instance_name = None
            for tag in instance.get('Tags', []):
                if tag['Key'] == 'Name':
                    instance_name = tag['Value']
                    break
            if instance_name:
                public_ip = instance.get('PublicIpAddress', 'N/A')
                private_ip = instance.get('PrivateIpAddress', 'N/A')
                instance_type = instance.get('InstanceType', 'unknown')
                instances[instance_name] = {
                    'InstanceId': instance_id,
                    'Name': instance_name,
                    'PublicIpAddress': public_ip,
                    'PrivateIpAddress': private_ip,
                    'Type': instance_type
                }
                print(f"  ‚úÖ {instance_name}")
                print(f"      ID: {instance_id}")
                print(f"      Public IP: {public_ip}")
                print(f"      Private IP: {private_ip}")
    if instances:
        with open('config/instance_ips.json', 'w') as f:
            json.dump(instances, f, indent=4)
        print(f"\n‚úÖ Updated config/instance_ips.json with {len(instances)} instances")
    else:
        print("‚ö†Ô∏è  No instances found, skipping update")
except Exception as e:
    print(f"‚ùå Error: {e}")
    import traceback
    traceback.print_exc()
    sys.exit(1)
EOF
            echo "üîÑ Syncing AWS IPs to .env files..."
            python3 sync-ips-to-env.py --prod
            echo "‚úÖ .env files updated for production"
          fi

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          if git diff --quiet; then
            echo "‚úÖ No changes to commit"
            exit 0
          fi
          git add config/ .env.generated .env.prod.frontend api-gateway/ micro-auth/ micro-estudiantes/ micro-maestros/ micro-notificaciones/ micro-messaging/ monitoring/ frontend-web/ 2>/dev/null || true
          if git diff --cached --quiet; then
            echo "‚úÖ No changes to commit"
          else
            git commit -m "chore: Update instance IPs and sync all configs [automated]"
            echo "üì• Pulling latest changes..."
            git pull --rebase origin main || true
            echo "üì§ Pushing changes..."
            for i in {1..3}; do
              if git push origin main; then
                echo "‚úÖ Push successful"
                exit 0
              else
                echo "‚è≥ Push attempt $i failed, retrying..."
                sleep 5
              fi
            done
            echo "‚ö†Ô∏è Push failed after 3 attempts, but configuration synced"
          fi