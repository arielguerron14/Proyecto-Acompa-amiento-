name: Update AWS Instance IPs

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  # Cada hora

jobs:
  update-ips:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1
        continue-on-error: true

      - name: Fetch and update instance IPs
        run: |
          echo "ðŸ”„ Fetching EC2 instances from AWS..."
          
          # Crear script Python inline mÃ¡s robusto
          python3 << 'PYSCRIPT'
          import json
          import subprocess
          import sys
          import os
          
          try:
              # Obtener instancias
              result = subprocess.run([
                  'aws', 'ec2', 'describe-instances',
                  '--filters', 'Name=instance-state-name,Values=running',
                  '--region', 'us-east-1',
                  '--output', 'json'
              ], capture_output=True, text=True, check=True)
              
              data = json.loads(result.stdout)
              instances = {}
              
              print("ðŸ“‹ Scanning instances:")
              for reservation in data.get('Reservations', []):
                  for inst in reservation.get('Instances', []):
                      name = None
                      
                      # Obtener nombre del tag
                      for tag in inst.get('Tags', []):
                          if tag.get('Key') == 'Name':
                              name = tag.get('Value')
                              break
                      
                      if name:
                          pub_ip = inst.get('PublicIpAddress', 'N/A')
                          priv_ip = inst.get('PrivateIpAddress', 'N/A')
                          
                          instances[name] = {
                              'InstanceId': inst.get('InstanceId'),
                              'Name': name,
                              'PublicIpAddress': pub_ip,
                              'PrivateIpAddress': priv_ip,
                              'Type': inst.get('InstanceType', 'unknown')
                          }
                          print(f"  âœ… {name}: {pub_ip}")
              
              # Guardar en config/instance_ips.json
              os.makedirs('config', exist_ok=True)
              with open('config/instance_ips.json', 'w') as f:
                  json.dump(instances, f, indent=4)
              
              print(f"\nâœ… Saved {len(instances)} instances to config/instance_ips.json")
              
              # Actualizar .ssh/config
              if os.path.exists('.ssh/config'):
                  with open('.ssh/config', 'r') as f:
                      lines = f.readlines()
                  
                  mapping = {
                      'EC-Bastion': 'bastion',
                      'EC2-CORE': 'core',
                      'EC2-DB': 'db',
                      'EC2-Frontend': 'frontend',
                      'EC2-API-Gateway': 'api-gateway',
                      'EC2-Messaging': 'messaging',
                      'EC2-Monitoring': 'monitoring',
                      'EC2-Notificaciones': 'notificaciones',
                      'EC2-Reportes': 'reportes',
                  }
                  
                  for inst_name, ssh_host in mapping.items():
                      if inst_name in instances:
                          new_ip = instances[inst_name]['PublicIpAddress']
                          if new_ip != 'N/A':
                              i = 0
                              while i < len(lines):
                                  if f'Host {ssh_host}' in lines[i]:
                                      j = i + 1
                                      while j < len(lines) and (lines[j].startswith('    ') or lines[j].startswith('\t')):
                                          if 'HostName' in lines[j]:
                                              indent = len(lines[j]) - len(lines[j].lstrip())
                                              lines[j] = ' ' * indent + f'HostName {new_ip}\n'
                                              print(f"  âœ… Updated SSH {ssh_host} â†’ {new_ip}")
                                              break
                                          j += 1
                                      break
                                  i += 1
                  
                  with open('.ssh/config', 'w') as f:
                      f.writelines(lines)
                  
                  print("âœ… Updated .ssh/config")
              
          except Exception as e:
              print(f"âŒ Error: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          PYSCRIPT

      - name: Sync IPs to configuration files
        run: |
          echo "ðŸ”„ Syncing IPs to all configuration files..."
          python3 sync-ips-to-config.py
    
      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global credential.helper store
          echo "https://x-access-token:${GITHUB_TOKEN}@github.com" > ~/.git-credentials
          
          git pull --rebase origin main || true
          
          # Stage all updated files
          git add config/instance_ips.json .ssh/config .env.generated .env.prod.frontend api-gateway/.env docker-compose.frontend.yml 2>/dev/null || true
          
          if git diff --cached --quiet; then
            echo "âœ… No changes to commit"
          else
            git commit -m "chore: Update instance IPs and sync all configs [automated]"
            git push origin main || true
            echo "âœ… Changes pushed successfully"
          fi