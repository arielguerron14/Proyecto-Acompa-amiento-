name: Update AWS Instance IPs

on:
  workflow_dispatch:
  push:
    paths:
      - 'config/instance_ips.json'

jobs:
  update-ips:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Python dependencies
        run: |
          pip install pyyaml boto3 -q

      - name: Fetch and update instance IPs from AWS
        continue-on-error: true
        run: |
          echo "üîÑ Fetching instance IPs from AWS..."
          python3 << 'EOF'
          import json
          import subprocess
          import sys

          try:
              result = subprocess.run([
                  'aws', 'ec2', 'describe-instances',
                  '--filters', 'Name=instance-state-name,Values=running',
                  '--region', 'us-east-1',
                  '--output', 'json'
              ], capture_output=True, text=True, timeout=30)
              
              if result.returncode != 0:
                  print(f"‚ö†Ô∏è  AWS CLI error: {result.stderr}")
                  sys.exit(0)  # Don't fail, continue with existing data
              
              data = json.loads(result.stdout)
              instances = {}
              
              print("üìã Found instances from AWS:")
              for reservation in data.get('Reservations', []):
                  for instance in reservation.get('Instances', []):
                      instance_id = instance['InstanceId']
                      instance_name = None
                      
                      # Get name from tags
                      for tag in instance.get('Tags', []):
                          if tag['Key'] == 'Name':
                              instance_name = tag['Value']
                              break
                      
                      if instance_name:
                          public_ip = instance.get('PublicIpAddress', 'N/A')
                          private_ip = instance.get('PrivateIpAddress', 'N/A')
                          instance_type = instance.get('InstanceType', 'unknown')
                          
                          instances[instance_name] = {
                              'InstanceId': instance_id,
                              'Name': instance_name,
                              'PublicIpAddress': public_ip,
                              'PrivateIpAddress': private_ip,
                              'Type': instance_type
                          }
                          
                          print(f"  ‚úÖ {instance_name}")
                          print(f"      ID: {instance_id}")
                          print(f"      Public IP: {public_ip}")
                          print(f"      Private IP: {private_ip}")

              if instances:
                  # Update config/instance_ips.json
                  with open('config/instance_ips.json', 'w') as f:
                      json.dump(instances, f, indent=4)
                  
                  print(f"\n‚úÖ Updated config/instance_ips.json with {len(instances)} instances")
              else:
                  print("‚ö†Ô∏è  No instances found, skipping update")
                  
          except Exception as e:
              print(f"‚ö†Ô∏è  Error: {e}")
              sys.exit(0)  # Don't fail the workflow
          EOF

      - name: Sync IPs to configuration files
        run: |
          echo "üîÑ Syncing instance IPs to all configuration files..."
          python3 sync-ips-to-config.py
          echo "‚úÖ IP synchronization complete"

      - name: Sync IPs to .env files
        run: |
          echo "üîÑ Syncing IPs to .env files..."
          python3 sync-ips-to-env.py
          echo "‚úÖ .env files updated"

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check for changes
          if git diff --quiet; then
            echo "‚úÖ No changes to commit"
            exit 0
          fi
          
          # Stage changed files
          git add config/ api-gateway/ micro-auth/ micro-estudiantes/ micro-maestros/ micro-notificaciones/ micro-messaging/ monitoring/ frontend-web/ 2>/dev/null || true
          
          # Commit only if there are staged changes
          if git diff --cached --quiet; then
            echo "‚úÖ No changes to commit"
          else
            git commit -m "chore: Update instance IPs and sync all configs [automated]"
            
            # Pull before push to avoid conflicts
            echo "üì• Pulling latest changes..."
            git pull --rebase origin main || true
            
            # Push with retry
            echo "üì§ Pushing changes..."
            for i in {1..3}; do
              if git push origin main; then
                echo "‚úÖ Push successful"
                exit 0
              else
                echo "‚è≥ Push attempt $i failed, retrying..."
                sleep 5
              fi
            done
            echo "‚ö†Ô∏è Push failed after 3 attempts, but configuration synced"
          fi