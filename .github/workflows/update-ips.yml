name: Update Instance IPs and Routes

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to update (local or prod)'
        required: true
        default: 'local'
        type: choice
        options:
          - local
          - prod

jobs:
  update-config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install pyyaml boto3 -q

      - name: Update configuration for ${{ inputs.environment }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
        run: |
          ENVIRONMENT="${{ inputs.environment }}"
          echo "üîÑ Updating configuration for: $ENVIRONMENT"
          
          if [ "$ENVIRONMENT" = "local" ]; then
            echo "üìç Setting up LOCAL configuration"
            python3 << 'PYTHON_EOF'
          import json
          local_config = {
              "api-gateway": {"host": "localhost", "port": 8080},
              "auth": {"host": "localhost", "port": 3000},
              "estudiantes": {"host": "localhost", "port": 3001},
              "maestros": {"host": "localhost", "port": 3002},
              "reportes-estudiantes": {"host": "localhost", "port": 5003},
              "reportes-maestros": {"host": "localhost", "port": 5004},
              "mongo": {"host": "localhost", "port": 27017}
          }
          with open('config/instance_ips.json', 'w') as f:
              json.dump(local_config, f, indent=4)
          print("‚úÖ Local configuration updated")
          PYTHON_EOF
          else
            echo "üìç Fetching PRODUCTION configuration from AWS"
            python3 << 'PYTHON_EOF'
          import json
          import boto3
          import os
          import sys
          try:
              session = boto3.Session(
                  aws_access_key_id=os.environ.get('AWS_ACCESS_KEY_ID'),
                  aws_secret_access_key=os.environ.get('AWS_SECRET_ACCESS_KEY'),
                  aws_session_token=os.environ.get('AWS_SESSION_TOKEN'),
                  region_name='us-east-1'
              )
              ec2 = session.client('ec2')
              response = ec2.describe_instances(
                  Filters=[{'Name': 'instance-state-name', 'Values': ['running']}]
              )
              instances = {}
              for reservation in response.get('Reservations', []):
                  for instance in reservation.get('Instances', []):
                      instance_id = instance['InstanceId']
                      instance_name = None
                      for tag in instance.get('Tags', []):
                          if tag['Key'] == 'Name':
                              instance_name = tag['Value']
                              break
                      if instance_name:
                          instances[instance_name] = {
                              'InstanceId': instance_id,
                              'Name': instance_name,
                              'PublicIpAddress': instance.get('PublicIpAddress', 'N/A'),
                              'PrivateIpAddress': instance.get('PrivateIpAddress', 'N/A'),
                              'Type': instance.get('InstanceType', 'unknown')
                          }
              with open('config/instance_ips.json', 'w') as f:
                  json.dump(instances, f, indent=4)
              print(f"‚úÖ Updated {len(instances)} instances from AWS")
          except Exception as e:
              print(f"‚ùå Error: {e}")
              sys.exit(1)
          PYTHON_EOF
          fi

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -z "$(git status --porcelain)" ]; then
            echo "‚úÖ No changes to commit"
          else
            git add config/instance_ips.json
            git commit -m "chore: Update IPs for ${{ inputs.environment }} environment [automated]"
            git push origin main
            echo "‚úÖ Changes pushed to main"
          fi