name: Update AWS Instance IPs

on:
  workflow_dispatch:
  push:
    paths:
      - 'config/instance_ips.json'

jobs:
  update-ips:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Python dependencies
        run: |
          pip install pyyaml boto3 -q

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Fetch and update instance IPs from AWS
        run: |
          echo "üîÑ Fetching instance IPs from AWS..."
          python3 << 'EOF'
          import json
          import boto3
          from pathlib import Path

          ec2 = boto3.client('ec2', region_name='us-east-1')
          response = ec2.describe_instances(
              Filters=[{'Name': 'instance-state-name', 'Values': ['running']}]
          )

          instances = {}
          print("üìã Found instances:")
          for reservation in response['Reservations']:
              for instance in reservation['Instances']:
                  instance_id = instance['InstanceId']
                  instance_name = None
                  
                  # Get name from tags
                  if 'Tags' in instance:
                      for tag in instance['Tags']:
                          if tag['Key'] == 'Name':
                              instance_name = tag['Value']
                              break
                  
                  if instance_name:
                      public_ip = instance.get('PublicIpAddress', 'N/A')
                      private_ip = instance.get('PrivateIpAddress', 'N/A')
                      instance_type = instance.get('InstanceType', 'unknown')
                      
                      instances[instance_name] = {
                          'InstanceId': instance_id,
                          'Name': instance_name,
                          'PublicIpAddress': public_ip,
                          'PrivateIpAddress': private_ip,
                          'Type': instance_type
                      }
                      
                      print(f"  ‚úÖ {instance_name}: ID={instance_id}, Public={public_ip}, Private={private_ip}")

          # Update config/instance_ips.json
          config_path = Path('config/instance_ips.json')
          config_path.parent.mkdir(parents=True, exist_ok=True)
          
          with open(config_path, 'w') as f:
              json.dump(instances, f, indent=4)
          
          print(f"\n‚úÖ Updated {config_path} with {len(instances)} instances")
          EOF

      - name: Sync IPs to configuration files
        run: |
          echo "üîÑ Syncing instance IPs to all configuration files..."
          python3 sync-ips-to-config.py
          echo "‚úÖ IP synchronization complete"

      - name: Sync IPs to .env files
        run: |
          echo "üîÑ Syncing IPs to .env files..."
          python3 sync-ips-to-env.py
          echo "‚úÖ .env files updated"

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check for changes
          if git diff --quiet; then
            echo "‚úÖ No changes to commit"
            exit 0
          fi
          
          # Stage changed files
          git add config/ api-gateway/ micro-auth/ micro-estudiantes/ micro-maestros/ micro-notificaciones/ micro-messaging/ monitoring/ frontend-web/ 2>/dev/null || true
          
          # Commit only if there are staged changes
          if git diff --cached --quiet; then
            echo "‚úÖ No changes to commit"
          else
            git commit -m "chore: Update instance IPs and sync all configs [automated]"
            
            # Pull before push to avoid conflicts
            echo "üì• Pulling latest changes..."
            git pull --rebase origin main || true
            
            # Push with retry
            echo "üì§ Pushing changes..."
            for i in {1..3}; do
              if git push origin main; then
                echo "‚úÖ Push successful"
                exit 0
              else
                echo "‚è≥ Push attempt $i failed, retrying..."
                sleep 5
              fi
            done
            echo "‚ö†Ô∏è Push failed after 3 attempts, but configuration synced"
          fi