name: DEBUG - Check Micro-Auth Logs

on:
  workflow_dispatch:

env:
  SSH_KEY: ${{ secrets.AWS_EC2_DB_SSH_PRIVATE_KEY }}

jobs:
  debug:
    name: Debug Micro-Auth Container
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/key.pem << 'EOF'
          ${{ env.SSH_KEY }}
          EOF
          chmod 600 ~/.ssh/key.pem
          cat > ~/.ssh/config << 'EOF'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
            LogLevel=QUIET
          EOF

      - name: Check Micro-Auth Logs
        run: |
          echo "=== Checking Micro-Auth Container Logs ==="
          ssh -i ~/.ssh/key.pem -o ConnectTimeout=10 ubuntu@13.221.55.216 << 'DEBUG'
          echo "Docker ps (all):"
          docker ps -a
          
          echo ""
          echo "=== Micro-Auth Logs (last 100 lines) ==="
          docker logs micro-auth 2>&1 | tail -100
          
          echo ""
          echo "=== Checking if databases are reachable ==="
          docker exec postgres ping -c 1 44.222.116.0 2>/dev/null || echo "Cannot reach DB from postgres container"
          
          echo ""
          echo "=== Environment variables in micro-auth container ==="
          docker run --rm micro-auth:latest env | grep -E "PORT|DB_HOST|REDIS|MONGO"
          
          DEBUG

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/key.pem
