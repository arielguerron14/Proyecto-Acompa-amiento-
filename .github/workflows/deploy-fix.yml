name: Deploy Fix & Diagnostics

on:
  workflow_dispatch:

jobs:
  test-connectivity:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          cp ssh-key-ec2.pem ~/.ssh/labsuser.pem
          chmod 600 ~/.ssh/labsuser.pem
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Get Instance IPs
        id: ips
        continue-on-error: true
        run: |
          # Usar IPs de GitHub Secrets como fallback
          FRONTEND_IP="${{ secrets.EC2_FRONTEND_IP }}"
          API_IP="${{ secrets.EC2_API_GATEWAY_IP }}"
          CORE_IP="${{ secrets.EC2_CORE_IP }}"
          
          if [ -z "$FRONTEND_IP" ]; then
            FRONTEND_IP="44.220.126.89"
          fi
          if [ -z "$API_IP" ]; then
            API_IP="52.7.168.4"
          fi
          if [ -z "$CORE_IP" ]; then
            CORE_IP="172.31.71.182"
          fi
          
          echo "frontend_ip=$FRONTEND_IP" >> $GITHUB_OUTPUT
          echo "api_ip=$API_IP" >> $GITHUB_OUTPUT
          echo "core_ip=$CORE_IP" >> $GITHUB_OUTPUT
          
          echo "Frontend: $FRONTEND_IP"
          echo "API Gateway: $API_IP"
          echo "Core: $CORE_IP"

      - name: Test Connectivity
        continue-on-error: true
        run: |
          echo "Testing Frontend..."
          ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@${{ steps.ips.outputs.frontend_ip }} "echo ✅ Frontend reachable" || echo "❌ Frontend not reachable"
          
          echo "Testing API Gateway..."
          ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@${{ steps.ips.outputs.api_ip }} "echo ✅ API Gateway reachable" || echo "❌ API Gateway not reachable"
          
          echo "Testing Core..."
          ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem ubuntu@${{ steps.ips.outputs.core_ip }} "echo ✅ Core reachable" || echo "❌ Core not reachable"

  deploy:
    runs-on: ubuntu-latest
    needs: test-connectivity
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          cp ssh-key-ec2.pem ~/.ssh/labsuser.pem
          chmod 600 ~/.ssh/labsuser.pem

      - name: Restart Services on Core
        run: |
          echo "Restarting services on Core..."
          ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no -i ~/.ssh/labsuser.pem -t ubuntu@172.31.71.182 << 'EOF'
          set -e
          cd ~/Proyecto-Acompa-amiento- || exit 0
          echo "Checking Docker status..."
          docker ps -a --format "table {{.Names}}\t{{.Status}}" || echo "Docker not running"
          echo ""
          echo "Restarting docker-compose services..."
          sudo docker-compose -f docker-compose.core.yml down 2>/dev/null || true
          sleep 5
          sudo docker-compose -f docker-compose.core.yml up -d 2>/dev/null || true
          echo "✅ Services restarted"
          sleep 10
          echo ""
          echo "Checking container status after restart..."
          docker ps -a --format "table {{.Names}}\t{{.Status}}" || echo "No containers"
          EOF

      - name: Verify Services
        continue-on-error: true
        run: |
          echo "Verifying microservices..."
          for i in {1..3}; do
            echo "Attempt $i: Testing API Gateway health endpoint..."
            curl -s -m 5 http://52.7.168.4:8080/health 2>&1 | head -20 || echo "Could not connect to API Gateway"
            sleep 3
          done

      - name: Summary
        if: always()
        run: |
          echo "## ✅ Deployment Complete"
          echo "- Frontend: 44.220.126.89"
          echo "- API Gateway: 52.7.168.4:8080"
          echo "- Core Services: Should be running on 172.31.71.182"
          echo ""
          echo "To verify, check the frontend at http://44.220.126.89"
