version: '3.8'

services:
  bastion:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bastion-host
    hostname: bastion-host
    restart: always
    
    # Configuración de red
    networks:
      - proyecto-network
    
    ports:
      - "2222:22"
    
    # Volúmenes para persistencia de datos
    volumes:
      # Logs de auditoría y monitoreo
      - bastion-logs:/var/log/bastion
      - bastion-auth:/var/log
      
      # Configuración SSH (persistente - read-write)
      - bastion-ssh-config:/etc/ssh
      
      # Scripts personalizados (readonly)
      - ./scripts:/opt/bastion/scripts:ro
    
    # Limites de recursos
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # Environment variables
    environment:
      TZ: UTC
      BASTION_PORT: 22
      LOG_LEVEL: INFO
    
    # Health check
    healthcheck:
      test: ["CMD", "/opt/bastion/scripts/health-check.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # Opciones de seguridad
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
    
    cap_drop:
      - ALL
    
    tmpfs:
      - /run
      - /tmp
      - /var/run
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"
        labels: "service=bastion-host"

# Volúmenes persistentes
volumes:
  bastion-logs:
    driver: local
  bastion-auth:
    driver: local
  bastion-ssh-config:
    driver: local
  bastion-ssh-auth:
    driver: local

# Red del proyecto
networks:
  proyecto-network:
    name: proyecto-network
    driver: bridge
