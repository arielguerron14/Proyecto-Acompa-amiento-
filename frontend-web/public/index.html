<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Panel de Maestros</title>
  <link rel="stylesheet" href="styles.css">
  <script>
    // Suppress browser extension errors
    window.addEventListener('error', function(event) {
      const msg = String(event.message || '');
      if (msg.includes('message channel') || msg.includes('asynchronous response')) {
        event.preventDefault();
      }
    }, true);
    
    window.addEventListener('unhandledrejection', function(event) {
      const msg = String(event.reason || '');
      if (msg.includes('message channel') || msg.includes('asynchronous response')) {
        event.preventDefault();
      }
    });
  </script>
  <style>
    .user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    .user-info {
      font-size: 14px;
      color: #666;
    }
    .logout-btn {
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .logout-btn:hover {
      background: #764ba2;
    }
  </style>
</head>
<body>
  <main class="app-shell">
    <div class="user-header">
      <div class="user-info">
        <strong id="userName">Maestro</strong> | <span id="userEmail">email@example.com</span>
      </div>
      <button class="logout-btn" onclick="handleLogout()">Cerrar Sesión</button>
    </div>
    <header class="hero">
      <p class="eyebrow">Panel de gestión</p>
      <h1>Horarios y reportes de maestros</h1>
      <p>Administra la disponibilidad del profesorado y consulta reportes detallados en una interfaz uniforme, clara y responsive.</p>
      <a class="cta-link" href="estudiante.html">Ir al panel de estudiantes →</a>
    </header>

    <section class="cards-grid">
      <article class="card">
        <div>
          <h2>Registrar nuevo horario</h2>
          <p>Define rápidamente los bloques disponibles para un maestro.</p>
        </div>
        <form class="form-grid" onsubmit="createHorario(event)">
          <label class="field">
            <span>Nombre del maestro</span>
            <input id="maestroName" type="text" required placeholder="Ana Gómez">
          </label>
          <label class="field">
            <span>Semestre</span>
            <select id="maestroSemestre" required></select>
          </label>
          <label class="field">
            <span>Materia</span>
            <select id="maestroMateria" required disabled></select>
          </label>
          <label class="field">
            <span>Paralelo</span>
            <select id="maestroParalelo" required>
              <option value="">Selecciona paralelo</option>
              <option value="Paralelo 1">Paralelo 1</option>
              <option value="Paralelo 2">Paralelo 2</option>
              <option value="Paralelo 3">Paralelo 3</option>
            </select>
          </label>
          <label class="field">
            <span>Día</span>
            <select id="dia" required>
              <option value="">Selecciona un día</option>
              <option value="Lunes">Lunes</option>
              <option value="Martes">Martes</option>
              <option value="Miércoles">Miércoles</option>
              <option value="Jueves">Jueves</option>
              <option value="Viernes">Viernes</option>
              <option value="Sábado">Sábado</option>
              <option value="Domingo">Domingo</option>
            </select>
          </label>
          <div class="form-grid split">
            <label class="field">
              <span>Hora inicio</span>
              <select id="inicio" required>
                <option value="">Selecciona hora</option>
              </select>
            </label>
            <label class="field">
              <span>Hora fin</span>
              <select id="fin" required>
                <option value="">Selecciona hora</option>
              </select>
            </label>
          </div>
          <button type="submit" class="btn primary">Guardar horario</button>
          <p class="status" id="horarioStatus" hidden></p>
        </form>
      </article>

      <article class="card">
        <div>
          <h2>Reporte del maestro</h2>
          <p>Accede al resumen consolidado de sesiones, reservas y métricas.</p>
        </div>
        <form class="form-grid split" onsubmit="getReporte(event)">
          <label class="field">
            <span>ID maestro</span>
            <input id="maestroIdReport" type="number" min="1" required placeholder="Ej. 12">
          </label>
          <button type="submit" class="btn secondary">Generar reporte</button>
        </form>
        <p class="status info" id="reporteStatus" hidden></p>
        <pre class="code-block" id="reportArea">Selecciona un docente para ver su reporte.</pre>
      </article>
    </section>

    <section class="planner">
      <div>
        <p class="eyebrow">Planificador</p>
        <h2>Horarios registrados por materia</h2>
        <p>Filtra por semestre y materia para visualizar los bloques ya cargados en el sistema.</p>
      </div>
      <div class="planner-grid">
        <label class="field">
          <span>Semestre</span>
          <select id="semesterSelectMaestros"></select>
        </label>
        <label class="field">
          <span>Materia</span>
          <select id="subjectSelectMaestros" disabled></select>
        </label>
      </div>
      <p class="status info" id="plannerStatusMaestros">Selecciona un semestre y una materia para comenzar.</p>
      <div class="planner-results">
        <p class="empty-state" id="plannerEmptyMaestros" hidden>No hay horarios registrados para esta materia.</p>
        <div class="table-wrapper">
          <table class="planner-table">
            <thead id="plannerTableHeadMaestros"></thead>
            <tbody id="plannerTableMaestros"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
  <script src="js/auth.js?v=2"></script>
  <script src="curriculum.js"></script>
  <script>
    const API = location.origin.replace(/:[0-9]+$/, '') + ':8080';
    let resetHorarioSelects;
    const plannerStatusEl = document.getElementById('plannerStatusMaestros');
    const plannerEmptyEl = document.getElementById('plannerEmptyMaestros');
    const plannerTableEl = document.getElementById('plannerTableMaestros');
    const plannerHeadEl = document.getElementById('plannerTableHeadMaestros');
    let lastPlannerDetail = null;

    function setStatus(id, message = '', type = 'info') {
      const el = document.getElementById(id);
      if (!el) return;
      if (!message) {
        el.hidden = true;
        return;
      }
      el.textContent = message;
      el.className = `status ${type}`;
      el.hidden = false;
    }

    async function parseJson(res) {
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data.message || 'No se pudo completar la operación');
      }
      return data;
    }

    function generateMaestroId(name) {
      const normalized = (name || '').trim().toLowerCase();
      if (!normalized) return Date.now();
      let hash = 0;
      for (let i = 0; i < normalized.length; i++) {
        hash = (hash * 31 + normalized.charCodeAt(i)) >>> 0;
      }
      return hash || Date.now();
    }

    function to24h(timeStr = '') {
      if (!timeStr) return '';
      if (/^\d{2}:\d{2}$/.test(timeStr)) return timeStr;
      const date = new Date(`1970-01-01T${timeStr}`);
      if (Number.isNaN(date.getTime())) return timeStr;
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    function buildTimeOptions(selectId) {
      const select = document.getElementById(selectId);
      if (!select) return;
      const fragment = document.createDocumentFragment();
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'Selecciona hora';
      placeholder.disabled = true;
      placeholder.selected = true;
      fragment.appendChild(placeholder);

      for (let hour = 7; hour <= 20; hour++) {
        const value = `${hour.toString().padStart(2, '0')}:00`;
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        fragment.appendChild(option);

        if (hour < 20) {
          const halfValue = `${hour.toString().padStart(2, '0')}:30`;
          const halfOption = document.createElement('option');
          halfOption.value = halfValue;
          halfOption.textContent = halfValue;
          fragment.appendChild(halfOption);
        }
      }

      select.innerHTML = '';
      select.appendChild(fragment);
    }

    async function createHorario(event) {
      event?.preventDefault();
      setStatus('horarioStatus', 'Guardando horario...', 'info');
      const maestroName = document.getElementById('maestroName').value.trim();
      const maestroId = generateMaestroId(maestroName);
      const semestre = document.getElementById('maestroSemestre').value;
      const materia = document.getElementById('maestroMateria').value;
      const paralelo = document.getElementById('maestroParalelo').value;
      const dia = document.getElementById('dia').value;
      const inicio = document.getElementById('inicio').value;
      const fin = document.getElementById('fin').value;
      if (!inicio || !fin) {
        setStatus('horarioStatus', 'Selecciona una hora de inicio y fin.', 'error');
        return;
      }

      try {
        const res = await fetch(API + '/maestros/horarios', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ maestroId, maestroName, semestre, materia, paralelo, dia, inicio, fin })
        });
        const data = await parseJson(res);
        setStatus('horarioStatus', data.message || 'Horario registrado correctamente.', 'success');
        event?.target?.reset();
        resetHorarioSelects?.();
      } catch (error) {
        setStatus('horarioStatus', error.message, 'error');
      }
    }

    async function getReporte(event) {
      event?.preventDefault();
      setStatus('reporteStatus', 'Generando reporte...', 'info');
      const id = Number(document.getElementById('maestroIdReport').value);
      try {
        const res = await fetch(API + '/reportes/maestros/reporte/' + id);
        const data = await parseJson(res);
        document.getElementById('reportArea').textContent = JSON.stringify(data, null, 2);
        setStatus('reporteStatus', 'Reporte actualizado.', 'success');
      } catch (error) {
        setStatus('reporteStatus', error.message, 'error');
      }
    }

    function setPlannerStatus(message = '', type = 'info') {
      if (!plannerStatusEl) return;
      if (!message) {
        plannerStatusEl.hidden = true;
        return;
      }
      plannerStatusEl.hidden = false;
      plannerStatusEl.className = `status ${type}`;
      plannerStatusEl.textContent = message;
    }

    function setPlannerEmpty(show) {
      if (!plannerEmptyEl) return;
      plannerEmptyEl.hidden = !show;
      plannerTableEl.parentElement.hidden = show;
    }

    const DAYS = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];

    function buildPlannerHead() {
      if (!plannerHeadEl) return;
      plannerHeadEl.innerHTML = '';
      const tr = document.createElement('tr');
      const timeTh = document.createElement('th');
      timeTh.textContent = 'Horario';
      tr.appendChild(timeTh);
      DAYS.forEach(day => {
        const th = document.createElement('th');
        th.textContent = day;
        tr.appendChild(th);
      });
      plannerHeadEl.appendChild(tr);
    }

    function buildTimeSlots() {
      const slots = [];
      for (let hour = 7; hour < 20; hour++) {
        const start = hour.toString().padStart(2, '0') + ':00';
        const end = (hour + 1).toString().padStart(2, '0') + ':00';
        slots.push({ start, end, label: `${start} - ${end}` });
      }
      return slots;
    }

    function renderPlannerTable(items = []) {
      if (!plannerTableEl) return;
      plannerTableEl.innerHTML = '';

      if (!items.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = DAYS.length + 1;
        td.style.textAlign = 'center';
        td.textContent = 'No hay horarios disponibles para los filtros seleccionados.';
        tr.appendChild(td);
        plannerTableEl.appendChild(tr);
        return;
      }

      const slotMap = new Map();
      items.forEach(item => {
        const start = to24h(item.inicio || '');
        const end = to24h(item.fin || '');
        const normalizedItem = { ...item, inicio: start, fin: end };
        const slotKey = `${start}|${end}`;
        if (!slotMap.has(slotKey)) {
        const label = start && end ? `${to24h(start)} - ${to24h(end)}` : start ? `${to24h(start)} - ?` : 'Horario sin definir';
          slotMap.set(slotKey, { label, days: {} });
        }
        const slot = slotMap.get(slotKey);
        const dayKey = item.dia || 'Sin día';
        if (!slot.days[dayKey]) slot.days[dayKey] = [];
        slot.days[dayKey].push(normalizedItem);
      });

      const sortedSlots = Array.from(slotMap.entries()).sort((a, b) => {
        const [startA] = a[0].split('|');
        const [startB] = b[0].split('|');
        return (startA || '').localeCompare(startB || '');
      });

      sortedSlots.forEach(([, slot]) => {
        const tr = document.createElement('tr');
        const timeTd = document.createElement('td');
        timeTd.className = 'time-col';
        timeTd.textContent = slot.label;
        tr.appendChild(timeTd);

        DAYS.forEach(day => {
          const td = document.createElement('td');
          const entries = slot.days[day] || [];
          if (entries.length) {
            entries.forEach(entry => {
              const div = document.createElement('div');
              div.className = 'planner-slot';
              const prof = document.createElement('p');
              const paraleloText = entry.paralelo ? ` — ${entry.paralelo}` : ' — Paralelo sin definir';
              prof.textContent = `${entry.maestroName || `Maestro ${entry.maestroId}`}${paraleloText}`;
              const paraleloP = document.createElement('p');
              paraleloP.textContent = entry.paralelo || 'Paralelo sin definir';
              paraleloP.style.fontStyle = 'italic';
              paraleloP.style.color = 'var(--primary-dark)';
              const actions = document.createElement('div');
              actions.className = 'planner-slot-actions';
              const deleteBtn = document.createElement('button');
              deleteBtn.type = 'button';
              deleteBtn.className = 'planner-remove';
              deleteBtn.textContent = 'Eliminar';
              deleteBtn.addEventListener('click', () => deleteHorario(entry._id));
              actions.appendChild(deleteBtn);
              div.appendChild(prof);
              div.appendChild(paraleloP);
              div.appendChild(actions);
              td.appendChild(div);
            });
          } else {
            td.textContent = '—';
            td.style.color = 'rgba(15, 23, 42, 0.3)';
          }
          tr.appendChild(td);
        });

        plannerTableEl.appendChild(tr);
      });
    }

    async function handlePlannerSelection(detail) {
      lastPlannerDetail = detail;
      if (!detail || !detail.hasSelection) {
        renderPlannerTable([]);
        setPlannerEmpty(true);
        setPlannerStatus('Selecciona un semestre y una materia para comenzar.', 'info');
        return;
      }

      const params = new URLSearchParams();
      if (detail.semester) params.append('semestre', detail.semester);
      if (detail.course) params.append('materia', detail.course);

      setPlannerStatus('Cargando horarios...', 'info');
      setPlannerEmpty(false);
      renderPlannerTable([]);

      try {
        const res = await fetch(`${API}/maestros/horarios?${params.toString()}`);
        const data = await parseJson(res);
        setPlannerEmpty(!data.length);
        renderPlannerTable(data);
        if (!data.length) {
          setPlannerStatus('No hay horarios registrados para esta materia.', 'info');
        } else {
          setPlannerStatus(`Se encontraron ${data.length} horario(s) registrados para ${detail.course}.`, 'success');
        }
      } catch (error) {
        console.error(error);
        setPlannerStatus(error.message || 'No se pudo obtener la información.', 'error');
        setPlannerEmpty(true);
        renderPlannerTable([]);
      }
    }

    resetHorarioSelects = setupSemesterCourseSelect({
      semesterSelectId: 'maestroSemestre',
      courseSelectId: 'maestroMateria'
    });
    buildTimeOptions('inicio');
    buildTimeOptions('fin');
    buildPlannerHead();
    renderPlannerTable([]);
    setupSemesterCourseSelect({
      semesterSelectId: 'semesterSelectMaestros',
      courseSelectId: 'subjectSelectMaestros',
      onCourseChange: handlePlannerSelection
    });

    async function deleteHorario(id) {
      if (!id) return;
      if (!confirm('¿Deseas eliminar este horario?')) return;
      setPlannerStatus('Eliminando horario...', 'info');
      try {
        const res = await fetch(`${API}/maestros/horarios/${id}`, { method: 'DELETE' });
        await parseJson(res);
        setPlannerStatus('Horario eliminado.', 'success');
        if (lastPlannerDetail && lastPlannerDetail.hasSelection) {
          handlePlannerSelection(lastPlannerDetail);
        } else {
          renderPlannerTable([]);
          setPlannerEmpty(true);
        }
      } catch (error) {
        setPlannerStatus(error.message || 'No se pudo eliminar el horario.', 'error');
      }
    }

    // Funciones de autenticación
    async function handleLogout() {
      if (window.AuthClient) {
        await window.AuthClient.logout();
      } else {
        localStorage.removeItem('acomp_jwt_token_v1');
        localStorage.removeItem('user');
      }
      window.location.href = 'login.html';
    }

    function checkAuth() {
      const token = window.AuthClient?.getToken?.() || localStorage.getItem('acomp_jwt_token_v1');
      
      if (!token) {
        window.location.href = 'login.html';
        return;
      }

      const user = window.currentUser || JSON.parse(localStorage.getItem('user') || '{}');
      document.getElementById('userName').textContent = user.name || 'Maestro';
      document.getElementById('userEmail').textContent = user.email || 'email@example.com';
    }

    window.addEventListener('load', () => {
      try {
        checkAuth();
      } catch (err) {
        console.error('Auth check error:', err);
        window.location.href = 'login.html';
      }
    });
  </script>
</body>
</html>
