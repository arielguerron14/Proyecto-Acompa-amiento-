<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Panel de Estudiantes</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <main class="app-shell">
    <header class="hero">
      <p class="eyebrow">Panel del estudiante</p>
      <h1>Reservas y reportes personales</h1>
      <p>Programa tus sesiones, consulta las reservas confirmadas y descarga tu reporte académico en un entorno visualmente consistente y agradable.</p>
      <a class="cta-link" href="index.html">Volver al panel de maestros →</a>
    </header>

    <section class="cards-grid">
      <article class="card">
        <div>
          <h2>Reservar sesión</h2>
          <p>Solicita un horario con el maestro disponible que prefieras.</p>
        </div>
        <form class="form-grid" onsubmit="reservar(event)">
          <label class="field">
            <span>ID estudiante</span>
            <input id="estId" type="number" min="1" required placeholder="Ej. 301">
          </label>
          <label class="field">
            <span>Nombre del estudiante</span>
            <input id="estName" type="text" required placeholder="Carlos Díaz">
          </label>
          <label class="field">
            <span>ID maestro</span>
            <input id="maestroId" type="number" min="1" required placeholder="Ej. 12">
          </label>
          <label class="field">
            <span>Día</span>
            <input id="dia" type="text" required placeholder="Martes">
          </label>
          <div class="form-grid split">
            <label class="field">
              <span>Hora inicio</span>
              <input id="inicio" type="time" required>
            </label>
            <label class="field">
              <span>Hora fin</span>
              <input id="fin" type="time" required>
            </label>
          </div>
          <button type="submit" class="btn primary">Reservar</button>
          <p class="status" id="reservaStatus" hidden></p>
        </form>
      </article>

      <article class="card">
        <div>
          <h2>Mis reservas</h2>
          <p>Revisa lo que ya tienes agendado y confirma detalles.</p>
        </div>
        <form class="form-grid split" onsubmit="verReservas(event)">
          <label class="field">
            <span>ID estudiante</span>
            <input id="verEstId" type="number" min="1" required placeholder="Ej. 301">
          </label>
          <button type="submit" class="btn secondary">Ver reservas</button>
        </form>
        <p class="status info" id="reservasStatus" hidden></p>
        <p class="empty-state" id="reservasEmpty" hidden>No hay reservas activas para este estudiante.</p>
        <ul class="list" id="reservasList"></ul>
      </article>

      <article class="card">
        <div>
          <h2>Reporte personal</h2>
          <p>Obtén el detalle de progreso y sesiones completadas.</p>
        </div>
        <form class="form-grid split" onsubmit="verReporte(event)">
          <label class="field">
            <span>ID estudiante</span>
            <input id="reportEstId" type="number" min="1" required placeholder="Ej. 301">
          </label>
          <button type="submit" class="btn secondary">Generar reporte</button>
        </form>
        <p class="status info" id="reportEstStatus" hidden></p>
        <pre class="code-block" id="reportArea">Consulta tu reporte para ver métricas y seguimiento.</pre>
      </article>
    </section>

    <section class="planner">
      <div>
        <p class="eyebrow">Planificador personal</p>
        <h2>Define tu materia y horario</h2>
        <p>Selecciona el semestre y la materia, luego marca el día de la semana y los horarios que prefieras.</p>
      </div>
      <div class="planner-grid">
        <label class="field">
          <span>Semestre</span>
          <select id="semesterSelectEstudiantes"></select>
        </label>
        <label class="field">
          <span>Materia</span>
          <select id="subjectSelectEstudiantes"></select>
        </label>
      </div>
      <div class="table-wrapper">
        <table class="planner-table">
          <thead>
            <tr>
              <th>Día</th>
              <th>Hora inicio</th>
              <th>Hora fin</th>
              <th>Elegir</th>
            </tr>
          </thead>
          <tbody id="plannerTableEstudiantes"></tbody>
        </table>
      </div>
      <div class="planner-footer">
        <button type="button" class="btn primary" id="plannerAssignBtnEstudiantes">Guardar preferencia</button>
        <p class="assignment-summary" id="plannerSummaryEstudiantes">Selecciona un semestre y una materia para comenzar.</p>
      </div>
    </section>
  </main>

  <script src="curriculum.js"></script>
  <script>
    const API = location.origin.replace(/:[0-9]+$/, '') + ':8080';

    function setStatus(id, message = '', type = 'info') {
      const el = document.getElementById(id);
      if (!el) return;
      if (!message) {
        el.hidden = true;
        return;
      }
      el.textContent = message;
      el.className = `status ${type}`;
      el.hidden = false;
    }

    async function parseJson(res) {
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data.message || 'No se pudo completar la operación');
      }
      return data;
    }

    async function reservar(event) {
      event?.preventDefault();
      setStatus('reservaStatus', 'Creando reserva...', 'info');
      const estudianteId = Number(document.getElementById('estId').value);
      const estudianteName = document.getElementById('estName').value.trim();
      const maestroId = Number(document.getElementById('maestroId').value);
      const dia = document.getElementById('dia').value.trim();
      const inicio = document.getElementById('inicio').value;
      const fin = document.getElementById('fin').value;

      try {
        const res = await fetch(API + '/estudiantes/reservar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ estudianteId, estudianteName, maestroId, dia, inicio, fin })
        });
        const data = await parseJson(res);
        setStatus('reservaStatus', data.message || 'Reserva creada con éxito.', 'success');
        event?.target?.reset();
      } catch (error) {
        setStatus('reservaStatus', error.message, 'error');
      }
    }

    async function verReservas(event) {
      event?.preventDefault();
      setStatus('reservasStatus', 'Cargando reservas...', 'info');
      document.getElementById('reservasEmpty').hidden = true;
      const ul = document.getElementById('reservasList');
      ul.innerHTML = '';

      const id = Number(document.getElementById('verEstId').value);
      try {
        const res = await fetch(API + '/estudiantes/reservas/estudiante/' + id);
        const data = await parseJson(res);
        setStatus('reservasStatus', '', 'info');
        if (!data.length) {
          document.getElementById('reservasEmpty').hidden = false;
          return;
        }
        data.forEach(r => {
          const li = document.createElement('li');
          const maestroLabel = r.maestroName || `Maestro ${r.maestroId}`;
          li.textContent = `${maestroLabel} · ${r.dia} ${r.inicio}-${r.fin}`;
          ul.appendChild(li);
        });
      } catch (error) {
        setStatus('reservasStatus', error.message, 'error');
      }
    }

    async function verReporte(event) {
      event?.preventDefault();
      setStatus('reportEstStatus', 'Generando reporte...', 'info');
      const id = Number(document.getElementById('reportEstId').value);

      try {
        const res = await fetch(API + '/reportes/estudiantes/reporte/' + id);
        const data = await parseJson(res);
        document.getElementById('reportArea').textContent = JSON.stringify(data, null, 2);
        setStatus('reportEstStatus', 'Reporte actualizado.', 'success');
      } catch (error) {
        setStatus('reportEstStatus', error.message, 'error');
      }
    }

    initPlanner({
      semesterSelectId: 'semesterSelectEstudiantes',
      subjectSelectId: 'subjectSelectEstudiantes',
      tableBodyId: 'plannerTableEstudiantes',
      summaryId: 'plannerSummaryEstudiantes',
      buttonId: 'plannerAssignBtnEstudiantes'
    });
  </script>
</body>
</html>
