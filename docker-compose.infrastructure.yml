version: '3.9'

services:
  # ============================================================================
  # BASTION HOST - Gateway and SSH proxy
  # ============================================================================
  bastion:
    image: ubuntu:22.04
    container_name: EC2-Bastion
    hostname: ec2-bastion
    networks:
      infrastructure:
        ipv4_address: 10.0.1.10
    ports:
      - "2222:22"
    environment:
      - SERVICE_NAME=Bastion Host
      - SERVICE_PORT=22
    volumes:
      - bastion-data:/data
    command: >
      bash -c "
        apt-get update &&
        apt-get install -y openssh-server openssh-client curl wget net-tools &&
        mkdir -p /run/sshd &&
        echo 'root:proyecto123' | chpasswd &&
        sed -i 's/^#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config &&
        /usr/sbin/sshd -D
      "
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "22"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # CORE MICROSERVICE
  # ============================================================================
  core:
    image: ubuntu:22.04
    container_name: EC2-CORE
    hostname: ec2-core
    networks:
      infrastructure:
        ipv4_address: 10.0.1.20
    environment:
      - SERVICE_NAME=Core Microservice
      - SERVICE_PORT=8080
      - DB_HOST=db
      - DB_PORT=5432
    volumes:
      - core-data:/data
    command: >
      bash -c "
        apt-get update &&
        apt-get install -y openssh-server openssh-client python3-pip curl &&
        mkdir -p /run/sshd &&
        echo 'root:proyecto123' | chpasswd &&
        /usr/sbin/sshd -D &
        python3 -m http.server 8080
      "
    ports:
      - "8080:8080"
      - "2220:22"
    depends_on:
      - db
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # MONITORING SERVICE
  # ============================================================================
  monitoring:
    image: ubuntu:22.04
    container_name: EC2-Monitoring
    hostname: ec2-monitoring
    networks:
      infrastructure:
        ipv4_address: 10.0.1.30
    environment:
      - SERVICE_NAME=Monitoring Service
      - SERVICE_PORT=9090
    volumes:
      - monitoring-data:/data
    command: >
      bash -c "
        apt-get update &&
        apt-get install -y openssh-server openssh-client curl net-tools &&
        mkdir -p /run/sshd &&
        echo 'root:proyecto123' | chpasswd &&
        /usr/sbin/sshd -D &
        python3 -m http.server 9090
      "
    ports:
      - "9090:9090"
      - "2221:22"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # API GATEWAY
  # ============================================================================
  api-gateway:
    image: ubuntu:22.04
    container_name: EC2-API-Gateway
    hostname: ec2-api-gateway
    networks:
      infrastructure:
        ipv4_address: 10.0.1.40
    environment:
      - SERVICE_NAME=API Gateway
      - SERVICE_PORT=3000
    volumes:
      - api-gateway-data:/data
    command: >
      bash -c "
        apt-get update &&
        apt-get install -y openssh-server openssh-client nodejs npm curl &&
        mkdir -p /run/sshd &&
        echo 'root:proyecto123' | chpasswd &&
        /usr/sbin/sshd -D &
        npm install -g http-server &&
        http-server -p 3000 /data
      "
    ports:
      - "3000:3000"
      - "2223:22"
    depends_on:
      - core
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # FRONTEND SERVICE
  # ============================================================================
  frontend:
    image: ubuntu:22.04
    container_name: EC2-Frontend
    hostname: ec2-frontend
    networks:
      infrastructure:
        ipv4_address: 10.0.2.10
    environment:
      - SERVICE_NAME=Frontend Service
      - SERVICE_PORT=80
      - API_URL=http://api-gateway:3000
    volumes:
      - frontend-data:/data
    command: >
      bash -c "
        apt-get update &&
        apt-get install -y openssh-server openssh-client nginx curl &&
        mkdir -p /run/sshd &&
        echo 'root:proyecto123' | chpasswd &&
        /usr/sbin/sshd -D &
        nginx -g 'daemon off;'
      "
    ports:
      - "80:80"
      - "443:443"
      - "2224:22"
    depends_on:
      - api-gateway
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # NOTIFICATIONS SERVICE
  # ============================================================================
  notificaciones:
    image: ubuntu:22.04
    container_name: EC2-Notificaciones
    hostname: ec2-notificaciones
    networks:
      infrastructure:
        ipv4_address: 10.0.2.20
    environment:
      - SERVICE_NAME=Notifications Service
      - SERVICE_PORT=5672
    volumes:
      - notificaciones-data:/data
    command: >
      bash -c "
        apt-get update &&
        apt-get install -y openssh-server openssh-client curl &&
        mkdir -p /run/sshd &&
        echo 'root:proyecto123' | chpasswd &&
        /usr/sbin/sshd -D
      "
    ports:
      - "5672:5672"
      - "2225:22"
    healthcheck:
      test: ["CMD", "test", "-f", "/etc/hostname"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # MESSAGING SERVICE
  # ============================================================================
  messaging:
    image: ubuntu:22.04
    container_name: EC2-Messaging
    hostname: ec2-messaging
    networks:
      infrastructure:
        ipv4_address: 10.0.2.30
    environment:
      - SERVICE_NAME=Messaging Service
      - SERVICE_PORT=5673
    volumes:
      - messaging-data:/data
    command: >
      bash -c "
        apt-get update &&
        apt-get install -y openssh-server openssh-client curl &&
        mkdir -p /run/sshd &&
        echo 'root:proyecto123' | chpasswd &&
        /usr/sbin/sshd -D
      "
    ports:
      - "5673:5673"
      - "2226:22"
    healthcheck:
      test: ["CMD", "test", "-f", "/etc/hostname"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # REPORTS SERVICE
  # ============================================================================
  reportes:
    image: ubuntu:22.04
    container_name: EC2-Reportes
    hostname: ec2-reportes
    networks:
      infrastructure:
        ipv4_address: 10.0.2.40
    environment:
      - SERVICE_NAME=Reports Service
      - SERVICE_PORT=8081
    volumes:
      - reportes-data:/data
    command: >
      bash -c "
        apt-get update &&
        apt-get install -y openssh-server openssh-client python3 curl &&
        mkdir -p /run/sshd &&
        echo 'root:proyecto123' | chpasswd &&
        /usr/sbin/sshd -D &
        python3 -m http.server 8081
      "
    ports:
      - "8081:8081"
      - "2227:22"
    depends_on:
      - db
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # DATABASE - PostgreSQL
  # ============================================================================
  db:
    image: postgres:15-alpine
    container_name: postgres-db
    hostname: db
    networks:
      infrastructure:
        ipv4_address: 10.0.3.10
    environment:
      - POSTGRES_USER=proyecto
      - POSTGRES_PASSWORD=proyecto123
      - POSTGRES_DB=acompanamiento_db
    ports:
      - "5432:5432"
    volumes:
      - db-data:/var/lib/postgresql/data
      - ./postgres-init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U proyecto"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # LOAD BALANCER - Nginx (simulating ALB)
  # ============================================================================
  load-balancer:
    image: nginx:alpine
    container_name: alb-proyecto-acompanamiento
    hostname: load-balancer
    networks:
      infrastructure:
        ipv4_address: 10.0.0.2
    ports:
      - "8000:80"
    volumes:
      - ./nginx-alb.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - frontend
      - api-gateway
      - core
      - monitoring
      - notificaciones
      - messaging
      - reportes
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  infrastructure:
    name: proyecto-acompanamiento-network
    driver: bridge
    ipam:
      config:
        - subnet: 10.0.0.0/16

volumes:
  bastion-data:
    name: bastion-data
  core-data:
    name: core-data
  monitoring-data:
    name: monitoring-data
  api-gateway-data:
    name: api-gateway-data
  frontend-data:
    name: frontend-data
  notificaciones-data:
    name: notificaciones-data
  messaging-data:
    name: messaging-data
  reportes-data:
    name: reportes-data
  db-data:
    name: db-data
